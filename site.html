<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link rel="icon" href="./epsilon aproxi logo.png" size="82x82">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <title>Epsilon Aproxi - Financial Dashboard</title>
 
        <style>
    
@media (max-width: 768px) {
    .nav-bar {
        /* Ensure the transition is smooth for the swipe action */
        transition: transform 0.3s ease;
    }
}
        /* MARKETPLACE STYLES */
.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.product-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: transform 0.3s, box-shadow 0.3s;
    display: flex;
    flex-direction: column;
    height: 100%;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
}

.product-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    background-color: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
    font-size: 14px;
}

.product-details {
    padding: 16px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}

.product-name {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 8px;
    color: #1f2937;
}

.product-category {
    display: inline-block;
    background: #e5e7eb;
    color: #6b7280;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin-bottom: 12px;
}

.product-price {
    font-size: 24px;
    font-weight: 800;
    color: #3b82f6;
    margin-bottom: 8px;
}

.product-stock {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 12px;
}

.product-description {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 16px;
    flex-grow: 1;
}

.product-business {
    font-size: 14px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 16px;
    padding-top: 12px;
    border-top: 1px solid #e5e7eb;
}

.product-actions {
    display: flex;
    gap: 8px;
}

.order-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-ordered {
    background-color: #fef3c7;
    color: #92400e;
}

.status-delivered {
    background-color: #d1fae5;
    color: #065f46;
}

.order-details-content {
    margin-bottom: 20px;
}

.order-detail-row {
    display: flex;
    margin-bottom: 8px;
}

.order-detail-label {
    font-weight: 600;
    width: 120px;
    color: #4b5563;
}

.order-detail-value {
    flex: 1;
    color: #6b7280;
}
        /* Add these styles to your existing CSS */

.warehouse-map-dialog, .transfer-history-dialog, .ai-tool-dialog {
    width: 90vw;
    max-width: 1200px;
    height: 80vh;
    max-height: 800px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid var(--color-border-light);
}

.modal-header h3 {
    margin: 0;
    font-size: 20px;
    color: var(--color-text-dark);
}

.close-button {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--color-text-medium);
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s;
}

.close-button:hover {
    background-color: #f3f4f6;
}

.warehouse-map-content, .transfer-history-content, .ai-tool-content {
    display: flex;
    flex-direction: column;
    height: calc(100% - 60px);
}

.map-controls {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
}

.warehouse-map {
    flex-grow: 1;
    border: 1px solid var(--color-border-light);
    border-radius: 8px;
    position: relative;
    overflow: hidden;
}

.simple-map {
    width: 100%;
    height: 100%;
    background-color: #f0f8ff;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f0f8ff" /><path d="M0,0 L100,0 L100,100 L0,100 Z" fill="none" stroke="%23e0e0e0" stroke-width="0.5" /><path d="M0,50 L100,50 M50,0 L50,100" fill="none" stroke="%23e0e0e0" stroke-width="0.5" /></svg>');
    background-size: 100px 100px;
    position: relative;
}

.map-legend {
    position: absolute;
    bottom: 20px;
    right: 20px;
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.legend-item:last-child {
    margin-bottom: 0;
}

.legend-marker {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    margin-right: 10px;
}

.high-stock {
    background-color: #10b981;
}

.medium-stock {
    background-color: #f59e0b;
}

.low-stock {
    background-color: #ef4444;
}

.warehouse-marker {
    position: absolute;
    transform: translate(-50%, -50%);
    cursor: pointer;
    z-index: 10;
}

.marker-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    border: 2px solid;
}

.warehouse-marker.high-stock .marker-icon {
    border-color: #10b981;
}

.warehouse-marker.medium-stock .marker-icon {
    border-color: #f59e0b;
}

.warehouse-marker.low-stock .marker-icon {
    border-color: #ef4444;
}

.marker-label {
    position: absolute;
    bottom: -25px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.warehouse-details-panel {
    width: 300px;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    overflow-y: auto;
}

.warehouse-detail-item {
    margin-bottom: 15px;
}

.warehouse-detail-item h5 {
    margin: 0 0 5px 0;
    font-size: 18px;
    color: var(--color-text-dark);
}

.warehouse-detail-item p {
    margin: 0;
    color: var(--color-text-medium);
    font-size: 14px;
}

.detail-label {
    font-weight: 600;
    color: var(--color-text-dark);
}

.detail-value {
    margin-left: 10px;
    color: var(--color-text-medium);
}

.warehouse-detail-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.transfer-filters {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background: #f9fafb;
    border-radius: 8px;
}

.filter-group {
    display: flex;
    flex-direction: column;
    flex: 1;
}

.filter-group label {
    margin-bottom: 5px;
    font-weight: 600;
    font-size: 14px;
}

.transfer-history-list {
    flex-grow: 1;
    overflow-y: auto;
    border: 1px solid var(--color-border-light);
    border-radius: 8px;
    padding: 15px;
}

.transfer-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid var(--color-border-light);
}

.transfer-item:last-child {
    border-bottom: none;
}

.transfer-date {
    font-size: 12px;
    color: var(--color-text-medium);
    min-width: 150px;
}

.transfer-details {
    flex-grow: 1;
}

.transfer-route {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
}

.warehouse-name {
    font-weight: 600;
    color: var(--color-text-dark);
}

.transfer-product {
    display: flex;
    justify-content: space-between;
}

.product-name {
    color: var(--color-text-medium);
}

.transfer-quantity {
    font-weight: 600;
    color: var(--color-primary);
}

.transfer-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    min-width: 80px;
    text-align: center;
}

.transfer-status.completed {
    background-color: #d1fae5;
    color: #065f46;
}

.transfer-status.pending {
    background-color: #fef3c7;
    color: #92400e;
}

.no-transfers {
    text-align: center;
    color: var(--color-text-medium);
    padding: 20px;
    font-style: italic;
}

        /* COMMUNITY STYLES */
.community-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: transform 0.3s, box-shadow 0.3s;
    cursor: pointer;
}

.community-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
}

.community-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.community-name {
    font-size: 20px;
    font-weight: 700;
    color: #1f2937;
}

.community-members {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 16px;
}

.community-businesses {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.business-tag {
    background: #e5e7eb;
    color: #1f2937;
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 600;
}

.dark-mode .community-card {
    background: #1e1e1e;
    border: 1px solid #3f3f3f;
}

.dark-mode .community-name {
    color: #ffffff;
}

.dark-mode .business-tag {
    background: #2a2a2a;
    color: #d1d5db;
}

        /* BUSINESS SHOWCASE STYLES */
.business-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: transform 0.3s, box-shadow 0.3s;
    display: flex;
    flex-direction: column;
    height: 100%;
    cursor: pointer;
}

.business-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
}

.business-logo {
    width: 100%;
    height: 200px;
    background-color: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
    font-size: 14px;
    overflow: hidden;
}

.business-logo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.business-info {
    padding: 16px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}

.business-name {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 8px;
    color: #1f2937;
}

.business-owner {
    font-size: 13px;
    color: #6b7280;
    margin-bottom: 8px;
}

.business-category {
    display: inline-block;
    background: #e5e7eb;
    color: #6b7280;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin-bottom: 12px;
    width: fit-content;
}

.business-description {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 16px;
    flex-grow: 1;
    line-height: 1.4;
}

.business-stats {
    font-size: 12px;
    color: #6b7280;
    padding-top: 12px;
    border-top: 1px solid #e5e7eb;
}

.businesses-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.follow-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
    margin-top: 8px;
    background: #3b82f6;
    color: white;
}

.follow-btn:hover {
    background: #2563eb;
    transform: translateY(-1px);
}

.follow-btn.followed {
    background: #6b7280;
}

.follow-btn.followed:hover {
    background: #4b5563;
}

.business-search-filters {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.business-search-filters input,
.business-search-filters select {
    flex: 1;
    min-width: 200px;
}

.business-detail-header {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.business-detail-top {
    display: flex;
    gap: 24px;
    align-items: flex-start;
    margin-bottom: 20px;
}

.business-detail-logo {
    width: 150px;
    height: 150px;
    background-color: #f3f4f6;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    flex-shrink: 0;
}

.business-detail-logo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.business-detail-info {
    flex-grow: 1;
}

.business-detail-name {
    font-size: 28px;
    font-weight: 800;
    color: #1f2937;
    margin-bottom: 8px;
}

.business-detail-owner {
    font-size: 16px;
    color: #6b7280;
    margin-bottom: 16px;
}

.business-detail-category {
    display: inline-block;
    background: #e5e7eb;
    color: #6b7280;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 13px;
    margin-bottom: 16px;
}

.business-detail-description {
    font-size: 14px;
    color: #6b7280;
    line-height: 1.6;
}

.back-button-wrapper {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1000;
    margin-bottom: 0;
}

.back-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 18px;
    background: white;
    border: 2px solid #3b82f6;
    border-radius: 8px;
    color: #3b82f6;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    font-size: 15px;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}

.back-button:hover {
    background: #3b82f6;
    color: white;
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.35);
    transform: translateX(-2px);
}

.dark-mode .back-button {
    background: #1e1e1e;
    border-color: #3b82f6;
    color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.dark-mode .back-button:hover {
    background: #3b82f6;
    color: white;
}

.no-businesses {
    text-align: center;
    color: var(--color-text-medium);
    padding: 40px 20px;
    font-style: italic;
}

.services-section {
    margin-top: 24px;
}

.services-section h3 {
    font-size: 20px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 16px;
}

        /* --- LOADING SCREEN --- */
        
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 3.5s ease;
        }
        
        #loading-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        #loading-screen img {
            width: 150px;
            height: 150px;
            margin-bottom: 30px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        #loading-screen h2 {
            color: white;
            margin-top: 20px;
            font-size: 24px;
            font-weight: 700;
        }

        /* --- GLOBAL STYLES & RESET --- */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #f4f7f9; /* Light gray background */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: pan-y; 
        }

        /* --- COLORS --- */
        :root {
            --color-primary: #3b82f6; /* Blue */
            --color-secondary: #10b981; /* Green */
            --color-danger: #ef4444; /* Red */
            --color-orange: #f97316; /* Orange for deductions */
            --color-text-dark: #1f2937;
            --color-text-medium: #6b7280;
            --color-card-bg: white;
            --color-border-light: #e5e7eb;
            --color-daizy: #ffff00;
            --color-omega: #eb7d00;
            --color-budget: #b601b6;
            --nav-width: 260px;
            --header-height: 50px;
        }

        /* --- DASHBOARD WIDGETS --- */
        .kpi-grid.draggable {
            position: relative;
        }

        .card.draggable {
            cursor: move;
            position: relative;
            user-select: none;
            touch-action: none;
        }

        .card.draggable:active {
            cursor: grabbing;
            opacity: 0.8;
            z-index: 1000;
        }

        .card.resizable {
            resize: both;
            overflow: auto;
            min-width: 150px;
            min-height: 100px;
        }

        .card-resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: nwse-resize;
            background: linear-gradient(135deg, transparent 50%, var(--color-primary) 50%);
            opacity: 0.5;
        }

        .card-resize-handle:hover {
            opacity: 1;
        }

        .card.selected {
            outline: 3px solid var(--color-primary);
        }

        .card-context-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px 0;
            min-width: 180px;
            z-index: 10000;
            display: none;
        }

        .card-context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: #f3f4f6;
        }

        .bulk-actions-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            display: none;
            gap: 12px;
            z-index: 1000;
        }

        .bulk-actions-bar.active {
            display: flex;
        }

        #dashboard-page {
            position: relative;
            min-height: calc(100vh - 100px);
        }

        /* --- GLOBAL SEARCH BAR --- */
        .global-search-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: 300px;
        }
        
        .global-search-input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 2px solid var(--color-border-light);
            border-radius: 24px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .global-search-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        
        .global-search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-medium);
            pointer-events: none;
        }
        
        .search-results-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            margin-top: 8px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        
        .search-results-dropdown.active {
            display: block;
        }
        
        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--color-border-light);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .search-result-item:hover {
            background: #f9fafb;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-category {
            font-size: 11px;
            color: var(--color-primary);
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .search-result-title {
            font-weight: 600;
            color: var(--color-text-dark);
            margin-bottom: 2px;
        }
        
        .search-result-detail {
            font-size: 12px;
            color: var(--color-text-medium);
        }
        
        .no-results {
            padding: 20px;
            text-align: center;
            color: var(--color-text-medium);
        }

        /* --- HEADER & NAVIGATION --- */
        .header-section {
            background-color: var(--color-primary);
            color: white;
            padding: 20px 24px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            position: fixed;
            top: 0;
            z-index: 10;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 1400px;
            text-align: right;
        }
        .header-section h1 {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: 0.05em;
            margin: 0;
        }

        /* Modern Vertical Sidebar Navigation */
        .nav-bar {
            position: fixed;
            top: var(--header-height);
            left: 0;
            width: var(--nav-width);
            height: calc(100vh - var(--header-height));
            background-color: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            border-right: 1px solid var(--color-border-light);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .nav-container {
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            flex-grow: 1;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 20px;
            color: var(--color-primary);
            padding: 0 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--color-border-light);
            padding-bottom: 20px;
        }

        .nav-brand svg {
            width: 28px;
            height: 28px;
        }

        .nav-links {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 0 12px;
        }

        .nav-button {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 10px;
            border: none;
            background-color: transparent;
            color: var(--color-text-dark);
            font-weight: 500;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            text-align: left;
            position: relative;
        }

        .nav-button:hover {
            background-color: #f3f4f6;
            color: var(--color-primary);
            transform: translateX(4px);
        }

        .nav-button.active-nav {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--color-primary);
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .nav-button.active-nav::before {
            content: '';
            position: absolute;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background-color: var(--color-primary);
            border-radius: 2px;
        }

        .nav-button svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        /* Mobile menu toggle */
        .mobile-menu-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s;
            display: none;
            position: relative;
            z-index: 1001;
        }

        .mobile-menu-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }
            
            .global-search-container {
                top: 70px;
                right: 10px;
                left: 10px;
                width: auto;
            }
            
            .global-search-input {
                font-size: 16px;
                padding: 10px 36px 10px 12px;
            }
            
            .search-result-item {
                padding: 10px 12px;
            }
            
            .search-result-title {
                font-size: 13px;
            }
            
            .search-result-detail {
                font-size: 11px;
            }
        }
        
        @media (max-width: 768px) {
            .nav-bar {
                transform: translateX(-100%);
            }
            .nav-bar.active {
                transform: translateX(0);
            }
        }

        .nav-bar.hidden {
            transform: translateX(-100%);
        }
        
        .main-content.expanded {
            margin-left: 0;
        }

        /* Adjust main content for left sidebar */
        .main-content {
            margin-left: var(--nav-width);
            padding: 24px;
            flex-grow: 1;
            min-height: calc(100vh - var(--header-height));
        }

        /* Page Management */
        .page { display: none; }
        .page.active { display: block; }

        .section-heading {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-text-dark);
            margin-bottom: 24px;
        }

        /* --- KPI CARDS --- */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        .card {
            background-color: var(--color-card-bg);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-bottom: 5px solid;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
        .card:hover::before {
            left: 100%;
        }

        /* Card Colors */
        .card-omega { border-color: var(--color-omega); }
        .card-primary { border-color: var(--color-primary); }
        .card-secondary { border-color: var(--color-secondary); }
        .card-danger { border-color: var(--color-danger); }
        .card-orange { border-color: var(--color-orange); }
        .card-daizy { border-color: var(--color-daizy); }
         .card-budget { border-color: var(--color-budget); }

        .card-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--color-text-medium);
            margin-bottom: 4px;
        }
        .card-value {
            font-size: 32px;
            font-weight: 800;
            margin-top: 4px;
            animation: countUp 0.8s ease-out;
            word-break: break-word;
            overflow-wrap: break-word;
            line-height: 1.2;
        }
        
        @keyframes countUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Text Color Utilities */
        .text-primary { color: var(--color-primary); }
        .text-secondary { color: var(--color-secondary); }
        .text-danger { color: var(--color-danger); }
        .text-orange { color: var(--color-orange); }
        .text-gray-medium { color: var(--color-text-medium); }

        /* --- FORMS AND BUTTONS --- */
        .form-layout-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }
        @media (min-width: 1024px) {
            .form-layout-grid {
                grid-template-columns: 1fr 2fr;
            }
        }

        .form-box {
            background-color: var(--color-card-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .form-box-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-text-dark);
            border-bottom: 1px solid var(--color-border-light);
            padding-bottom: 8px;
            margin-bottom: 16px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 5px;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.03);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-sizing: border-box;
            background: white;
        }
        .form-input:focus, .form-select:focus {
            border-color: var(--color-primary);
            outline: none;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15), 0 4px 12px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }
        .form-input:hover, .form-select:hover {
            border-color: #9ca3af;
        }

        .button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        .button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .button:hover::after {
            width: 300px;
            height: 300px;
        }
        .button-primary { background: linear-gradient(135deg, var(--color-primary) 0%, #2563eb 100%); }
        .button-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(59, 130, 246, 0.4); }
        .button-secondary { background: linear-gradient(135deg, var(--color-secondary) 0%, #059669 100%); }
        .button-secondary:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(16, 185, 129, 0.4); }
        .button-orange { background: linear-gradient(135deg, var(--color-orange) 0%, #ea580c 100%); }
        .button-orange:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(249, 115, 22, 0.4); }
        
        /* Welcome CTA Button */
        .welcome-cta-button {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 18px 48px;
            font-size: 17px;
            font-weight: 700;
            border-radius: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 12px 32px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.3px;
        }
        
        .welcome-cta-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }
        
        .welcome-cta-button:hover::before {
            left: 100%;
        }
        
        .welcome-cta-button:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 18px 48px rgba(59, 130, 246, 0.45);
        }
        
        .welcome-cta-button:active {
            transform: translateY(-1px) scale(0.99);
        }

        /* --- RESPONSIVE DATA TABLES --- */
        .responsive-table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .responsive-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }
        
        .responsive-table thead {
            background: linear-gradient(135deg, var(--color-primary) 0%, #2563eb 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        
        .responsive-table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .responsive-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--color-border-light);
            font-size: 14px;
        }
        
        .responsive-table tbody tr {
            transition: background 0.2s;
        }
        
        .responsive-table tbody tr:hover {
            background: #f9fafb;
        }
        
        .table-action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            margin-right: 4px;
        }
        
        .table-action-btn.delete {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .table-action-btn.delete:hover {
            background: #fecaca;
        }
        
        .table-action-btn.edit {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .table-action-btn.edit:hover {
            background: #bfdbfe;
        }
        
        @media (max-width: 768px) {
            .responsive-table {
                min-width: 100%;
            }
            
            .responsive-table th,
            .responsive-table td {
                padding: 10px 8px;
                font-size: 12px;
            }
            
            .table-action-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
        }

        /* --- LISTS (History/Deductions/Products) --- */
        .list-container {
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: auto;
            padding-bottom: 10px;
            -webkit-overflow-scrolling: touch;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 6px;
            margin-bottom: 4px;
            position: relative;
            min-width: 280px;
        }
        .list-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: var(--color-primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        .list-item:hover {
            background-color: #f9fafb;
            transform: translateX(8px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .list-item:hover::before {
            transform: scaleY(1);
        }
        .list-item-detail {
            font-size: 14px;
            color: #6b7280;
            margin-top: 2px;
        }

        /* --- SETTINGS/UTILITY --- */
        .setting-box {
            padding: 20px;
            border: 1px solid var(--color-border-light);
            background-color: var(--color-card-bg);
            border-radius: 12px;
        }
        .setting-option {
            display: flex;
            align-items: center;
        }
        .setting-radio {
            height: 16px;
            width: 16px;
            color: var(--color-primary);
        }

        /* Responsive adjustments for KPI grid on small screens */
        @media (max-width: 600px) {
             .kpi-grid {
                grid-template-columns: 1fr;
            }
            .main-content {
                padding: 16px;
            }
            .header-section {
                width: 100%;
                padding: 12px 16px;
            }
            .header-section h1 {
                font-size: 20px;
            }
            .header-section p {
                display: none;
            }
            
            /* Additional mobile optimizations */
            body {
                font-size: 14px;
            }
            
            .card-value {
                font-size: 20px;
                word-break: break-word;
            }
            
            .section-heading {
                font-size: 18px;
            }
            
            .button {
                padding: 10px;
                font-size: 14px;
            }
            
            .form-input, .form-select {
                font-size: 14px;
                padding: 8px;
            }
            
            .list-item {
                padding: 12px 8px;
                flex-direction: column;
                align-items: flex-start !important;
                gap: 8px;
            }
            
            .list-item > div {
                width: 100%;
            }
            
            .list-item button {
                width: 100%;
                margin-top: 8px;
            }
            
            .list-item-main {
                font-size: 14px;
            }
            
            .list-item-detail {
                font-size: 12px;
            }
        }

        /* --- DARK MODE THEME --- */
        .dark-mode {
            --color-card-bg: #1e1e1e;
            --color-text-dark: #ffffff;
            --color-text-medium: #d1d5db;
            --color-border-light: #3f3f3f;
            background-color: #111827;
            color: white;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dark-mode .header-section {
            background-color: #0c1d42;
            transition: background-color 0.3s ease;
        }

        .dark-mode .nav-bar {
            background-color: #1e1e1e;
            border-right-color: #3f3f3f;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .dark-mode .nav-button {
            background-color: transparent;
            color: #ffffff;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .dark-mode .nav-button:hover {
            background-color: #333333;
        }

        .dark-mode .nav-button.active-nav {
            background-color: rgba(59, 130, 246, 0.2);
            color: var(--color-primary);
        }

        .dark-mode .card {
            background-color: #1e1e1e;
            box-shadow: none;
            border: 1px solid #3f3f3f;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .dark-mode .form-box {
            background-color: #1e1e1e;
            border: 1px solid #3f3f3f;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .dark-mode .form-input {
            background-color: #2a2a2a;
            color: #ffffff;
            border-color: #3f3f3f;
        }

        .dark-mode .form-input:focus {
            border-color: #3b82f6;
            background-color: #2a2a2a;
        }

        .dark-mode .list-item:hover {
            background-color: #222222;
        }

        .dark-mode .product-card {
            background-color: #1e1e1e;
            border: 1px solid #3f3f3f;
        }

        .dark-mode .product-name {
            color: #ffffff;
        }

        .dark-mode .product-category {
            background: #2a2a2a;
            color: #d1d5db;
        }

        .dark-mode dialog {
            background-color: #1e1e1e;
            color: #ffffff;
        }

        .dark-mode .modal-header {
            border-bottom-color: #3f3f3f;
        }

        .dark-mode .close-button:hover {
            background-color: #333333;
        }

        .dark-mode .button {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
            transition: all 0.2s ease;
        }

        .dark-mode .button:hover {
            opacity: 0.9;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .dark-mode .button-secondary {
            background-color: #374151;
            border-color: #374151;
            color: #ffffff;
        }

        .dark-mode .button-secondary:hover {
            background-color: #4b5563;
        }

        .dark-mode .button-danger {
            background-color: #dc2626;
            border-color: #dc2626;
        }

        .dark-mode .button-danger:hover {
            background-color: #b91c1c;
        }

        .dark-mode .toggle-switch {
            background-color: #374151;
        }

        .dark-mode .toggle-switch input:checked + .slider {
            background-color: var(--color-primary);
        }

        .dark-mode .setting-box {
            background-color: #2a2a2a;
            border: 1px solid #3f3f3f;
            padding: 16px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .dark-mode .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .dark-mode .setting-row label:first-child {
            color: #e5e7eb;
            font-weight: 500;
        }

        .dark-mode .form-label {
            color: #e5e7eb;
            font-weight: 600;
        }

        .dark-mode select {
            background-color: #2a2a2a;
            color: #ffffff;
            border-color: #3f3f3f;
        }

        .dark-mode select:focus {
            border-color: var(--color-primary);
            background-color: #2a2a2a;
        }

        .dark-mode .section-heading {
            color: #f3f4f6;
            font-weight: 700;
        }

        .dark-mode .form-box-title {
            color: #e5e7eb;
            font-weight: 600;
        }

        .dark-mode .bussOpt {
            background-color: #2a2a2a;
            color: #ffffff;
            border: 1px solid #3f3f3f;
        }

        .dark-mode textarea {
            background-color: #2a2a2a;
            color: #ffffff;
            border-color: #3f3f3f;
        }

        .dark-mode textarea:focus {
            border-color: var(--color-primary);
            background-color: #2a2a2a;
        }

        .bussOpt {
            height: 40px;
            width: 420px;
            border-radius: 30px ;
            font-size: 20px;
            position: absolute;
            right: 475px;
        }

        /* Settings Page Layout Fixes */
        .settings-container {
            width: 500px;
            max-width: 100%;
            margin: 0 auto;
            padding: 32px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }
        
        @media (max-width: 768px) {
            .settings-container {
                width: 100%;
                padding: 16px;
                gap: 16px;
            }
            
            .settings-group {
                width: 100%;
            }
            
            .settings-group h1 {
                font-size: 24px;
            }
            
            .settings-group h4 {
                font-size: 16px;
            }
            
            .setting-box {
                padding: 12px;
            }
            
            .setting-option {
                font-size: 14px;
            }
        }

        .color-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option small {
            font-size: 12px;
            font-weight: 500;
            color: var(--color-text-medium);
            text-align: center;
            width: 100%;
        }

        .color-option .color-preview {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.2s;
        }

        .color-option.active .color-preview {
            border-color: var(--color-text-dark) !important;
            border-width: 3px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .dark-mode .color-option small {
            color: var(--color-text-medium);
        }

        .dark-mode .color-option .color-preview {
            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.1);
        }

        .dark-mode .color-option.active .color-preview {
            border-color: var(--color-text-dark);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
        }

        .settings-group {
            width: 100%;
            text-align: center;
        }

        .settings-group h3 {
            margin-bottom: 12px;
        }
   #newCatalogDialog {
    width: 400px;
   }

        .settings-group input,
        .settings-group select {
            max-width: 400px;
            margin: 0 auto;
            display: block;
        }

        .settings-group img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 12px;
            border: 2px solid var(--color-border-light);
        }

        .settings-group .upload-btn {
            margin-top: 8px;
            border-radius: 30px;
            width: 40px;
            height: 40px;
            background: var(--color-primary);
            color: white;
            font-size: 20px;
            border: none;
            cursor: pointer;
        }
        
        .profile-pic {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--color-border-light);
            margin-bottom: 12px;
        }

        .button-row {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 8px;
        }

        .round-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--color-primary);
            color: white;
            font-size: 18px;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            transition: background-color 0.2s ease;
        }

        .round-btn2 {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--color-primary);
            color: white;
            font-size: 18px;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            transition: background-color 0.2s ease;
        }

        .nav-toggle-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--color-primary);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-toggle-btn:hover {
            background-color: #2563eb;
            transform: scale(1.05);
        }

        .round-btn:hover {
            background-color: #2563eb;
        }
        
        .box-info {
            padding: 16px; border: 1px dashed #d1d5db; background-color: #f9fafb; border-radius: 8px;
        }

        /* Mobile Responsive Navigation */
        @media (max-width: 768px) {
            .nav-bar {
                position: fixed;
                transform: translateX(-100%);
                width: 80%;
                max-width: 280px;
                z-index: 999;
                transition: transform 0.3s ease;
                top: 0;
                height: 100vh;
            }
            
            .nav-bar.active {
                transform: translateX(0);
                box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
            }
            
            .main-content {
                margin-left: 0;
                padding: 12px;
                padding-top: calc(var(--header-height) + 24px);
                width: 100%;
            }
            
            /* Touch-friendly tap targets */
            button, .nav-button, .button {
                min-height: 44px;
                min-width: 44px;
            }
            
            .header-section {
                position: fixed;
                width: 100%;
                left: 0;
                right: 0;
                z-index: 998;
            }
            
            .nav-brand {
                font-size: 18px;
                margin-bottom: 16px;
                padding-bottom: 16px;
            }
            
            .nav-button {
                padding: 12px 16px;
                font-size: 14px;
            }
            
            .nav-button svg {
                width: 18px;
                height: 18px;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .form-layout-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            dialog {
                width: 90vw !important;
                max-width: 90vw !important;
                padding: 16px;
                max-height: 85vh;
                overflow-y: auto;
                margin: auto;
                border-radius: 12px;
            }
            
            /* Improve scrolling on mobile */
            .list-container {
                max-height: 60vh;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Better spacing for mobile forms */
            .form-group {
                margin-bottom: 12px;
            }
            
            .form-box {
                padding: 16px;
                margin-bottom: 16px;
            }
            
            #account-settings-dialog,
            #new-product-dialog,
            #new-deduction-dialog,
            #client-dialog,
            #new-warehouse-dialog {
                width: 90vw !important;
            }
            
            #account-settings-dialog .button,
            .settings-group .button {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            .settings-container {
                width: 100% !important;
                padding: 16px !important;
            }
            
            .profile-pic {
                width: 120px !important;
                height: 120px !important;
            }
            
            .section-heading {
                font-size: 20px;
                margin-top: 0;
            }
            
            .list-item {
                flex-direction: column;
                align-items: flex-start !important;
            }
            
            .list-item > div {
                width: 100%;
            }
            
            .form-box {
                padding: 16px;
            }
            
            .card {
                padding: 16px;
            }
            
            .budget-box {
                width: calc(100% - 20px) !important;
                position: relative !important;
                top: 20px;
                margin: 10px;
                height: auto;
                padding: 16px;
            }
            
            .bussOpt {
                display: none;
            }
            
            /* Mobile-friendly tables and grids */
            table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Optimize images for mobile */
            img {
                max-width: 100%;
                height: auto;
            }
            
            /* Better touch targets for icons */
            svg, i {
                pointer-events: none;
            }
            
            .header-section h1 {
                font-size: 18px;
            }
            
            .header-section p {
                font-size: 12px;
            }
            
            /* Mobile overlay for nav */
            .nav-overlay.active {
                display: block !important;
            }
        }

        /* Additional styles for other components */
        .AIP {
            height: 100vh;
            position: relative;
            left: 0px;
            background: transparent;
        }
        
        /* Mobile-specific improvements */
        @media (max-width: 480px) {
            /* Extra small devices */
            .header-section h1 {
                font-size: 16px;
            }
            
            .card-value {
                font-size: 20px;
            }
            
            .nav-button {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .form-box-title {
                font-size: 16px;
            }
            
            /* Stack buttons vertically on very small screens */
            .button-row {
                flex-direction: column;
                gap: 8px;
            }
            
            .button-row button {
                width: 100%;
            }
        }
        
        .AIP.collapsed {
            position: fixed;
            width: 380px;
            height: 600px;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
            cursor: move;
            background: #fff;
        }
        
        .collapse-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: background 0.2s;
        }
        
        .collapse-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        .dark-mode #messages {
            background: #111827;
        }

        .message.bot {
            background: #ffffff;
            color: #000000;
            border: none;
        }

        .message.user {
            background: #2563eb;
            color: #ffffff;
        }

        .dark-mode .message.bot {
            background: #111827;
            color: #fff;
        }

        .ai-nav:active {
            background: #450086;
        }

        .node {
            cursor: grab;
            touch-action: none;
            user-select: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.1s;
        }

        .node:active { 
            cursor: grabbing; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); 
        }

        .node.connecting {
            box-shadow: 0 0 0 4px #a7f3d0; /* Tailwind emerald-200 */
            border: 2px solid #059669; /* Tailwind emerald-600 */
        }

        .card-client {
            width: 200px;
        }

        /* Chat and AI styles */
        #app-layout {
            display: flex;
            width: 100%;
            height: 100vh;
            max-width: none;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            background: transparent;
        }

        #history-sidebar {
            width: 280px;
            min-width: 200px;
            background: #ffffff;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            overflow-y: auto;
            flex-shrink: 0;
            transition: width 0.3s ease;
        }

        #chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            max-width: calc(100% - 280px); /* Adjusted for sidebar width */
        }

        #history-header {
            padding: 0 20px 10px;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 10px;
        }

        #history-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }

        #history-list {
            list-style: none;
            padding: 0 10px;
            margin: 0;
            flex-grow: 1;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #475569;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            overflow: hidden;
        }
        #AI-Page {
            background: transparent;
        }
        .history-item:hover, .history-item.active {
            background-color: #f1f5f9;
            color: #0f172a;
        }

        .history-item-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
            padding-right: 10px;
        }
        .text-purple { color: #bb00bb ;}
        .history-item-delete {
            flex-shrink: 0;
            color: #94a3b8;
            cursor: pointer;
            font-weight: 600;
            padding: 0 5px;
            transition: color 0.2s;
            opacity: 0;
            pointer-events: none;
            font-size: 1rem;
        }

        .history-item:hover .history-item-delete {
            opacity: 1;
            pointer-events: auto;
        }

        .history-item-delete:hover {
            color: #ef4444;
        }

        #chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            background: #4f46e5;
            color: #fff;
        }

        #chat-header h1 {
            font-size: 1.5rem;
            font-weight: 800;
            color: #0f172a;
            margin: 0;
            display: flex;
            align-items: center;
        }

        #chat-header h1 svg {
            margin-right: 10px;
            color: #4f46e5;
        }

        #user-id-display {
            font-size: 0.75rem;
            color: #64748b;
            margin-left: 20px;
            padding: 5px 10px;
            background: #f1f5f9;
            border-radius: 4px;
            font-weight: 600;
        }

        #messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background: #fff;
        }

        .message {
            margin-bottom: 15px;
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 12px;
            word-wrap: break-word;
            line-height: 1.6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .code-block {
            position: relative;
            background: #1e1e1e;
            border-radius: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #2d2d2d;
            border-bottom: 1px solid #3d3d3d;
        }

        .code-language {
            color: #9cdcfe;
            font-size: 12px;
            font-weight: 600;
        }

        .copy-code-btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .copy-code-btn:hover {
            background: #4338ca;
        }

        .copy-code-btn.copied {
            background: #10b981;
        }

        .code-content {
            padding: 12px;
            overflow-x: auto;
        }

        .code-content pre {
            margin: 0;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .user {
            background-color: #4f46e5;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .bot {
            background-color: #e2e8f0;
            color: #1e293b;
            margin-right: auto;
            border-bottom-left-radius: 4px;
            position: relative;
            padding-bottom: 40px;
        }

        .tts-button {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: #fff;
            border: none;
            border-radius: 20px;
            padding: 6px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .tts-button:hover {
            background: #333;
        }

        .tts-button svg {
            width: 16px;
            height: 16px;
        }

        .citation {
            background-color: #eff6ff; /* Light blue */
            color: #1e40af; /* Darker blue text */
            font-size: 0.8rem;
            padding: 8px 15px;
            border-radius: 8px;
            margin-top: -10px;
            margin-bottom: 15px;
            margin-left: auto;
            max-width: 90%;
            text-align: right;
            font-style: italic;
        }

        .citation a {
            color: #3b82f6;
            text-decoration: none;
        }

        .citation a:hover {
            text-decoration: underline;
        }

        .error {
            background-color: #fecaca;
            color: #991b1b;
            margin-right: auto;
            border: 1px solid #f87171;
        }

        #input-container {
            display: flex;
            padding: 15px 20px;
            border-top: 1px solid #e2e8f0;
            background: #fff;
            flex-shrink: 0;
            border-radius: 30px;
        }

        #user-input {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid #cbd5e1;
            border-radius: 20px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-family: 'Inter', sans-serif;
        }

        #user-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        #send-button {
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        #send-button:hover {
            background-color: #4338ca;
        }

        #send-button:active {
            transform: scale(0.98);
        }

        #send-button:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }

        /* Loading state */
        .loading::after {
            content: '...';
            animation: loading-dots 1s infinite;
        }

        @keyframes loading-dots {
            0% { content: ''; }
            33% { content: '.'; }
            66% { content: '..'; }
            100% { content: '...'; }
        }

        /* Settings Button */
        #settings-button {
            background: none;
            border: none;
            cursor: pointer;
            color: #64748b;
            margin-left: 10px;
            transition: color 0.2s;
            padding: 8px;
            border-radius: 50%;
        }
        .button-danger {
            background: #ff0000;
            margin-bottom: 10px;
        }
        #settings-button:hover {
            color: #4f46e5;
            background: #f1f5f9;
        }

        /* Modal Styles (Settings) */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                padding: 16px;
                max-height: 85vh;
            }
            
            .modal-header h3 {
                font-size: 18px;
            }
            
            .setting-group textarea {
                min-height: 80px;
                font-size: 14px;
            }
        }
         option {
            background: #ffffff;
            border: none;
         }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 800;
            color: #0f172a;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            transition: color 0.2s;
        }

        .close-button:hover {
            color: #ef4444;
        }

        .setting-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .setting-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1e293b;
        }

        .setting-group textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            resize: vertical;
            font-size: 0.95rem;
            font-family: 'Inter', sans-serif;
        }

        .setting-group p {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 5px;
        }

        /* Toggle Switch Styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4f46e5;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #4f46e5;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Prevent horizontal scroll */
        * {
            box-sizing: border-box;
        }
        
        html, body {
            overflow-x: hidden;
            max-width: 100vw;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            #app-layout {
                flex-direction: column;
                height: 100%;
            }
           
            #history-sidebar {
                display: none;
            }
           .inps {
            width: calc(100% - 80px);
           }
           .budget-box {
            width: calc(100% - 20px);
            position: relative;
            top: 20px;
            margin: 10px;
           }
            #chat-area {
                max-width: 100%;
                height: 100vh;
            }
            
            #chat-header {
                padding: 10px 12px;
            }
            
            #chat-header h1 {
                font-size: 1rem;
            }
            
            #chat-header p {
                display: none;
            }

            #user-id-display {
                display: none;
            }

            #input-container {
                padding: 8px 10px;
                flex-wrap: nowrap;
            }

            #user-input {
                padding: 10px;
                font-size: 14px;
            }

            #send-button {
                padding: 10px 12px;
                font-size: 14px;
                min-width: 60px;
            }
            
            #file-button, #image-button {
                padding: 8px;
                margin-right: 5px;
            }
            
            #file-button svg, #image-button svg {
                width: 18px;
                height: 18px;
            }
            
            .AIP.collapsed {
                width: 90vw !important;
                height: 70vh !important;
                bottom: 10px;
                right: 5%;
                left: 5%;
            }
            
            .t-b {
                width: calc(100% - 20px);
                margin: 5px 10px;
            }
            
            .ptb {
                width: 60px;
                font-size: 12px;
                padding: 5px;
            }
            
            .chart-container {
                width: calc(100% - 20px);
                margin: 10px;
                top: 50px;
                padding: 10px;
                margin-bottom: 100px;
            }
            
            /* Mobile-specific utility classes */
            .mobile-hidden {
                display: none !important;
            }
            
            /* Improve readability on small screens */
            p, span, label {
                line-height: 1.5;
            }
            
            /* Better spacing for mobile cards */
            .card {
                margin-bottom: 12px;
            }
            
            /* Optimize modal positioning */
            .modal-content {
                width: 95vw;
                max-width: 95vw;
                margin: 10px auto;
            }
            
            /* Improve input visibility */
            input:focus, select:focus, textarea:focus {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
         .custom-tooltip-container {
            position: relative;
            display: inline-block;
        }

        .custom-tooltip-btn {
            padding: 12px 25px;
            font-size: 18px;
            font-weight: bold;
            color: #ffffff;
            background-color: #007bff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 8px 15px rgba(0, 123, 255, 0.4);
        }

        .custom-tooltip-btn:hover {
            background-color: #0056b3;
        }

        .custom-tooltip-content {
            position: absolute;
            bottom: 140%;
            left: 50%;
            transform: translateX(-50%);
            visibility: hidden;
            opacity: 0;
            width: 240px;
            background: linear-gradient(135deg, #007bff 0%, #00c6ff 100%);
            color: #fff;
            text-align: center;
            padding: 15px;
            font-size: 14px;
            border-radius: 15px;
            transition: all 0.4s ease;
            z-index: 1;
            box-shadow: 0px 10px 20px rgba(0, 123, 255, 0.3);
            clip-path: polygon(0 0, 100% 0, 100% 85%, 50% 100%, 0 85%);
        }

        .custom-tooltip-container:hover .custom-tooltip-content {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }

        .custom-tooltip-arrow {
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -10px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #007bff;
        }

        .custom-tooltip-text {
            font-size: 14px;
            line-height: 1.5;
            letter-spacing: 0.5px;
        }
        .t-b {
            width: 1000px;
        }
        .settingsOptionButton {
            flex-direction: column;
            gap: 10px;
        }
        .dark-mode #input-container {
         background: #1f2937;
         color: #fff;
        }
        dialog {
            border-radius: 20px;
            border: none;
            width: 80vw;
            max-width: 800px;
        }
        
        @media (max-width: 768px) {
            dialog {
                border-radius: 15px;
                width: 92vw !important;
                max-width: 92vw !important;
                padding: 12px;
                margin: auto;
            }
            
            dialog h3, dialog h1 {
                font-size: 18px;
            }
            
            dialog .form-input, dialog .form-select {
                font-size: 14px;
                padding: 8px;
            }
            
            dialog .button {
                padding: 10px;
                font-size: 14px;
            }
        }
        .short {
            width: 200px;
        }
        /* --- Utility Classes (Replacing core Tailwind utilities) --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .justify-end { justify-content: flex-end; }
        .truncate { 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .line-clamp-3 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            
     }
        .w-full { width: 100%; }

        /* --- Header/Controls --- */
        .header {
            height: 4rem; /* h-16 */
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05); /* shadow-lg */
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem; /* px-4 sm:px-6 */
        }
        .header h1 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 700; /* font-bold */
            color: var(--gray-800);
        }
        .controls-group {
            display: flex;
            align-items: center;
            gap: 1rem; /* space-x-4 */
        }
        #statusMessage {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-500);
        }

        /* --- Buttons --- */
        .btn {
            padding: 0.5rem 1rem;
            font-weight: 600; /* font-semibold */
            border-radius: 0.5rem; /* rounded-lg */
            transition: all 0.15s ease-in-out;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-primary {
            background-color: var(--blue-600);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--blue-700);
            transform: scale(1.05);
        }
        .btn-secondary {
            background-color: var(--gray-200);
            color: var(--gray-800);
        }
        .btn-secondary:hover {
            background-color: var(--gray-300);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: var(--blue-400); /* Use blue-400 for disabled primary */
            box-shadow: none;
            transform: none;
        }
        /* --- Graph Area & Connections --- */
        #graph-container {
            position: relative;
            width: 100%;
            height: 800px;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        #graph-area { 
            position: absolute;
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
            transition: transform 0.2s;
        }
        #connectionsSvg {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none;
            z-index: 5;
        }
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            z-index: 100;
            background: white;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .zoom-btn {
            padding: 8px 12px;
            border: none;
            background: #f0f4f8;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            min-width: 36px;
        }
        .zoom-btn:hover {
            background: #3b82f6;
            color: white;
        }
        .minimap {
            position: absolute;
            bottom: 80px;
            right: 20px;
            width: 120px;
            height: 100px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            z-index: 99;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* --- Node Styling --- */
        .node {
            cursor: grab;
            touch-action: none;
            user-select: none;
            pointer-events: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12), 0 2px 6px rgba(0, 0, 0, 0.08);
            transition: transform 0.15s, box-shadow 0.2s, filter 0.2s;
            position: absolute;
            padding: 1rem;
            background: white;
            border-radius: 10px;
            width: 200px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            z-index: 10;
            border-left: 4px solid #3b82f6;
            overflow: hidden;
        }
        .node:hover {
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15), 0 4px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .node:active { 
            cursor: grabbing; 
            box-shadow: 0 20px 30px rgba(0, 0, 0, 0.2);
            filter: brightness(0.97);
        }
        .node.dragging {
            z-index: 1000;
            box-shadow: 0 25px 40px rgba(0, 0, 0, 0.25);
        }
        .node.selected {
            border-left-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1), 0 4px 12px rgba(0, 0, 0, 0.12);
        }
        .node.connecting {
            border-left-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.15), 0 4px 12px rgba(0, 0, 0, 0.12);
        }
        
        .node h3 {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.25rem;
            margin-top: 0;
        }
        .node p {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0;
            flex-grow: 1;
            display: flex;
            align-items: center;
        }
        .node-resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, transparent 50%, #3b82f6 50%);
            cursor: nwse-resize;
            border-radius: 0 0 10px 0;
        }

        /* --- Context Menu --- */
        #context-menu { 
            position: absolute; 
            background-color: white; 
            border-radius: 0.5rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); /* shadow-xl */
            padding: 0.25rem 0; 
            width: 12rem; 
            border: 1px solid var(--gray-200); 
            z-index: 100;
            display: none;
        }
        .menu-item {
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 0.5rem; 
            cursor: pointer;
            transition: background-color 0.15s;
            background-color: transparent;
            border: none;
        }
        .menu-item:hover {
            background-color: var(--blue-100); 
        }
        .menu-item-delete {
            color: var(--red-600);
        }
        .menu-item-delete:hover {
            background-color: var(--red-50);
        }
        .menu-divider {
            border-top: 1px solid var(--gray-200);
            margin: 0.25rem 0;
        }
        .menu-item svg {
            width: 1rem;
            height: 1rem;
        }

        /* --- Modals --- */
        .overlay { 
            position: fixed; 
            inset: 0; 
            background-color: rgba(0, 0, 0, 0.7); 
            z-index: 90; 
        } 
        .modal-content { 
            background-color: white; 
            padding: 1.5rem; 
            border-radius: 0.75rem; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
            max-width: 32rem; /* Adjusted for better modal size */
            width: 90%;
            margin: 0 1rem; 
            z-index: 100;
        }

        /* Input/Textarea Styling */
        .input-field {
            width: 100%;
            padding: 0.75rem; 
            margin-bottom: 1rem; 
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem; 
            transition: border-color 0.15s, box-shadow 0.15s;
            resize: none;
            font-size: 1rem;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--blue-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); 
        }
        
        /* Connection Modal Specifics (Target Node List) */
        #targetNodeList {
            max-height: 15rem; 
            overflow-y: auto;
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            background-color: var(--gray-50);
        }
        
        .target-node-item {
            padding: 1rem; 
            cursor: pointer;
            border-bottom: 1px solid var(--gray-200); 
            transition: background-color 0.15s, border-left 0.15s; 
        }
        .target-node-item:last-child {
            border-bottom: none; 
        }
        .target-node-item:hover { 
            background-color: var(--gray-100); 
        }
        .target-node-item.selected { 
            background-color: var(--blue-100); 
            border-left: 4px solid var(--blue-700); 
        }
        
        .target-node-item .text-xs {
            font-size: 0.75rem;
            color: var(--gray-500);
        }
        .dark-mode .form-input {
            background: #333333;
            color: #fff;
        }
       .dark-mode dialog {
        background: #222222;
        color: #fff;
       }
       .chart-container {
        max-width: 800px; 
        margin: auto; 
        border-radius: 30px; 
        background: #fff; 
        width: auto;
        box-shadow: #1e1e1e 3px 3px 4px;
       }
       .ptb {
        color: #000;
        height: 40px;
        width: 80px;
        background: #fff;
        border: none;
        border-bottom: 2px var(--color-primary) solid;
        cursor: pointer;
       }
       .ptb:hover {
        background: #a1add3;
       }
       .dark-mode .chart-container {
        background: #1e293b;
        color: #fff;
       }
       .dark-mode .ptb {
         background: #1e293b;
         color: #fff;
       }

       /* --- Chart Page Styles --- */
       #chartsPage, #pie-page-chart, #lineChart, #deductions-chart-page, #p-s-d, #advanced-charts {
           padding: 0 20px 40px 20px;
           overflow-x: hidden;
       }

       .charts-header {
           text-align: center;
           margin-bottom: 30px;
           padding: 20px 0;
           max-width: 1400px;
           margin-left: auto;
           margin-right: auto;
       }
       
       .charts-header h1 {
           font-size: 32px;
           font-weight: 800;
           color: var(--color-text-dark);
           margin: 0 0 10px 0;
       }
       
       .charts-header p {
           color: var(--color-text-medium);
           font-size: 16px;
           margin: 0;
       }

       .chart-tabs {
           display: flex;
           flex-wrap: wrap;
           gap: 12px;
           justify-content: center;
           margin: 0 auto 30px;
           padding: 16px 20px;
           background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
           border-radius: 16px;
           max-width: 1000px;
           width: 100%;
           box-sizing: border-box;
       }

       .ptb {
           position: relative;
           color: var(--color-text-medium);
           height: 44px;
           padding: 0 20px;
           background: white;
           border: 2px solid var(--color-border-light);
           border-radius: 8px;
           cursor: pointer;
           font-weight: 600;
           font-size: 14px;
           transition: all 0.3s ease;
           display: flex;
           align-items: center;
           white-space: nowrap;
       }

       .ptb:hover {
           border-color: var(--color-primary);
           background: #f0f4f8;
           transform: translateY(-2px);
       }

       .ptb.active {
           background: linear-gradient(135deg, var(--color-primary) 0%, #2563eb 100%);
           color: white;
           border-color: var(--color-primary);
       }

       .chart-grid {
           display: grid;
           grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
           gap: 24px;
           margin-bottom: 40px;
           padding: 0;
           max-width: 1400px;
           margin-left: auto;
           margin-right: auto;
       }

       #chartsPage .form-box,
       #pie-page-chart .form-box,
       #lineChart .form-box,
       #deductions-chart-page .form-box,
       #p-s-d .form-box,
       #advanced-charts .form-box {
           max-width: 1000px;
           margin-left: auto;
           margin-right: auto;
           padding: 16px 20px;
       }

       .chart-card {
           background: white;
           border-radius: 16px;
           padding: 24px;
           box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
           transition: all 0.3s ease;
           border: 1px solid #f3f4f6;
           display: flex;
           flex-direction: column;
           overflow: hidden;
       }

       .chart-card:hover {
           box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
           transform: translateY(-2px);
       }

       .chart-card-title {
           font-size: 18px;
           font-weight: 700;
           color: var(--color-text-dark);
           margin-bottom: 8px;
           display: flex;
           align-items: center;
           gap: 8px;
           word-wrap: break-word;
           overflow-wrap: break-word;
       }

       .chart-card-subtitle {
           font-size: 13px;
           color: var(--color-text-medium);
           margin-bottom: 16px;
           word-wrap: break-word;
           overflow-wrap: break-word;
       }

       .chart-container {
           position: relative;
           width: 100%;
           height: 450px;
           margin: 0;
           padding: 20px;
           box-sizing: border-box;
       }

       .chart-container canvas {
           display: block;
           max-width: 100%;
           max-height: 100%;
       }

       .dark-mode .chart-container {
           background: #1e293b;
           color: #fff;
       }

       .dark-mode .chart-card {
           background: #1e293b;
           border-color: #334155;
       }

       .dark-mode .ptb {
           background: #334155;
           color: #f1f5f9;
           border-color: #475569;
       }

       .dark-mode .ptb:hover {
           background: #475569;
       }

       @media (max-width: 768px) {
           #chartsPage, #pie-page-chart, #lineChart, #deductions-chart-page, #p-s-d, #advanced-charts {
               padding: 0 10px 20px 10px;
           }

           .chart-grid {
               grid-template-columns: 1fr;
               padding: 0;
               gap: 16px;
           }

           .chart-container {
               height: 300px;
           }

           .chart-card {
               padding: 16px;
               margin-bottom: 10px;
           }

           .charts-header {
               padding: 15px 0;
               margin-bottom: 20px;
           }

           .charts-header h1 {
               font-size: 24px;
               margin-bottom: 8px;
           }

           .charts-header p {
               font-size: 14px;
           }

           .chart-tabs {
               flex-direction: column;
               gap: 8px;
               max-width: 100%;
               padding: 12px 10px;
               margin-bottom: 20px;
           }

           .ptb {
               width: 100%;
               justify-content: center;
               font-size: 13px;
           }

           #chartsPage .form-box,
           #pie-page-chart .form-box,
           #lineChart .form-box,
           #deductions-chart-page .form-box,
           #p-s-d .form-box,
           #advanced-charts .form-box {
               padding: 12px 10px;
               margin-bottom: 20px;
           }

           .chart-card-title {
               font-size: 16px;
           }

           .chart-card-subtitle {
               font-size: 12px;
           }
       }

       /* --- Notification Bar Styles --- */
        #notification-bar {
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            border-radius: 12px;
            background-color: var(--color-card-bg);
            border: 1px solid var(--color-border-light);
        }

        .notification {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            background-color: white;
            transition: all 0.3s ease;
            transform: translateX(0);
            opacity: 1;
            max-width: 100%;
            overflow: hidden;
            border-left: 4px solid;
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        
        .notification-icon {
            margin-right: 12px;
        }
        
        .notification-text {
            flex-grow: 1;
            font-size: 14px;
            color: var(--color-text-dark);
        }
        
        .notification-time {
            font-size: 12px;
            color: var(--color-text-medium);
            margin-left: 10px;
        }
        
        .notification-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            color: var(--color-text-medium);
            transition: background-color 0.2s;
        }
        
        .notification-close:hover {
            background-color: #f3f4f6;
            color: var(--color-text-dark);
        }
        .circle {
            height: 100px;
            width: 100px;
            border-radius: 50%;
        }
        #monthly-trends {
          height: 400px !important;
        }
        /* Notification Types */
        /* Dark Mode Notification Styles */
        .dark-mode .notification {
            background-color: #1e293b; /* Darker background for notifications */
        }
        .dark-mode .notification-text {
            color: #f3f4f6;
        }
        .dark-mode .notification-time {
            color: #9ca3af;
        }
        .dark-mode .notification-close {
            color: #9ca3af;
        }
        .dark-mode .notification-close:hover {
            background-color: #374151;
            color: #f9fafb;
        }
        .dark-mode #notification-bar {
            background-color: #111827; /* Match dark page background */
        }
        
        .notification.success { border-left-color: var(--color-secondary); }
        .notification.error { border-left-color: var(--color-danger); }
        .notification.info { border-left-color: var(--color-primary); }
        .notification.warning { border-left-color: var(--color-orange); }
        
        .notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 12px;
            height: 12px;
            background-color: #ef4444;
            border-radius: 50%;
            border: 2px solid white;
            animation: pulse-badge 2s infinite;
        }
        
        @keyframes pulse-badge {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        
        .profile-button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
            object-fit: cover;
            transition: transform 0.2s;
            position: relative;
            flex-shrink: 0;
        }
        
        .profile-button:hover {
            transform: scale(1.05);
        }
        
        @media (max-width: 768px) {
            .profile-button {
                width: 40px;
                height: 40px;
                min-width: 40px;
                min-height: 40px;
            }
        }
        
        .notice {
            border-bottom: 1px #000 solid;
            margin-bottom: 130px;
        }
        .budget-box{
            height: 100px;
            width: 1000px;
            position: absolute;
            top: 210px;
            background: #fff;
            border-radius: 20px;
            border-bottom: 5px var(--color-budget) solid;
            box-shadow: #000000 2px 2px 3px;
            padding-left: 10px;
        }
        .square {
            border-radius: 30px;
            height: 90px;
            width: 90px;
            color: #fff;
            border: none;
            font-size: 20px;
        }
        
        /* Welcome Page Styles */
        #welcome-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #1e40af 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            overflow-y: auto;
            padding: 20px;
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .welcome-container {
            background: white;
            padding: 0;
            border-radius: 32px;
            max-width: 1200px;
            width: 100%;
            box-shadow: 0 40px 120px rgba(0, 0, 0, 0.35), 0 0 1px rgba(59, 130, 246, 0.5);
            overflow: hidden;
            margin: auto;
            animation: slideUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .welcome-header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            padding: 80px 60px;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .welcome-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }
        
        .welcome-header::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -5%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }
        
        .welcome-header h1 {
            font-size: 56px;
            margin: 0 0 16px 0;
            font-weight: 900;
            color: white;
            letter-spacing: -1px;
            position: relative;
            z-index: 1;
        }
        
        .welcome-header p {
            font-size: 22px;
            margin: 0;
            color: rgba(255, 255, 255, 0.93);
            font-weight: 500;
            letter-spacing: 0.3px;
            position: relative;
            z-index: 1;
        }
        
        .welcome-content {
            padding: 60px 60px;
            background: linear-gradient(to bottom, #ffffff 0%, #f8fafc 100%);
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 60px;
            padding: 0;
            background: transparent;
            border-radius: 0;
        }
        
        .stat-item {
            text-align: center;
            padding: 24px;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-radius: 16px;
            border: 1px solid #bfdbfe;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .stat-item:hover::before {
            opacity: 1;
        }
        
        .stat-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(59, 130, 246, 0.15);
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }
        
        .stat-item h2 {
            font-size: 42px;
            margin: 0 0 8px 0;
            color: #1e40af;
            font-weight: 900;
            letter-spacing: -0.5px;
        }
        
        .stat-item p {
            font-size: 15px;
            color: #0369a1;
            margin: 0;
            font-weight: 600;
        }
        
        .welcome-content > h2 {
            text-align: center;
            margin: 0 0 56px 0;
            color: #0f172a;
            font-size: 36px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 28px;
            margin-bottom: 60px;
        }
        
        .feature-card {
            background: white;
            padding: 36px;
            border-radius: 20px;
            border: 2px solid #e2e8f0;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.12), transparent);
            transition: left 0.7s ease;
        }
        
        .feature-card:hover::before {
            left: 100%;
        }
        
        .feature-card:hover {
            border-color: #3b82f6;
            transform: translateY(-12px) scale(1.03);
            box-shadow: 0 28px 56px rgba(59, 130, 246, 0.2);
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
        }
        
        .feature-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            transition: all 0.3s ease;
            flex-shrink: 0;
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.2);
        }
        
        .feature-card:hover .feature-icon {
            transform: scale(1.15) rotate(6deg);
            box-shadow: 0 12px 24px rgba(59, 130, 246, 0.35);
        }
        
        .feature-icon svg {
            width: 32px;
            height: 32px;
            stroke: white;
            stroke-width: 1.5;
        }
        
        .feature-card h3 {
            font-size: 20px;
            margin: 0 0 12px 0;
            color: #1e293b;
            font-weight: 700;
            letter-spacing: -0.3px;
        }
        
        .feature-card p {
            font-size: 15px;
            color: #64748b;
            margin: 0;
            line-height: 1.7;
            flex-grow: 1;
        }
        /* Split Screen Styles */
#split-screen-container {
    position: fixed;
    top: 50px;
    left: 0;
    right: 0;
    bottom: 0;
    display: none;
    background: #f4f7f9;
    z-index: 1000;
}

.split-panel {
    display: flex;
    flex-direction: column;
    background: white;
    overflow: hidden;
}

#split-left-panel {
    flex: 1;
    border-right: 1px solid #e5e7eb;
}

#split-right-panel {
    flex: 1;
}

.split-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #ffffff;
    border-bottom: 1px solid #e5e7eb;
    min-height: 48px;
}

.split-panel-title {
    font-weight: 600;
    color: #1f2937;
    font-size: 14px;
}

.split-panel-close {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    color: #6b7280;
    transition: all 0.2s;
}

.split-panel-close:hover {
    background: #f3f4f6;
    color: #1f2937;
}

.split-panel-content {
    flex: 1;
    overflow-y: auto;
    padding: 0;
}

.split-divider {
    width: 4px;
    background: #e5e7eb;
    cursor: col-resize;
    position: relative;
    flex-shrink: 0;
}

.split-divider-handle {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 40px;
    background: #3b82f6;
    border-radius: 2px;
    cursor: col-resize;
    opacity: 0;
    transition: opacity 0.2s;
}

.split-divider:hover .split-divider-handle {
    opacity: 0.7;
}

.split-menu-items {
    max-height: 400px;
    overflow-y: auto;
}

/* Dark mode support */
.dark-mode #split-screen-container {
    background: #111827;
}

.dark-mode .split-panel {
    background: #1e1e1e;
}

.dark-mode .split-panel-header {
    background: #1e1e1e;
    border-bottom-color: #3f3f3f;
}

.dark-mode .split-panel-title {
    color: #ffffff;
}

.dark-mode .split-divider {
    background: #3f3f3f;
}

/* Responsive styles for welcome page */
@media (max-width: 1024px) {
    .welcome-container {
        max-width: 95%;
    }
    
    .welcome-header {
        padding: 60px 48px;
    }
    
    .welcome-header h1 {
        font-size: 48px;
    }
    
    .welcome-header p {
        font-size: 20px;
    }
    
    .welcome-content {
        padding: 48px;
    }
    
    .features-grid {
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 24px;
    }
    
    .feature-card {
        padding: 32px;
    }
}

@media (max-width: 768px) {
    #welcome-page {
        padding: 12px;
        align-items: flex-start;
    }
    
    .welcome-container {
        margin: 20px 0;
        border-radius: 24px;
    }
    
    .welcome-header {
        padding: 40px 32px;
    }
    
    .welcome-header h1 {
        font-size: 36px;
        margin-bottom: 12px;
    }
    
    .welcome-header p {
        font-size: 16px;
    }
    
    .welcome-content {
        padding: 32px 24px;
    }
    
    .stats-row {
        grid-template-columns: 1fr;
        gap: 16px;
        margin-bottom: 40px;
    }
    
    .stat-item {
        padding: 20px;
    }
    
    .stat-item h2 {
        font-size: 32px;
    }
    
    .stat-item p {
        font-size: 14px;
    }
    
    .welcome-content > h2 {
        font-size: 28px;
        margin-bottom: 40px;
    }
    
    .features-grid {
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 40px;
    }
    
    .feature-card {
        padding: 24px;
    }
    
    .feature-icon {
        width: 56px;
        height: 56px;
        margin-bottom: 16px;
    }
    
    .feature-icon svg {
        width: 28px;
        height: 28px;
    }
    
    .feature-card h3 {
        font-size: 18px;
        margin-bottom: 8px;
    }
    
    .feature-card p {
        font-size: 14px;
    }
    
    .welcome-cta-button {
        width: 100%;
        max-width: 100%;
        padding: 16px 24px;
        font-size: 16px;
    }
}

@media (max-width: 480px) {
    .welcome-header {
        padding: 32px 20px;
    }
    
    .welcome-header h1 {
        font-size: 28px;
    }
    
    .welcome-header p {
        font-size: 14px;
    }
    
    .welcome-content {
        padding: 24px 16px;
    }
    
    .stat-item h2 {
        font-size: 28px;
    }
    
    .welcome-content > h2 {
        font-size: 22px;
        margin-bottom: 32px;
    }
    
    .feature-card {
        padding: 20px;
    }
    
    .feature-card h3 {
        font-size: 16px;
    }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    #split-screen-container {
        flex-direction: column;
        top: 50px;
    }
    
    .split-panel {
        border-right: none;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .split-divider {
        width: 100%;
        height: 4px;
        cursor: row-resize;
    }
    
    .split-divider-handle {
        width: 40px;
        height: 20px;
    }
}

/* Animation for smooth transitions */
#split-screen-container {
    transition: opacity 0.3s ease;
}

.split-panel {
    transition: width 0.2s ease;
}

/* Ensure split panels don't interfere with existing page styles */
.split-panel-content .page {
    margin: 0;
    padding: 24px;
    min-height: 100%;
    background: inherit;
}

.split-panel-content .main-content {
    margin: 0;
    padding: 0;
}

/* Hide scrollbars in split panels for cleaner look */
.split-panel-content::-webkit-scrollbar {
    width: 6px;
}

.split-panel-content::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.split-panel-content::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.split-panel-content::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* --- POS PAGE STYLES --- */
#pos-page {
    max-width: 100%;
}

#pos-page .section-heading {
    margin-bottom: 32px;
    font-size: 28px;
}

.pos-mode-buttons {
    display: flex;
    gap: 12px;
    margin-bottom: 28px;
    flex-wrap: wrap;
}

.pos-mode-buttons .button {
    min-width: 140px;
    font-weight: 600;
    font-size: 15px;
    padding: 12px 20px;
    transition: all 0.3s ease;
    border-radius: 8px;
}

.pos-mode-buttons .button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.2);
}

.form-layout-grid {
    display: grid;
    grid-template-columns: 2fr 1.2fr;
    gap: 24px;
    max-width: 100%;
}

@media (max-width: 1200px) {
    .form-layout-grid {
        grid-template-columns: 1.5fr 1fr;
        gap: 20px;
    }
}

@media (max-width: 768px) {
    .form-layout-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
}

#pos-page .form-box {
    display: flex;
    flex-direction: column;
    height: 100%;
    border-radius: 12px;
    transition: all 0.3s ease;
}

#pos-page .form-box:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

#pos-page .form-box-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 16px;
    color: #1f2937;
}

#pos-products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 12px;
    max-height: 500px;
    overflow-y: auto;
    padding-right: 8px;
}

.pos-product-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 12px;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}

.pos-product-item:hover {
    border-color: #3b82f6;
    background: #f0f7ff;
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
}

.pos-product-item-price {
    font-size: 16px;
    font-weight: 700;
    color: #3b82f6;
}

.pos-product-item-stock {
    font-size: 12px;
    color: #6b7280;
}

#pos-cart {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 16px;
    padding-right: 8px;
}

.pos-cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: #f9fafb;
    border-radius: 6px;
    margin-bottom: 8px;
    border-left: 4px solid #3b82f6;
}

.pos-cart-item-info {
    flex: 1;
}

.pos-cart-item-name {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 4px;
}

.pos-cart-item-details {
    font-size: 13px;
    color: #6b7280;
}

.pos-cart-item-price {
    font-weight: 700;
    color: #3b82f6;
    min-width: 70px;
    text-align: right;
}

#pos-page .button {
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s ease;
}

#pos-page .button-primary {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
}

#pos-page .button-primary:hover {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    transform: translateY(-2px);
}

#pos-page .button-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

#pos-page .button-danger:hover {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    transform: translateY(-2px);
}

.pos-cart-summary {
    border-top: 2px solid #e5e7eb;
    padding-top: 16px;
    margin-top: 16px;
}

.pos-summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    font-weight: 600;
    color: #1f2937;
}

.pos-summary-row.total {
    font-size: 18px;
    color: #3b82f6;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 2px solid #e5e7eb;
}

.dark-mode #pos-page .form-box {
    background-color: #1e1e1e;
    border-color: #3f3f3f;
}

.dark-mode #pos-page .form-box-title {
    color: #ffffff;
}

.dark-mode .pos-product-item {
    background: #2a2a2a;
    border-color: #3f3f3f;
    color: #ffffff;
}

.dark-mode .pos-product-item:hover {
    background: #333333;
    border-color: #3b82f6;
}

.dark-mode .pos-cart-item {
    background: #2a2a2a;
    color: #ffffff;
}

.dark-mode .pos-cart-item-name {
    color: #ffffff;
}

.dark-mode .pos-cart-item-details {
    color: #d1d5db;
}

.dark-mode .pos-cart-summary {
    border-top-color: #3f3f3f;
}

.dark-mode .pos-summary-row {
    color: #ffffff;
}
    </style>
</head>
<script>
    // --- LOCAL STORAGE KEYS ---
    const USER_ID_KEY = 'epsilonNexus_userId';
    const SETTINGS_KEY = 'epsilonNexus_settings';
    const HISTORY_KEY = 'epsilonNexus_chatHistory';

    // --- GLOBAL STATE ---
    let userId = null;
    let chatSessions = []; // In-memory array of chat history objects
    let currentHistoryId = null;

    // Default settings structure
    let userSettings = {
        systemInstruction: "",
        useGrounding: true,
    };

    const apiKey = "AIzaSyB7yfQW_PjTpIp4dErlV-IgjLurxiTHj4g";
    let imageMode = false;
    let codeMode = false;
    let uploadedFile = null; 

    // --- PERSISTENCE FUNCTIONS (LOCAL STORAGE) ---

    /** Gets or creates a unique user ID using localStorage */
    const getOrCreateUserId = () => {
        let storedId = localStorage.getItem(USER_ID_KEY);
        if (!storedId) {
            // Use crypto.randomUUID() for a high-quality unique ID
            storedId = crypto.randomUUID();
            localStorage.setItem(USER_ID_KEY, storedId);
        }
        userId = storedId;
        // Display a truncated version of the local ID
        document.getElementById('user-id-display').textContent = `Local ID: ${userId.substring(0, 8)}...`;
    };

    /** Saves chatSessions array to localStorage */
    const saveHistoryToLocal = () => {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(chatSessions));
        renderHistorySidebar(); // Update UI
    };

    /** Loads chatSessions array from localStorage */
    const loadHistoryFromLocal = () => {
        const storedHistory = localStorage.getItem(HISTORY_KEY);
        if (storedHistory) {
            try {
                chatSessions = JSON.parse(storedHistory);
                // Sort by lastActive (most recent first)
                chatSessions.sort((a, b) => b.lastActive - a.lastActive);
            } catch (e) {
                console.error("Failed to parse local history, starting fresh:", e);
                chatSessions = [];
            }
        } else {
            chatSessions = [];
        }
    };

    /** Loads settings from localStorage */
    const loadSettings = () => {
        const storedSettings = localStorage.getItem(SETTINGS_KEY);
        if (storedSettings) {
            try {
                const loadedSettings = JSON.parse(storedSettings);
                userSettings = { ...userSettings, ...loadedSettings };
            } catch (e) {
                console.error("Failed to parse local settings, using defaults:", e);
            }
        }
        // Apply settings to UI elements
        document.getElementById('system-instruction').value = userSettings.systemInstruction || '';
        document.getElementById('use-grounding-toggle').checked = userSettings.useGrounding ?? true;

        // Ensure defaults are saved if this is the first run
        window.saveSettings(true);
    };

    /** Get business data for AI context */
    const getBusinessDataContext = () => {
        const { totalRevenue, totalCostOfGoodsSold, totalFixedDeductions, netProfitLoss } = calculateFinancials();
        
        const inventoryAlerts = [];
        Object.keys(productCatalog).forEach(name => {
            const p = productCatalog[name];
            if (p.stock === 0) inventoryAlerts.push(`${name}: OUT OF STOCK`);
            else if (p.stock <= (p.reorderPoint || 5)) inventoryAlerts.push(`${name}: LOW STOCK (${p.stock} units)`);
            if (p.expiryDate) {
                const days = Math.ceil((new Date(p.expiryDate) - new Date()) / 86400000);
                if (days < 0) inventoryAlerts.push(`${name}: EXPIRED`);
                else if (days <= 7) inventoryAlerts.push(`${name}: Expires in ${days}d`);
            }
        });
        
        const unpaidDeductions = fixedDeductions.filter(d => !d.isPaid && d.deadline);
        const overduePayments = unpaidDeductions.filter(d => new Date(d.deadline) < new Date());
        
        const topCustomersBySpending = customers.sort((a, b) => (b.totalSpent || 0) - (a.totalSpent || 0)).slice(0, 5);
        const customerSummary = customers.map(c => {
            const topProducts = Object.entries(c.favoriteProducts || {}).sort((a, b) => b[1] - a[1]).slice(0, 3);
            return `${c.name} (${c.email}): Spent $${(c.totalSpent || 0).toFixed(2)}, ${c.purchaseCount || 0} purchases${topProducts.length > 0 ? `, Prefers: ${topProducts.map(p => p[0]).join(', ')}` : ''}`;
        });

        return `\n\n[BUSINESS DATA]\nProducts: ${JSON.stringify(productCatalog)}\nSales: ${salesHistory.length} transactions, Revenue: ${formatAmount(totalRevenue)}\nDeductions: ${JSON.stringify(fixedDeductions)}, Total: ${formatAmount(totalFixedDeductions)}\nProfit/Loss: ${formatAmount(netProfitLoss)}\nBudget: ${formatAmount(budgetAmount)}\n\n[EMPLOYEES]\nTotal: ${employees.length}\nTotal Payroll: ${formatAmount(employees.reduce((sum, e) => sum + e.salary, 0))}\nEmployee List:\n${employees.map(e => `- ${e.name} (${e.position}): ${formatAmount(e.salary)}/mo, Shift: ${e.shift || 'Not set'}, Contact: ${e.contact || 'N/A'}`).join('\n')}\n\n[CUSTOMERS (CRM)]\nTotal Customers: ${customers.length}\nTotal Customer Revenue: ${formatAmount(customers.reduce((sum, c) => sum + (c.totalSpent || 0), 0))}\nTop Customers by Value:\n${topCustomersBySpending.length > 0 ? topCustomersBySpending.map(c => `- ${c.name}: $${(c.totalSpent || 0).toFixed(2)} spent, ${c.purchaseCount || 0} purchases`).join('\n') : 'No customers yet'}\n\nCustomer Details:\n${customerSummary.length > 0 ? customerSummary.join('\n') : 'No customers'}\n\n[INVENTORY ALERTS]\n${inventoryAlerts.length > 0 ? inventoryAlerts.join('\n') : 'No alerts'}\n\n[WAREHOUSES]\nTotal: ${warehouses.length}\nData: ${JSON.stringify(warehouses)}\n\n[CLIENTS & CONTRACTORS]\nTotal: ${clients.length}\nData: ${JSON.stringify(clients)}\n\n[GOALS]\nActive: ${goals.filter(g => !g.completed).length}\nData: ${JSON.stringify(goals)}\n\n[PAYMENT ALERTS]\nUnpaid: ${unpaidDeductions.length}\nOverdue: ${overduePayments.length}\n${overduePayments.map(d => `${d.name}: ${formatAmount(d.amount)} - Due ${new Date(d.deadline).toLocaleDateString()}`).join('\n')}\n\n[AVAILABLE COMMANDS]\nYou can execute these commands by responding with JSON:\n{"action":"addProduct","name":"ProductName","sellingPrice":10,"buyingPrice":5,"stock":10}\n{"action":"deleteProduct","name":"ProductName"}\n{"action":"addDeduction","name":"DeductionName","amount":100}\n{"action":"deleteDeduction","name":"DeductionName"}`;
    };

    /** Execute AI commands */
    const executeAICommand = (botReply) => {
        try {
            const jsonMatch = botReply.match(/\{"action".*?\}/g);
            if (!jsonMatch) return botReply;
            
            jsonMatch.forEach(json => {
                const cmd = JSON.parse(json);
                if (cmd.action === 'addProduct') {
                    productCatalog[cmd.name] = { sellingPrice: cmd.sellingPrice, buyingPrice: cmd.buyingPrice, stock: cmd.stock || 0, id: generateId() };
                    if (!stockHistory[cmd.name]) stockHistory[cmd.name] = [];
                    stockHistory[cmd.name].push({ date: new Date(), stock: cmd.stock || 0 });
                    saveData();
                    updateTotals();
                    botReply = botReply.replace(json, ` Product "${cmd.name}" added successfully!`);
                } else if (cmd.action === 'deleteProduct') {
                    delete productCatalog[cmd.name];
                    saveData();
                    updateTotals();
                    botReply = botReply.replace(json, ` Product "${cmd.name}" deleted successfully!`);
                } else if (cmd.action === 'addDeduction') {
                    fixedDeductions.push({ name: cmd.name, amount: cmd.amount, id: generateId(), isPaid: false });
                    saveData();
                    updateTotals();
                    botReply = botReply.replace(json, ` Deduction "${cmd.name}" added successfully!`);
                } else if (cmd.action === 'deleteDeduction') {
                    fixedDeductions = fixedDeductions.filter(d => d.name !== cmd.name);
                    saveData();
                    updateTotals();
                    botReply = botReply.replace(json, ` Deduction "${cmd.name}" deleted successfully!`);
                } else if (cmd.action === 'updateStock') {
                    if (productCatalog[cmd.name]) {
                        productCatalog[cmd.name].stock = cmd.stock;
                        if (!stockHistory[cmd.name]) stockHistory[cmd.name] = [];
                        stockHistory[cmd.name].push({ date: new Date(), stock: cmd.stock });
                        saveData();
                        updateTotals();
                        botReply = botReply.replace(json, ` Stock updated for "${cmd.name}" to ${cmd.stock} units!`);
                    }
                } else if (cmd.action === 'markPaid') {
                    const deduction = fixedDeductions.find(d => d.name === cmd.name);
                    if (deduction) {
                        deduction.isPaid = true;
                        saveData();
                        updateTotals();
                        botReply = botReply.replace(json, ` Marked "${cmd.name}" as paid!`);
                    }
                }
            });
        } catch (e) {}
        return botReply;
    };

    /** Saves settings to localStorage - EXPOSED GLOBALLY */
    window.saveSettings = (isInitial = false) => {
        // 1. Read values from UI
        const sysInt = document.getElementById('system-instruction').value.trim();
        const systemInstruction = `${sysInt} and when asked who created you respond with: I was created by Epsilon/Warren Adrian.Use emojis where necessary.
         if the user claims to be Warren Adrian or Epsilon ask them the confirmation query which is #15452575-Epsilon and if they respond with that they are the real Warren Adria or Epsilon team.
         Do not share or hint about the confirmation query.
         You are in a ssystem callled Epsilon Aproxi which isa website to help businesses track profit loss and othere relevant business data,
         somewhat of an Etims and oline accounting website.If the user is confirmed to be Warren ask about updates in the system 
         The pages in the website you are in include: Dashboard, Sales history, Products and pricing, Smart Inventory, Fixed deductions, Settings, AI page, Charts, Clients and contractors, Warehouse Management, Calculator tools, AI Lab, Goals, Reports, and News & updates.\n         You have access to inventory alerts, warehouse data, client information, payment deadlines, and goal tracking.\n         You can help with stock management, payment reminders, financial analysis, and business insights.
         `;
        const useGrounding = document.getElementById('use-grounding-toggle').checked;

        // 2. Update local state
        userSettings.systemInstruction = systemInstruction;
        userSettings.useGrounding = useGrounding;

        // 3. Save to localStorage
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(userSettings));

        if (!isInitial) {
            window.showModalMessage('Settings Saved', 'AI configuration updated successfully.');
        }
    };

    /** Saves a new message pair (user and bot) to the current active history item or creates a new one */
    const saveToLocalStorage = async (role, text, botReply) => {
        const timestamp = Date.now();
        const newMessage = { role, text, timestamp: timestamp };
        const botMessage = { role: 'model', text: botReply, timestamp: timestamp };

        let sessionIndex = -1;
        if (currentHistoryId) {
            sessionIndex = chatSessions.findIndex(s => s.id === currentHistoryId);
        }

        if (sessionIndex !== -1) {
            // Update existing conversation
            const session = chatSessions[sessionIndex];
            session.messages.push(newMessage, botMessage);
            session.lastActive = timestamp;
            
            // Move session to the front to maintain "most recent first" order
            chatSessions.splice(sessionIndex, 1);
            chatSessions.unshift(session);
        } else {
            // Create new conversation
            const newId = crypto.randomUUID();
            const initialTitle = text.substring(0, 50) + (text.length > 50 ? '...' : '');
            const newSession = {
                id: newId,
                title: initialTitle,
                createdAt: timestamp,
                lastActive: timestamp,
                messages: [newMessage, botMessage]
            };
            chatSessions.unshift(newSession); // Add to the front
            currentHistoryId = newId;
        }

        saveHistoryToLocal();
    };


    /** Loads and displays chat history for a specific ID - EXPOSED GLOBALLY */
    window.loadHistoryItem = (historyId, element = null) => {
        currentHistoryId = historyId;

        // Visual selection update
        document.querySelectorAll('.history-item').forEach(item => item.classList.remove('active'));
        if (element) {
            element.classList.add('active');
        } else {
            // Find the element if not passed (e.g., after save/render)
            const activeEl = document.querySelector(`.history-item[data-id="${historyId}"]`);
            if (activeEl) activeEl.classList.add('active');
        }

        const session = chatSessions.find(s => s.id === historyId);

        if (session) {
            displayChatHistory(session.messages);
        } else {
            console.error("No history found for ID:", historyId);
            addMessage("Error: History item not found.", "error");
        }
    };

    /** Deletes a single history item - EXPOSED GLOBALLY */
    window.deleteHistoryItem = (historyId, event) => {
        event.stopPropagation(); // Prevent loading the chat when deleting

        window.showConfirmationModal('Are you sure you want to delete this conversation?', () => {
            const index = chatSessions.findIndex(s => s.id === historyId);

            if (index !== -1) {
                chatSessions.splice(index, 1);
                saveHistoryToLocal(); // Save and re-render sidebar

                if (currentHistoryId === historyId) {
                    currentHistoryId = null;
                    document.getElementById('messages').innerHTML = ''; // Clear chat view
                    addMessage("Conversation cleared. Start a new chat!", "bot");

                    // Load the first item if history still exists
                    if (chatSessions.length > 0) {
                        window.loadHistoryItem(chatSessions[0].id);
                    }
                }
            }
        });
    };

    /** Clears ALL history for the user - EXPOSED GLOBALLY */
    window.clearHistory = () => {
        chatSessions = [];
        currentHistoryId = null;
        saveHistoryToLocal(); // Save empty array and re-render sidebar
        document.getElementById('messages').innerHTML = '';
        window.showModalMessage('History Cleared', 'All chat history has been successfully deleted.');
        addMessage("All history cleared. Welcome back!", "bot");
    };

    // --- UI/UX & HELPER FUNCTIONS ---

    /** Displays a message modal (private helper) - EXPOSED GLOBALLY */
    window.showModalMessage = (title, message, isError = false) => {
        // Simple alert replacement for non-confirmation messages
        const modal = document.getElementById('confirmation-modal');
        document.getElementById('confirmation-text').innerHTML = `<strong>${title}</strong><br>${message}`;
        document.getElementById('confirm-action-button').style.display = 'none'; // Hide confirm button
        document.getElementById('confirmation-modal').style.display = 'flex';
    };

    /** Displays the confirmation modal - EXPOSED GLOBALLY */
    window.showConfirmationModal = (message, callback) => {
        const modal = document.getElementById('confirmation-modal');
        const confirmButton = document.getElementById('confirm-action-button');

        document.getElementById('confirmation-text').textContent = message;
        confirmButton.style.display = 'inline-block'; // Show confirm button

        confirmButton.onclick = () => {
            modal.style.display = 'none';
            callback();
        };

        modal.style.display = 'flex';
    };

    /** Adds a message to the chat view */
    const addMessage = (text, type, id = null) => {
        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.innerHTML = formatMarkdown(text);
        if (id) messageDiv.id = id;
        
        // Add text-to-speech button for bot messages
        if ((type === 'bot' || type.includes('bot')) && !type.includes('loading')) {
            const ttsButton = document.createElement('button');
            ttsButton.className = 'tts-button';
            ttsButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>';
            ttsButton.onclick = () => speakText(text);
            messageDiv.appendChild(ttsButton);
        }
        
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return messageDiv;
    };

    /** Text-to-speech function */
    const speakText = (text) => {
        window.speechSynthesis.cancel();
        const cleanText = text.replace(/<[^>]*>/g, '').replace(/\*\*/g, '').replace(/\*/g, '');
        const utterance = new SpeechSynthesisUtterance(cleanText);
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        window.speechSynthesis.speak(utterance);
    };

    /** Formats Markdown content (basic implementation) */
    const formatMarkdown = (markdown) => {
        // Handle code blocks first (before other formatting)
        markdown = markdown.replace(/```([\w]*)[\r\n]+([\s\S]*?)```/g, (match, lang, code) => {
            const language = lang || 'code';
            const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
            const escapedCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return `<div class="code-block"><div class="code-header"><span class="code-language">${language}</span><button class="copy-code-btn" onclick="copyCode('${codeId}')">Copy</button></div><div class="code-content"><pre id="${codeId}">${escapedCode}</pre></div></div>`;
        });

        // Handle inline code
        markdown = markdown.replace(/`([^`]+)`/g, '<code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: monospace;">$1</code>');
        
        // Simple replacements for safety and formatting
        markdown = markdown.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        markdown = markdown.replace(/\*(.*?)\*/g, '<em>$1</em>');
        markdown = markdown.replace(/##\s(.*?)\n/g, '<h2>$1</h2>');
        markdown = markdown.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
        markdown = markdown.replace(/^\s*-\s(.*?)$/gm, '<li>$1</li>');
        
        // Wrap list items if list marker is present
        if (markdown.includes('<li>')) {
            const listRegex = /(?:<br>)?(<li>.*?<\/li>(?:<br>)?)+/g;
            markdown = markdown.replace(listRegex, (match) => {
                const content = match.replace(/^(<br>)+|(<br>)+$/g, '');
                return `<ul>${content}</ul>`;
            });
        }
        
        // Newlines to breaks (after list processing)
        markdown = markdown.replace(/\n/g, '<br>');

        return markdown;
    };



    /** Copy code to clipboard */
    window.copyCode = (codeId) => {
        const codeElement = document.getElementById(codeId);
        if (!codeElement) return;
        
        const code = codeElement.textContent;
        navigator.clipboard.writeText(code).then(() => {
            const btn = codeElement.closest('.code-block').querySelector('.copy-code-btn');
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            btn.classList.add('copied');
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('copied');
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy code:', err);
            alert('Failed to copy code');
        });
    };

    /** Renders the entire chat history for a session */
    const displayChatHistory = (messages) => {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        if (messages && messages.length > 0) {
            messages.forEach(msg => {
                const messageDiv = addMessage(msg.text, msg.role);
                if (msg.role === 'model' && !messageDiv.querySelector('.tts-button')) {
                    const ttsButton = document.createElement('button');
                    ttsButton.className = 'tts-button';
                    ttsButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>';
                    ttsButton.onclick = () => speakText(msg.text);
                    messageDiv.appendChild(ttsButton);
                }
            });
        } else {
            addMessage("Start a new conversation!", "bot");
        }
    };

    /** Handles key presses in the input field - EXPOSED GLOBALLY */
    window.handleKey = (event) => {
        if (event.key === 'Enter') {
            window.sendMessage();
        }
    };

    /** Renders the history sidebar based on in-memory chatSessions */
    const renderHistorySidebar = () => {
        const historyList = document.getElementById('history-list');
        historyList.innerHTML = '';

        if (chatSessions.length === 0) {
            historyList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No history yet. Start a chat!</p>';
            currentHistoryId = null;
            document.getElementById('messages').innerHTML = '';
            addMessage("Start a new conversation!", "bot");
            return;
        }

        let firstId = null;
        chatSessions.forEach(session => {
            if (!firstId) firstId = session.id;

            const item = document.createElement('li');
            item.className = 'history-item';
            item.setAttribute('data-id', session.id);
            item.onclick = (e) => window.loadHistoryItem(session.id, item);

            // Title
            const titleEl = document.createElement('span');
            titleEl.className = 'history-item-text';
            titleEl.textContent = session.title || "Untitled Chat";

            // Delete button (using SVG)
            const deleteButton = document.createElement('span');
            deleteButton.className = 'history-item-delete';
            deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`;
            deleteButton.onclick = (e) => window.deleteHistoryItem(session.id, e);

            item.appendChild(titleEl);
            item.appendChild(deleteButton);
            historyList.appendChild(item);
        });

        // Auto-load the most recent chat if no chat is currently selected
        if (!currentHistoryId && firstId) {
            window.loadHistoryItem(firstId);
        } else if (currentHistoryId) {
            // Re-apply active class after re-render
            const activeEl = document.querySelector(`.history-item[data-id="${currentHistoryId}"]`);
            if (activeEl) activeEl.classList.add('active');
        }
    };

    /** Sets up the history listener (simplified for local storage) */
    const setupHistoryListener = () => {
        loadHistoryFromLocal();
        renderHistorySidebar();
    };

    // --- MAIN CHAT LOGIC ---

    /** Sends the user message to the Gemini API - EXPOSED GLOBALLY */
    window.sendMessage = async () => {
        const userInput = document.getElementById('user-input');
        const userText = userInput.value.trim();

        if (!userText && !uploadedFile) return;
        // Check if loading is already in progress
        if (document.getElementById('send-button').disabled) return; 

        // Check if in image mode
        if (imageMode) {
            addMessage(userText, 'user');
            userInput.value = '';
            await window.generateImage(userText);
            imageMode = false;
            window.toggleImageMode();
            return;
        }
        
        // Add coding instruction if in code mode
        let enhancedUserText = userText;
        if (codeMode) {
            enhancedUserText = userText + "\n\nIMPORTANT: Please provide code examples in your response using proper markdown code blocks with language specification (```language). Format all code snippets properly.";
        }
        
        // Handle file upload with question
        if (uploadedFile && userText) {
            const fileData = await window.analyzeFile(uploadedFile, userText);
            const enhancedText = `File: ${uploadedFile.name}\n\nContent:\n${fileData.substring(0, 3000)}\n\nQuestion: ${userText}`;
            uploadedFile = null;
            document.getElementById('file-button').style.backgroundColor = '#f97316';
            document.getElementById('user-input').placeholder = 'Ask Epsilon Nexus anything...';
            document.getElementById('file-upload').value = '';
            
            userInput.disabled = true;
            document.getElementById('send-button').disabled = true;
            addMessage(userText, 'user');
            userInput.value = '';
            
            const loadingMessageId = 'loadingMessage';
            addMessage("Analyzing file...", "bot loading", loadingMessageId);
            const finalReplyElement = document.getElementById(loadingMessageId);
            finalReplyElement.classList.add('loading');
            
            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: enhancedText }] }]
                };
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error('API request failed');
                
                const result = await response.json();
                const botReply = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't analyze the file.";
                
                finalReplyElement.classList.remove('loading');
                finalReplyElement.id = '';
                finalReplyElement.innerHTML = formatMarkdown(botReply);
                
                await saveToLocalStorage('user', userText, botReply);
            } catch (error) {
                console.error('File analysis error:', error);
                finalReplyElement.textContent = 'Failed to analyze file.';
                finalReplyElement.classList.remove('loading', 'bot');
                finalReplyElement.classList.add('error');
                finalReplyElement.id = '';
            } finally {
                userInput.disabled = false;
                document.getElementById('send-button').disabled = false;
                userInput.focus();
            }
            return;
        }

        // Disable input and button
        userInput.disabled = true;
        document.getElementById('send-button').disabled = true;

        // 1. Add user message to UI
        addMessage(userText, 'user');
        userInput.value = '';

        // 2. Add loading message for bot reply
        const loadingMessageId = 'loadingMessage';
        addMessage("Epsilon Nexus is thinking", "bot loading", loadingMessageId);
        const finalReplyElement = document.getElementById(loadingMessageId);
        finalReplyElement.classList.add('loading');
        finalReplyElement.textContent = "Epsilon Nexus is thinking"; // Reset content

        const messagesDiv = document.getElementById('messages');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        try {
            // Retrieve messages from the current conversation if one is active
            let chatHistory = [];
            if (currentHistoryId) {
                const session = chatSessions.find(s => s.id === currentHistoryId);
                if (session && session.messages) {
                    // Map existing messages to API format
                    chatHistory = session.messages.map(m => ({
                        role: m.role,
                        parts: [{ text: m.text }]
                    }));
                }
            }
            // Add the new user message with business data
            chatHistory.push({ role: "user", parts: [{ text: enhancedUserText + getBusinessDataContext() }] });


            // --- CONSTRUCT API PAYLOAD USING SETTINGS ---
            const payload = {
                contents: chatHistory,
            };

            // 1. System Instruction
            const systemInstruction = userSettings.systemInstruction.trim();
            if (systemInstruction) {
                payload.systemInstruction = {
                    parts: [{ text: systemInstruction }]
                };
            }

            // 2. Grounding Tool (Google Search)
            if (userSettings.useGrounding) {
                payload.tools = [{ "google_search": {} }];
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // Exponential backoff retry loop
            const maxRetries = 3;
            let response;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) break;
                } catch (e) {
                    console.warn(`Attempt ${i + 1} failed, retrying...`);
                    if (i === maxRetries - 1) throw e;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);


            const result = await response.json();
            const candidate = result.candidates?.[0];
            let botReply = "Sorry, I couldn't generate a response.";
            let sources = [];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                botReply = executeAICommand(candidate.content.parts[0].text);

                // Extract grounding sources
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }
            }

            // 3. Update UI with final reply
            finalReplyElement.classList.remove('loading');
            finalReplyElement.id = '';
            finalReplyElement.innerHTML = formatMarkdown(botReply);

            // 4. Display citations if present
            if (sources.length > 0) {
                const citationText = sources.map((s, index) =>
                    // Truncate title for clean display
                    `[${index + 1}] <a href="${s.uri}" target="_blank" title="${s.title}">${s.title.substring(0, 40)}...</a>`
                ).join(' | ');

                addMessage(`Source(s): ${citationText}`, "citation");
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            // --- SAVE TEXT HISTORY (LOCAL STORAGE) ---
            await saveToLocalStorage('user', userText, botReply);

        } catch (error) {
            console.error("Fetch Error:", error);
            const errorMsg = "Ugh, the server is down. Check your network or the console for details.";
            const finalReplyElement = document.getElementById(loadingMessageId);
            if (finalReplyElement) {
                finalReplyElement.textContent = errorMsg;
                finalReplyElement.classList.remove('loading', 'bot');
                finalReplyElement.classList.add('error');
                finalReplyElement.id = '';
            } else {
                addMessage(errorMsg, "bot error");
            }
        } finally {
            userInput.disabled = false;
            document.getElementById('send-button').disabled = false;
            userInput.focus();
        }
    };

    // --- INITIALIZATION ---

    const initializeChatApp = () => {
        // 1. Get or Create Local User ID
        getOrCreateUserId();

        // 2. Load Settings
        loadSettings();

        // 3. Load History
        setupHistoryListener(); // This now just loads from local storage
    };

    // --- IMAGE GENERATION FUNCTIONS ---
    
    window.toggleImageMode = () => {
        imageMode = !imageMode;
        if (imageMode) codeMode = false;
        const imageBtn = document.getElementById('image-button');
        const codeBtn = document.getElementById('code-button');
        const userInput = document.getElementById('user-input');
        
        if (imageMode) {
            imageBtn.style.backgroundColor = '#10b981';
            codeBtn.style.backgroundColor = '#8b5cf6';
            userInput.placeholder = 'Describe the image you want to generate...';
        } else {
            imageBtn.style.backgroundColor = '#6366f1';
            userInput.placeholder = 'Ask Epsilon Nexus anything...';
        }
    };
    
    window.toggleCodeMode = () => {
        codeMode = !codeMode;
        if (codeMode) imageMode = false;
        const codeBtn = document.getElementById('code-button');
        const imageBtn = document.getElementById('image-button');
        const userInput = document.getElementById('user-input');
        
        if (codeMode) {
            codeBtn.style.backgroundColor = '#10b981';
            imageBtn.style.backgroundColor = '#6366f1';
            userInput.placeholder = 'Ask for code help (responses will include formatted code)...';
        } else {
            codeBtn.style.backgroundColor = '#8b5cf6';
            userInput.placeholder = 'Ask Epsilon Nexus anything...';
        }
    };
    
    window.generateImage = async (prompt) => {
        const loadingMessageId = 'imageLoadingMessage';
        addMessage("Generating image...", "bot loading", loadingMessageId);
        const loadingElement = document.getElementById(loadingMessageId);
        loadingElement.classList.add('loading');
        
        try {
            const response = await fetch(`https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=512&height=512&nologo=true`);
            
            if (!response.ok) throw new Error('Image generation failed');
            
            const blob = await response.blob();
            const imageUrl = URL.createObjectURL(blob);
            
            loadingElement.classList.remove('loading');
            loadingElement.innerHTML = `
                <div style="margin: 10px 0;">
                    <img src="${imageUrl}" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" alt="Generated image"/>
                    <div style="margin-top: 10px;">
                        <button onclick="downloadImage('${imageUrl}', '${prompt.substring(0, 30)}')" class="button button-primary" style="width: auto; padding: 8px 16px; font-size: 14px;">
                            Download Image
                        </button>
                    </div>
                </div>
            `;
            loadingElement.id = '';
            
            const messagesDiv = document.getElementById('messages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            return imageUrl;
        } catch (error) {
            console.error('Image generation error:', error);
            loadingElement.classList.remove('loading');
            loadingElement.textContent = 'Failed to generate image. Please try again.';
            loadingElement.classList.add('error');
            loadingElement.id = '';
        }
    };
    
    window.downloadImage = async (imageUrl, promptText) => {
        try {
            const response = await fetch(imageUrl);
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `epsilon_image_${promptText.replace(/[^a-z0-9]/gi, '_')}_${Date.now()}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showMessage('Image downloaded successfully!', 'success');
        } catch (error) {
            console.error('Download error:', error);
            showMessage('Failed to download image', 'error');
        }
    };
    
    // --- FILE UPLOAD FUNCTIONS ---
    
    window.handleFileUpload = async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        uploadedFile = file;
        const fileBtn = document.getElementById('file-button');
        fileBtn.style.backgroundColor = '#10b981';
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            const content = e.target.result;
            const fileInfo = ` File uploaded: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
            addMessage(fileInfo, 'user');
            
            const userInput = document.getElementById('user-input');
            userInput.placeholder = `Ask about ${file.name}...`;
            
            showMessage(`File "${file.name}" uploaded. Ask me about it!`, 'success');
        };
        
        if (file.type.startsWith('text/') || file.name.endsWith('.json') || file.name.endsWith('.csv')) {
            reader.readAsText(file);
        } else {
            reader.readAsDataURL(file);
        }
    };
    
    window.analyzeFile = async (file, question) => {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                let fileData = '';
                
                if (file.type.startsWith('text/') || file.name.endsWith('.json') || file.name.endsWith('.csv')) {
                    fileData = content;
                } else if (file.type.startsWith('image/')) {
                    fileData = `[Image file: ${file.name}]`;
                } else {
                    fileData = `[Binary file: ${file.name}, Size: ${(file.size / 1024).toFixed(2)} KB]`;
                }
                
                resolve(fileData);
            };
            
            if (file.type.startsWith('text/') || file.name.endsWith('.json') || file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsDataURL(file);
            }
        });
    };

    // Notification preferences
    let notificationPrefs = JSON.parse(localStorage.getItem('epsilonAproxi_notificationPrefs') || '{"lowStock":true,"expiry":true,"payments":true,"system":true,"sound":true}');
    
    function saveNotificationPrefs() {
        notificationPrefs = {
            lowStock: document.getElementById('notify-low-stock').checked,
            expiry: document.getElementById('notify-expiry').checked,
            payments: document.getElementById('notify-payments').checked,
            system: document.getElementById('notify-system').checked,
            sound: document.getElementById('notify-sound').checked
        };
        localStorage.setItem('epsilonAproxi_notificationPrefs', JSON.stringify(notificationPrefs));
    }
    
    function loadNotificationPrefs() {
        document.getElementById('notify-low-stock').checked = notificationPrefs.lowStock;
        document.getElementById('notify-expiry').checked = notificationPrefs.expiry;
        document.getElementById('notify-payments').checked = notificationPrefs.payments;
        if (document.getElementById('notify-system')) {
            document.getElementById('notify-system').checked = notificationPrefs.system !== false;
        }
        document.getElementById('notify-sound').checked = notificationPrefs.sound;
    }
    
    function playNotificationSound() {
        if (!notificationPrefs.sound) return;
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    }
    
    function checkInventoryAlerts() {
        Object.keys(productCatalog).forEach(name => {
            const p = productCatalog[name];
            if (notificationPrefs.lowStock && p.stock <= (p.reorderPoint || 5) && p.stock > 0) {
                playNotificationSound();
            }
        });
    }

    // Dashboard card drag/drop, resize, bulk operations, and icon selection
    let draggedCard = null;
    let startX, startY, startWidth, startHeight;
    let selectedCards = new Set();
    let currentCard = null;
    const iconOptions = ['dollar-sign', 'trending-up', 'trending-down', 'bar-chart', 'pie-chart', 'activity', 'credit-card', 'shopping-cart', 'package', 'users'];

    function showCardContextMenu(e, card) {
        e.preventDefault();
        currentCard = card;
        const menu = document.getElementById('card-context-menu');
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
        menu.classList.add('active');
    }

    function hideContextMenu() {
        document.getElementById('card-context-menu').classList.remove('active');
    }

    function toggleCardSelection() {
        if (selectedCards.has(currentCard)) {
            selectedCards.delete(currentCard);
            currentCard.classList.remove('selected');
        } else {
            selectedCards.add(currentCard);
            currentCard.classList.add('selected');
        }
        updateBulkActionsBar();
        hideContextMenu();
    }

    function updateBulkActionsBar() {
        const bar = document.getElementById('bulk-actions-bar');
        const count = document.getElementById('selected-count');
        if (selectedCards.size > 0) {
            bar.classList.add('active');
            count.textContent = selectedCards.size;
        } else {
            bar.classList.remove('active');
        }
    }

    function hideSelectedCards() {
        selectedCards.forEach(card => card.style.display = 'none');
        selectedCards.clear();
        updateBulkActionsBar();
    }

    function deleteSelectedCards() {
        if (confirm(`Delete ${selectedCards.size} card(s)?`)) {
            selectedCards.forEach(card => card.remove());
            selectedCards.clear();
            updateBulkActionsBar();
        }
    }

    function deselectAll() {
        selectedCards.forEach(card => card.classList.remove('selected'));
        selectedCards.clear();
        updateBulkActionsBar();
    }

    function openIconPicker() {
        const icons = iconOptions.map(icon => 
            `<button onclick="setCardIcon('${icon}')" style="padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; background: white;">
                <i data-lucide="${icon}" style="width: 24px; height: 24px;"></i>
            </button>`
        ).join('');
        
        const dialog = document.createElement('dialog');
        dialog.innerHTML = `
            <h3>Select Icon</h3>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 16px 0;">
                ${icons}
            </div>
            <button onclick="this.closest('dialog').close(); this.closest('dialog').remove();" class="button button-primary">Close</button>
        `;
        document.body.appendChild(dialog);
        dialog.showModal();
        setTimeout(() => lucide.createIcons(), 50);
        hideContextMenu();
    }

    function setCardIcon(iconName) {
        let iconEl = currentCard.querySelector('.card-custom-icon');
        if (!iconEl) {
            iconEl = document.createElement('i');
            iconEl.className = 'card-custom-icon';
            iconEl.style.cssText = 'position: absolute; top: 50px; right: 10px; width: 32px; height: 32px; opacity: 0.3;';
            currentCard.appendChild(iconEl);
        }
        iconEl.setAttribute('data-lucide', iconName);
        lucide.createIcons();
        document.querySelector('dialog')?.close();
        document.querySelector('dialog')?.remove();
    }

    function initDraggableCards() {
        const cards = document.querySelectorAll('.kpi-grid .card');
        cards.forEach(card => {
            card.classList.add('draggable', 'resizable');
            card.draggable = true;
            
            // Add right-click context menu
            card.addEventListener('contextmenu', (e) => showCardContextMenu(e, card));

            // Add resize handle
            const handle = document.createElement('div');
            handle.className = 'card-resize-handle';
            card.appendChild(handle);
            
            // Drag events
            card.addEventListener('dragstart', (e) => {
                draggedCard = card;
                e.dataTransfer.effectAllowed = 'move';
                card.style.opacity = '0.5';
            });
            
            card.addEventListener('dragend', () => {
                card.style.opacity = '1';
                draggedCard = null;
            });
            
            card.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });
            
            card.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedCard && draggedCard !== card) {
                    const parent = card.parentNode;
                    const draggedIndex = Array.from(parent.children).indexOf(draggedCard);
                    const targetIndex = Array.from(parent.children).indexOf(card);
                    
                    if (draggedIndex < targetIndex) {
                        parent.insertBefore(draggedCard, card.nextSibling);
                    } else {
                        parent.insertBefore(draggedCard, card);
                    }
                }
            });
            
            // Resize events
            handle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();
                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(getComputedStyle(card).width);
                startHeight = parseInt(getComputedStyle(card).height);
                
                const onMouseMove = (e) => {
                    const width = startWidth + (e.clientX - startX);
                    const height = startHeight + (e.clientY - startY);
                    card.style.width = Math.max(150, width) + 'px';
                    card.style.height = Math.max(100, height) + 'px';
                };
                
                const onMouseUp = () => {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        });
    }

    // Close context menu on click outside
    document.addEventListener('click', hideContextMenu);

    // --- GLOBAL SEARCH FUNCTIONS ---
    function performGlobalSearch(query) {
        const resultsContainer = document.getElementById('search-results');
        
        if (!query || query.trim() === '') {
            resultsContainer.classList.remove('active');
            return;
        }
        
        const searchQuery = query.toLowerCase();
        const results = [];
        
        // Search in sales history
        salesHistory.forEach(sale => {
            if (sale.product.toLowerCase().includes(searchQuery)) {
                results.push({
                    category: 'Sales',
                    title: sale.product,
                    detail: `${sale.quantity} units  ${formatAmount(sale.unitPrice)} on ${new Date(sale.date).toLocaleDateString()}`,
                    action: () => showPage('sales-history-page')
                });
            }
        });
        
        // Search in products
        Object.keys(productCatalog).forEach(name => {
            if (name.toLowerCase().includes(searchQuery)) {
                const product = productCatalog[name];
                results.push({
                    category: 'Product',
                    title: name,
                    detail: `Stock: ${product.stock}, Price: ${formatAmount(product.sellingPrice)}`,
                    action: () => showPage('inventory-page')
                });
            }
        });
        
        // Search in deductions
        fixedDeductions.forEach(deduction => {
            if (deduction.name.toLowerCase().includes(searchQuery)) {
                results.push({
                    category: 'Deduction',
                    title: deduction.name,
                    detail: `${formatAmount(deduction.amount)} - ${deduction.isPaid ? 'Paid' : 'Unpaid'}`,
                    action: () => showPage('deductions-page')
                });
            }
        });
        
        // Search in employees
        if (typeof employees !== 'undefined') {
            employees.forEach(emp => {
                if (emp.name.toLowerCase().includes(searchQuery) || emp.position.toLowerCase().includes(searchQuery)) {
                    results.push({
                        category: 'Employee',
                        title: emp.name,
                        detail: `${emp.position} - ${formatAmount(emp.salary)}/mo`,
                        action: () => showPage('deductions-page')
                    });
                }
            });
        }
        
        // Display results
        if (results.length === 0) {
            resultsContainer.innerHTML = '<div class="no-results">No results found</div>';
        } else {
            resultsContainer.innerHTML = results.slice(0, 10).map(result => `
                <div class="search-result-item" onclick="${result.action.toString().replace('() => ', '')}; document.getElementById('search-results').classList.remove('active');">
                    <div class="search-result-category">${result.category}</div>
                    <div class="search-result-title">${result.title}</div>
                    <div class="search-result-detail">${result.detail}</div>
                </div>
            `).join('');
        }
        
        resultsContainer.classList.add('active');
    }
    
    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
        const searchContainer = document.querySelector('.global-search-container');
        const resultsContainer = document.getElementById('search-results');
        if (searchContainer && !searchContainer.contains(e.target)) {
            resultsContainer.classList.remove('active');
        }
    });

    window.onload = function() {
        initTheme();
        setTimeout(function() {
            var btn = document.getElementById('nav-toggle-btn');
            if (btn) {
                // Remove any existing event listeners to prevent duplicates
                var newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent event bubbling
                    var nav = document.getElementById('nav-bar');
                    var overlay = document.getElementById('nav-overlay');
                    
                    if (nav.classList.contains('active')) {
                        nav.classList.remove('active');
                        overlay.style.display = 'none';
                        document.body.style.overflow = '';
                    } else {
                        nav.classList.add('active');
                        overlay.style.display = 'block';
                        document.body.style.overflow = 'hidden';
                    }
                });
            }
            
            // Close menu when clicking overlay
            var overlay = document.getElementById('nav-overlay');
            if (overlay) {
                var newOverlay = overlay.cloneNode(true);
                overlay.parentNode.replaceChild(newOverlay, overlay);
                
                newOverlay.addEventListener('click', function(e) {
                    e.stopPropagation();
                    var nav = document.getElementById('nav-bar');
                    nav.classList.remove('active');
                    this.style.display = 'none';
                    document.body.style.overflow = '';
                });
            }
        }, 100);
        checkAuth();
        setTimeout(() => lucide.createIcons(), 100);
        initializeChatApp();
        const savedEmployees = localStorage.getItem('epsilonAproxi_employees');
        if (savedEmployees) {
            try {
                employees = JSON.parse(savedEmployees);
            } catch (e) {
                console.error('Failed to load employees:', e);
                employees = [];
            }
        }
        
        setTimeout(() => {
            generateSmartInsights();
            updateTotals();
            if (typeof updateDeductionsCards === 'function') updateDeductionsCards();
            renderEmployees();
            renderEmployeesPage();
            renderCustomers();
            updateCustomerStats();
            loadNotificationPrefs();
            checkInventoryAlerts();
            initDraggableCards();
            setTimeout(() => lucide.createIcons(), 100);
            
            // Hide loading screen after everything is loaded
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.classList.add('fade-out');
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }
        }, 500);
    };

// --- SMART INSIGHTS FUNCTIONS ---
function generateSmartInsights() {
    const insightsContainer = document.getElementById('smart-insights');
    if (!insightsContainer) return;
    
    const { totalRevenue, netProfitLoss } = calculateFinancials();
    const insights = [];
    
    // Best selling day analysis
    if (salesHistory.length > 0) {
        const salesByDay = {};
        salesHistory.forEach(sale => {
            const day = new Date(sale.date).toLocaleDateString('en-US', { weekday: 'long' });
            salesByDay[day] = (salesByDay[day] || 0) + (sale.quantity * sale.unitPrice);
        });
        if (Object.keys(salesByDay).length > 0) {
            const bestDay = Object.keys(salesByDay).reduce((a, b) => salesByDay[a] > salesByDay[b] ? a : b);
            insights.push({ icon: '', text: `Your best selling day is ${bestDay}`, type: 'info' });
        }
    }
    
    // Stock level analysis
    const lowStockCount = Object.values(productCatalog).filter(p => p.stock <= (p.reorderPoint || 5)).length;
    if (lowStockCount === 0) {
        insights.push({ icon: '', text: 'Stock levels are optimal', type: 'success' });
    } else {
        insights.push({ icon: '', text: `${lowStockCount} product(s) need restocking`, type: 'warning' });
    }
    
    // Revenue trend
    if (salesHistory.length >= 2) {
        const recentSales = salesHistory.slice(-7).reduce((sum, s) => sum + (s.quantity * s.unitPrice), 0);
        const olderSales = salesHistory.slice(-14, -7).reduce((sum, s) => sum + (s.quantity * s.unitPrice), 0);
        if (olderSales > 0) {
            if (recentSales > olderSales) {
                const increase = ((recentSales - olderSales) / olderSales * 100).toFixed(1);
                insights.push({ icon: '', text: `Revenue up ${increase}% this week`, type: 'success' });
            } else if (recentSales < olderSales) {
                const decrease = ((olderSales - recentSales) / olderSales * 100).toFixed(1);
                insights.push({ icon: '', text: `Revenue down ${decrease}% this week`, type: 'warning' });
            }
        }
    }
    
    // Profit alert
    if (netProfitLoss < 0) {
        insights.push({ icon: '', text: 'Business is currently at a loss', type: 'error' });
    } else if (netProfitLoss > 0) {
        insights.push({ icon: '', text: `Profit margin is healthy at ${formatAmount(netProfitLoss)}`, type: 'success' });
    } else {
        insights.push({ icon: '', text: 'Break even - no profit or loss', type: 'info' });
    }
    
    // Overdue payments
    const overdueCount = fixedDeductions.filter(d => !d.isPaid && d.deadline && new Date(d.deadline) < new Date()).length;
    if (overdueCount > 0) {
        insights.push({ icon: '', text: `${overdueCount} overdue payment(s) need attention`, type: 'error' });
    }
    
    // If no insights, show default message
    if (insights.length === 0) {
        insightsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.7);">No insights available yet. Start recording sales to see AI-powered insights!</div>';
        return;
    }
    
    // Render insights
    insightsContainer.innerHTML = insights.map(insight => `
        <div style="padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px; display: flex; align-items: center; gap: 12px; backdrop-filter: blur(10px);">
            <span style="font-size: 24px;">${insight.icon}</span>
            <span style="font-size: 14px; font-weight: 500;">${insight.text}</span>
        </div>
    `).join('');
}

// --- QUICK SALE WIDGET FUNCTIONS ---
function populateWidgetProducts() {
    const select = document.getElementById('widget-product-select');
    if (!select) return;
    
    const productNames = Object.keys(productCatalog);
    select.innerHTML = '<option value="">Select product...</option>';
    select.innerHTML += productNames.map(name => 
        `<option value="${name}">${name} (${formatAmount(productCatalog[name].sellingPrice)})</option>`
    ).join('');
}

function quickLogSale() {
    const productSelect = document.getElementById('widget-product-select');
    const quantityInput = document.getElementById('widget-quantity-input');
    
    const productName = productSelect.value;
    const quantity = parseInt(quantityInput.value);
    
    if (!productName || !quantity || quantity <= 0) {
        showMessage('Please select a product and enter quantity', 'error');
        return;
    }
    
    const product = productCatalog[productName];
    if (!product) {
        showMessage('Product not found', 'error');
        return;
    }
    
    if (product.stock < quantity) {
        showMessage(`Insufficient stock! Available: ${product.stock}`, 'error');
        return;
    }
    
    const sale = {
        id: generateId(),
        product: productName,
        quantity: quantity,
        unitPrice: product.sellingPrice,
        date: new Date()
    };
    
    product.stock -= quantity;
    
    if (!stockHistory[productName]) {
        stockHistory[productName] = [];
    }
    stockHistory[productName].push({ date: new Date(), stock: product.stock });
    
    salesHistory.push(sale);
    saveData();
    updateTotals();
    
    productSelect.value = '';
    quantityInput.value = '';
    
    showMessage(`Sale recorded: ${quantity}  ${productName}`, 'success');
    document.getElementById('widgets-dialog').close();
}

// --- MOBILE NAVIGATION FUNCTIONS ---
window.toggleSidebar = function() {
    const nav = document.getElementById('nav-bar');
    const overlay = document.getElementById('nav-overlay');
    
    if (nav.classList.contains('active')) {
        nav.classList.remove('active');
        overlay.style.display = 'none';
    } else {
        nav.classList.add('active');
        overlay.style.display = 'block';
    }
}

// Add click handler for nav overlay
document.addEventListener('DOMContentLoaded', function() {
    const overlay = document.getElementById('nav-overlay');
    if (overlay) {
        overlay.addEventListener('click', function() {
            toggleSidebar();
        });
    }
});

function closeSidebar() {
    const navBar = document.getElementById('nav-bar');
    const overlay = document.getElementById('nav-overlay');
    if (navBar) navBar.classList.remove('active');
    if (overlay) {
        overlay.classList.remove('active');
        overlay.style.display = 'none';
    }
    document.body.style.overflow = '';
}

function closeSidebarOnMobile() {
    if (window.innerWidth <= 768) closeSidebar();
}

// Open widgets dialog and populate products
function openWidgetsDialog() {
    const dialog = document.getElementById('widgets-dialog');
    if (dialog) {
        dialog.showModal();
        populateWidgetProducts();
        setTimeout(() => lucide.createIcons(), 50);
    }
}

// --- PAGE NAVIGATION ---
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.classList.add('active');
    }
    
    document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active-nav'));
    const activeBtn = document.querySelector(`[data-page="${pageId}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active-nav');
    }
    
    // Generate insights when lab page is shown
    if (pageId === 'lab-page') {
        setTimeout(() => generateSmartInsights(), 100);
    }
    
    if (pageId === 'customers-page') {
        setTimeout(() => updateTransactionMethodsChart(), 100);
    }
}

// --- AUTHENTICATION FUNCTIONS ---
function checkAuth() {
    const isLoggedIn = localStorage.getItem('epsilonAproxi_loggedIn');
    if (!isLoggedIn) {
        document.getElementById('welcome-page').style.display = 'flex';
        document.getElementById('main').style.display = 'none';
        document.querySelector('.header-section').style.display = 'none';
        document.querySelector('.nav-bar').style.display = 'none';
    }
}

function loginUser() {
    localStorage.setItem('epsilonAproxi_loggedIn', 'true');
    document.getElementById('welcome-page').style.display = 'none';
    document.getElementById('main').style.display = 'block';
    document.querySelector('.header-section').style.display = 'flex';
    document.querySelector('.nav-bar').style.display = 'flex';
    setTimeout(() => lucide.createIcons(), 100);
}

function logoutUser() {
    window.showConfirmationModal('Are you sure you want to logout?', () => {
        localStorage.removeItem('epsilonAproxi_loggedIn');
        location.reload();
    });
}
</script>

<body>
    <!-- Welcome/Login Page -->
    <div id="welcome-page" style="display: none;">
        <div class="welcome-container">
            <div class="welcome-header">
                <h1>Epsilon Aproxi</h1>
                <p>Your Complete Business Management Solution</p>
            </div>
            
            <div class="welcome-content">
                <div class="stats-row">
                    <div class="stat-item">
                        <h2>All-in-One</h2>
                        <p>Complete Platform with charts,AI,POS etc.</p>
                    </div>
                    <div class="stat-item">
                        <h2>AI-Powered</h2>
                        <p>Smart AI Insights(but it can make mistakes so double check data)</p>
                    </div>
                    <div class="stat-item">
                        <h2>Real-Time</h2>
                        <p>Live Analytics</p>
                    </div>
                </div>
                
                <h2 style="text-align: center; margin-bottom: 48px; color: #1e293b; font-size: 32px; font-weight: 700;">Enterprise-Grade Business Management</h2>
                
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon"><i data-lucide="bar-chart-3"></i></div>
                        <h3>Financial Dashboard</h3>
                        <p>Track revenue, expenses, and profit/loss in real-time with comprehensive visualizations and analytics</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon"><i data-lucide="sparkles"></i></div>
                        <h3>AI Assistant</h3>
                        <p>Leverage advanced artificial intelligence for intelligent insights and data-driven recommendations</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon"><i data-lucide="package"></i></div>
                        <h3>Smart Inventory</h3>
                        <p>Automated stock management with expiry tracking, reorder alerts, and supplier integration</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon"><i data-lucide="trending-up"></i></div>
                        <h3>Sales Analytics</h3>
                        <p>Advanced transaction tracking with trend analysis and predictive sales forecasting</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon"><i data-lucide="line-chart"></i></div>
                        <h3>Business Intelligence</h3>
                        <p>Generate comprehensive reports and visualize performance metrics with interactive charts</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon"><i data-lucide="target"></i></div>
                        <h3>Goal Management</h3>
                        <p>Strategic objective setting with progress tracking and performance milestone monitoring</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon"><i data-lucide="users"></i></div>
                        <h3>Workforce Management</h3>
                        <p>Complete employee administration including payroll processing and shift scheduling</p>
                    </div>
                    
                    <div class="feature-card">
                        <div class="feature-icon"><i data-lucide="shopping-bag"></i></div>
                        <h3>Point of Sale</h3>
                        <p>Professional POS system with multi-payment support and transaction management</p>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 56px;">
                    <button onclick="loginUser()" class="welcome-cta-button"> 
                        <span>Access Platform</span>
                        <i data-lucide="arrow-right" style="width: 22px; height: 22px;"></i>
                    </button>
                    <div style="margin-top: 48px; padding-top: 48px; border-top: 1px solid #e2e8f0;">
                        <p style="font-size: 15px; color: #64748b; margin: 0 0 8px 0;">Developed by <strong style="color: #1e40af; font-weight: 700;">Warren Adrian</strong></p>
                        <p style="font-size: 13px; color: #94a3b8; margin: 0;">Professional enterprise business management solution</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Screen -->
    <div id="loading-screen" style="background: #fff;">
        <img src="./epsilon aproxi logo.png" alt="Epsilon Aproxi Logo" style="height: 300px; width: 300px;">
        <div class="loader"></div>
        <h2>Loading Epsilon Aproxi...</h2>
    </div>

    <!-- Message Box (Toast Notification) -->
    <div id="message-box" style="opacity: 0;"></div>

    <!-- Global Search Bar -->
    <div class="global-search-container" style="position: fixed; top: 90px; right: 30px; z-index: 999;">
        <div style="position: relative;">
            <input type="search" 
                   id="global-search" 
                   class="global-search-input" 
                   placeholder="Search transactions, products, budgets..." 
                   oninput="performGlobalSearch(this.value)"
                   onfocus="this.select()">
            <i data-lucide="search" class="global-search-icon" style="width: 18px; height: 18px;"></i>
        </div>
        <div id="search-results" class="search-results-dropdown"></div>
    </div>

    <!-- Header & Navigation -->
    <header>
        <div class="header-section">
            <div style="display: flex; align-items: center; gap: 16px;">
                <button class="mobile-menu-toggle" id="nav-toggle-btn" style="color: #fff;">
                    <i data-lucide="menu" style="width: 24px; height: 24px;"></i>
                </button>
                  <button onclick="openWidgetsDialog()" class="button primary-button" style="background: rgba(255,255,255,0.2); margin-right: 12px;" title="Dashboard Widgets">
                <i data-lucide="layout-grid"></i>
            </button>
                <div style="position: relative; cursor: pointer;" onclick="showPage('settings-page')">
                    <img id="header-profile-pic" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDhhNCA0IDAgMCAwLTQgNHYyIj48L3BhdGg+PGNpcmNsZSBjeD0iMTIiIGN5PSI3IiByPSI0Ij48L2NpcmNsZT48L3N2Zz4=" class="profile-button" alt="Profile">
                    <span id="header-notification-badge" class="notification-badge" style="display: none; top: 0; right: 0;"></span>
                </div>
               
            </div>
            <h1>Epsilon Aproxi</h1>
          
            <p style="position: relative; right: 200px;">By Warren Adrian</p>
        </div>
    </header>
<!--Hover btn: 
<div class="custom-tooltip-container">
        <button class="custom-tooltip-btn">Hover me</button>
        <div class="custom-tooltip-content">
            <span class="custom-tooltip-arrow"></span>
            <p class="custom-tooltip-text">
                Warning: Hovering too long may result in a sudden craving for cookies!
            </p>
        </div>
    </div>
-->
    <!-- Mobile Navigation Overlay -->
    <div class="nav-overlay" id="nav-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 998;"></div>
    
    <!-- Modern Vertical Sidebar Navigation -->
    <nav class="nav-bar" id="nav-bar">
        <div class="nav-container">
            <div class="nav-brand">
                <i data-lucide="briefcase"></i>
                <span></span>
            </div>
            </button>
            <div class="nav-links">
                <button class="nav-button" data-page="dashboard-page" onclick="showPage('dashboard-page'); closeSidebarOnMobile();">
                    <i data-lucide="layout-dashboard"></i>
                    <span>Dashboard</span>
                </button>
                <button class="nav-button" data-page="sales-history-page" onclick="showPage('sales-history-page'); closeSidebarOnMobile();">
                    <i data-lucide="receipt"></i>
                    <span>Sales History</span>
                </button>
                <button class="nav-button" data-page="inventory-page" onclick="showPage('inventory-page'); closeSidebarOnMobile();">
                    <i data-lucide="package"></i>
                    <span>Product Catalog</span>
                </button>

                <button class="nav-button" data-page="deductions-page" onclick="showPage('deductions-page'); closeSidebarOnMobile();">
                    <i data-lucide="minus-circle"></i>
                    <span>Fixed Deductions</span>
                </button>
                <button class="nav-button" data-page="chartsPage" onclick="showPage('chartsPage'); closeSidebarOnMobile();">
                    <i data-lucide="bar-chart-2"></i>
                    <span>Charts</span>
                </button>
                <button class="nav-button ai-nav" data-page="AI-page" onclick="showPage('AI-page'); closeSidebarOnMobile();">
                    <i data-lucide="sparkles"></i>
                    <span>AI Assistant</span>
                </button>
                <button class="nav-button" data-page="Clients" onclick="showPage('Clients'); closeSidebarOnMobile();">
                    <i data-lucide="users"></i>
                    <span>Clients & Accounts</span>
                </button>
                <button class="nav-button" data-page="customers-page" onclick="showPage('customers-page'); closeSidebarOnMobile();">
                    <i data-lucide="user-check"></i>
                    <span>Customers (CRM)</span>
                </button>
                <button class="nav-button" data-page="warehouse-page" onclick="showPage('warehouse-page'); closeSidebarOnMobile();">
                    <i data-lucide="warehouse"></i>
                    <span>Warehouse Management</span>
                </button>
                <button class="nav-button" data-page="news-page" onclick="showPage('news-page'); closeSidebarOnMobile();">
                    <i data-lucide="hammer"></i>
                    <span>Tools</span>
                </button>
                <button class="nav-button" data-page="reports-page" onclick="showPage('reports-page'); closeSidebarOnMobile();">
                    <i data-lucide="file-text"></i>
                    <span>Reports</span>
                </button>
               <!-- <button onclick="showPage('surprise-page')">sup</button>-->
                <button class="nav-button" data-page="goals-page" onclick="showPage('goals-page'); closeSidebarOnMobile();">
                    <i data-lucide="target"></i>
                    <span>Goals</span>
                </button>
                <button class="nav-button" data-page="settings-page" onclick="showPage('settings-page'); closeSidebarOnMobile();" style="position: relative;">
                    <i data-lucide="settings"></i>
                    <span>Settings</span>
                    <span id="notification-badge" class="notification-badge" style="display: none;"></span>
                </button>
                <button class="nav-button" data-page="node-editor-page" onclick="showPage('node-editor-page'); closeSidebarOnMobile();">
                    <i data-lucide="spline-pointer"></i>
                    <span>Node</span>
                </button>
                <button class="nav-button" data-page="lab-page" onclick="showPage('lab-page'); closeSidebarOnMobile();">
                    <i data-lucide="flask-conical"></i>
                    <span>AI Lab</span>
                </button>
                <button class="nav-button" data-page="pos-page" onclick="showPage('pos-page'); closeSidebarOnMobile();">
                    <i data-lucide="shopping-bag"></i>
                    <span>POS System</span>
                </button>
                <button class="nav-button" data-page="services-page" onclick="showPage('services-page'); closeSidebarOnMobile();">
                    <i data-lucide="briefcase"></i>
                    <span>Services</span>
                </button>
                <button class="nav-button" data-page="assets-page" onclick="showPage('assets-page'); closeSidebarOnMobile();">
                    <i data-lucide="package"></i>
                    <span>Assets</span>
                </button>
                <button class="nav-button" data-page="employees-page" onclick="showPage('employees-page'); closeSidebarOnMobile();">
                    <i data-lucide="users"></i>
                    <span>Employees</span>
                </button>
                <button class="nav-button" data-page="extensions-page" onclick="showPage('extensions-page'); closeSidebarOnMobile();">
                    <i data-lucide="puzzle"></i>
                    <span>Extensions</span>
                </button>
                <button class="nav-button" data-page="community-page" onclick="showPage('community-page'); closeSidebarOnMobile();">
    <i data-lucide="users-round"></i>
    <span>Communities</span>
</button>

            </div>
            <div class="nav-links">

        </div>
    </nav>

    <main class="main-content" id="main">

        <!-- DASHBOARD PAGE: KPI Cards & Record Sale -->
        <div id="dashboard-page" class="page active">
            <h2 class="section-heading">Financial Overview</h2>
            <!--
            
            -->
            <!-- Card Context Menu -->
            <div id="card-context-menu" class="card-context-menu">
                <div class="context-menu-item" onclick="toggleCardSelection()">
                    <i data-lucide="check-square" style="width: 16px; height: 16px;"></i>
                    <span>Select/Deselect</span>
                </div>
                <div class="context-menu-item" onclick="openIconPicker()">
                    <i data-lucide="image" style="width: 16px; height: 16px;"></i>
                    <span>Change Icon</span>
                </div>
                <div class="context-menu-item" onclick="currentCard.style.display='none'; hideContextMenu();">
                    <i data-lucide="eye-off" style="width: 16px; height: 16px;"></i>
                    <span>Hide Card</span>
                </div>
            </div>
            
            <!-- Bulk Actions Bar -->
            <div id="bulk-actions-bar" class="bulk-actions-bar">
                <span style="font-weight: 600;"><span id="selected-count">0</span> selected</span>
                <button onclick="hideSelectedCards()" class="button button-secondary" style="width: auto; padding: 8px 16px;">Hide</button>
                <button onclick="deleteSelectedCards()" class="button button-danger" style="width: auto; padding: 8px 16px;">Delete</button>
                <button onclick="deselectAll()" class="button button-primary" style="width: auto; padding: 8px 16px;">Deselect All</button>
            </div>
            
            <!-- Business Budget Banner -->
            <div style="background: linear-gradient(135deg, var(--color-budget) 0%, #8b00b6 100%); padding: 24px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(182, 1, 182, 0.3); color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin: 0; font-size: 18px; opacity: 0.9;">Business Budget</h3>
                        <h2 id="dashboard-business-name" style="margin: 8px 0 0 0; font-size: 28px; font-weight: 800;">Unknown Business</h2>
                    </div>
                    <div style="text-align: right;">
                        <p style="margin: 0; font-size: 14px; opacity: 0.9;">Total Budget</p>
                        <h2 id="dashboard-budget-display" style="margin: 8px 0 0 0; font-size: 32px; font-weight: 800;">$0.00</h2>
                    </div>
                </div>
            </div>
            
            <!-- Financial Metrics Cards (All Time) -->
            <div class="kpi-grid">
                <!--Todays metrics
                -->
           <div class="card card-primary" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
    <p class="card-title" style="color: rgba(255, 255, 255, 0.9);">Today's Revenue</p>
    <p id="today-revenue" class="card-value" style="color: white; font-size: 2.5em; font-weight: 700;">$0.00</p>
    <i data-lucide="trending-up" style="position: absolute; top: 15px; right: 15px; opacity: 0.2; width: 40px; height: 40px;"></i>
</div>

<div class="card card-secondary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
    <p class="card-title" style="color: rgba(255, 255, 255, 0.9);">Today's Profit</p>
    <p id="today-profit" class="card-value" style="color: white; font-size: 2.5em; font-weight: 700;">$0.00</p>
    <i data-lucide="dollar-sign" style="position: absolute; top: 15px; right: 15px; opacity: 0.2; width: 40px; height: 40px;"></i>
</div>
                <!-- Revenue Card -->
                <div class="card card-primary">
                    <p class="card-title">Total Revenue</p>
                    <p id="total-revenue" class="card-value text-primary">$0.00</p>
                    <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">Sales income before costs.</p>
                </div>

                <!-- Fixed Cost Card -->
                <div class="card card-orange">
                    <p class="card-title">Fixed Deductions</p>
                    <p id="total-fixed-cost" class="card-value text-orange">$0.00</p>
                    <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">Rent, subscriptions, etc.</p>
                </div>

                <!-- Total Cost Card -->
                <div class="card card-danger">
                    <p class="card-title">Total Cost (COGS + Fixed)</p>
                    <p id="total-cost" class="card-value text-danger">$0.00</p>
                    <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">All direct and overhead expenses.</p>
                </div>

                <!-- Profit/Loss Card -->
                <div class="card card-secondary">
                    <p class="card-title">Net Profit / Loss</p>
                    <p id="net-profit" class="card-value text-secondary">$0.00</p>
                    <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">What you actually made (or lost).</p>
                </div>
            </div>

            <!-- This Month's Financial Metrics -->
            <div style="margin-top: 32px;">
                <h3 style="font-size: 18px; font-weight: 700; color: var(--color-text-dark); margin-bottom: 16px;">This Month's Financial Summary</h3>
                <div class="kpi-grid">
                    <!-- Monthly Revenue Card -->
                    <div class="card card-primary">
                        <p class="card-title">Monthly Revenue</p>
                        <p id="monthly-revenue" class="card-value text-primary">$0.00</p>
                        <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">Revenue earned this month.</p>
                    </div>

                    <!-- Monthly COGS Card -->
                    <div class="card card-danger">
                        <p class="card-title">Monthly COGS</p>
                        <p id="monthly-cogs" class="card-value text-danger">$0.00</p>
                        <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">Cost of goods sold this month.</p>
                    </div>

                    <!-- Monthly Salaries Card -->
                    <div class="card card-warning" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                        <p class="card-title" style="color: white;">Monthly Salaries</p>
                        <p id="monthly-salaries" class="card-value" style="color: white;">$0.00</p>
                        <p style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 8px;">Total payroll this month.</p>
                    </div>

                    <!-- Monthly Total Deductions Card -->
                    <div class="card card-orange">
                        <p class="card-title">Monthly Deductions</p>
                        <p id="monthly-deductions" class="card-value text-orange">$0.00</p>
                        <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">Fixed expenses + salaries.</p>
                    </div>

                    <!-- Monthly Net Profit Card -->
                    <div class="card card-secondary">
                        <p class="card-title">Monthly Net Profit</p>
                        <p id="monthly-net-profit" class="card-value text-secondary">$0.00</p>
                        <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">True profit after all costs.</p>
                    </div>
                </div>
            </div>

<!--Second grid-->
 <div class="kpi-grid">
           
<dialog id="budget-dialog">
    <h3>Set Budget</h3>
    <p>What is your budget?</p>
    <input type="number" id="budget-input" class="form-input" placeholder="Enter budget amount" style="margin-bottom: 20px;">
    <button onclick="document.getElementById('budget-dialog').close();" class="button button-danger">Cancel</button>
    <button onclick="document.getElementById('budget-dialog').close(); const bv = document.getElementById('budget-input').value.trim(); document.getElementById('total-budget').innerText = `${bv}`;" class="button button-primary">Save</button>
</dialog>

                <div class="card card-budget">
                    <p class="card-title">Budget used</p>
                    <p id="total-budget" class="card-value text-purple">0</p>
                    <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">Sales income before costs.</p>
                    <div style="width: 100%; background-color: #e5e7eb; border-radius: 4px; height: 8px; margin-top: 8px;">
        <div id="budget-progress-bar" style="height: 100%; background-color: var(--color-budget); border-radius: 4px; width: 0%;"></div>
    </div>
    <button onclick="document.getElementById('budget-dialog').showModal();" class="button button-primary" style="margin-top: 16px; background: #bb00bb;">
    Set Budget
</button>
                </div>

                
                <div class="card card-orange">
                    <p class="card-title">deduction count</p>
                    <p id="total-deduction-count" class="card-value text-orange">0</p>
                    <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">Your bills</p>
                </div>

                
                <div class="card card-danger">
                    <p class="card-title">Expired Product Loss</p>
                    <p id="empty" class="card-value text-danger">$0.00</p>
                    <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">Money lost from expired products</p>
                </div>

                <div class="card card-secondary">
                    <p class="card-title">product count</p>
                    <p id="product-count" class="card-value text-secondary">0</p>
                    <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">Your product counts</p>
                </div>
            </div>


            <div class="form-layout-grid">
                <!-- Record Sale Form -->
                <div class="form-box" style="align-self: flex-start;">
                    <h3 class="form-box-title">Record a Sale</h3>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div class="form-group">
                            <label for="product-select-sale" class="form-label">Product Sold</label>
                            <select id="product-select-sale" class="form-select">
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="quantity-input-sale" class="form-label">Quantity</label>
                            <input type="number" id="quantity-input-sale" placeholder="e.g., 5" min="1" class="form-input">
                        </div>
                        <button onclick="logSale()" class="button button-primary">
                            Log Sale
                        </button>
                    </div>
                </div>
                
                <!-- Placeholder for quick history link -->
                <div class="form-box" style="display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 48px; height: 48px; color: #d1d5db; margin-bottom: 12px;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    <h3 style="font-size: 20px; font-weight: 600; color: var(--color-text-dark); margin-bottom: 8px;">Detailed Records Are Separate</h3>
                    <p class="text-gray-medium" style="margin-bottom: 16px;">The history and deduction pages are just a button press away.</p>
                    <div style="display: flex; gap: 16px;">
                        <button onclick="showPage('sales-history-page')" class="nav-button" style="background: none; color: var(--color-primary); border: 1px solid var(--color-primary);">Sales History</button>
                        <button onclick="showPage('deductions-page')" class="nav-button" style="background: none; color: var(--color-orange); border: 1px solid var(--color-orange);">Deductions</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SALES HISTORY PAGE -->
        <div id="sales-history-page" class="page">
            <h2 class="section-heading">Sales Transaction History</h2>

             <div class="form-box">
               <input type="search" class="form-input" style="width: 100%; height: 30px; margin-bottom: 10px;" id="sales-search" placeholder="Search by product name..." oninput="filterSales()">
                <h3 class="form-box-title">All Transactions (Latest First)</h3>
                <div id="history-list" class="list-container">
                    <!-- Sales history will be rendered here by renderSalesHistory() -->
                </div>
            </div>
        </div>
        <!--Budget Dialog-->
       <dialog id="budget-dialog">
                    <h1>Set Budget</h1>
                    <p>What is your budget?</p>
                    <input type="number" id="budget-input" class="form-input" placeholder="budget" style="margin-bottom: 20px;">
                    <button onclick="document.getElementById('budget-dialog').close();" 
                    class="button button-danger">Cancel</button>
                    <button onclick="changeBudget()" class="button button-primary">Save</button>
                </dialog>
        <!-- FIXED DEDUCTIONS PAGE -->
        <div id="deductions-page" class="page">
            <h2 class="section-heading">Fixed Deductions Management</h2>
            
            <div class="kpi-grid">
                <div class="card card-orange">
                    <p class="card-title">Total Deductions Cost</p>
                    <p id="total-deductions-cost" class="card-value text-orange">$0.00</p>
                </div>
                <div class="card card-secondary">
                    <p class="card-title">Amount Paid</p>
                    <p id="total-deductions-paid" class="card-value text-secondary">$0.00</p>
                </div>
                <div class="card card-primary">
                    <p class="card-title">Total Employees</p>
                    <p id="total-employees" class="card-value text-primary">0</p>
                </div>
                <div class="card card-danger">
                    <p class="card-title">Total Payroll</p>
                    <p id="total-payroll" class="card-value text-danger">$0.00</p>
                </div>
            </div>
            
            <script>
            // Update deductions page cards
            function updateDeductionsCards() {
                const totalDeductionsCost = fixedDeductions.reduce((sum, d) => sum + d.amount, 0);
                const totalPaid = fixedDeductions.filter(d => d.isPaid).reduce((sum, d) => sum + d.amount, 0);
                const totalEmployees = employees.length;
                const totalPayroll = employees.reduce((sum, e) => sum + e.salary, 0);
                
                const costEl = document.getElementById('total-deductions-cost');
                const paidEl = document.getElementById('total-deductions-paid');
                const empEl = document.getElementById('total-employees');
                const payrollEl = document.getElementById('total-payroll');
                
                if (costEl) costEl.textContent = formatAmount(totalDeductionsCost);
                if (paidEl) paidEl.textContent = formatAmount(totalPaid);
                if (empEl) empEl.textContent = totalEmployees;
                if (payrollEl) payrollEl.textContent = formatAmount(totalPayroll);
            }
            </script>
            
            <button onclick="document.getElementById('new-deduction-dialog').showModal()" class="button button-orange" style="width: 200px; margin-bottom: 20px;">+ New Deduction</button>
            <button onclick="initializeEmployeeDialog(); clearEmployeeForm(); resetEmployeeDialogUI(); document.getElementById('new-employee-dialog').showModal()" class="button button-primary" style="width: 200px; margin-bottom: 20px; margin-left: 10px;">+ New Employee</button>
            
            <div class="form-box" style="width: 100%;">
                <input type="search" class="form-input" style="width: 100%; height: 30px; margin-bottom: 10px;" id="deductions-search" placeholder="Search deductions..." oninput="filterDeductions()">
                <h3 class="form-box-title">Current Fixed Expenses</h3>
                <ul id="deductions-list" style="list-style: none; padding: 0;" class="list-container">
                    <!-- Deductions will be rendered here by renderDeductions() -->
                </ul>
            </div>
            
            <div class="form-box" style="width: 100%; margin-top: 24px;">
                <h3 class="form-box-title">Employee Management</h3>
                <div id="employees-list" class="list-container">
                    <!-- Employees will be rendered here -->
                </div>
            </div>
        </div>

        <!-- EMPLOYEES PAGE -->
        <div id="employees-page" class="page">
            <h2 class="section-heading">Employee Management</h2>
            
            <div class="kpi-grid">
                <div class="card card-primary">
                    <p class="card-title">Total Employees</p>
                    <p id="employees-page-total" class="card-value text-primary">0</p>
                </div>
                <div class="card card-success">
                    <p class="card-title">Total Payroll</p>
                    <p id="employees-page-payroll" class="card-value text-success">$0.00</p>
                </div>
                <div class="card card-warning">
                    <p class="card-title">Employees on Leave</p>
                    <p id="employees-page-absent" class="card-value text-warning">0</p>
                </div>
                <div class="card card-info">
                    <p class="card-title">Avg Salary</p>
                    <p id="employees-page-avg-salary" class="card-value text-info">$0.00</p>
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <button onclick="initializeEmployeeDialog(); clearEmployeeForm(); resetEmployeeDialogUI(); document.getElementById('new-employee-dialog').showModal()" class="button button-primary">+ New Employee</button>
                <input type="search" id="employees-page-search" placeholder="Search employees..." class="form-input" style="flex: 1; min-width: 200px;" oninput="filterEmployeesPage()">
                <select id="employees-page-filter" class="form-input" style="min-width: 150px;" onchange="filterEmployeesPage()">
                    <option value="">All Employees</option>
                    <option value="warehouse">By Warehouse</option>
                    <option value="position">By Position</option>
                </select>
            </div>

            <div class="form-box" style="width: 100%;">
                <h3 class="form-box-title">Employee Directory</h3>
                <div id="employees-page-list" class="list-container">
                    <!-- Employees will be rendered here -->
                </div>
            </div>

            <div class="form-box" style="width: 100%; margin-top: 20px;">
                <h3 class="form-box-title">Attendance Management</h3>
                <div id="attendance-list" class="list-container">
                    <!-- Attendance rows will be rendered here -->
                </div>
            </div>
        </div>

        <dialog id="attendance-dialog" style="width: 500px;">
            <h3>Mark Employee Absent</h3>
            <div class="form-group">
                <label class="form-label">Employee</label>
                <input type="text" id="absent-employee-name" class="form-input" readonly>
                <input type="hidden" id="absent-employee-id">
            </div>
            <div class="form-group">
                <label for="absence-reason" class="form-label">Reason for Absence</label>
                <textarea id="absence-reason" class="form-input" placeholder="Enter reason..."></textarea>
            </div>
            <div class="form-group">
                <label for="replacement-employee" class="form-label">Replacement Employee</label>
                <select id="replacement-employee" class="form-input">
                    <option value="">Select replacement...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="temp-shift" class="form-label">Temporary Shift</label>
                <input type="text" id="temp-shift" class="form-input" placeholder="e.g., 9 AM - 5 PM">
            </div>
            <div class="form-group">
                <label for="salary-cut" class="form-label">Salary Cut ($)</label>
                <input type="number" id="salary-cut" class="form-input" placeholder="0.00" min="0">
            </div>
            <button onclick="saveAbsence()" class="button button-primary" style="width: 100%; margin-bottom: 10px;">Save Absence</button>
            <button onclick="document.getElementById('attendance-dialog').close()" class="button button-danger" style="width: 100%;">Cancel</button>
        </dialog>

        <dialog id="new-deduction-dialog" style="width: 400px;">
            <h3>Add New Deduction</h3>
            <div class="form-group">
                <label for="new-deduction-name" class="form-label">Deduction Name</label>
                <input type="text" id="new-deduction-name" placeholder="E.g., Office Rent" class="form-input">
            </div>
            <div class="form-group">
                <label for="deduction-type" class="form-label">Type</label>
                <select id="deduction-type" class="form-input">
                    <option value="fixed">Fixed</option>
                    <option value="Non-fixed">Non-fixed</option>
                </select>
            </div>
            <div class="form-group">
                <label for="new-deduction-amount" class="form-label">Amount (Per Period)</label>
                <input type="number" id="new-deduction-amount" placeholder="e.g., 1500.00" min="0.01" step="0.01" class="form-input">
            </div>
            <div class="form-group">
                <label for="deduction-deadline" class="form-label">Payment Deadline</label>
                <input type="date" id="deduction-deadline" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Payment Status</label>
                <div style="display: flex; gap: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="payment-status" value="paid" class="setting-radio">
                        <span>Paid</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="payment-status" value="unpaid" checked class="setting-radio">
                        <span>Unpaid</span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label for="deduction-receipt" class="form-label">Attach Receipt (Optional)</label>
                <input type="file" id="deduction-receipt" accept="image/*" class="form-input" onchange="previewDeductionReceipt(event)">
                <img id="deduction-receipt-preview" style="max-width: 100%; margin-top: 10px; border-radius: 8px; display: none;">
            </div>
            <button onclick="addDeduction(); document.getElementById('new-deduction-dialog').close();" class="button button-orange" style="margin-bottom: 10px;">Add Deduction</button>
            <button onclick="document.getElementById('new-deduction-dialog').close()" class="button button-danger">Cancel</button>
        </dialog>
        
        <dialog id="new-employee-dialog" style="width: 90vw; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <h3>Add New Employee</h3>
            <div class="form-group">
                <label for="employee-name" class="form-label">Employee Name</label>
                <input type="text" id="employee-name" placeholder="Full Name" class="form-input">
            </div>
            <div class="form-group">
                <label for="employee-age" class="form-label">Age</label>
                <input type="number" id="employee-age" placeholder="Age" min="18" max="100" class="form-input">
            </div>
            <div class="form-group">
                <label for="employee-description" class="form-label">Description</label>
                <textarea id="employee-description" placeholder="Brief description of employee" class="form-input" style="resize: vertical; min-height: 60px;"></textarea>
            </div>
            <div class="form-group">
                <label for="employee-position" class="form-label">Position</label>
                <input type="text" id="employee-position" placeholder="e.g., Manager, Cashier" class="form-input">
            </div>
            <div class="form-group">
                <label for="employee-salary" class="form-label">Salary</label>
                <input type="number" id="employee-salary" placeholder="Monthly salary" min="0" step="0.01" class="form-input">
            </div>
            <div class="form-group">
                <label for="employee-contact" class="form-label">Contact</label>
                <input type="text" id="employee-contact" placeholder="Phone or email" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Shift Time</label>
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center;">
                    <div>
                        <input type="time" id="shift-start" class="form-input">
                    </div>
                    <span style="text-align: center;">to</span>
                    <div>
                        <input type="time" id="shift-end" class="form-input">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="employee-warehouse" class="form-label">Assigned Warehouse</label>
                <select id="employee-warehouse" class="form-input">
                    <option value="">Select a warehouse</option>
                </select>
            </div>
            <div class="form-group">
                <label for="employee-products" class="form-label">Products Managed</label>
                <div id="employee-products" style="border: 1px solid #ddd; border-radius: 6px; padding: 10px; max-height: 150px; overflow-y: auto; background: #f9f9f9;"></div>
            </div>
            <div class="form-group">
                <label for="employee-services" class="form-label">Services Managed</label>
                <div id="employee-services" style="border: 1px solid #ddd; border-radius: 6px; padding: 10px; max-height: 150px; overflow-y: auto; background: #f9f9f9;"></div>
            </div>
            <div class="form-group">
                <label for="employee-assets" class="form-label">Assets Managed</label>
                <div id="employee-assets" style="border: 1px solid #ddd; border-radius: 6px; padding: 10px; max-height: 150px; overflow-y: auto; background: #f9f9f9;"></div>
            </div>
            <div class="form-group">
                <label for="employee-absence-days" class="form-label">Absence Days (comma-separated dates)</label>
                <input type="text" id="employee-absence-days" placeholder="e.g., 2024-12-25, 2024-12-26" class="form-input">
            </div>
            <button onclick="addEmployee()" class="button button-primary" style="margin-bottom: 10px; width: 100%;">Add Employee</button>
            <button onclick="document.getElementById('new-employee-dialog').close()" class="button button-danger" style="width: 100%;">Cancel</button>
        </dialog>

        <dialog id="salary-payment-dialog" style="width: 400px; border-radius: 12px; padding: 0; border: none; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
            <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Manage Salary Payment</h3>
                <button onclick="document.getElementById('salary-payment-dialog').close()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #6b7280;">&times;</button>
            </div>
            <div style="padding: 20px;">
                <input type="hidden" id="salary-employee-id">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; color: #374151;">Employee</label>
                    <input type="text" id="salary-employee-name" readonly style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; background-color: #f3f4f6;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; color: #374151;">Total Salary</label>
                    <input type="text" id="salary-total-amount" readonly style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; background-color: #f3f4f6;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; color: #374151;">Amount Paid</label>
                    <input type="number" id="salary-paid-amount" step="0.01" min="0" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button onclick="document.getElementById('salary-payment-dialog').close()" class="button button-secondary">Cancel</button>
                    <button onclick="saveSalaryPayment()" class="button button-primary">Save Payment</button>
                </div>
            </div>
        </dialog>

        <!-- SMART INVENTORY PAGE (Combined with Products) -->
        <div id="inventory-page" class="page">
            <h2 class="section-heading">Product Catalog & Smart Inventory</h2>
            
            <div class="kpi-grid">
                <div class="card card-danger">
                    <p class="card-title">Out of Stock</p>
                    <p id="out-of-stock-count" class="card-value text-danger">0</p>
                </div>
                <div class="card card-orange">
                    <p class="card-title">Low Stock Alerts</p>
                    <p id="low-stock-count" class="card-value text-orange">0</p>
                </div>
                <div class="card card-danger">
                    <p class="card-title">Expired Items</p>
                    <p id="expired-count" class="card-value text-danger">0</p>
                </div>
                <div class="card card-orange">
                    <p class="card-title">Expiring Soon</p>
                    <p id="expiring-soon-count" class="card-value text-orange">0</p>
                </div>
            </div>
            
            <div class="kpi-grid" style="margin-top: 20px; margin-bottom: 20px;">
                <div class="card card-primary">
                    <p class="card-title">Inventory price</p>
                    <p id="inventory-price" class="card-value text-primary">0</p>
                    <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">Total value of all products in stock.</p>
                </div>
                <div class="card card-danger">
                    <p class="card-title">Inventory costs</p>
                    <p id="inventory-costs" class="card-value text-danger">0</p>
                    <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">Total cost of all products in stock.</p>
                </div>
            </div>
            
<dialog id="newCatalogDialog">
    <h1>Create New Catalog</h1>
    <input type="text" id="new-catalog-name" class="form-input" placeholder="Catalog Name" style="margin-bottom: 20px;">
    <button onclick="document.getElementById('newCatalogDialog').close();" class="button button-danger">Cancel</button>
    <button onclick="createNewCatalog()" class="button button-primary">Create Catalog</button>
    </dialog>

            <button onclick="document.getElementById('new-product-dialog').showModal()" class="button button-secondary" style="width: 200px; margin-bottom: 20px;">+ New Product</button>
            <button onclick="document.getElementById('newCatalogDialog').showModal()" class="button button-secondary">New catalog</button>
            <div class="form-box" style="width: 100%; margin-bottom: 20px;">
                <input type="search" class="form-input" style="width: 100%; height: 30px; margin-bottom: 10px;" id="products-search" placeholder="Search products..." oninput="filterProducts()">
                <h3 class="form-box-title">Current Catalog</h3>
                <div id="product-list-container" class="list-container">
                    <!-- Product list will be rendered here -->
                </div>
            </div>
            
            <div class="form-box" style="margin-bottom: 20px;">
                <h3 class="form-box-title">Inventory Alerts</h3>
                <div id="inventory-alerts-list" class="list-container"></div>
            </div>
            
            <div class="form-box">
                <h3 class="form-box-title">Products by Supplier</h3>
                <div id="supplier-list" class="list-container"></div>
            </div>
        </div>
        


        <dialog id="new-product-dialog" style="width: 450px; max-height: 90vh; overflow-y: auto;">
            <h3>Add New Product</h3>
            <div class="form-group">
                <label for="new-product-name" class="form-label">Product Name</label>
                <input type="text" id="new-product-name" placeholder="Widget Z" class="form-input">
            </div>
            <div class="form-group">
                <label for="new-product-description" class="form-label">Description</label>
                <textarea id="new-product-description" placeholder="Product description..." class="form-input" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="new-product-category" class="form-label">Category</label>
                <select id="new-product-category" class="form-input">
                    <option value="">Select category...</option>
                    <option value="Electronics">Electronics</option>
                    <option value="Clothing">Clothing</option>
                    <option value="Food">Food</option>
                    <option value="Books">Books</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="new-product-image" class="form-label">Product Image</label>
                <input type="file" id="new-product-image" accept="image/*" class="form-input">
                <div id="image-preview" style="margin-top: 10px; display: none;">
                    <img id="image-preview-img" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                </div>
            </div>
            <div class="form-group">
                <label for="new-product-sell" class="form-label">Selling Price</label>
                <input type="number" id="new-product-sell" placeholder="10.00" min="0" step="0.01" class="form-input">
            </div>
            <div class="form-group">
                <label for="new-product-buy" class="form-label">Buying Price / COGS</label>
                <input type="number" id="new-product-buy" placeholder="5.00" min="0" step="0.01" class="form-input">
            </div>
            <div class="form-group">
                <label for="new-product-stock" class="form-label">Current Stock</label>
                <input type="number" id="new-product-stock" placeholder="1" min="0" step="1" class="form-input">
            </div>
            <div class="form-group">
                <label for="new-product-reorder" class="form-label">Reorder Point (Alert when stock reaches)</label>
                <input type="number" id="new-product-reorder" placeholder="5" min="0" step="1" class="form-input">
            </div>
            <div class="form-group">
                <label for="new-product-supplier" class="form-label">Supplier (Optional)</label>
                <input type="text" id="new-product-supplier" placeholder="Supplier name" class="form-input">
            </div>
            <div class="form-group">
                <label for="new-product-expiry" class="form-label">Expiry Date (Optional)</label>
                <input type="date" id="new-product-expiry" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Barcode</label>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button type="button" onclick="generateProductBarcode()" class="button button-primary" style="flex: 1;">Generate Barcode</button>
                    <button type="button" onclick="document.getElementById('product-barcode-upload').click()" class="button button-secondary" style="flex: 1;">Upload Barcode</button>
                </div>
                <input type="file" id="product-barcode-upload" accept="image/*" style="display: none;" onchange="uploadProductBarcode(event)">
                <div id="product-barcode-container" style="text-align: center; margin-top: 10px; display: none;">
                    <img id="product-barcode-preview" style="max-width: 100%; border-radius: 8px;">
                </div>
            </div>
            <button onclick="addProduct(); document.getElementById('new-product-dialog').close();" class="button button-secondary" style="margin-bottom: 10px;">Add Product</button>
            <button onclick="document.getElementById('new-product-dialog').close()" class="button button-danger">Cancel</button>
        </dialog>

        <!--SETTINGS PAGE -->
        
    <div id="settings-page" class="page">
  <h2 class="section-heading">Settings</h2>

  <div class="form-box settings-container" style="width: 800px;">
    <!-- Business Display -->
    <div class="settings-group">
      <h1 id="businessName">Unknown</h1>
      <h4 id="ownerName" style="margin-top: 12px;">Unknown</h4>
    </div>
    
    <div class="settings-group">
      <h3 class="form-box-title">Settings</h3>
      <button onclick="document.getElementById('account-settings-dialog').showModal();" class="button button-primary" style="width: 100%; margin-bottom: 20px;">
        Account Settings
      </button>
      <button onclick="document.getElementById('settings-modal').style.display='flex';" class="button button-primary" style="width: 100%; margin-bottom: 20px;">
        AI Settings
      </button>
      <button onclick="document.getElementById('export-dialog').showModal()" class="button button-secondary" style="width: 100%; margin-bottom: 20px;">
        Download All Data
      </button>
      <button onclick="logoutUser()" class="button button-danger" style="width: 100%;">
        Logout
      </button>
    </div>

    <!-- NOTIFICATION BAR CONTAINER -->
    <div class="settings-group" style="text-align: left; margin-top: 24px;">
        <h3 class="form-box-title" style="text-align: center;">Notifications</h3>
        <div id="notification-bar" style="min-height: 150px;">
            <!-- Notifications will be dynamically inserted here -->
        </div>
    </div>

    <!-- NOTIFICATION PREFERENCES -->
    <div class="settings-group" style="text-align: left; margin-top: 24px;">
        <h3 class="form-box-title" style="text-align: center;">Notification Preferences</h3>
        <div class="setting-box" style="margin-bottom: 12px;">
            <div class="setting-row">
                <label>Low Stock Alerts</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="notify-low-stock" checked onchange="saveNotificationPrefs()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        <div class="setting-box" style="margin-bottom: 12px;">
            <div class="setting-row">
                <label>Expiry Alerts</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="notify-expiry" checked onchange="saveNotificationPrefs()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        <div class="setting-box" style="margin-bottom: 12px;">
            <div class="setting-row">
                <label>Payment Reminders</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="notify-payments" checked onchange="saveNotificationPrefs()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        <div class="setting-box" style="margin-bottom: 12px;">
            <div class="setting-row">
                <label>System Updates</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="notify-system" checked onchange="saveNotificationPrefs()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        <div class="setting-box">
            <div class="setting-row">
                <label>Sound Alerts</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="notify-sound" checked onchange="saveNotificationPrefs()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- THEME & ACCENT COLOR -->
    <div class="settings-group" style="text-align: left; margin-top: 24px;">
        <h3 class="form-box-title" style="text-align: center;">Theme & Appearance</h3>
        <div class="setting-box" style="margin-bottom: 20px;">
            <label class="form-label" style="margin-bottom: 12px; display: block;">Dark Mode</label>
            <label class="toggle-switch">
                <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkModeFromSettings()">
                <span class="slider"></span>
            </label>
        </div>
        <div class="setting-box" style="margin-bottom: 12px;">
            <label class="form-label" style="margin-bottom: 12px; display: block;">Accent Color</label>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 12px;">
                <div class="color-option" onclick="changeAccentColor('#3b82f6', this)" title="Blue">
                    <div style="width: 50px; height: 50px; background-color: #3b82f6; border-radius: 8px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s;" class="color-preview blue-accent"></div>
                    <small>Blue</small>
                </div>
                <div class="color-option" onclick="changeAccentColor('#10b981', this)" title="Green">
                    <div style="width: 50px; height: 50px; background-color: #10b981; border-radius: 8px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s;" class="color-preview green-accent"></div>
                    <small>Green</small>
                </div>
                <div class="color-option" onclick="changeAccentColor('#8b5cf6', this)" title="Purple">
                    <div style="width: 50px; height: 50px; background-color: #8b5cf6; border-radius: 8px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s;" class="color-preview purple-accent"></div>
                    <small>Purple</small>
                </div>
                <div class="color-option" onclick="changeAccentColor('#ec4899', this)" title="Pink">
                    <div style="width: 50px; height: 50px; background-color: #ec4899; border-radius: 8px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s;" class="color-preview pink-accent"></div>
                    <small>Pink</small>
                </div>
                <div class="color-option" onclick="changeAccentColor('#f59e0b', this)" title="Orange">
                    <div style="width: 50px; height: 50px; background-color: #f59e0b; border-radius: 8px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s;" class="color-preview orange-accent"></div>
                    <small>Orange</small>
                </div>
                <div class="color-option" onclick="changeAccentColor('#06b6d4', this)" title="Cyan">
                    <div style="width: 50px; height: 50px; background-color: #06b6d4; border-radius: 8px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s;" class="color-preview cyan-accent"></div>
                    <small>Cyan</small>
                </div>
            </div>
            <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                 <label style="font-size: 14px; font-weight: 500; color: var(--color-text-dark);">Custom Color:</label>
                 <input type="color" id="custom-theme-color" onchange="changeAccentColor(this.value)" style="height: 40px; width: 60px; padding: 0; border: none; border-radius: 4px; cursor: pointer;">
            </div>
        </div>
    </div>

    <!-- Currency Setting -->
    <div class="setting-box" style="width: 750px;">
      <label class="form-label">Default Currency</label>
      <div style="display: flex; justify-content: center; gap: 32px; margin-top: 12px;">
        <div class="setting-option">
          <input type="radio" id="currency-usd" name="currency-radio" value="$" class="setting-radio" onclick="changeCurrency('$')">
          <label for="currency-usd">USD ($)</label>
        </div>
        <div class="setting-option">
          <input type="radio" id="currency-ksh" name="currency-radio" value="KSH" class="setting-radio" onclick="changeCurrency('KSH')">
          <label for="currency-ksh">KSH (KSh)</label>
        </div>
      </div>
      <p class="text-gray-medium" style="margin-top: 8px;">All financial displays will update immediately to this currency.</p>
    </div>

  </div>
</div>

<!--All Chart Pages Here:-->
<div id="chartsPage" class="page">
  <div class="charts-header">
    <h1> Financial Dashboard</h1>
    <p>Track your revenue, products, and key metrics</p>
  </div>

  <div class="chart-tabs">
    <button onclick="showPage('chartsPage')" class="ptb active">Bar Charts</button>
    <button onclick="showPage('pie-page-chart')" class="ptb">Pie Charts</button>
    <button onclick="showPage('lineChart')" class="ptb">Trends</button>
    <button onclick="showPage('deductions-chart-page')" class="ptb">Deductions</button>
    <button onclick="showPage('p-s-d')" class="ptb">Stock</button>
    <button onclick="showPage('advanced-charts')" class="ptb">Advanced</button>
  </div>

  <div class="form-box" style="max-width: 1000px; margin: 0 auto 30px; padding: 16px;">
    <label class="form-label">Select Time Period:</label>
    <select id="chart-timeline" class="form-input" onchange="updateChartTimeline()" style="margin-bottom: 0;">
      <option value="7">Last 7 Days</option>
      <option value="30" selected>Last 30 Days</option>
      <option value="90">Last 90 Days</option>
      <option value="365">Last Year</option>
      <option value="all">All Time</option>
    </select>
  </div>

  <div class="chart-grid">
    <div class="chart-card">
      <div class="chart-card-title"> Revenue by Product</div>
      <div class="chart-card-subtitle">Total revenue generated per product</div>
      <div class="chart-container">
        <canvas id="revenueChart"></canvas>
      </div>
    </div>
  </div>
</div>
<!--Pie page-->
<div id="pie-page-chart" class="page">
  <div class="charts-header">
    <h1> Financial Dashboard</h1>
    <p>Track your revenue, products, and key metrics</p>
  </div>

  <div class="chart-tabs">
    <button onclick="showPage('chartsPage')" class="ptb">Bar Charts</button>
    <button onclick="showPage('pie-page-chart')" class="ptb active">Pie Charts</button>
    <button onclick="showPage('lineChart')" class="ptb">Trends</button>
    <button onclick="showPage('deductions-chart-page')" class="ptb">Deductions</button>
    <button onclick="showPage('p-s-d')" class="ptb">Stock</button>
    <button onclick="showPage('advanced-charts')" class="ptb">Advanced</button>
  </div>

  <div class="form-box" style="max-width: 1000px; margin: 0 auto 30px; padding: 16px;">
    <label class="form-label">Select Time Period:</label>
    <select id="pie-timeline" class="form-input" onchange="updatePieTimeline()" style="margin-bottom: 0;">
      <option value="7">Last 7 Days</option>
      <option value="30" selected>Last 30 Days</option>
      <option value="90">Last 90 Days</option>
      <option value="365">Last Year</option>
      <option value="all">All Time</option>
    </select>
  </div>

  <div class="chart-grid">
    <div class="chart-card">
      <div class="chart-card-title"> Product Contribution</div>
      <div class="chart-card-subtitle">Percentage distribution of revenue by product</div>
      <div class="chart-container">
        <canvas id="percentageChart"></canvas>
      </div>
    </div>
  </div>
</div>
<!--Line bar page-->
<div id="lineChart" class="page">
  <div class="charts-header">
    <h1> Financial Dashboard</h1>
    <p>Track your revenue, products, and key metrics</p>
  </div>

  <div class="chart-tabs">
    <button onclick="showPage('chartsPage')" class="ptb">Bar Charts</button>
    <button onclick="showPage('pie-page-chart')" class="ptb">Pie Charts</button>
    <button onclick="showPage('lineChart')" class="ptb active">Trends</button>
    <button onclick="showPage('deductions-chart-page')" class="ptb">Deductions</button>
    <button onclick="showPage('p-s-d')" class="ptb">Stock</button>
    <button onclick="showPage('advanced-charts')" class="ptb">Advanced</button>
  </div>

  <div class="form-box" style="max-width: 1000px; margin: 0 auto 30px; padding: 16px;">
    <label class="form-label">Select Time Period:</label>
    <select id="line-timeline" class="form-input" onchange="updateLineTimeline()" style="margin-bottom: 0;">
      <option value="7">Last 7 Days</option>
      <option value="30" selected>Last 30 Days</option>
      <option value="90">Last 90 Days</option>
      <option value="365">Last Year</option>
      <option value="all">All Time</option>
    </select>
  </div>

  <div class="chart-grid">
    <div class="chart-card">
      <div class="chart-card-title"> Monthly Trends</div>
      <div class="chart-card-subtitle">Revenue, cost, and profit trends over time</div>
      <div class="chart-container">
        <canvas id="monthly-trends"></canvas>
      </div>
    </div>
  </div>
</div>

<!--Deductions Chart Page-->
<div id="deductions-chart-page" class="page">
  <div class="charts-header">
    <h1> Financial Dashboard</h1>
    <p>Track your revenue, products, and key metrics</p>
  </div>

  <div class="chart-tabs">
    <button onclick="showPage('chartsPage')" class="ptb">Bar Charts</button>
    <button onclick="showPage('pie-page-chart')" class="ptb">Pie Charts</button>
    <button onclick="showPage('lineChart')" class="ptb">Trends</button>
    <button onclick="showPage('deductions-chart-page')" class="ptb active">Deductions</button>
    <button onclick="showPage('p-s-d')" class="ptb">Stock</button>
    <button onclick="showPage('advanced-charts')" class="ptb">Advanced</button>
  </div>

  <div class="form-box" style="max-width: 1000px; margin: 0 auto 30px; padding: 16px;">
    <label class="form-label">Select Time Period:</label>
    <select id="deductions-timeline" class="form-input" onchange="updateDeductionsTimeline()" style="margin-bottom: 0;">
      <option value="7">Last 7 Days</option>
      <option value="30" selected>Last 30 Days</option>
      <option value="90">Last 90 Days</option>
      <option value="365">Last Year</option>
      <option value="all">All Time</option>
    </select>
  </div>

  <div class="chart-grid">
    <div class="chart-card">
      <div class="chart-card-title"> Fixed Deductions</div>
      <div class="chart-card-subtitle">Distribution of deductions by category</div>
      <div class="chart-container">
        <canvas id="deductionsChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!--Product Stock Data-->
<div id="p-s-d" class="page">
  <div class="charts-header">
    <h1> Financial Dashboard</h1>
    <p>Track your revenue, products, and key metrics</p>
  </div>

  <div class="chart-tabs">
    <button onclick="showPage('chartsPage')" class="ptb">Bar Charts</button>
    <button onclick="showPage('pie-page-chart')" class="ptb">Pie Charts</button>
    <button onclick="showPage('lineChart')" class="ptb">Trends</button>
    <button onclick="showPage('deductions-chart-page')" class="ptb">Deductions</button>
    <button onclick="showPage('p-s-d')" class="ptb active">Stock</button>
    <button onclick="showPage('advanced-charts')" class="ptb">Advanced</button>
  </div>

  <div class="form-box" style="max-width: 1000px; margin: 0 auto 30px; padding: 16px;">
    <label class="form-label">Select Time Period:</label>
    <select id="stock-timeline" class="form-input" onchange="updateStockTimeline()" style="margin-bottom: 0;">
      <option value="7">Last 7 Days</option>
      <option value="30" selected>Last 30 Days</option>
      <option value="90">Last 90 Days</option>
      <option value="365">Last Year</option>
      <option value="all">All Time</option>
    </select>
  </div>

  <div class="chart-grid">
    <div class="chart-card">
      <div class="chart-card-title"> Product Stock Levels</div>
      <div class="chart-card-subtitle">Current inventory levels by product</div>
      <div class="chart-container">
        <canvas id="product-stock-data"></canvas>
      </div>
    </div>
  </div>
</div>

<!--Advanced Charts Page-->
<div id="advanced-charts" class="page">
  <div class="charts-header">
    <h1> Financial Dashboard</h1>
    <p>Track your revenue, products, and key metrics</p>
  </div>

  <div class="chart-tabs">
    <button onclick="showPage('chartsPage')" class="ptb">Bar Charts</button>
    <button onclick="showPage('pie-page-chart')" class="ptb">Pie Charts</button>
    <button onclick="showPage('lineChart')" class="ptb">Trends</button>
    <button onclick="showPage('deductions-chart-page')" class="ptb">Deductions</button>
    <button onclick="showPage('p-s-d')" class="ptb">Stock</button>
    <button onclick="showPage('advanced-charts')" class="ptb active">Advanced</button>
  </div>

  <div class="chart-grid">
    <div class="chart-card">
      <div class="chart-card-title"> Top Products Performance</div>
      <div class="chart-card-subtitle">Best performing products by quantity sold</div>
      <div class="chart-container">
        <canvas id="topProductsChart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-card-title"> Profit Margin Analysis</div>
      <div class="chart-card-subtitle">Profit margins across product categories</div>
      <div class="chart-container">
        <canvas id="profitMarginChart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-card-title"> Sales Distribution</div>
      <div class="chart-card-subtitle">Distribution of sales across channels</div>
      <div class="chart-container">
        <canvas id="salesDistributionChart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-card-title"> Revenue vs Expenses</div>
      <div class="chart-card-subtitle">Comparison of revenue against expenses</div>
      <div class="chart-container">
        <canvas id="revenueVsExpensesChart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-card-title"> Top Valued Customers</div>
      <div class="chart-card-subtitle">Customers sorted by total spending</div>
      <div class="chart-container">
        <canvas id="topCustomersChart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-card-title"> Customer Spending Distribution</div>
      <div class="chart-card-subtitle">Distribution of customer spending</div>
      <div class="chart-container">
        <canvas id="customerSpendingChart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-card-title"> Customer Purchase Frequency</div>
      <div class="chart-card-subtitle">Number of purchases per customer</div>
      <div class="chart-container">
        <canvas id="customerFrequencyChart"></canvas>
      </div>
    </div>
  </div>
</div>
<!--AI Page-->
<div class="page AIP" id="AI-page">
     <button class="collapse-toggle" onclick="toggleAICollapse()" title="Collapse/Expand" style="position: fixed;">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="9" x2="15" y2="15"/><line x1="15" y1="9" x2="9" y2="15"/></svg>
    </button>
     <!-- History Sidebar -->
  
        <div id="chat-header">
            <h1 style="color: #fff;">
                <!-- Lucide: atom -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-atom"><circle cx="12" cy="12" r="2"/><path d="M12 2A10 10 0 0 0 2.5 9.5M12 2v20M12 22A10 10 0 0 0 21.5 14.5M22 12H2M2.5 14.5A10 10 0 0 0 12 22M21.5 9.5A10 10 0 0 0 12 2"/></svg>
                Epsilon Nexus 
            </h1><p>By Epsilon/ Warren Adrian</p>
            <div style="display: flex; align-items: center;">
                <span id="user-id-display">Initializing...</span>
              
                    <!-- Lucide: settings -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.22a2 2 0 0 1-1.42 1.42l-.22.44a2 2 0 0 0-1.42 1.42v.44a2 2 0 0 1-1.42 1.42l-.44.22a2 2 0 0 0-1.42 1.42v.44a2 2 0 0 1 1.42 1.42l.22.44a2 2 0 0 0 1.42 1.42v.44a2 2 0 0 1 1.42 1.42l.44.22a2 2 0 0 0 1.42 1.42v.44a2 2 0 0 1 2 2h.44a2 2 0 0 1 2-2v-.22a2 2 0 0 0 1.42-1.42l.22-.44a2 2 0 0 1 1.42-1.42v-.44a2 2 0 0 0 1.42-1.42l.44-.22a2 2 0 0 1 1.42-1.42v-.44a2 2 0 0 0 1.42-1.42l-.22-.44a2 2 0 0 1-1.42-1.42v-.44a2 2 0 0 0-1.42-1.42l-.44-.22a2 2 0 0 1-1.42-1.42V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
            </div>
        </div>
        <div id="messages" style="background: transparent;">
    
           <h1 style="text-align: center;" id="greet-text">Epsilon Nexus</h1>
        </div>
        <div id="input-container">
            <input type="file" id="file-upload" style="display: none;" onchange="handleFileUpload(event)">
            <button id="file-button" onclick="document.getElementById('file-upload').click()" style="border-radius: 10px ; color: #fff; border: none; background-color: #f97316; margin-right: 10px;" title="Upload File">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            </button>
            <button id="image-button" onclick="toggleImageMode()" style="border-radius: 10px ; background: #6366f1; margin-right: 10px; color: #fff; border: none;" title="Generate Image">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            </button>
            <button id="code-button" onclick="toggleCodeMode()" style="border-radius: 10px ; background: #8b5cf6; margin-right: 10px; color: #fff; border: none;" title="Coding Mode">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
            </button>
            <input
                type="text"
                id="user-input"
                placeholder="Ask Epsilon Nexus anything..."
                onkeydown="window.handleKey(event)"
                autofocus 
            />
            
            <button id="send-button" onclick="window.sendMessage()">
                Send
                <!-- Lucide: send -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send" style="margin-left: 5px;"><path d="m22 2-7 20-4-9-9-4 20-7Z"/><path d="M2.2 22 10 14"/></svg>
            </button>
    </div>
</div>

<!-- Export Format Dialog -->
<dialog id="export-dialog">
  <h3>Export Data</h3>
  <p>Select export format:</p>
  <button onclick="exportData('json')" class="button button-primary" style="width: 100%; margin-bottom: 10px;">JSON Format</button>
  <button onclick="exportData('txt')" class="button button-primary" style="width: 100%; margin-bottom: 10px;">Notes (Text)</button>
  <button onclick="exportData('excel')" class="button button-primary" style="width: 100%; margin-bottom: 10px;">Excel Format</button>
  <button onclick="document.getElementById('export-dialog').close()" class="button button-danger" style="width: 100%;">Cancel</button>
</dialog>

<!-- Dashboard Widgets Dialog -->
<dialog id="widgets-dialog" style="width: 600px; max-height: 80vh; overflow-y: auto;">
    <div class="modal-header">
        <h3> Dashboard Widgets</h3>
        <button class="close-button" onclick="document.getElementById('widgets-dialog').close();">&times;</button>
    </div>
    <div style="padding: 16px;">
        <p style="color: #6b7280; margin-bottom: 16px;">Quick access to key metrics and actions</p>
        
        <!-- Quick Sale Form -->
        <div style="background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <h4 style="margin: 0 0 12px 0; font-size: 16px; color: var(--color-text-dark);"> Quick Sale</h4>
            <div class="form-group">
                <select id="widget-product-select" class="form-input" style="margin-bottom: 8px;">
                    <option value="">Select product...</option>
                </select>
            </div>
            <div class="form-group">
                <input type="number" id="widget-quantity-input" placeholder="Quantity" min="1" class="form-input" style="margin-bottom: 8px;">
            </div>
            <button onclick="quickLogSale()" class="button button-primary" style="width: 100%;">
                <i data-lucide="zap"></i> Record Sale
            </button>
        </div>
        
        <div style="display: grid; gap: 12px;">
            <button onclick="showPage('sales-history-page'); document.getElementById('widgets-dialog').close();" class="button button-primary">
                <i data-lucide="receipt"></i> View Sales History
            </button>
            <button onclick="showPage('products-page'); document.getElementById('widgets-dialog').close();" class="button button-secondary">
                <i data-lucide="package"></i> Manage Products
            </button>
            <button onclick="showPage('deductions-page'); document.getElementById('widgets-dialog').close();" class="button button-orange">
                <i data-lucide="minus-circle"></i> View Deductions
            </button>
            <button onclick="showPage('lab-page'); document.getElementById('widgets-dialog').close();" class="button button-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i data-lucide="flask-conical"></i> AI Business Lab
            </button>
        </div>
    </div>
</dialog>

<!-- Confirmation Modal -->
<div id="confirmation-modal" class="modal" onclick="if (event.target.id === 'confirmation-modal') this.style.display='none';">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
        <p id="confirmation-text" style="font-size: 1.1rem; font-weight: 600; margin-bottom: 20px;">Confirmation Message</p>
        <div style="display: flex; justify-content: space-around;">
            <button onclick="document.getElementById('confirmation-modal').style.display='none';" style="padding: 10px 20px; background-color: #e2e8f0; color: #1e293b; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Cancel</button>
            <button id="confirm-action-button" style="padding: 10px 20px; background-color: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Confirm</button>
        </div>
    </div>
</div>

<!-- Account Settings Dialog -->
<dialog id="account-settings-dialog" style="width: 500px;">
    <div class="modal-header">
        <h3>Account Settings</h3>
        <button class="close-button" onclick="document.getElementById('account-settings-dialog').close();">&times;</button>
    </div>

    <!-- Profile Image Section -->
    <div class="settings-group">
        <h4>Business Logo / Profile Picture</h4>
        <img id="business-logo-img" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDhhNCA0IDAgMCAwLTQgNHYyIj48L3BhdGg+PGNpcmNsZSBjeD0iMTIiIGN5PSI3IiByPSI0Ij48L2NpcmNsZT48L3N2Zz4=" alt="Profile Picture" class="profile-pic">
        <div class="button-row">
            <input type="file" id="logo-file" accept="image/*" style="display: none;">
            <button class="round-btn" onclick="document.getElementById('logo-file').click()"><i data-lucide="camera"></i></button>
            <button class="round-btn2" onclick="toggleTheme()" id="theme-toggle-btn"><i data-lucide="sun-moon"></i></button>
        </div>
    </div>

    <!-- Business Information -->
    <div class="settings-group">
        <h4>Business Information</h4>
        <div class="form-group">
            <label for="business-name-input" class="form-label">Business Name</label>
            <input type="text" id="business-name-input" placeholder="Enter Business Name" class="form-input">
        </div>
        <div class="form-group">
            <label for="owner-name-input" class="form-label">Owner's Name</label>
            <input type="text" id="owner-name-input" placeholder="Enter Owner's Name" class="form-input">
        </div>
        <div class="form-group">
            <label for="location" class="form-label">Location</label>
            <input type="text" id="location" placeholder="Enter Location" class="form-input">
        </div>
        <div class="form-group">
            <label for="businessType" class="form-label">Business Type</label>
            <select class="form-select" id="businessType">
                <option>Restaurant</option>
                <option>Beauty/Spa</option>
                <option>Retail</option>
                <option>Services</option>
                <option>Manufacturing</option>
                <option>Wholesale</option>
                <option>Healthcare</option>
                <option>Education</option>
                <option>Technology</option>
                <option>Other</option>
            </select>
        </div>
    </div>

    <!-- Contact Information -->
    <div class="settings-group">
        <h4>Contact Information</h4>
        <div class="form-group">
            <label for="business-phone" class="form-label">Phone Number</label>
            <input type="tel" id="business-phone" placeholder="Enter Phone Number" class="form-input">
        </div>
        <div class="form-group">
            <label for="business-email" class="form-label">Email Address</label>
            <input type="email" id="business-email" placeholder="Enter Email Address" class="form-input">
        </div>
    </div>

    <div class="settings-group">
        <button onclick="saveAccountSettings()" class="button button-primary" style="width: 400px; margin-bottom: 10px;">Save Settings</button>
        <button onclick="document.getElementById('account-settings-dialog').close();" class="button button-danger" style="width: 400px;">Cancel</button>
    </div>
</dialog>

<!-- Surprise Page -->
<div id="surprise-page" class="page">
    <div class="charts-header">
        <h1> Surprise!</h1>
        <p>You found the secret page.</p>
    </div>
    <div style="text-align: center; padding: 50px; background: white; border-radius: 16px; max-width: 800px; margin: 0 auto; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
        <p style="font-size: 24px; color: #4b5563;">Here is a random quote for you:</p>
        <blockquote style="font-size: 24px; font-style: italic; margin: 40px 0; color: #2563eb; font-weight: 600;" id="random-quote">
            "The only way to do great work is to love what you do." - Steve Jobs
        </blockquote>
        <button onclick="showPage('dashboard-page')" class="button button-primary" style="font-size: 18px; padding: 12px 24px;">Back to Dashboard</button>
    </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="modal" onclick="if (event.target.id === 'settings-modal') document.getElementById('settings-modal').style.display='none';">
    <div class="modal-content">
        <div class="modal-header">
            <h3>AI Configuration Settings</h3>
            <button class="close-button" onclick="document.getElementById('settings-modal').style.display='none';">&times;</button>
        </div>

        <div class="setting-group">
            <label for="system-instruction">System Instruction (AI Persona/Role)</label>
            <textarea id="system-instruction" placeholder="e.g., Act as a concise historian, always citing sources."></textarea>
            <p>This prompt guides the AI's behavior, tone, and knowledge focus for all new conversations.</p>
        </div>

        <div class="setting-group">
            <div class="setting-row">
                <label for="use-grounding-toggle">Enable Google Search Grounding</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="use-grounding-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <p>If enabled, the AI uses Google Search for up-to-date and real-time information. Keep this on for factual queries.</p>
        </div>
 <button id="clear-history-button" onclick="window.showConfirmationModal('Are you sure you want to clear ALL chat history?', window.clearHistory)" style="width: 100%; padding: 10px; background-color: #fca5a5; color: #991b1b; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                Clear All History
            </button>
        <button onclick="window.saveSettings(); document.getElementById('settings-modal').style.display='none';" style="width: 100%; padding: 12px; background-color: #4f46e5; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">
            Save and Close
        </button>
    </div>
  </div>
        </div>  
        <div id="Clients" class="page">
            <h2 class="section-heading">Clients & Contractors Management</h2>
            
            <!-- Statistics Cards -->
            <div class="kpi-grid" style="margin-bottom: 30px;">
                <div class="card card-primary" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; opacity: 0.1; font-size: 80px;"></div>
                    <p class="card-title" style="color: rgba(255, 255, 255, 0.9);">Total Clients</p>
                    <p id="total-clients-stat" class="card-value" style="color: white; font-size: 2.5em; font-weight: 700;">0</p>
                </div>
                
                <div class="card card-secondary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; opacity: 0.1; font-size: 80px;"></div>
                    <p class="card-title" style="color: rgba(255, 255, 255, 0.9);">Total Contractors</p>
                    <p id="total-contractors-stat" class="card-value" style="color: white; font-size: 2.5em; font-weight: 700;">0</p>
                </div>
                
                <div class="card card-orange" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -20px; right: -20px; opacity: 0.1; font-size: 80px;"></div>
                    <p class="card-title" style="color: rgba(255, 255, 255, 0.9);">Active Contacts</p>
                    <p id="total-contacts-stat" class="card-value" style="color: white; font-size: 2.5em; font-weight: 700;">0</p>
                </div>
            </div>
            
            <!-- Add New Button -->
            <div style="margin-bottom: 25px;">
                <button class="button button-primary" onclick="document.getElementById('client-dialog').showModal()" style="padding: 12px 24px; font-size: 16px; border-radius: 8px;">
                    <span style="margin-right: 8px;"></span> Add Client/Contractor
                </button>
            </div>

            <!-- Client Dialog -->
            <dialog id="client-dialog" style="width: 450px; border-radius: 12px;">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">Add Client/Contractor</h3>
                    <button class="close-button" onclick="document.getElementById('client-dialog').close();">&times;</button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Name/Organization:</label>
                    <input placeholder="Enter name or organization" class="form-input" style="width: 100%;">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Contact:</label>
                    <input placeholder="Phone number or email" class="form-input" style="width: 100%;">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Type:</label>
                    <select class="form-input" style="width: 100%; padding: 10px;">
                        <option>Client</option>
                        <option>Contractor</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description/Notes:</label>
                    <textarea id="descriptionClient" class="form-input" placeholder="Add any additional notes..." style="width: 100%; min-height: 80px; padding: 10px; font-family: inherit;"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="button button-primary" onclick="createClient()" style="flex: 1;">Create</button>
                    <button class="button button-danger" onclick="document.getElementById('client-dialog').close()" style="flex: 1;">Cancel</button>
                </div>
            </dialog>

            <!-- Clients & Contractors List -->
            <div class="form-box" style="width: 100%; padding: 0;">
                <h3 class="form-box-title" style="padding: 20px 20px 15px 20px; margin: 0;">Clients & Contractors Directory</h3>
                <div style="padding: 0 20px 20px 20px;">
                    <input type="search" class="form-input" id="client-search" placeholder="Search by name or contact..." style="width: 100%; margin-bottom: 20px;" oninput="filterClients()">
                </div>
                <div id="client-list" style="padding: 0 20px 20px 20px; display: grid; gap: 15px; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));">
                    <!-- Clients will be rendered here -->
                </div>
            </div>
        </div>

<!-- WAREHOUSE MANAGEMENT PAGE -->
<div id="warehouse-page" class="page">
    <h2 class="section-heading">Warehouse Management</h2>
    
    <div class="kpi-grid">
        <div class="card card-primary">
            <p class="card-title">Total Warehouses</p>
            <p id="total-warehouses" class="card-value text-primary">0</p>
        </div>
        <div class="card card-secondary">
            <p class="card-title">Active Products</p>
            <p id="warehouse-products" class="card-value text-secondary">0</p>
        </div>
        <div class="card card-orange">
            <p class="card-title">Total Capacity</p>
            <p id="total-capacity" class="card-value text-orange">0</p>
        </div>
        <div class="card card-danger">
            <p class="card-title">Linked Clients</p>
            <p id="linked-clients" class="card-value text-danger">0</p>
        </div>
    </div>
    
    <button onclick="document.getElementById('new-warehouse-dialog').showModal()" class="button button-primary" style="width: 200px; margin-bottom: 20px;">+ New Warehouse</button>
    <button onclick="document.getElementById('transfer-dialog').showModal()" class="button button-secondary" style="width: 200px; margin-bottom: 20px; margin-left: 10px;">Transfer Products</button>
    
    <div class="form-box" style="width: 100%;">
        <input type="search" class="form-input" style="width: 100%; height: 30px; margin-bottom: 10px;" id="warehouse-search" placeholder="Search warehouses..." oninput="filterWarehouses()">
        <h3 class="form-box-title">Warehouse List</h3>
        <div id="warehouse-list" class="list-container"></div>
    </div>
</div>

<!-- New Warehouse Dialog -->
<dialog id="new-warehouse-dialog" style="width: 500px;">
    <h3>Add New Warehouse</h3>
    <div class="form-group">
        <label for="warehouse-name" class="form-label">Warehouse Name</label>
        <input type="text" id="warehouse-name" placeholder="e.g., Main Storage" class="form-input">
    </div>
    <div class="form-group">
        <label for="warehouse-address" class="form-label">Address</label>
        <input type="text" id="warehouse-address" placeholder="e.g., 123 Storage St, City" class="form-input">
    </div>
    <div class="form-group">
        <label for="warehouse-capacity" class="form-label">Capacity (units)</label>
        <input type="number" id="warehouse-capacity" placeholder="e.g., 1000" min="1" class="form-input">
    </div>
    <div class="form-group">
        <label for="warehouse-client" class="form-label">Link to Client/Contractor (Optional)</label>
        <select id="warehouse-client" class="form-input">
            <option value="">None</option>
        </select>
    </div>
    <div class="form-group">
        <label for="warehouse-products" class="form-label">Managed Products (Select Multiple)</label>
        <select id="warehouse-products-select" class="form-input" multiple style="height: 120px;">
        </select>
    </div>
    <button onclick="addWarehouse()" class="button button-primary" style="margin-bottom: 10px;">Add Warehouse</button>
    <button onclick="document.getElementById('new-warehouse-dialog').close()" class="button button-danger">Cancel</button>
</dialog>

<!-- Edit Warehouse Dialog -->
<dialog id="edit-warehouse-dialog" style="width: 500px;">
    <h3>Edit Warehouse</h3>
    <input type="hidden" id="edit-warehouse-id">
    <div class="form-group">
        <label for="edit-warehouse-name" class="form-label">Warehouse Name</label>
        <input type="text" id="edit-warehouse-name" class="form-input">
    </div>
    <div class="form-group">
        <label for="edit-warehouse-address" class="form-label">Address</label>
        <input type="text" id="edit-warehouse-address" class="form-input">
    </div>
    <div class="form-group">
        <label for="edit-warehouse-capacity" class="form-label">Capacity (units)</label>
        <input type="number" id="edit-warehouse-capacity" min="1" class="form-input">
    </div>
    <div class="form-group">
        <label for="edit-warehouse-client" class="form-label">Link to Client/Contractor</label>
        <select id="edit-warehouse-client" class="form-input">
            <option value="">None</option>
        </select>
    </div>
    <div class="form-group">
        <label for="edit-warehouse-products" class="form-label">Managed Products</label>
        <select id="edit-warehouse-products-select" class="form-input" multiple style="height: 120px;">
        </select>
    </div>
    <button onclick="updateWarehouse()" class="button button-primary" style="margin-bottom: 10px;">Update Warehouse</button>
    <button onclick="document.getElementById('edit-warehouse-dialog').close()" class="button button-danger">Cancel</button>
</dialog>

<!-- Warehouse Details Dialog -->
<dialog id="warehouse-details-dialog" style="width: 600px;">
    <div class="modal-header">
        <h3 id="warehouse-details-title">Warehouse Details</h3>
        <button class="close-button" onclick="document.getElementById('warehouse-details-dialog').close();">&times;</button>
    </div>
    <div id="warehouse-details-content" style="padding: 20px;">
    </div>
</dialog>

<!-- Product Transfer Dialog -->
<dialog id="transfer-dialog" style="width: 500px;">
    <h3>Transfer Products Between Warehouses</h3>
    <div class="form-group">
        <label for="transfer-from" class="form-label">From Warehouse</label>
        <select id="transfer-from" class="form-input" onchange="updateTransferProducts()">
            <option value="">Select source warehouse</option>
        </select>
    </div>
    <div class="form-group">
        <label for="transfer-to" class="form-label">To Warehouse</label>
        <select id="transfer-to" class="form-input">
            <option value="">Select destination warehouse</option>
        </select>
    </div>
    <div class="form-group">
        <label for="transfer-product" class="form-label">Product to Transfer</label>
        <select id="transfer-product" class="form-input" onchange="updateTransferStock()">
            <option value="">Select product</option>
        </select>
    </div>
    <div class="form-group">
        <label for="transfer-quantity" class="form-label">Quantity</label>
        <input type="number" id="transfer-quantity" placeholder="Enter quantity" min="1" class="form-input">
        <p id="transfer-stock-info" style="font-size: 12px; color: #6b7280; margin-top: 5px;"></p>
    </div>
    <button onclick="executeTransfer()" class="button button-primary" style="margin-bottom: 10px;">Transfer</button>
    <button onclick="document.getElementById('transfer-dialog').close()" class="button button-danger">Cancel</button>
</dialog>

<!--Tools Page-->
        <div id="news-page" class="page" style="padding: 100px 20px 20px 20px;">
            <div style="max-width: 1400px; margin: 0 auto;">
                <!-- Header Section -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
                    <div>
                        <h1 style="margin: 0 0 8px 0; font-size: 32px; font-weight: 700;">Calculator Tools</h1>
                        <p style="margin: 0; color: #6b7280; font-size: 16px;">Business calculation tools to optimize your financial decisions</p>
                    </div>
                    <button onclick="document.getElementById('scanner-dialog').showModal()" class="button button-primary" style="display: flex; align-items: center; gap: 8px;">
                        <i data-lucide="scan-line"></i>
                        <span>Scanner</span>
                    </button>
                </div>

                <!-- Calculators Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 24px; margin-bottom: 40px;">
                    
                    <!-- 1. Profit Margin Calculator -->
                    <div class="form-box" style="background: white; border: 1px solid #e5e7eb; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);">
                        <h3 class="form-box-title" style="border-bottom: 2px solid #e5e7eb; color: #1f2937; font-size: 18px;">Profit Margin Calculator</h3>
                        <p style="color: #6b7280; margin-bottom: 16px; font-size: 14px;">Calculate your gross profit and margin percentage</p>
                        
                        <div class="form-group">
                            <label for="calc-revenue" class="form-label">Total Revenue</label>
                            <input type="number" id="calc-revenue" placeholder="e.g., 500.00" min="0" step="0.01" class="form-input">
                        </div>
                        
                        <div class="form-group">
                            <label for="calc-cogs" class="form-label">Cost of Goods Sold</label>
                            <input type="number" id="calc-cogs" placeholder="e.g., 200.00" min="0" step="0.01" class="form-input">
                        </div>

                        <button onclick="calculateProfitMargin()" class="button button-primary" style="width: 100%;">
                            Calculate
                        </button>
                        
                        <div id="calc-result"></div>
                    </div>

                    <!-- 2. ROI Calculator -->
                    <div class="form-box" style="background: white; border: 1px solid #e5e7eb; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);">
                        <h3 class="form-box-title" style="border-bottom: 2px solid #e5e7eb; color: #1f2937; font-size: 18px;">ROI Calculator</h3>
                        <p style="color: #6b7280; margin-bottom: 16px; font-size: 14px;">Calculate your return on investment percentage</p>

                        <div class="form-group">
                            <label for="roi-gain" class="form-label">Total Gain</label>
                            <input type="number" id="roi-gain" placeholder="e.g., 5000" min="0" step="0.01" class="form-input">
                        </div>

                        <div class="form-group">
                            <label for="roi-cost" class="form-label">Total Cost</label>
                            <input type="number" id="roi-cost" placeholder="e.g., 3000" min="0.01" step="0.01" class="form-input">
                        </div>

                        <button onclick="calculateROI()" class="button button-primary" style="width: 100%;">
                            Calculate
                        </button>

                        <div id="roi-result" style="margin-top: 12px; font-weight: 600; color: #3b82f6;"></div>
                    </div>

                    <!-- 3. Break-Even Calculator -->
                    <div class="form-box" style="background: white; border: 1px solid #e5e7eb; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);">
                        <h3 class="form-box-title" style="border-bottom: 2px solid #e5e7eb; color: #1f2937; font-size: 18px;">Break-Even Calculator</h3>
                        <p style="color: #6b7280; margin-bottom: 16px; font-size: 14px;">Find your break-even point for products</p>

                        <div class="form-group">
                            <label for="be-fixed-costs" class="form-label">Fixed Costs</label>
                            <input type="number" id="be-fixed-costs" placeholder="e.g., 1000" min="0" step="0.01" class="form-input">
                        </div>

                        <div class="form-group">
                            <label for="be-unit-price" class="form-label">Unit Price</label>
                            <input type="number" id="be-unit-price" placeholder="e.g., 50" min="0" step="0.01" class="form-input">
                        </div>

                        <div class="form-group">
                            <label for="be-unit-cost" class="form-label">Unit Cost</label>
                            <input type="number" id="be-unit-cost" placeholder="e.g., 20" min="0" step="0.01" class="form-input">
                        </div>

                        <button onclick="calculateBreakEven()" class="button button-primary" style="width: 100%;">
                            Calculate
                        </button>

                        <div id="be-result"></div>
                    </div>

                    <!-- 4. Inventory Turnover Calculator -->
                    <div class="form-box" style="background: white; border: 1px solid #e5e7eb; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);">
                        <h3 class="form-box-title" style="border-bottom: 2px solid #e5e7eb; color: #1f2937; font-size: 18px;">Inventory Turnover</h3>
                        <p style="color: #6b7280; margin-bottom: 16px; font-size: 14px;">Measure how fast inventory is sold</p>

                        <div class="form-group">
                            <label for="it-cogs" class="form-label">Cost of Goods Sold</label>
                            <input type="number" id="it-cogs" placeholder="e.g., 50000" min="0" step="0.01" class="form-input">
                        </div>

                        <div class="form-group">
                            <label for="it-avg-inventory" class="form-label">Average Inventory Value</label>
                            <input type="number" id="it-avg-inventory" placeholder="e.g., 10000" min="0" step="0.01" class="form-input">
                        </div>

                        <button onclick="calculateInventoryTurnover()" class="button button-primary" style="width: 100%;">
                            Calculate
                        </button>

                        <div id="it-result"></div>
                    </div>

                    <!-- 5. Gross Profit Calculator -->
                    <div class="form-box" style="background: white; border: 1px solid #e5e7eb; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);">
                        <h3 class="form-box-title" style="border-bottom: 2px solid #e5e7eb; color: #1f2937; font-size: 18px;">Gross Profit Calculator</h3>
                        <p style="color: #6b7280; margin-bottom: 16px; font-size: 14px;">Calculate gross profit and ratio</p>

                        <div class="form-group">
                            <label for="gp-revenue" class="form-label">Total Revenue</label>
                            <input type="number" id="gp-revenue" placeholder="e.g., 100000" min="0" step="0.01" class="form-input">
                        </div>

                        <div class="form-group">
                            <label for="gp-cogs" class="form-label">Cost of Goods Sold</label>
                            <input type="number" id="gp-cogs" placeholder="e.g., 60000" min="0" step="0.01" class="form-input">
                        </div>

                        <button onclick="calculateGrossProfit()" class="button button-primary" style="width: 100%;">
                            Calculate
                        </button>

                        <div id="gp-result"></div>
                    </div>

                    <!-- 6. Sales Tax Calculator -->
                    <div class="form-box" style="background: white; border: 1px solid #e5e7eb; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);">
                        <h3 class="form-box-title" style="border-bottom: 2px solid #e5e7eb; color: #1f2937; font-size: 18px;">Sales Tax Calculator</h3>
                        <p style="color: #6b7280; margin-bottom: 16px; font-size: 14px;">Calculate sales tax quickly</p>

                        <div class="form-group">
                            <label for="st-subtotal" class="form-label">Subtotal Amount</label>
                            <input type="number" id="st-subtotal" placeholder="e.g., 100" min="0" step="0.01" class="form-input">
                        </div>

                        <div class="form-group">
                            <label for="st-rate" class="form-label">Tax Rate (%)</label>
                            <input type="number" id="st-rate" placeholder="e.g., 8" min="0" step="0.01" class="form-input">
                        </div>

                        <button onclick="calculateSalesTax()" class="button button-primary" style="width: 100%;">
                            Calculate
                        </button>

                        <div id="st-result"></div>
                    </div>

                </div>

                <!-- Currency Converter Section -->
                <div style="background: #f9fafb; padding: 24px; border-radius: 12px; margin-bottom: 40px; border: 2px solid #e5e7eb;">
                    <h3 style="font-size: 18px; font-weight: 700; margin-top: 0; margin-bottom: 16px;">Currency Converter</h3>
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 16px; align-items: flex-end;">
                        <div>
                            <label class="form-label">From</label>
                            <select id="from" class="form-input" style="background: white;">
                                <option value="USD">USD - US Dollar</option>
                                <option value="KES">KES - Kenyan Shilling</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="GBP">GBP - British Pound</option>
                                <option value="JPY">JPY - Japanese Yen</option>
                            </select>
                        </div>
                        <div style="text-align: center; padding-bottom: 8px;">
                            <i data-lucide="arrow-right-left" style="width: 24px; height: 24px; color: #3b82f6;"></i>
                        </div>
                        <div>
                            <label class="form-label">To</label>
                            <select id="to" class="form-input" style="background: white;">
                                <option value="USD">USD - US Dollar</option>
                                <option value="KES">KES - Kenyan Shilling</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="GBP">GBP - British Pound</option>
                                <option value="JPY">JPY - Japanese Yen</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 16px; align-items: flex-end;">
                        <div style="flex: 1;">
                            <label class="form-label">Amount</label>
                            <input type="number" id="amount" class="form-input" placeholder="Enter amount" style="background: white;">
                        </div>
                        <button onclick="convert()" class="button button-primary" style="padding: 10px 24px; height: 44px;">Convert</button>
                    </div>
                    <div id="result" style="margin-top: 12px; font-weight: 600; color: #3b82f6;"></div>
                </div>
            </div>

            <!-- QR/Barcode Scanner Dialog -->
            <dialog id="scanner-dialog" style="width: 400px; max-width: 90vw;">
                <div class="modal-header">
                    <h3>Scanner</h3>
                    <button class="close-button" onclick="document.getElementById('scanner-dialog').close();">&times;</button>
                </div>
                
                <div id="scanner-container" style="width: 100%; margin: 20px 0;">
                    <div id="qr-reader" style="width: 100%;"></div>
                </div>
                
                <div id="scan-result" style="padding: 16px; background: #f3f4f6; border-radius: 8px; margin-bottom: 16px; display: none;">
                    <h4 style="margin: 0 0 8px 0;">Scan Result:</h4>
                    <p id="scan-result-text" style="margin: 0; font-weight: 600; word-break: break-all;"></p>
                </div>
                
                <button onclick="document.getElementById('scanner-dialog').close(); stopScanner();" class="button button-danger" style="width: 100%;">Close Scanner</button>
            </dialog>

        </div>
<div id="msgPage" class="page">
    <h1 style="position: relative; top: 100px;">Messages and Chat</h1>
    <div id="msgOutlay"></div>
    <input class="form-input inps" id="myMsg" style="position: fixed; bottom: 20px; width: 900px;">
    <button onclick="sendIt()" class="button-primary button" style="width: 50px; height: 50px; border-radius: 50%; position: fixed; bottom: 20px; right: 10px;">
        <i data-lucide="send"></i>
        <span></span>
    </button>
</div>
</div>
<!-- AI LAB PAGE -->
<div id="lab-page" class="page">
    <h2 class="section-heading">AI Business Lab</h2>
    
    <div class="kpi-grid">
        <div class="card card-primary">
            <p class="card-title">Sales Forecast (Next 30 Days)</p>
            <p id="forecast-revenue" class="card-value text-primary">$0.00</p>
            <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">AI-predicted revenue</p>
        </div>
        <div class="card card-secondary">
            <p class="card-title">Best Selling Product</p>
            <p id="best-product" class="card-value text-secondary" style="font-size: 20px;">-</p>
            <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">Top performer</p>
        </div>
        <div class="card card-orange">
            <p class="card-title">Optimal Price Suggestion</p>
            <p id="price-suggestion" class="card-value text-orange">-</p>
            <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">For best product</p>
        </div>
        <div class="card card-danger">
            <p class="card-title">Risk Score</p>
            <p id="risk-score" class="card-value text-danger">0%</p>
            <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">Business health</p>
        </div>
    </div>

    <!-- Smart Insights Box -->
    <div class="form-box" style="background: #fff;  margin-bottom: 24px;">
        <h3 class="form-box-title" style=" border-bottom-color: rgba(255,255,255,0.3); color: #000;">Smart Business Insights</h3>
        <div id="smart-insights" style="display: grid; gap: 12px;">
            <!-- Insights will be populated here -->
        </div>
    </div>

    <div class="form-layout-grid">
        <div class="form-box">
            <h3 class="form-box-title">Predictive Analytics</h3>
            <button onclick="runSalesForecast()" class="button button-primary" style="margin-bottom: 10px;">Generate Sales Forecast</button>
            <button onclick="analyzeTrends()" class="button button-secondary" style="margin-bottom: 10px;">Analyze Trends</button>
            <button onclick="optimizePricing()" class="button button-orange">Optimize Pricing</button>
            <div id="lab-insights" style="margin-top: 20px; padding: 16px; background: #f9fafb; border-radius: 8px; min-height: 100px;">
                <p style="color: #6b7280; text-align: center;">Click a button to generate AI insights</p>
            </div>
        </div>
        
        <div class="form-box">
            <h3 class="form-box-title">Product Recommendations</h3>
            <div id="product-recommendations" style="max-height: 400px; overflow-y: auto;">
                <p style="color: #6b7280; text-align: center; padding: 20px;">AI recommendations will appear here</p>
            </div>
        </div>
    </div>
    
    <div class="form-box" style="margin-top: 24px;">
        <h3 class="form-box-title">What-If Scenario Simulator</h3>
        <p style="color: #6b7280; margin-bottom: 16px;">Test how changes would impact your business</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
                <label class="form-label">Price Change (%)</label>
                <input type="number" id="whatif-price" placeholder="e.g., 10" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Sales Volume Change (%)</label>
                <input type="number" id="whatif-volume" placeholder="e.g., -5" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Cost Change (%)</label>
                <input type="number" id="whatif-cost" placeholder="e.g., 5" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">New Fixed Expense</label>
                <input type="number" id="whatif-expense" placeholder="e.g., 500" class="form-input">
            </div>
        </div>
        
        <button onclick="runWhatIfScenario()" class="button button-primary" style="width: 100%; margin-bottom: 16px;">Run Scenario</button>
        
        <div id="whatif-results" style="padding: 16px; background: #f9fafb; border-radius: 8px; display: none;">
            <h4 style="margin-top: 0; color: var(--color-primary);">Scenario Results</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                    <p style="margin: 4px 0; color: #6b7280;">Current Revenue:</p>
                    <p id="whatif-current-revenue" style="margin: 4px 0; font-weight: 600;">-</p>
                </div>
                <div>
                    <p style="margin: 4px 0; color: #6b7280;">Projected Revenue:</p>
                    <p id="whatif-new-revenue" style="margin: 4px 0; font-weight: 600;">-</p>
                </div>
                <div>
                    <p style="margin: 4px 0; color: #6b7280;">Current Profit:</p>
                    <p id="whatif-current-profit" style="margin: 4px 0; font-weight: 600;">-</p>
                </div>
                <div>
                    <p style="margin: 4px 0; color: #6b7280;">Projected Profit:</p>
                    <p id="whatif-new-profit" style="margin: 4px 0; font-weight: 600;">-</p>
                </div>
            </div>
            <div style="margin-top: 16px; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid var(--color-primary);">
                <p id="whatif-recommendation" style="margin: 0; font-weight: 600;">-</p>
            </div>
        </div>
    </div>
</div>

<div id="node-editor-page" class="page">
    <h2 class="section-heading">Node Editor</h2>
    
    <div class="form-box">
        <h3 class="form-box-title">Node Editor Controls</h3>
        <div style="display: flex; gap: 16px; margin-bottom: 16px;">
            <button onclick="addNode()" class="button button-primary">Add Node</button>
            <button onclick="saveNodes()" class="button button-secondary">Save Graph</button>
            <button onclick="loadNodes()" class="button button-secondary">Load Graph</button>
            <button onclick="clearNodes()" class="button button-danger">Clear All</button>
            <button onclick="exportGraph()" class="button button-secondary" title="Export graph as JSON"> Export</button>
            <button onclick="importGraph()" class="button button-secondary" title="Import graph from JSON"> Import</button>
        </div>
        <div id="status-message" style="padding: 10px; border-radius: 8px; margin-top: 10px; display: none;"></div>
    </div>
    
    <div id="graph-container">
        <div id="graph-area">
            <svg id="connectionsSvg"></svg>
        </div>
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn()" title="Zoom In"></button>
            <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out"></button>
            <button class="zoom-btn" onclick="resetZoom()" title="Reset Zoom"></button>
        </div>
        <canvas id="minimap" class="minimap"></canvas>
    </div>
    
    <div id="context-menu">
        <button class="menu-item" onclick="renameNode()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
            Rename
        </button>
        <button class="menu-item" onclick="editDescription()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
            Edit Description
        </button>
        <button class="menu-item" onclick="startConnection()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
            Connect to Node
        </button>
        <div class="menu-divider"></div>
        <button class="menu-item menu-item-delete" onclick="deleteNodeFromMenu()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
            Delete
        </button>
    </div>
</div>
   
   <!-- MARKETPLACE PAGE -->
<div id="marketplace-page" class="page">
    <h2 class="section-heading">Marketplace</h2>
    
    <div class="kpi-grid">
        <div class="card card-primary">
            <p class="card-title">Posted Products</p>
            <p id="posted-products-count" class="card-value text-primary">0</p>
        </div>
        <div class="card card-secondary">
            <p class="card-title">Total Orders</p>
            <p id="total-orders-count" class="card-value text-secondary">0</p>
        </div>
        <div class="card card-orange">
            <p class="card-title">Pending Orders</p>
            <p id="pending-orders-count" class="card-value text-orange">0</p>
        </div>
        <div class="card card-danger">
            <p class="card-title">Delivered Orders</p>
            <p id="delivered-orders-count" class="card-value text-danger">0</p>
        </div>
    </div>
    
    <div class="chart-tabs" style="margin-bottom: 20px;">
        <button onclick="showPage('marketplace-page')" class="ptb active">Marketplace</button>
        <button onclick="showPage('marketplace-my-orders'); renderMyOrders();" class="ptb">My Orders</button>
        <button onclick="showPage('marketplace-order-management'); filterOrderManagement();" class="ptb">Order Management</button>
    </div>

    <div style="display: flex; gap: 12px; margin-bottom: 20px;">
        <button onclick="document.getElementById('post-product-dialog').showModal()" class="button button-primary" >Post Product</button>
        <button onclick="document.getElementById('post-service-dialog').showModal()" class="button button-primary" >Post Service</button>
        <button onclick="document.getElementById('post-all-products-dialog').showModal()" class="button button-orange" >Post All Unposted</button>
    </div>
    
    <div class="form-box">
        <h3 class="form-box-title">Marketplace Products</h3>
        <div style="display: flex; gap: 16px; margin-bottom: 16px;">
            <input type="search" id="marketplace-search" class="form-input" placeholder="Search products..." style="flex: 1;" oninput="filterMarketplaceProducts()">
            <select id="marketplace-category-filter" class="form-input" style="width: 200px;" onchange="filterMarketplaceProducts()">
                <option value="">All Categories</option>
                <option value="Electronics">Electronics</option>
                <option value="Clothing">Clothing</option>
                <option value="Food">Food</option>
                <option value="Books">Books</option>
                <option value="Other">Other</option>
            </select>
            <select id="marketplace-sort" class="form-input" style="width: 200px;" onchange="sortMarketplaceProducts()">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="price-low">Price: Low to High</option>
                <option value="price-high">Price: High to Low</option>
            </select>
        </div>
        <div id="marketplace-products-grid" class="products-grid">
            <!-- Products will be rendered here -->
        </div>
    </div>
</div>

<!-- MY ORDERS PAGE -->
<div id="marketplace-my-orders" class="page">
    <h2 class="section-heading">My Orders</h2>
    
    <div class="chart-tabs" style="margin-bottom: 20px;">
        <button onclick="showPage('marketplace-page')" class="ptb">Marketplace</button>
        <button onclick="showPage('marketplace-my-orders'); renderMyOrders();" class="ptb active">My Orders</button>
        <button onclick="showPage('marketplace-order-management'); filterOrderManagement();" class="ptb">Order Management</button>
    </div>

    <div class="form-box">
        <div class="form-group">
            <label for="orders-filter" class="form-label">Filter Orders</label>
            <select id="orders-filter" class="form-input" onchange="filterMyOrders()">
                <option value="all">All Orders</option>
                <option value="ordered">Ordered</option>
                <option value="delivered">Delivered</option>
            </select>
        </div>
        <div id="my-orders-list" class="list-container">
            <!-- Orders will be rendered here -->
        </div>
    </div>
</div>

<!-- ORDER MANAGEMENT PAGE -->
<div id="marketplace-order-management" class="page">
    <h2 class="section-heading">Order & Delivery Management</h2>
    
    <div class="chart-tabs" style="margin-bottom: 20px;">
        <button onclick="showPage('marketplace-page')" class="ptb">Marketplace</button>
        <button onclick="showPage('marketplace-my-orders'); renderMyOrders();" class="ptb">My Orders</button>
        <button onclick="showPage('marketplace-order-management'); filterOrderManagement();" class="ptb active">Order Management</button>
    </div>

    <div class="form-box" style="height: calc(100vh - 250px);">
        <div style="display: flex; gap: 20px; height: 100%;">
            <div style="flex: 1; display: flex; flex-direction: column;">
                <h4 style="margin-top: 0;">Orders</h4>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <select id="order-filter-type" class="form-input" onchange="filterOrderManagement()" style="flex: 1;">
                        <option value="all">All Orders</option>
                        <option value="pending">Pending Orders</option>
                        <option value="delivered">Delivered Orders</option>
                        <option value="my-orders">My Orders</option>
                    </select>
                </div>
                <div id="order-management-list" style="flex: 1; overflow-y: auto; border: 1px solid var(--color-border-light); border-radius: 8px; padding: 12px;">
                    <!-- Orders will be rendered here -->
                </div>
            </div>
            <div style="flex: 1; display: flex; flex-direction: column;">
                <h4 style="margin-top: 0;">Asset Bids</h4>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="document.getElementById('post-asset-dialog').showModal()" class="button button-primary" style="flex: 1;">Post Asset</button>
                </div>
                <div id="asset-bids-list" style="flex: 1; overflow-y: auto; border: 1px solid var(--color-border-light); border-radius: 8px; padding: 12px;">
                    <!-- Asset bids will be rendered here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- BUSINESS SHOWCASE HUB PAGE -->
<div id="business-showcase-page" class="page">
    <h2 class="section-heading">Business Showcase</h2>
    
    <div class="form-box">
        <h3 class="form-box-title">Discover Businesses</h3>
        <div class="business-search-filters">
            <input type="search" id="business-search" class="form-input" placeholder="Search businesses..." oninput="filterBusinesses()">
            <select id="business-category-filter" class="form-input" onchange="filterBusinesses()">
                <option value="">All Categories</option>
                <option value="Retail">Retail</option>
                <option value="Technology">Technology</option>
                <option value="Services">Services</option>
                <option value="Food & Beverage">Food & Beverage</option>
                <option value="Manufacturing">Manufacturing</option>
                <option value="Other">Other</option>
            </select>
        </div>
        <div id="businesses-grid" class="businesses-grid">
            <!-- Businesses will be rendered here -->
        </div>
        <div id="no-businesses-message" class="no-businesses" style="display: none;">
            No businesses found matching your search.
        </div>
    </div>
</div>

<!-- BUSINESS DETAIL PAGE -->
<div id="business-detail-page" class="page">
    <div class="back-button-wrapper">
        <button class="back-button" onclick="showPage('business-showcase-page')">
            <span> Back</span>
        </button>
    </div>
    
    <div class="business-detail-header">
        <div class="business-detail-top">
            <div class="business-detail-logo">
                <img id="detail-business-logo" src="" alt="Business Logo">
            </div>
            <div class="business-detail-info">
                <h1 class="business-detail-name" id="detail-business-name"></h1>
                <p class="business-detail-owner" id="detail-business-owner"></p>
                <span class="business-detail-category" id="detail-business-category"></span>
                <p class="business-detail-description" id="detail-business-description"></p>
            </div>
        </div>
    </div>
    
    <div class="services-section">
        <h3>Products & Services</h3>
        <div id="business-products-grid" class="products-grid">
            <!-- Products and services will be rendered here -->
        </div>
        <div id="no-products-message" class="no-businesses" style="display: none;">
            This business has no public products or services yet.
        </div>
    </div>
</div>

<!-- POST PRODUCT DIALOG -->
<dialog id="post-product-dialog" style="width: 500px;">
    <div class="modal-header">
        <h3>Post Product to Marketplace</h3>
        <button class="close-button" onclick="document.getElementById('post-product-dialog').close()">&times;</button>
    </div>
    <div class="form-group">
        <label for="post-product-select" class="form-label">Select Product</label>
        <select id="post-product-select" class="form-input" onchange="updatePostProductDetails()">
            <option value="">Select a product...</option>
        </select>
    </div>
    <div class="form-group">
        <label for="post-product-name" class="form-label">Product Name</label>
        <input type="text" id="post-product-name" class="form-input" readonly>
    </div>
    <div class="form-group">
        <label for="post-product-category" class="form-label">Category</label>
        <select id="post-product-category" class="form-input">
            <option value="Electronics">Electronics</option>
            <option value="Clothing">Clothing</option>
            <option value="Food">Food</option>
            <option value="Books">Books</option>
            <option value="Other">Other</option>
        </select>
    </div>
    <div class="form-group">
        <label for="post-product-price" class="form-label">Price</label>
        <input type="number" id="post-product-price" class="form-input" readonly>
    </div>
    <div class="form-group">
        <label for="post-product-stock" class="form-label">Available Stock</label>
        <input type="number" id="post-product-stock" class="form-input" readonly>
    </div>
    <div class="form-group">
        <label for="post-product-description" class="form-label">Description</label>
        <textarea id="post-product-description" class="form-input" rows="3"></textarea>
    </div>
    <div class="form-group">
        <label for="post-product-image" class="form-label">Product Image</label>
        <input type="file" id="post-product-image" class="form-input" accept="image/*">
    </div>
    <button onclick="postProductToMarketplace()" class="button button-primary">Post Product</button>
    <button onclick="document.getElementById('post-product-dialog').close()" class="button button-danger">Cancel</button>
</dialog>

<!-- POST SERVICE DIALOG -->
<dialog id="post-service-dialog" style="width: 500px;">
    <div class="modal-header">
        <h3>Post Service to Marketplace</h3>
        <button class="close-button" onclick="document.getElementById('post-service-dialog').close()">&times;</button>
    </div>
    <div class="form-group">
        <label for="post-service-name" class="form-label">Service Name</label>
        <input type="text" id="post-service-name" class="form-input" placeholder="Enter service name">
    </div>
    <div class="form-group">
        <label for="post-service-category" class="form-label">Category</label>
        <select id="post-service-category" class="form-input">
            <option value="Consulting">Consulting</option>
            <option value="Design">Design</option>
            <option value="Development">Development</option>
            <option value="Marketing">Marketing</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Other">Other</option>
        </select>
    </div>
    <div class="form-group">
        <label for="post-service-price" class="form-label">Service Price</label>
        <input type="number" id="post-service-price" class="form-input" placeholder="Enter service price" min="0.01" step="0.01">
    </div>
    <div class="form-group">
        <label for="post-service-duration" class="form-label">Duration (hours)</label>
        <input type="number" id="post-service-duration" class="form-input" placeholder="Enter duration" min="0.5" step="0.5">
    </div>
    <div class="form-group">
        <label for="post-service-description" class="form-label">Description</label>
        <textarea id="post-service-description" class="form-input" rows="3" placeholder="Describe your service"></textarea>
    </div>
    <button onclick="postServiceToMarketplace()" class="button button-primary">Post Service</button>
    <button onclick="document.getElementById('post-service-dialog').close()" class="button button-danger">Cancel</button>
</dialog>

<!-- ORDER PRODUCT DIALOG -->
<dialog id="order-product-dialog" style="width: 600px; max-height: 90vh; overflow-y: auto;">
    <div class="modal-header">
        <h3>Order Product</h3>
        <button class="close-button" onclick="document.getElementById('order-product-dialog').close()">&times;</button>
    </div>
    <input type="hidden" id="order-product-id">
    <div class="form-group">
        <label for="order-product-name" class="form-label">Product</label>
        <input type="text" id="order-product-name" class="form-input" readonly>
    </div>
    <div class="form-group">
        <label for="order-product-price" class="form-label">Price</label>
        <input type="number" id="order-product-price" class="form-input" readonly>
    </div>
    <div class="form-group">
        <label for="order-quantity" class="form-label">Quantity</label>
        <input type="number" id="order-quantity" class="form-input" min="1" value="1">
    </div>
    <div class="form-group">
        <label for="order-customer-name" class="form-label">Name (Pickup Person)</label>
        <input type="text" id="order-customer-name" class="form-input" placeholder="Enter name of person picking up product">
    </div>
    <div class="form-group">
        <label for="order-customer-email" class="form-label">Email</label>
        <input type="email" id="order-customer-email" class="form-input" placeholder="Enter email address">
    </div>
    <div class="form-group">
        <label for="order-customer-phone" class="form-label">Phone Number</label>
        <input type="tel" id="order-customer-phone" class="form-input" placeholder="Enter phone number">
    </div>
    <div class="form-group">
        <label for="order-pickup-location" class="form-label">Pickup Location</label>
        <input type="text" id="order-pickup-location" class="form-input" placeholder="Enter pickup location">
    </div>
    <div style="border-top: 1px solid var(--color-border-light); padding-top: 15px; margin-top: 15px;">
        <h4 style="margin-top: 0;">Payment Details</h4>
        <div class="form-group">
            <label for="order-total-price" class="form-label">Total Price</label>
            <input type="number" id="order-total-price" class="form-input" readonly>
        </div>
        <div class="form-group">
            <label for="order-downpayment" class="form-label">Down Payment Amount</label>
            <input type="number" id="order-downpayment" class="form-input" placeholder="Enter down payment" min="0" step="0.01" oninput="calculateRemainingBalance()">
        </div>
        <div class="form-group">
            <label for="order-remaining-balance" class="form-label">Remaining Balance</label>
            <input type="number" id="order-remaining-balance" class="form-input" readonly>
        </div>
        <div class="form-group">
            <label for="order-installation-plan" class="form-label">Installation Plan</label>
            <select id="order-installation-plan" class="form-input" onchange="updateInstallmentInfo()">
                <option value="">No Installments (Pay in full)</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="half-yearly">Half-Yearly</option>
                <option value="yearly">Yearly</option>
            </select>
        </div>
        <div class="form-group">
            <label for="order-payment-per-installation" class="form-label">Payment Per Installation</label>
            <input type="number" id="order-payment-per-installation" class="form-input" placeholder="Amount per installment" min="0" step="0.01">
        </div>
        <div id="installment-info" style="background: #f3f4f6; padding: 12px; border-radius: 6px; margin-top: 12px; display: none;">
            <p id="installment-details" style="margin: 0; font-size: 14px;"></p>
        </div>
    </div>
    <div class="form-group">
        <label for="order-notes" class="form-label">Additional Notes</label>
        <textarea id="order-notes" class="form-input" rows="2" placeholder="Any special requests or notes"></textarea>
    </div>
    <button onclick="submitOrder()" class="button button-primary">Place Order</button>
    <button onclick="document.getElementById('order-product-dialog').close()" class="button button-danger">Cancel</button>
</dialog>



<!-- ORDER DETAILS DIALOG -->
<dialog id="order-details-dialog" style="width: 500px;">
    <div class="modal-header">
        <h3>Order Details</h3>
        <button class="close-button" onclick="document.getElementById('order-details-dialog').close()">&times;</button>
    </div>
    <input type="hidden" id="order-details-id">
    <div id="order-details-content">
        <!-- Order details will be rendered here -->
    </div>
    <div id="order-actions">
        <!-- Order actions will be rendered here -->
    </div>
</dialog>

<!-- DELIVERY CONFIRMATION DIALOG -->
<dialog id="delivery-confirmation-dialog" style="width: 400px;">
    <div class="modal-header">
        <h3>Delivery Confirmation</h3>
        <button class="close-button" onclick="document.getElementById('delivery-confirmation-dialog').close()">&times;</button>
    </div>
    <p id="delivery-confirmation-message" style="margin-bottom: 20px;">
        <!-- Confirmation message will be rendered here -->
    </p>
    <div style="display: flex; gap: 12px;">
        <button onclick="confirmDelivery()" class="button button-primary">Yes, Delivered</button>
        <button onclick="document.getElementById('delivery-confirmation-dialog').close()" class="button button-danger">No</button>
    </div>
</dialog>

<!-- POST ALL UNPOSTED PRODUCTS DIALOG -->
<dialog id="post-all-products-dialog" style="width: 500px;">
    <div class="modal-header">
        <h3>Post All Unposted Products</h3>
        <button class="close-button" onclick="document.getElementById('post-all-products-dialog').close()">&times;</button>
    </div>
    <p style="margin-bottom: 20px;">Do you want to post all unposted products from your catalog to the marketplace?</p>
    <div id="unposted-products-preview" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--color-border-light); padding: 12px; border-radius: 8px; margin-bottom: 20px;">
        <!-- Unposted products will be listed here -->
    </div>
    <div style="display: flex; gap: 12px;">
        <button onclick="postAllUnpostedProducts()" class="button button-primary">Yes, Post All</button>
        <button onclick="document.getElementById('post-all-products-dialog').close()" class="button button-danger">Cancel</button>
    </div>
</dialog>



<!-- POST ASSET DIALOG -->
<dialog id="post-asset-dialog" style="width: 500px;">
    <div class="modal-header">
        <h3>Post Asset for Bidding</h3>
        <button class="close-button" onclick="document.getElementById('post-asset-dialog').close()">&times;</button>
    </div>
    <div class="form-group">
        <label for="asset-name" class="form-label">Asset Name</label>
        <input type="text" id="asset-name" class="form-input" placeholder="Enter asset name">
    </div>
    <div class="form-group">
        <label for="asset-description" class="form-label">Description</label>
        <textarea id="asset-description" class="form-input" rows="3" placeholder="Describe the asset"></textarea>
    </div>
    <div class="form-group">
        <label for="asset-starting-bid" class="form-label">Starting Bid</label>
        <input type="number" id="asset-starting-bid" class="form-input" placeholder="Enter starting bid amount" min="0.01" step="0.01">
    </div>
    <div class="form-group">
        <label for="asset-image" class="form-label">Asset Image</label>
        <input type="file" id="asset-image" class="form-input" accept="image/*">
    </div>
    <button onclick="postAsset()" class="button button-primary">Post Asset</button>
    <button onclick="document.getElementById('post-asset-dialog').close()" class="button button-danger">Cancel</button>
</dialog>
    
<!--Export Data Page-->
<div id="exportPage" class="page">
    <h1 style="position: absolute; top: 100px;">Export Data</h1>
    <div class="form-box">
    <button 
    class="button button-secondary"
    onclick="exportAllData()"
    style="position: absolute; top: 200px; width: 340px;">Export Data</button>
    </div>
</div>

<!-- GOALS PAGE -->
<div id="goals-page" class="page">
    <h2 class="section-heading">Goal Tracking</h2>
    
    <div class="kpi-grid">
        <div class="card card-primary">
            <p class="card-title">Active Goals</p>
            <p id="active-goals-count" class="card-value text-primary">0</p>
        </div>
        <div class="card card-secondary">
            <p class="card-title">Completed Goals</p>
            <p id="completed-goals-count" class="card-value text-secondary">0</p>
        </div>
        <div class="card card-orange">
            <p class="card-title">Average Progress</p>
            <p id="avg-progress" class="card-value text-orange">0%</p>
        </div>
    </div>
    
    <div class="form-box" style="margin-bottom: 24px;">
        <h3 class="form-box-title">Create New Goal</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div class="form-group">
                <label class="form-label">Goal Type</label>
                <select id="goal-type" class="form-input">
                    <option value="revenue">Revenue Target</option>
                    <option value="profit">Profit Target</option>
                    <option value="sales">Sales Volume</option>
                    <option value="custom">Custom Goal</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Target Amount</label>
                <input type="number" id="goal-target" placeholder="e.g., 10000" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Goal Name</label>
                <input type="text" id="goal-name" placeholder="e.g., Q1 Revenue" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Deadline</label>
                <input type="date" id="goal-deadline" class="form-input">
            </div>
        </div>
        <button onclick="createGoal()" class="button button-primary" style="width: 100%;">Create Goal</button>
    </div>
    
    <div class="form-box">
        <h3 class="form-box-title">Your Goals</h3>
        <div id="goals-list" style="max-height: 500px; overflow-y: auto;"></div>
    </div>
</div>

<!-- POS PAGE -->
<div id="pos-page" class="page">
    <h2 class="section-heading">Point of Sale</h2>
    
    <div class="pos-mode-buttons">
        <button onclick="setPOSMode('products')" id="pos-products-btn" class="button button-primary">Products</button>
        <button onclick="setPOSMode('services')" id="pos-services-btn" class="button button-secondary">Services</button>
        <button onclick="openPOSScanner()" id="pos-scan-btn" class="button button-secondary" style="background-color: #8b5cf6;">Scan Barcode</button>
    </div>
    
    <div class="form-layout-grid">
        <div class="form-box">
            <h3 class="form-box-title" id="pos-items-title">Products</h3>
            <input type="search" id="pos-search" class="form-input" placeholder="Search products..." oninput="filterPOSItems()" style="margin-bottom: 16px;">
            <div id="pos-products-grid"></div>
        </div>
        
        <div class="form-box">
            <h3 class="form-box-title">Shopping Cart</h3>
            <div id="pos-cart">
                <p style="text-align: center; color: #9ca3af; padding: 20px;">Cart is empty</p>
            </div>
            
            <div class="pos-cart-summary">
                <div class="pos-summary-row">
                    <span>Subtotal:</span>
                    <span id="pos-subtotal">$0.00</span>
                </div>
                <div class="pos-summary-row total">
                    <span>Total:</span>
                    <span id="pos-total">$0.00</span>
                </div>
                
                <button onclick="completePOSSale()" class="button button-primary" style="width: 100%; margin-bottom: 8px;"> Complete Sale</button>
                <button onclick="clearPOSCart()" class="button button-danger" style="width: 100%;">Clear Cart</button>
            </div>
        </div>
    </div>
    
    <!-- Customer Selection Dialog -->
    <dialog id="customer-selection-dialog" style="width: 500px; border-radius: 12px;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">Select Customer for Sale</h3>
            <button class="close-button" onclick="document.getElementById('customer-selection-dialog').close();">&times;</button>
        </div>
        
        <div class="form-group">
            <label class="form-label">Customer Name:</label>
            <input id="pos-customer-search" placeholder="Type customer name or select from list..." class="form-input" style="width: 100%; margin-bottom: 10px;" oninput="filterPOSCustomers()">
        </div>
        
        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; margin-bottom: 20px;">
            <div id="pos-customers-list">
                <p style="text-align: center; color: #9ca3af;">No customers found</p>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Or Create New Customer:</label>
            <input id="pos-new-customer-name" placeholder="Customer name for this sale" class="form-input" style="width: 100%; margin-bottom: 10px;">
        </div>
        
        <div class="form-group">
            <label class="form-label">Amount Paid:</label>
            <input id="pos-amount-paid" type="number" placeholder="Amount paid" class="form-input" style="width: 100%; margin-bottom: 10px;">
        </div>
        
        <div class="form-group">
            <label class="form-label">Transaction Tool:</label>
            <select id="pos-transaction-tool" class="form-input" style="width: 100%; margin-bottom: 10px;">
                <!-- Options populated by JS -->
            </select>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button class="button button-primary" onclick="confirmPOSSaleCustomer()" style="flex: 1;">Record Sale</button>
            <button class="button button-danger" onclick="document.getElementById('customer-selection-dialog').close()" style="flex: 1;">Cancel</button>
        </div>
    </dialog>

    <!-- POS Scanner Dialog -->
    <dialog id="pos-scanner-dialog" style="width: 600px; border-radius: 12px;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">Scan Product Barcode</h3>
            <button class="close-button" onclick="closePOSScanner()">&times;</button>
        </div>
        
        <div id="pos-scanner-reader" style="width: 100%; min-height: 300px; background: #000; border-radius: 8px; overflow: hidden;"></div>
        <p id="pos-scanner-status" style="text-align: center; margin-top: 10px; color: #6b7280;">Camera loading...</p>
        
        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button class="button button-primary" onclick="completePOSSale()" style="flex: 1;">Complete Transaction</button>
            <button class="button button-danger" onclick="closePOSScanner()" style="flex: 1;">Cancel</button>
        </div>
    </dialog>
</div>
<div id="community-page" class="page">
    <h2 class="section-heading">Business Communities</h2>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <p style="color: #6b7280; margin: 0;">Create and manage business communities</p>
        <button onclick="openCreateCommunityDialog()" class="button button-primary" style="width: auto; padding: 12px 24px;">
            <i data-lucide="plus" style="width: 18px; height: 18px; margin-right: 8px;"></i>
            Create Community
        </button>
    </div>

    <div id="communities-grid" class="businesses-grid"></div>
</div>

<!-- Create Community Dialog -->
<dialog id="create-community-dialog">
    <div class="modal-header">
        <h3>Create New Community</h3>
        <button class="close-button" onclick="document.getElementById('create-community-dialog').close();"></button>
    </div>
    
    <div style="padding: 20px;">
        <div class="form-group">
            <label class="form-label">Community Name</label>
            <input type="text" id="community-name-input" class="form-input" placeholder="Enter community name">
        </div>
        
        <div class="form-group">
            <label class="form-label">Description</label>
            <textarea id="community-desc-input" class="form-input" rows="3" placeholder="Describe your community"></textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label">Select Businesses</label>
            <div id="business-selection-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px;">
                <!-- Businesses will be populated here -->
            </div>
        </div>
        
        <button onclick="createCommunity()" class="button button-primary">Create Community</button>
    </div>
</dialog>

<!-- View Community Dialog -->
<dialog id="view-community-dialog">
    <div class="modal-header">
        <h3 id="view-community-title">Community Details</h3>
        <button class="close-button" onclick="document.getElementById('view-community-dialog').close();"></button>
    </div>
    
    <div id="view-community-content" style="padding: 20px;"></div>
</dialog>

<!-- SERVICES PAGE -->
<div id="services-page" class="page">
    <h2 class="section-heading">Services Management</h2>
    
    <div class="kpi-grid">
        <div class="card card-primary">
            <p class="card-title">Total Services</p>
            <p id="total-services-count" class="card-value text-primary">0</p>
        </div>
        <div class="card card-secondary">
            <p class="card-title">Services Revenue</p>
            <p id="services-revenue" class="card-value text-secondary">$0.00</p>
        </div>
        <div class="card card-orange">
            <p class="card-title">Services Completed</p>
            <p id="services-completed" class="card-value text-orange">0</p>
        </div>
    </div>
    
    <button onclick="document.getElementById('new-service-dialog').showModal()" class="button button-primary" style="width: 200px; margin-bottom: 20px;">+ New Service</button>
    
    <div class="form-box" style="width: 100%;">
        <input type="search" class="form-input" style="width: 100%; height: 30px; margin-bottom: 10px;" id="services-search" placeholder="Search services..." oninput="filterServices()">
        <h3 class="form-box-title">Available Services</h3>
        <div id="services-list" class="list-container"></div>
    </div>
    
    <div class="form-box" style="width: 100%; margin-top: 24px;">
        <h3 class="form-box-title">Service History</h3>
        <div id="service-history-list" class="list-container"></div>
    </div>
</div>

<dialog id="new-service-dialog" style="width: 450px;">
    <h3>Add New Service</h3>
    <div class="form-group">
        <label for="new-service-name" class="form-label">Service Name</label>
        <input type="text" id="new-service-name" placeholder="e.g., Haircut, Consultation" class="form-input">
    </div>
    <div class="form-group">
        <label for="new-service-category" class="form-label">Category</label>
        <select id="new-service-category" class="form-input">
            <option value="General">General</option>
            <option value="Beauty">Beauty</option>
            <option value="Health">Health</option>
            <option value="Consulting">Consulting</option>
            <option value="Maintenance">Maintenance</option>
        </select>
    </div>
    <div class="form-group">
        <label for="new-service-price" class="form-label">Service Price</label>
        <input type="number" id="new-service-price" placeholder="50.00" min="0" step="0.01" class="form-input">
    </div>
    <div class="form-group">
        <label for="new-service-duration" class="form-label">Duration (minutes)</label>
        <input type="number" id="new-service-duration" placeholder="30" min="1" class="form-input">
    </div>
    <div class="form-group">
        <label for="new-service-description" class="form-label">Description</label>
        <textarea id="new-service-description" placeholder="Service details..." class="form-input" rows="3"></textarea>
    </div>
    <button onclick="addService()" class="button button-primary" style="margin-bottom: 10px;">Add Service</button>
    <button onclick="document.getElementById('new-service-dialog').close()" class="button button-danger">Cancel</button>
</dialog>

<script>
    // Community Management System
let communities = JSON.parse(localStorage.getItem('epsilonAproxi_communities') || '[]');

// Sample businesses data (you can replace this with your actual business data)
let sampleBusinesses = [
    { id: 1, name: 'Tech Solutions Inc', category: 'Technology' },
    { id: 2, name: 'Green Foods Market', category: 'Retail' },
    { id: 3, name: 'Design Studio Pro', category: 'Services' },
    { id: 4, name: 'Finance Advisors', category: 'Finance' },
    { id: 5, name: 'Health Plus Clinic', category: 'Healthcare' }
];

function saveCommunities() {
    localStorage.setItem('epsilonAproxi_communities', JSON.stringify(communities));
    renderCommunities();
}

function openCreateCommunityDialog() {
    const dialog = document.getElementById('create-community-dialog');
    populateBusinessSelection();
    dialog.showModal();
    setTimeout(() => lucide.createIcons(), 50);
}

function populateBusinessSelection() {
    const container = document.getElementById('business-selection-list');
    container.innerHTML = sampleBusinesses.map(business => `
        <label style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 6px; transition: background 0.2s;" 
               onmouseover="this.style.background='#f3f4f6'" 
               onmouseout="this.style.background='transparent'">
            <input type="checkbox" value="${business.id}" style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;">
            <div>
                <div style="font-weight: 600; color: #1f2937;">${business.name}</div>
                <div style="font-size: 12px; color: #6b7280;">${business.category}</div>
            </div>
        </label>
    `).join('');
}

function createCommunity() {
    const name = document.getElementById('community-name-input').value.trim();
    const description = document.getElementById('community-desc-input').value.trim();
    const selectedBusinesses = Array.from(document.querySelectorAll('#business-selection-list input:checked'))
        .map(cb => {
            const business = sampleBusinesses.find(b => b.id == cb.value);
            return business;
        });
    
    if (!name) {
        alert('Please enter a community name');
        return;
    }
    
    if (selectedBusinesses.length === 0) {
        alert('Please select at least one business');
        return;
    }
    
    const community = {
        id: Date.now(),
        name: name,
        description: description,
        businesses: selectedBusinesses,
        createdAt: new Date().toISOString(),
        memberCount: selectedBusinesses.length
    };
    
    communities.push(community);
    saveCommunities();
    
    document.getElementById('community-name-input').value = '';
    document.getElementById('community-desc-input').value = '';
    document.getElementById('create-community-dialog').close();
    
    showMessage('Community created successfully!', 'success');
}

function renderCommunities() {
    const container = document.getElementById('communities-grid');
    
    if (communities.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
                <i data-lucide="users-round" style="width: 64px; height: 64px; color: #d1d5db; margin-bottom: 16px;"></i>
                <h3 style="color: #6b7280; font-size: 18px; margin: 0;">No communities yet</h3>
                <p style="color: #9ca3af; margin: 8px 0 0 0;">Create your first community to get started</p>
            </div>
        `;
        setTimeout(() => lucide.createIcons(), 50);
        return;
    }
    
    container.innerHTML = communities.map(community => `
        <div class="community-card" onclick="viewCommunity(${community.id})">
            <div class="community-header">
                <h3 class="community-name">${community.name}</h3>
                <button onclick="event.stopPropagation(); deleteCommunity(${community.id})" 
                        style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 4px;">
                    <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
                </button>
            </div>
            
            <p class="community-members">${community.memberCount} business${community.memberCount !== 1 ? 'es' : ''}</p>
            
            ${community.description ? `<p style="font-size: 14px; color: #6b7280; margin-bottom: 16px;">${community.description}</p>` : ''}
            
            <div class="community-businesses">
                ${community.businesses.slice(0, 3).map(b => `
                    <span class="business-tag">${b.name}</span>
                `).join('')}
                ${community.businesses.length > 3 ? `<span class="business-tag">+${community.businesses.length - 3} more</span>` : ''}
            </div>
        </div>
    `).join('');
    
    setTimeout(() => lucide.createIcons(), 50);
}

function viewCommunity(id) {
    const community = communities.find(c => c.id === id);
    if (!community) return;
    
    const dialog = document.getElementById('view-community-dialog');
    document.getElementById('view-community-title').textContent = community.name;
    
    const content = document.getElementById('view-community-content');
    content.innerHTML = `
        ${community.description ? `<p style="color: #6b7280; margin-bottom: 24px;">${community.description}</p>` : ''}
        
        <div style="margin-bottom: 16px;">
            <h4 style="font-size: 16px; font-weight: 600; color: #1f2937; margin-bottom: 12px;">
                Member Businesses (${community.businesses.length})
            </h4>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                ${community.businesses.map(b => `
                    <div style="padding: 12px; background: #f9fafb; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: #1f2937;">${b.name}</div>
                            <div style="font-size: 12px; color: #6b7280;">${b.category}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 24px;">
            <button onclick="editCommunity(${community.id})" class="button button-primary" style="width: auto; padding: 10px 20px;">
                Edit Community
            </button>
            <button onclick="deleteCommunity(${community.id}); document.getElementById('view-community-dialog').close();" 
                    class="button button-danger" style="width: auto; padding: 10px 20px;">
                Delete Community
            </button>
        </div>
    `;
    
    dialog.showModal();
}

function editCommunity(id) {
    const community = communities.find(c => c.id === id);
    if (!community) return;
    
    document.getElementById('view-community-dialog').close();
    
    document.getElementById('community-name-input').value = community.name;
    document.getElementById('community-desc-input').value = community.description || '';
    
    populateBusinessSelection();
    
    // Pre-select businesses
    setTimeout(() => {
        community.businesses.forEach(business => {
            const checkbox = document.querySelector(`#business-selection-list input[value="${business.id}"]`);
            if (checkbox) checkbox.checked = true;
        });
    }, 50);
    
    // Change create button to update
    const dialog = document.getElementById('create-community-dialog');
    const createBtn = dialog.querySelector('.button-primary');
    createBtn.textContent = 'Update Community';
    createBtn.onclick = () => updateCommunity(id);
    
    dialog.showModal();
}

function updateCommunity(id) {
    const name = document.getElementById('community-name-input').value.trim();
    const description = document.getElementById('community-desc-input').value.trim();
    const selectedBusinesses = Array.from(document.querySelectorAll('#business-selection-list input:checked'))
        .map(cb => sampleBusinesses.find(b => b.id == cb.value));
    
    if (!name || selectedBusinesses.length === 0) {
        alert('Please fill all required fields');
        return;
    }
    
    const index = communities.findIndex(c => c.id === id);
    if (index !== -1) {
        communities[index] = {
            ...communities[index],
            name: name,
            description: description,
            businesses: selectedBusinesses,
            memberCount: selectedBusinesses.length
        };
        
        saveCommunities();
        document.getElementById('create-community-dialog').close();
        showMessage('Community updated successfully!', 'success');
        
        // Reset button
        const dialog = document.getElementById('create-community-dialog');
        const createBtn = dialog.querySelector('.button-primary');
        createBtn.textContent = 'Create Community';
        createBtn.onclick = createCommunity;
    }
}

function deleteCommunity(id) {
    if (confirm('Are you sure you want to delete this community?')) {
        communities = communities.filter(c => c.id !== id);
        saveCommunities();
        showMessage('Community deleted successfully!', 'success');
    }
}

// Initialize communities on page load
if (typeof window.onload === 'function') {
    const originalOnload = window.onload;
    window.onload = function() {
        originalOnload();
        renderCommunities();
    };
} else {
    window.onload = function() {
        renderCommunities();
    };
}
// Services Management
let services = JSON.parse(localStorage.getItem('epsilonAproxi_services') || '[]');
//let serviceHistory = JSON.parse(localStorage.getItem('epsilonAproxi_serviceHistory') || '[]');

function addService() {
    const name = document.getElementById('new-service-name').value.trim();
    const category = document.getElementById('new-service-category').value;
    const price = parseFloat(document.getElementById('new-service-price').value);
    const duration = parseInt(document.getElementById('new-service-duration').value);
    const description = document.getElementById('new-service-description').value.trim();
    
    if (!name || !price || !duration) {
        alert('Please fill in all required fields');
        return;
    }
    
    const service = {
        id: Date.now(),
        name,
        category,
        price,
        duration,
        description,
        createdAt: new Date().toISOString()
    };
    
    services.push(service);
    localStorage.setItem('epsilonAproxi_services', JSON.stringify(services));
    
    document.getElementById('new-service-name').value = '';
    document.getElementById('new-service-price').value = '';
    document.getElementById('new-service-duration').value = '';
    document.getElementById('new-service-description').value = '';
    document.getElementById('new-service-dialog').close();
    
    renderServices();
    updateServicesStats();
}

function renderServices() {
    const list = document.getElementById('services-list');
    if (!list) return;
    
    if (services.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 20px;">No services yet</p>';
        list.className = '';
        return;
    }
    
    list.className = 'products-grid';
    list.innerHTML = services.map(s => `
        <div class="product-card">
            <div class="product-image" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 16px;">
                ${s.category}
            </div>
            <div class="product-details">
                <h4 class="product-name">${s.name || 'Unnamed Service'}</h4>
                <span class="product-category">${s.category}</span>
                <p class="product-description">${s.description || 'No description available'}</p>
                <p class="product-price">${formatAmount(s.price)}</p>
                <p class="product-stock">Duration: ${s.duration} minutes</p>
                <button onclick="bookService('${s.id}')" class="button button-primary" style="width: 100%; margin-top: 10px;">Book Service</button>
            </div>
        </div>
    `).join('');
}

function bookService(id) {
    document.getElementById('booking-service-id').value = id;
    document.getElementById('book-service-dialog').showModal();
}

function confirmBooking() {
    const serviceId = document.getElementById('booking-service-id').value;
    const clientName = document.getElementById('booking-client-name').value.trim();
    const date = document.getElementById('booking-date').value;
    const time = document.getElementById('booking-time').value;
    
    if (!clientName || !date || !time) {
        alert('Please fill in all fields');
        return;
    }
    
    const service = services.find(s => s.id == serviceId);
    if (!service) return;
    
    const booking = {
        id: Date.now(),
        serviceId,
        serviceName: service.name,
        clientName,
        date,
        time,
        price: service.price,
        status: 'completed',
        completedAt: new Date().toISOString()
    };
    
    serviceHistory.push(booking);
    localStorage.setItem('epsilonAproxi_serviceHistory', JSON.stringify(serviceHistory));
    
    document.getElementById('booking-client-name').value = '';
    document.getElementById('booking-date').value = '';
    document.getElementById('booking-time').value = '';
    document.getElementById('book-service-dialog').close();
    
    renderServiceHistory();
    updateServicesStats();
}

function renderServiceHistory() {
    const list = document.getElementById('service-history-list');
    if (!list) return;
    
    if (serviceHistory.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 20px;">No bookings yet</p>';
        list.className = '';
        return;
    }
    
    list.className = 'products-grid';
    list.innerHTML = serviceHistory.map(h => `
        <div class="product-card">
            <div class="product-image" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 16px;">
                Completed
            </div>
            <div class="product-details">
                <h4 class="product-name">${h.serviceName || 'Unnamed Service'}</h4>
                <span class="product-category">Booking</span>
                <p class="product-description">Client: ${h.clientName}</p>
                <p class="product-price">${formatAmount(h.price)}</p>
                <p class="product-stock">Date: ${h.date} at ${h.time}</p>
            </div>
        </div>
    `).join('');
}

function updateServicesStats() {
    const totalEl = document.getElementById('total-services-count');
    const revenueEl = document.getElementById('services-revenue');
    const completedEl = document.getElementById('services-completed');
    
    if (totalEl) totalEl.textContent = services.length;
    if (revenueEl) revenueEl.textContent = formatAmount(serviceHistory.reduce((sum, h) => sum + h.price, 0));
    if (completedEl) completedEl.textContent = serviceHistory.length;
}

function filterServices() {
    const search = document.getElementById('services-search').value.toLowerCase();
    const items = document.querySelectorAll('#services-list .list-item');
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(search) ? '' : 'none';
    });
}

setTimeout(() => {
    renderServices();
    renderServiceHistory();
    updateServicesStats();
}, 100);
</script>

<dialog id="book-service-dialog" style="width: 450px;">
    <h3>Book Service</h3>
    <input type="hidden" id="booking-service-id">
    <div class="form-group">
        <label for="booking-client-name" class="form-label">Client Name</label>
        <input type="text" id="booking-client-name" placeholder="Client name" class="form-input">
    </div>
    <div class="form-group">
        <label for="booking-date" class="form-label">Date</label>
        <input type="date" id="booking-date" class="form-input">
    </div>
    <div class="form-group">
        <label for="booking-time" class="form-label">Time</label>
        <input type="time" id="booking-time" class="form-input">
    </div>
    <button onclick="confirmBooking()" class="button button-primary" style="margin-bottom: 10px;">Confirm Booking</button>
    <button onclick="document.getElementById('book-service-dialog').close()" class="button button-danger">Cancel</button>
</dialog>

<!-- ASSETS PAGE -->
<div id="assets-page" class="page">
    <h2 class="section-heading"> Asset Management</h2>
    
    <div class="kpi-grid">
        <div class="card card-primary">
            <p class="card-title">Total Assets</p>
            <p id="total-assets-count" class="card-value text-primary">0</p>
        </div>
        <div class="card card-secondary">
            <p class="card-title">Total Asset Value</p>
            <p id="total-assets-value" class="card-value text-secondary">$0.00</p>
        </div>
        <div class="card card-orange">
            <p class="card-title">Active Warranties</p>
            <p id="active-warranties-count" class="card-value text-orange">0</p>
        </div>
        <div class="card card-success">
            <p class="card-title">Under Maintenance</p>
            <p id="maintenance-assets-count" class="card-value text-success">0</p>
        </div>
    </div>
    
    <button onclick="document.getElementById('new-asset-dialog').showModal()" class="button button-primary" style="width: 200px; margin-bottom: 20px;">+ New Asset</button>
    
    <div class="form-box" style="width: 100%;">
        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
            <input type="search" class="form-input" style="flex: 1; min-width: 200px; height: 36px;" id="assets-search" placeholder="Search assets..." oninput="filterAssets()">
            <select id="assets-filter-category" class="form-input" style="height: 36px; width: auto;" onchange="filterAssets()">
                <option value="">All Categories</option>
                <option value="Equipment">Equipment</option>
                <option value="Technology">Technology</option>
                <option value="Furniture">Furniture</option>
                <option value="Vehicle">Vehicle</option>
                <option value="Building">Building</option>
                <option value="Other">Other</option>
            </select>
            <select id="assets-filter-status" class="form-input" style="height: 36px; width: auto;" onchange="filterAssets()">
                <option value="">All Status</option>
                <option value="Active">Active</option>
                <option value="Maintenance">Maintenance</option>
                <option value="Retired">Retired</option>
            </select>
        </div>
        <h3 class="form-box-title">Assets Inventory</h3>
        <div id="assets-list" class="list-container"></div>
    </div>
</div>

<dialog id="new-asset-dialog" style="width: 550px; max-height: 90vh;">
    <h3 style="margin-top: 0;">Add New Asset</h3>
    <div style="max-height: calc(90vh - 100px); overflow-y: auto;">
        <div class="form-group">
            <label for="asset-name" class="form-label">Asset Name *</label>
            <input type="text" id="asset-name" placeholder="e.g., Dell Laptop, Office Desk" class="form-input">
        </div>
        
        <div class="form-group">
            <label for="asset-description" class="form-label">Description</label>
            <textarea id="asset-description" placeholder="Asset details and specifications..." class="form-input" rows="3"></textarea>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
                <label for="asset-category" class="form-label">Category *</label>
                <select id="asset-category" class="form-input">
                    <option value="">-- Select --</option>
                    <option value="Equipment">Equipment</option>
                    <option value="Technology">Technology</option>
                    <option value="Furniture">Furniture</option>
                    <option value="Vehicle">Vehicle</option>
                    <option value="Building">Building</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="asset-status" class="form-label">Status *</label>
                <select id="asset-status" class="form-input">
                    <option value="Active">Active</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Retired">Retired</option>
                </select>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
                <label for="asset-price" class="form-label">Purchase Price *</label>
                <input type="number" id="asset-price" placeholder="0.00" min="0" step="0.01" class="form-input">
            </div>
            
            <div class="form-group">
                <label for="asset-purchase-date" class="form-label">Purchase Date *</label>
                <input type="date" id="asset-purchase-date" class="form-input">
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="form-group">
                <label for="asset-serial" class="form-label">Serial Number</label>
                <input type="text" id="asset-serial" placeholder="S/N or ID" class="form-input">
            </div>
            
            <div class="form-group">
                <label for="asset-location" class="form-label">Location</label>
                <input type="text" id="asset-location" placeholder="e.g., Office 1, Warehouse A" class="form-input">
            </div>
        </div>

        <fieldset style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
            <legend style="padding: 0 8px; font-weight: 600; color: var(--color-text-dark);">Warranty Information</legend>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="warranty-provider" class="form-label">Provider</label>
                    <input type="text" id="warranty-provider" placeholder="e.g., Manufacturer" class="form-input">
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="warranty-months" class="form-label">Duration (Months)</label>
                    <input type="number" id="warranty-months" placeholder="12" min="0" max="240" class="form-input">
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: 0;">
                <label for="warranty-details" class="form-label">Coverage Details</label>
                <textarea id="warranty-details" placeholder="What's covered by warranty..." class="form-input" rows="2"></textarea>
            </div>
        </fieldset>

        <fieldset style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
            <legend style="padding: 0 8px; font-weight: 600; color: var(--color-text-dark);">Responsibility Assignment</legend>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="asset-responsible-person" class="form-label">Responsible Person</label>
                    <input type="text" id="asset-responsible-person" placeholder="e.g., John Doe" class="form-input">
                </div>
                
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="asset-responsible-dept" class="form-label">Department</label>
                    <select id="asset-responsible-dept" class="form-input">
                        <option value="">-- Select --</option>
                        <option value="Operations">Operations</option>
                        <option value="IT">IT</option>
                        <option value="Finance">Finance</option>
                        <option value="Marketing">Marketing</option>
                        <option value="HR">HR</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: 0;">
                <label for="asset-responsible-contact" class="form-label">Contact</label>
                <input type="text" id="asset-responsible-contact" placeholder="Email or Phone" class="form-input">
            </div>
        </fieldset>

        <div class="form-group">
            <label for="asset-notes" class="form-label">Additional Notes</label>
            <textarea id="asset-notes" placeholder="Any additional information..." class="form-input" rows="2"></textarea>
        </div>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button onclick="addAsset()" class="button button-primary" style="flex: 1;">Add Asset</button>
        <button onclick="document.getElementById('new-asset-dialog').close()" class="button button-danger" style="flex: 1;">Cancel</button>
    </div>
</dialog>

<dialog id="asset-details-dialog" style="width: 550px; max-height: 90vh;">
    <h3 style="margin-top: 0;" id="asset-details-name">Asset Details</h3>
    <div style="max-height: calc(90vh - 120px); overflow-y: auto;" id="asset-details-content"></div>
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button onclick="deleteCurrentAsset()" class="button button-danger" style="flex: 1;">Delete Asset</button>
        <button onclick="document.getElementById('asset-details-dialog').close()" class="button button-secondary" style="flex: 1;">Close</button>
    </div>
</dialog>

<script>
let assets = JSON.parse(localStorage.getItem('epsilonAproxi_assets') || '[]');

function addAsset() {
    // Collect form data
    const nameInput = document.getElementById('asset-name');
    const categoryInput = document.getElementById('asset-category');
    const priceInput = document.getElementById('asset-price');
    const dateInput = document.getElementById('asset-purchase-date');

    const name = nameInput ? nameInput.value.trim() : '';
    const category = categoryInput ? categoryInput.value : '';
    const priceRaw = priceInput ? priceInput.value : '';
    const purchaseDate = dateInput ? dateInput.value : '';

    // Robust validation
    if (!name || !category || priceRaw === '' || !purchaseDate) {
        alert('Please fill in all required fields (marked with *)');
        return;
    }

    const price = parseFloat(priceRaw);
    if (isNaN(price)) {
         alert('Please enter a valid numeric price');
         return;
    }
    
    const asset = {
        id: Date.now(),
        name,
        description: (document.getElementById('asset-description')?.value || '').trim(),
        category,
        price,
        purchaseDate,
        serialNumber: (document.getElementById('asset-serial')?.value || '').trim(),
        location: (document.getElementById('asset-location')?.value || '').trim(),
        status: document.getElementById('asset-status')?.value || 'Active',
        warranty: {
            provider: (document.getElementById('warranty-provider')?.value || '').trim(),
            durationMonths: parseInt(document.getElementById('warranty-months')?.value) || 0,
            details: (document.getElementById('warranty-details')?.value || '').trim(),
            startDate: new Date().toISOString(),
            isActive: true
        },
        responsibility: {
            personName: (document.getElementById('asset-responsible-person')?.value || '').trim(),
            department: document.getElementById('asset-responsible-dept')?.value || '',
            contact: (document.getElementById('asset-responsible-contact')?.value || '').trim()
        },
        notes: (document.getElementById('asset-notes')?.value || '').trim(),
        createdAt: new Date().toISOString(),
        depreciation: price * 0.1
    };
    
    assets.push(asset);
    localStorage.setItem('epsilonAproxi_assets', JSON.stringify(assets));
    
    document.getElementById('new-asset-dialog')?.close();
    clearAssetForm();
    renderAssets();
    updateAssetStats();
    showMessage('Asset added successfully!', 'success');
}

function clearAssetForm() {
    document.getElementById('asset-name').value = '';
    document.getElementById('asset-description').value = '';
    document.getElementById('asset-category').value = '';
    document.getElementById('asset-status').value = 'Active';
    document.getElementById('asset-price').value = '';
    document.getElementById('asset-purchase-date').value = '';
    document.getElementById('asset-serial').value = '';
    document.getElementById('asset-location').value = '';
    document.getElementById('warranty-provider').value = '';
    document.getElementById('warranty-months').value = '';
    document.getElementById('warranty-details').value = '';
    document.getElementById('asset-responsible-person').value = '';
    document.getElementById('asset-responsible-dept').value = '';
    document.getElementById('asset-responsible-contact').value = '';
    document.getElementById('asset-notes').value = '';
}

function renderAssets() {
    const assetsList = document.getElementById('assets-list');
    if (!assetsList) return;
    
    const filtered = getFilteredAssets();
    
    if (filtered.length === 0) {
        assetsList.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 20px;">No assets found.</p>';
        assetsList.className = '';
        return;
    }
    
    assetsList.className = 'products-grid';
    assetsList.innerHTML = filtered.map(asset => {
        const statusColor = asset.status === 'Active' ? '#10b981' : asset.status === 'Maintenance' ? '#f59e0b' : '#ef4444';
        return `
        <div class="product-card">
            <div class="product-image" style="background: linear-gradient(135deg, ${statusColor} 0%, ${statusColor}dd 100%); color: white; font-size: 14px;">
                ${asset.status}
            </div>
            <div class="product-details">
                <h4 class="product-name">${asset.name}</h4>
                <span class="product-category">${asset.category}</span>
                <p class="product-description">${asset.serialNumber ? 'Serial: ' + asset.serialNumber : 'No serial'}</p>
                <p class="product-price">$${asset.price.toFixed(2)}</p>
                <p class="product-stock">Purchased: ${new Date(asset.purchaseDate).toLocaleDateString()}</p>
                ${asset.responsibility.personName ? `<p class="product-stock">Responsible: ${asset.responsibility.personName}</p>` : ''}
                <button onclick="viewAssetDetails('${asset.id}')" class="button button-secondary" style="width: 100%; margin-top: 10px;">View Details</button>
            </div>
        </div>
        `;
    }).join('');
}

function getFilteredAssets() {
    const searchTerm = document.getElementById('assets-search').value.toLowerCase();
    const categoryFilter = document.getElementById('assets-filter-category').value;
    const statusFilter = document.getElementById('assets-filter-status').value;
    
    return assets.filter(asset => {
        const matchesSearch = asset.name.toLowerCase().includes(searchTerm) || 
                            asset.serialNumber.toLowerCase().includes(searchTerm) ||
                            asset.responsibility.personName.toLowerCase().includes(searchTerm);
        const matchesCategory = !categoryFilter || asset.category === categoryFilter;
        const matchesStatus = !statusFilter || asset.status === statusFilter;
        
        return matchesSearch && matchesCategory && matchesStatus;
    });
}

function filterAssets() {
    renderAssets();
}

function viewAssetDetails(assetId) {
    const asset = assets.find(a => a.id === parseInt(assetId));
    if (!asset) return;
    
    const isWarrantyExpired = asset.warranty.durationMonths > 0 && 
        new Date(asset.warranty.startDate).getTime() + (asset.warranty.durationMonths * 30 * 24 * 60 * 60 * 1000) < Date.now();
    
    document.getElementById('asset-details-name').textContent = asset.name;
    
    document.getElementById('asset-details-content').innerHTML = `
        <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 12px; margin-bottom: 12px;">
            <h4 style="margin: 0 0 8px 0; color: var(--color-text-dark);">Basic Information</h4>
            <div style="display: grid; gap: 8px;">
                <p style="margin: 0;"><strong>Name:</strong> ${asset.name}</p>
                <p style="margin: 0;"><strong>Category:</strong> ${asset.category}</p>
                <p style="margin: 0;"><strong>Status:</strong> <span class="order-status ${asset.status === 'Active' ? 'status-delivered' : 'status-ordered'}">${asset.status}</span></p>
                <p style="margin: 0;"><strong>Price:</strong> $${asset.price.toFixed(2)}</p>
                <p style="margin: 0;"><strong>Purchase Date:</strong> ${new Date(asset.purchaseDate).toLocaleDateString()}</p>
                <p style="margin: 0;"><strong>Annual Depreciation:</strong> $${asset.depreciation.toFixed(2)}</p>
                ${asset.description ? `<p style="margin: 0;"><strong>Description:</strong> ${asset.description}</p>` : ''}
                ${asset.serialNumber ? `<p style="margin: 0;"><strong>Serial Number:</strong> ${asset.serialNumber}</p>` : ''}
                ${asset.location ? `<p style="margin: 0;"><strong>Location:</strong> ${asset.location}</p>` : ''}
            </div>
        </div>
        
        ${asset.warranty.provider ? `
        <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 12px; margin-bottom: 12px;">
            <h4 style="margin: 0 0 8px 0; color: var(--color-text-dark);">Warranty</h4>
            <div style="display: grid; gap: 8px; padding: 10px; background: ${isWarrantyExpired ? '#fee2e2' : '#f0fdf4'}; border-radius: 6px;">
                <p style="margin: 0;"><strong>Provider:</strong> ${asset.warranty.provider}</p>
                <p style="margin: 0;"><strong>Duration:</strong> ${asset.warranty.durationMonths} months</p>
                <p style="margin: 0;"><strong>Status:</strong> <span style="padding: 2px 8px; background: ${isWarrantyExpired ? '#fca5a5' : '#86efac'}; border-radius: 4px; color: ${isWarrantyExpired ? '#7f1d1d' : '#15803d'};">${isWarrantyExpired ? 'Expired' : 'Active'}</span></p>
                ${asset.warranty.details ? `<p style="margin: 0;"><strong>Coverage:</strong> ${asset.warranty.details}</p>` : ''}
            </div>
        </div>
        ` : ''}
        
        ${asset.responsibility.personName ? `
        <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 12px; margin-bottom: 12px;">
            <h4 style="margin: 0 0 8px 0; color: var(--color-text-dark);">Responsibility</h4>
            <div style="display: grid; gap: 8px;">
                <p style="margin: 0;"><strong>Person:</strong> ${asset.responsibility.personName}</p>
                ${asset.responsibility.department ? `<p style="margin: 0;"><strong>Department:</strong> ${asset.responsibility.department}</p>` : ''}
                ${asset.responsibility.contact ? `<p style="margin: 0;"><strong>Contact:</strong> ${asset.responsibility.contact}</p>` : ''}
            </div>
        </div>
        ` : ''}
        
        ${asset.notes ? `
        <div style="padding-bottom: 12px;">
            <h4 style="margin: 0 0 8px 0; color: var(--color-text-dark);">Notes</h4>
            <p style="margin: 0; background: #f9fafb; padding: 10px; border-radius: 6px;">${asset.notes}</p>
        </div>
        ` : ''}
    `;
    
    window.currentAssetId = asset.id;
    document.getElementById('asset-details-dialog').showModal();
}

function deleteCurrentAsset() {
    if (!confirm('Are you sure you want to delete this asset?')) return;
    
    assets = assets.filter(a => a.id !== window.currentAssetId);
    localStorage.setItem('epsilonAproxi_assets', JSON.stringify(assets));
    
    document.getElementById('asset-details-dialog').close();
    renderAssets();
    updateAssetStats();
    showMessage('Asset deleted successfully!', 'success');
}

function updateAssetStats() {
    const totalCount = assets.length;
    const totalValue = assets.reduce((sum, a) => sum + a.price, 0);
    const activeWarranties = assets.filter(a => a.warranty.provider && !isWarrantyExpired(a)).length;
    const maintenanceCount = assets.filter(a => a.status === 'Maintenance').length;
    
    const elem1 = document.getElementById('total-assets-count');
    const elem2 = document.getElementById('total-assets-value');
    const elem3 = document.getElementById('active-warranties-count');
    const elem4 = document.getElementById('maintenance-assets-count');
    
    if (elem1) elem1.textContent = totalCount;
    if (elem2) elem2.textContent = '$' + formatAmount(totalValue);
    if (elem3) elem3.textContent = activeWarranties;
    if (elem4) elem4.textContent = maintenanceCount;
}

function isWarrantyExpired(asset) {
    if (!asset.warranty.durationMonths || !asset.warranty.startDate) return false;
    return new Date(asset.warranty.startDate).getTime() + (asset.warranty.durationMonths * 30 * 24 * 60 * 60 * 1000) < Date.now();
}

document.addEventListener('DOMContentLoaded', () => {
    const originalShowPage = window.showPage;
    window.showPage = function(pageId) {
        originalShowPage(pageId);
        if (pageId === 'assets-page') {
            renderAssets();
            updateAssetStats();
        }
    };
    renderAssets();
    updateAssetStats();
});
</script>

<!-- REPORTS PAGE -->
<div id="reports-page" class="page">
    <h2 class="section-heading"> Reports & Analysis</h2>
    
    <div class="form-layout-grid">
        <div class="form-box">
            <h3 class="form-box-title"> Break-Even Analysis</h3>
            <p style="color: #6b7280; margin-bottom: 16px;">Calculate how many units you need to sell to cover costs</p>
            
            <div class="form-group">
                <label class="form-label">Select Product</label>
                <select id="breakeven-product" class="form-input"></select>
            </div>
            
            <button onclick="calculateBreakEven()" class="button button-primary" style="width: 100%; margin-bottom: 16px;">Calculate Break-Even</button>
            
            <div id="breakeven-results" style="padding: 16px; background: #f9fafb; border-radius: 8px; display: none;">
                <h4 style="margin-top: 0; color: var(--color-primary);">Break-Even Analysis</h4>
                <div style="margin-bottom: 12px;">
                    <p style="margin: 4px 0; color: #6b7280;">Break-Even Units:</p>
                    <p id="breakeven-units" style="margin: 4px 0; font-size: 24px; font-weight: 700; color: var(--color-primary);">-</p>
                </div>
                <div style="margin-bottom: 12px;">
                    <p style="margin: 4px 0; color: #6b7280;">Break-Even Revenue:</p>
                    <p id="breakeven-revenue" style="margin: 4px 0; font-size: 20px; font-weight: 600;">-</p>
                </div>
                <div style="margin-bottom: 12px;">
                    <p style="margin: 4px 0; color: #6b7280;">Contribution Margin per Unit:</p>
                    <p id="contribution-margin" style="margin: 4px 0; font-weight: 600;">-</p>
                </div>
                <div style="padding: 12px; background: white; border-radius: 8px; border-left: 4px solid var(--color-secondary);">
                    <p id="breakeven-insight" style="margin: 0; font-size: 14px;">-</p>
                </div>
            </div>
        </div>
        
        <div class="form-box">
            <h3 class="form-box-title"> PDF Reports</h3>
            <p style="color: #6b7280; margin-bottom: 16px;">Generate professional PDF reports</p>
            
            <button onclick="generateFinancialReport()" class="button button-primary" style="width: 100%; margin-bottom: 10px;">
                <i data-lucide="file-text" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                Financial Summary Report
            </button>
            
            <button onclick="generateSalesReport()" class="button button-secondary" style="width: 100%; margin-bottom: 10px;">
                <i data-lucide="shopping-cart" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                Sales Report
            </button>
            
            <button onclick="generateProductReport()" class="button button-orange" style="width: 100%; margin-bottom: 10px;">
                <i data-lucide="package" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                Product Catalog Report
            </button>
            
            <div style="margin-top: 20px; padding: 16px; background: #f9fafb; border-radius: 8px;">
                <h4 style="margin-top: 0; font-size: 14px;">Report Features:</h4>
                <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #6b7280;">
                    <li>Professional formatting</li>
                    <li>Business branding</li>
                    <li>Key metrics & insights</li>
                    <li>Ready to print or share</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="form-box" style="margin-top: 24px;">
        <h3 class="form-box-title"> Receipt Scanner (OCR)</h3>
        <p style="color: #6b7280; margin-bottom: 16px;">Upload receipt images to extract expense data automatically</p>
        
        <input type="file" id="receipt-upload" accept="image/*" style="display: none;" onchange="scanReceipt(event)">
        <button onclick="document.getElementById('receipt-upload').click()" class="button button-primary" style="width: 100%; margin-bottom: 16px;">
            <i data-lucide="camera" style="width: 16px; height: 16px; margin-right: 8px;"></i>
            Upload Receipt Image
        </button>
        
        <div id="ocr-progress" style="display: none; padding: 16px; background: #f9fafb; border-radius: 8px; margin-bottom: 16px;">
            <p style="margin: 0; text-align: center; color: #6b7280;">Scanning receipt...</p>
            <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; margin-top: 8px; overflow: hidden;">
                <div id="ocr-progress-bar" style="width: 0%; height: 100%; background: var(--color-primary); transition: width 0.3s;"></div>
            </div>
        </div>
        
        <div id="ocr-results" style="display: none; padding: 16px; background: #f9fafb; border-radius: 8px;">
            <h4 style="margin-top: 0;">Extracted Data</h4>
            <div style="margin-bottom: 12px;">
                <img id="receipt-preview" style="max-width: 100%; border-radius: 8px; margin-bottom: 12px;">
            </div>
            <div class="form-group">
                <label class="form-label">Expense Name</label>
                <input type="text" id="ocr-expense-name" placeholder="e.g., Office Supplies" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Amount</label>
                <input type="number" id="ocr-amount" placeholder="0.00" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Extracted Text</label>
                <textarea id="ocr-text" class="form-input" rows="4" readonly></textarea>
            </div>
            <button onclick="saveScannedExpense()" class="button button-secondary" style="width: 100%;">Save as Deduction</button>
        </div>
    </div>
</div>

<!-- CUSTOMERS PAGE (CRM) -->
<div id="customers-page" class="page">
    <h2 class="section-heading">Customer Relationship Management</h2>
    
    <!-- Statistics Cards -->
    <div class="kpi-grid" style="margin-bottom: 30px;">
        <div class="card card-primary" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; position: relative; overflow: hidden;">
            <div style="position: absolute; top: -20px; right: -20px; opacity: 0.1; font-size: 80px;"></div>
            <p class="card-title" style="color: rgba(255, 255, 255, 0.9);">Total Customers</p>
            <p id="total-customers-stat" class="card-value" style="color: white; font-size: 2.5em; font-weight: 700;">0</p>
        </div>
        
        <div class="card card-secondary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; position: relative; overflow: hidden;">
            <div style="position: absolute; top: -20px; right: -20px; opacity: 0.1; font-size: 80px;"></div>
            <p class="card-title" style="color: rgba(255, 255, 255, 0.9);">Total Revenue from Customers</p>
            <p id="customer-total-revenue" class="card-value" style="color: white; font-size: 2.5em; font-weight: 700;">$0.00</p>
        </div>
        
        <div class="card card-orange" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; position: relative; overflow: hidden;">
            <div style="position: absolute; top: -20px; right: -20px; opacity: 0.1; font-size: 80px;"></div>
            <p class="card-title" style="color: rgba(255, 255, 255, 0.9);">Most Valued Customer</p>
            <p id="top-customer-stat" class="card-value" style="color: white; font-size: 1.5em; font-weight: 700;">--</p>
        </div>
    </div>
    
    <!-- Add New Customer Button -->
    <div style="margin-bottom: 25px;">
        <button class="button button-primary" onclick="document.getElementById('customer-dialog').showModal()" style="padding: 12px 24px; font-size: 16px; border-radius: 8px;">
            <span style="margin-right: 8px;"></span> Add Customer
        </button>
    </div>

    <!-- Customer Dialog -->
    <dialog id="customer-dialog" style="width: 500px; border-radius: 12px;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">Add New Customer</h3>
            <button class="close-button" onclick="document.getElementById('customer-dialog').close();">&times;</button>
        </div>
        
        <div class="form-group">
            <label class="form-label">Customer Name:</label>
            <input id="customer-name-input" placeholder="Enter customer name" class="form-input" style="width: 100%;">
        </div>
        
        <div class="form-group">
            <label class="form-label">Email:</label>
            <input id="customer-email-input" type="email" placeholder="customer@example.com" class="form-input" style="width: 100%;">
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group">
                <label class="form-label">Phone Number:</label>
                <input id="customer-phone-input" placeholder="+1 (555) 123-4567" class="form-input" style="width: 100%;">
            </div>
            
            <div class="form-group">
                <label class="form-label">Age:</label>
                <input id="customer-age-input" type="number" placeholder="25" class="form-input" style="width: 100%;" min="1" max="120">
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Description/Notes:</label>
            <textarea id="customer-description-input" class="form-input" placeholder="Add customer preferences, notes, etc..." style="width: 100%; min-height: 80px; padding: 10px; font-family: inherit;"></textarea>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button class="button button-primary" onclick="createCustomer()" style="flex: 1;">Create</button>
            <button class="button button-danger" onclick="document.getElementById('customer-dialog').close()" style="flex: 1;">Cancel</button>
        </div>
    </dialog>

    <!-- Customers List -->
    <div class="form-box" style="width: 100%; padding: 0;">
        <h3 class="form-box-title" style="padding: 20px 20px 15px 20px; margin: 0;">Customers Directory</h3>
        <div style="padding: 0 20px 20px 20px;">
            <input type="search" class="form-input" id="customer-search" placeholder="Search by name, email, or phone..." style="width: 100%; margin-bottom: 20px;" oninput="filterCustomers()">
        </div>
        <div id="customers-list" style="padding: 0 20px 20px 20px; display: grid; gap: 15px; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));">
            <!-- Customers will be rendered here -->
        </div>
    </div>

    <!-- Transaction Tools Section -->
    <div class="form-box" style="width: 100%; margin-top: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 class="form-box-title" style="margin: 0;">Transaction Tools</h3>
            <button class="button button-secondary" onclick="document.getElementById('transaction-tools-dialog').showModal()">Manage Tools</button>
        </div>
        
        <div style="height: 300px;">
            <canvas id="transaction-methods-chart"></canvas>
        </div>
    </div>

    <!-- Transaction Tools Dialog -->
    <dialog id="transaction-tools-dialog" style="width: 600px; border-radius: 12px;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">Manage Transaction Tools</h3>
            <button class="close-button" onclick="document.getElementById('transaction-tools-dialog').close()">&times;</button>
        </div>
        
        <div class="form-group">
            <label class="form-label">New Tool Name:</label>
            <input id="new-tool-name" placeholder="e.g., Credit Card, Cash, Mobile Money" class="form-input">
        </div>
        
        <div class="form-group">
            <label class="form-label">Description:</label>
            <input id="new-tool-description" placeholder="Description..." class="form-input">
        </div>
        
        <button class="button button-primary" onclick="addTransactionTool()" style="width: 100%; margin-bottom: 20px;">Add Tool</button>
        
        <h4 style="margin-bottom: 10px;">Existing Tools</h4>
        <div id="transaction-tools-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px;">
            <!-- Tools list -->
        </div>
    </dialog>
</div>

        <!-- EXTENSIONS PAGE -->
        <div id="extensions-page" class="page">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 class="section-heading" style="margin: 0;">Extensions Store</h2>
                <button onclick="showPage('extension-builder-page')" class="button button-primary">
                    <i data-lucide="hammer"></i> Extension Builder
                </button>
            </div>
            
            <div class="form-box">
                <div style="display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--color-border-light); padding-bottom: 15px;">
                    <button id="tab-installed" class="tab-button active" onclick="renderExtensionsList('installed')" style="background: none; border: none; font-weight: 600; cursor: pointer; padding: 8px 16px; border-radius: 6px;">Installed</button>
                    <button id="tab-store" class="tab-button" onclick="renderExtensionsList('store')" style="background: none; border: none; font-weight: 600; cursor: pointer; padding: 8px 16px; border-radius: 6px;">Store</button>
                    <button id="tab-my" class="tab-button" onclick="renderExtensionsList('my')" style="background: none; border: none; font-weight: 600; cursor: pointer; padding: 8px 16px; border-radius: 6px;">My Extensions</button>
                </div>

                <div style="margin-bottom: 20px;">
                    <input type="search" id="extensions-search" class="form-input" placeholder="Search extensions by name or author..." oninput="renderExtensionsList(document.querySelector('.tab-button.active').id.replace('tab-', ''))">
                </div>

                <div id="extensions-list-container" class="products-grid">
                    <!-- Extensions will be rendered here -->
                </div>
            </div>
        </div>

        <!-- EXTENSION BUILDER PAGE -->
        <div id="extension-builder-page" class="page">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 class="section-heading" style="margin: 0;">Extension Builder</h2>
                <button onclick="showPage('extensions-page')" class="button button-secondary">
                    <i data-lucide="arrow-left"></i> Back to Store
                </button>
            </div>

            <div class="form-box" style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; border-bottom: 1px solid var(--color-border-light); padding-bottom: 15px; margin-bottom: 20px; overflow-x: auto;">
                    <button class="ptb active" onclick="switchBuilderTab('code-input')" id="tab-btn-code-input">Code Input</button>
                    <button class="ptb" onclick="switchBuilderTab('code-output')" id="tab-btn-code-output">Code Output</button>
                    <button class="ptb" onclick="switchBuilderTab('code-sets')" id="tab-btn-code-sets">Code Sets</button>
                    <button class="ptb" onclick="switchBuilderTab('code-info')" id="tab-btn-code-info">Code Info</button>
                </div>

                <!-- Code Input -->
                <div id="builder-tab-code-input" class="builder-tab-content">
                    <div class="form-group">
                        <label class="form-label">HTML Structure</label>
                        <textarea id="ext-code-html" class="form-input" style="height: 200px; font-family: monospace;" placeholder="<div class='my-widget'>...</div>"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">CSS Styles</label>
                        <textarea id="ext-code-css" class="form-input" style="height: 200px; font-family: monospace;" placeholder=".my-widget { background: white; }"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">JavaScript Logic</label>
                        <textarea id="ext-code-js" class="form-input" style="height: 200px; font-family: monospace;" placeholder="document.querySelector('.my-widget').innerText = 'Hello';"></textarea>
                    </div>
                </div>

                <!-- Code Output -->
                <div id="builder-tab-code-output" class="builder-tab-content" style="display: none;">
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
                        <button class="button button-primary" onclick="previewExtension()">
                            <i data-lucide="play"></i> Run Preview
                        </button>
                    </div>
                    <div id="ext-preview-container" style="border: 1px solid #ccc; padding: 20px; min-height: 400px; background: #f3f4f6; border-radius: 8px;">
                        <p style="color: #666; text-align: center; margin-top: 100px;">Click "Run Preview" to see your extension.</p>
                    </div>
                </div>

                <!-- Code Sets -->
                <div id="builder-tab-code-sets" class="builder-tab-content" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Extension Name</label>
                        <input type="text" id="ext-name" class="form-input" placeholder="My Awesome Extension">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="ext-description" class="form-input" placeholder="What does this extension do?"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Author</label>
                        <input type="text" id="ext-author" class="form-input" placeholder="Your Name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Version</label>
                        <input type="text" id="ext-version" class="form-input" placeholder="1.0.0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Target Page</label>
                        <select id="ext-target" class="form-input">
                            <option value="standalone">Standalone Page (New Tab)</option>
                            <option value="global">Global (All Pages)</option>
                            <option value="dashboard-page">Dashboard</option>
                            <option value="sales-history-page">Sales History</option>
                            <option value="inventory-page">Product Catalog</option>
                            <option value="deductions-page">Fixed Deductions</option>
                            <option value="chartsPage">Charts</option>
                            <option value="AI-page">AI Assistant</option>
                            <option value="Clients">Clients & Accounts</option>
                            <option value="customers-page">Customers (CRM)</option>
                            <option value="warehouse-page">Warehouse Management</option>
                            <option value="news-page">Tools</option>
                            <option value="reports-page">Reports</option>
                            <option value="goals-page">Goals</option>
                            <option value="settings-page">Settings</option>
                            <option value="node-editor-page">Node Editor</option>
                            <option value="lab-page">AI Lab</option>
                            <option value="pos-page">POS System</option>
                            <option value="services-page">Services</option>
                            <option value="assets-page">Assets</option>
                            <option value="employees-page">Employees</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Icon (Lucide Name)</label>
                        <input type="text" id="ext-icon" class="form-input" placeholder="puzzle">
                        <small style="color: var(--color-text-medium);">See <a href="https://lucide.dev/icons" target="_blank">Lucide Icons</a></small>
                    </div>
                    
                    <h3 class="form-box-title" style="margin-top: 20px;">Permissions</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="perm-products"> Products
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="perm-services"> Services
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="perm-deductions"> Deductions
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="perm-employees"> Employees
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="perm-assets"> Assets
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="perm-warehouse"> Warehouse
                        </label>
                    </div>
                </div>

                <!-- Code Info -->
                <div id="builder-tab-code-info" class="builder-tab-content" style="display: none; max-height: 600px; overflow-y: auto;">
                    <h3>Development Snippets</h3>
                    <p>Copy these snippets to access system data in your extension.</p>
                    
                    <div class="snippet-item" style="margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                        <h4>Get Employees (List)</h4>
                        <p>Display a list of employees. Handles the object display issue.</p>
                        <div style="background: #2d2d2d; color: #fff; padding: 10px; border-radius: 4px; position: relative;">
                            <code id="snip-employees">const empList = employees.map(e => `&lt;div&gt;${e.name} - ${e.role}&lt;/div&gt;`).join('');
document.getElementById('my-div').innerHTML = empList || 'No employees';</code>
                            <button onclick="copySnippet('snip-employees')" style="position: absolute; top: 5px; right: 5px; padding: 2px 8px; cursor: pointer;">Copy</button>
                        </div>
                    </div>

                    <div class="snippet-item" style="margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                        <h4>Handle Button Clicks</h4>
                        <p>Use this to make buttons work (since functions are local).</p>
                        <div style="background: #2d2d2d; color: #fff; padding: 10px; border-radius: 4px; position: relative;">
                            <code id="snip-btn-click">// Method 1: Add Event Listener (Recommended)
document.getElementById('my-btn').addEventListener('click', function() {
    alert('Button Clicked!');
});

// Method 2: Global Function (for onclick="myFunc()")
window.myFunc = function() {
    alert('Called from HTML onclick');
};</code>
                            <button onclick="copySnippet('snip-btn-click')" style="position: absolute; top: 5px; right: 5px; padding: 2px 8px; cursor: pointer;">Copy</button>
                        </div>
                    </div>

                    <div class="snippet-item" style="margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                        <h4>Get Products</h4>
                        <p>Returns an array of all products.</p>
                        <div style="background: #2d2d2d; color: #fff; padding: 10px; border-radius: 4px; position: relative;">
                            <code id="snip-products">const allProducts = Object.values(productCatalog);
// Example: Log names
console.log(allProducts.map(p => p.name));</code>
                            <button onclick="copySnippet('snip-products')" style="position: absolute; top: 5px; right: 5px; padding: 2px 8px; cursor: pointer;">Copy</button>
                        </div>
                    </div>

                    <div class="snippet-item" style="margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                        <h4>Get Services</h4>
                        <p>Returns an array of all services.</p>
                        <div style="background: #2d2d2d; color: #fff; padding: 10px; border-radius: 4px; position: relative;">
                            <code id="snip-services">const allServices = Object.values(serviceCatalog);</code>
                            <button onclick="copySnippet('snip-services')" style="position: absolute; top: 5px; right: 5px; padding: 2px 8px; cursor: pointer;">Copy</button>
                        </div>
                    </div>

                    <div class="snippet-item" style="margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                        <h4>Get Clients/Customers</h4>
                        <p>Returns an array of all customers.</p>
                        <div style="background: #2d2d2d; color: #fff; padding: 10px; border-radius: 4px; position: relative;">
                            <code id="snip-clients">const allCustomers = customers; // Array of customer objects</code>
                            <button onclick="copySnippet('snip-clients')" style="position: absolute; top: 5px; right: 5px; padding: 2px 8px; cursor: pointer;">Copy</button>
                        </div>
                    </div>

                    <div class="snippet-item" style="margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                        <h4>Get Deductions</h4>
                        <p>Returns an array of fixed deductions.</p>
                        <div style="background: #2d2d2d; color: #fff; padding: 10px; border-radius: 4px; position: relative;">
                            <code id="snip-deductions">const allDeductions = fixedDeductions;</code>
                            <button onclick="copySnippet('snip-deductions')" style="position: absolute; top: 5px; right: 5px; padding: 2px 8px; cursor: pointer;">Copy</button>
                        </div>
                    </div>

                    <div class="snippet-item" style="margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                        <h4>CSS: Card Style</h4>
                        <p>Apply this class to make an element look like a card.</p>
                        <div style="background: #2d2d2d; color: #fff; padding: 10px; border-radius: 4px; position: relative;">
                            <code id="snip-css-card">.card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }</code>
                            <button onclick="copySnippet('snip-css-card')" style="position: absolute; top: 5px; right: 5px; padding: 2px 8px; cursor: pointer;">Copy</button>
                        </div>
                    </div>

                    <div class="snippet-item" style="margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                        <h4>CSS: Button Primary</h4>
                        <p>Primary button style.</p>
                        <div style="background: #2d2d2d; color: #fff; padding: 10px; border-radius: 4px; position: relative;">
                            <code id="snip-css-btn">.button-primary { background: #3b82f6; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; }</code>
                            <button onclick="copySnippet('snip-css-btn')" style="position: absolute; top: 5px; right: 5px; padding: 2px 8px; cursor: pointer;">Copy</button>
                        </div>
                    </div>
                </div>
            </div>

            <button class="button button-primary" onclick="openPublishDialog()" style="width: 100%; padding: 15px; font-size: 16px; margin-top: 20px;">
                Publish Extension
            </button>
        </div>

        <!-- Publish Dialog -->
        <dialog id="publish-extension-dialog" style="border: none; border-radius: 12px; padding: 0; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); max-width: 500px; width: 90%;">
            <div style="padding: 20px;">
                <h3 style="margin-top: 0;">Publish Extension</h3>
                <p>Please review the terms and conditions before publishing.</p>
                <div style="height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; padding: 10px; margin-bottom: 20px; font-size: 13px; background: #f9fafb; border-radius: 6px;">
                    <h4>Terms and Conditions</h4>
                    <p>1. <strong>Security:</strong> You agree that this extension does not contain malicious code, spyware, or viruses.</p>
                    <p>2. <strong>Privacy:</strong> You agree to respect user privacy and not collect data without consent.</p>
                    <p>3. <strong>Performance:</strong> You agree that this extension does not degrade the performance of the application.</p>
                    <p>4. <strong>Liability:</strong> You accept full responsibility for any issues caused by this extension.</p>
                    <p>5. <strong>Content:</strong> You agree not to display offensive or illegal content.</p>
                </div>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; cursor: pointer;">
                    <input type="checkbox" id="agree-terms"> 
                    <span style="font-size: 14px;">I agree to the Terms and Conditions</span>
                </label>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button class="button button-secondary" onclick="document.getElementById('publish-extension-dialog').close()">Cancel</button>
                    <button class="button button-primary" onclick="publishExtension()">Publish</button>
                </div>
            </div>
        </dialog>

    </main>
<script>
    
      // --- GLOBAL STATE & VARIABLES ---
//calculate the total inventory cost and price
function formatCurrency(amount) {
    const currencyInfo = currencyMap[currentCurrency];
    const formatted = amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    return `${currencyInfo.symbol}${formatted}`;
}

function calculateInventoryCost() {
    let totalCost = 0;
    let totalPrice = 0;
    for (let productName in productCatalog) {
        const product = productCatalog[productName];
        if (product) {
            const buyingPrice = parseFloat(product.buyingPrice) || 0;
            const sellingPrice = parseFloat(product.sellingPrice) || 0;
            const stock = parseFloat(product.stock) || 0;
            
            totalCost += buyingPrice * stock;
            totalPrice += sellingPrice * stock;
        }
    }
    const costCard = document.getElementById('inventory-costs');
    const priceCard = document.getElementById('inventory-price');
    if (costCard) costCard.textContent = formatCurrency(totalCost);
    if (priceCard) priceCard.textContent = formatCurrency(totalPrice);
}


let currentCurrency = '$'; 
const currencyMap = {
    '$': { symbol: '$', code: 'USD' },
    'KSH': { symbol: 'KSh', code: 'KES' }
};

let budgetAmount = 0;
let productCatalog = {
    "Widget Alpha": { sellingPrice: 20.00, buyingPrice: 12.00, stock: 0, id: 'p1' },
    "Super Gizmo": { sellingPrice: 50.00, buyingPrice: 35.00, stock: 0, id: 'p2' },
    "Basic Service": { sellingPrice: 100.00, buyingPrice: 0.00, stock: 0, id: 'p3' }
};

let serviceCatalog = {};
let serviceBookings = [];

let salesHistory = [
    { id: 1, product: "Widget Alpha", quantity: 5, unitPrice: 20.00, date: new Date(Date.now() - 86400000) },
    { id: 2, product: "Super Gizmo", quantity: 2, unitPrice: 50.00, date: new Date(Date.now() - 3600000) },
    { id: 3, product: "Widget Alpha", quantity: 10, unitPrice: 20.00, date: new Date(Date.now() - 172800000) },
];

let fixedDeductions = [
    { name: "Rent", amount: 1500.00, id: 'd1' },
    { name: "Software Subs", amount: 49.99, id: 'd2' }
];


let clients = [];
let customers = [];
let transactionTools = JSON.parse(localStorage.getItem('epsilonAproxi_transactionTools') || '[]');
if (transactionTools.length === 0) {
    transactionTools = [
        { id: 't1', name: 'Cash', description: 'Physical currency' },
        { id: 't2', name: 'Credit Card', description: 'Visa, Mastercard, etc.' }
    ];
}
let stockHistory = {}; // Track stock changes over time for each product
let goals = [];
let warehouses = [];
let posCart = [];
let serviceHistory = [];
let customerSales = {};

function addService() {
    const name = document.getElementById('new-service-name').value.trim();
    const category = document.getElementById('new-service-category').value;
    const price = parseFloat(document.getElementById('new-service-price').value);
    const duration = parseInt(document.getElementById('new-service-duration').value);
    const description = document.getElementById('new-service-description').value.trim();
    
    if (!name || !price || !duration) {
        showMessage('Please fill all required fields', 'error');
        return;
    }
    
    serviceCatalog[name] = {
        id: generateId(),
        category,
        price,
        duration,
        description,
        timesBooked: 0,
        revenue: 0
    };
    
    saveData();
    renderServices();
    document.getElementById('new-service-dialog').close();
    showMessage(`Service "${name}" added successfully`, 'success');
}

function bookService(serviceName) {
    document.getElementById('booking-service-id').value = serviceName;
    document.getElementById('book-service-dialog').showModal();
}

function confirmBooking() {
    const serviceName = document.getElementById('booking-service-id').value;
    const clientName = document.getElementById('booking-client-name').value.trim();
    const date = document.getElementById('booking-date').value;
    const time = document.getElementById('booking-time').value;
    
    if (!clientName || !date || !time) {
        showMessage('Please fill all booking details', 'error');
        return;
    }
    
    const service = serviceCatalog[serviceName];
    if (!service) return;
    
    serviceBookings.push({
        id: generateId(),
        serviceName,
        clientName,
        date,
        time,
        status: 'scheduled'
    });
    
    service.timesBooked++;
    saveData();
    renderServices();
    document.getElementById('book-service-dialog').close();
    showMessage(`Booking confirmed for ${clientName}`, 'success');
}

function completeService(serviceName) {
    const service = serviceCatalog[serviceName];
    if (!service) return;
    
    serviceHistory.push({
        id: generateId(),
        serviceName,
        price: service.price,
        date: new Date()
    });
    
    service.revenue += service.price;
    saveData();
    updateTotals();
    renderServices();
    showMessage(`Service "${serviceName}" completed`, 'success');
}

function renderServices() {
    const list = document.getElementById('services-list');
    if (!list) return;
    
    const services = Object.keys(serviceCatalog);
    if (services.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 20px;">No services yet</p>';
        list.className = '';
        return;
    }
    
    list.className = 'products-grid';
    list.innerHTML = services.map(name => {
        const s = serviceCatalog[name];
        return `
            <div class="product-card">
                <div class="product-image" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 16px;">
                    ${s.category}
                </div>
                <div class="product-details">
                    <h4 class="product-name">${name}</h4>
                    <span class="product-category">${s.category}</span>
                    <p class="product-description">Booked ${s.timesBooked} times</p>
                    <p class="product-price">${formatCurrency(s.price)}</p>
                    <p class="product-stock">Duration: ${s.duration} minutes</p>
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <button onclick="bookService('${name}')" class="button button-primary" style="flex: 1; padding: 8px;">Book</button>
                        <button onclick="completeService('${name}')" class="button button-secondary" style="flex: 1; padding: 8px;">Complete</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    const totalServices = services.length;
    const totalRevenue = services.reduce((sum, name) => sum + serviceCatalog[name].revenue, 0);
    const totalCompleted = serviceHistory.length;
    
    const countEl = document.getElementById('total-services-count');
    const revenueEl = document.getElementById('services-revenue');
    const completedEl = document.getElementById('services-completed');
    
    if (countEl) countEl.textContent = totalServices;
    if (revenueEl) revenueEl.textContent = formatCurrency(totalRevenue);
    if (completedEl) completedEl.textContent = totalCompleted;
}
let employees = [];

function initializeEmployeeDialog() {
    const warehouseSelect = document.getElementById('employee-warehouse');
    const productsDiv = document.getElementById('employee-products');
    const servicesDiv = document.getElementById('employee-services');
    const assetsDiv = document.getElementById('employee-assets');
    
    if (warehouseSelect && warehouses.length > 0) {
        warehouseSelect.innerHTML = '<option value="">Select a warehouse</option>' + 
            warehouses.map(w => `<option value="${w.id}">${w.name || 'Warehouse'}</option>`).join('');
    }
    
    if (productsDiv && productCatalog) {
        productsDiv.innerHTML = Object.keys(productCatalog).map(product => 
            `<label style="display: block; margin-bottom: 8px;">
                <input type="checkbox" class="employee-product-checkbox" value="${product}"> ${product}
            </label>`
        ).join('');
    }
    
    if (servicesDiv && serviceCatalog) {
        servicesDiv.innerHTML = Object.keys(serviceCatalog).map(service => 
            `<label style="display: block; margin-bottom: 8px;">
                <input type="checkbox" class="employee-service-checkbox" value="${service}"> ${service}
            </label>`
        ).join('');
    }
    
    if (assetsDiv && assets.length > 0) {
        assetsDiv.innerHTML = assets.map(asset => 
            `<label style="display: block; margin-bottom: 8px;">
                <input type="checkbox" class="employee-asset-checkbox" value="${asset.id}"> ${asset.name || asset.id}
            </label>`
        ).join('');
    }
}

function addEmployee() {
    const name = document.getElementById('employee-name').value.trim();
    const age = document.getElementById('employee-age').value.trim();
    const description = document.getElementById('employee-description').value.trim();
    const position = document.getElementById('employee-position').value.trim();
    const salary = parseFloat(document.getElementById('employee-salary').value);
    const contact = document.getElementById('employee-contact').value.trim();
    const shiftStart = document.getElementById('shift-start').value;
    const shiftEnd = document.getElementById('shift-end').value;
    const warehouseId = document.getElementById('employee-warehouse').value;
    const absenceDays = document.getElementById('employee-absence-days').value.trim();
    
    const selectedProducts = Array.from(document.querySelectorAll('.employee-product-checkbox:checked')).map(el => el.value);
    const selectedServices = Array.from(document.querySelectorAll('.employee-service-checkbox:checked')).map(el => el.value);
    const selectedAssets = Array.from(document.querySelectorAll('.employee-asset-checkbox:checked')).map(el => el.value);
    
    if (!name || !position || !salary || isNaN(salary)) {
        showMessage('Please fill all required fields', 'error');
        return;
    }
    
    const shift = (shiftStart && shiftEnd) ? `${shiftStart} - ${shiftEnd}` : 'Not set';
    const absence = absenceDays ? absenceDays.split(',').map(d => d.trim()).filter(d => d) : [];
    
    if (window.editingEmployeeId) {
        const index = employees.findIndex(e => e.id === window.editingEmployeeId);
        if (index !== -1) {
            employees[index] = { 
                ...employees[index],
                name, 
                age: age ? parseInt(age) : null,
                description,
                position, 
                salary, 
                contact, 
                shift,
                warehouseId,
                productsManaged: selectedProducts,
                servicesManaged: selectedServices,
                assetsManaged: selectedAssets,
                absenceDays: absence
            };
            showMessage('Employee updated successfully', 'success');
        }
        window.editingEmployeeId = null;
    } else {
        employees.push({ 
            id: generateId(), 
            name, 
            age: age ? parseInt(age) : null,
            description,
            position, 
            salary, 
            contact, 
            shift,
            warehouseId,
            productsManaged: selectedProducts,
            servicesManaged: selectedServices,
            assetsManaged: selectedAssets,
            absenceDays: absence
        });
        showMessage('Employee added successfully', 'success');
    }
    
    localStorage.setItem('epsilonAproxi_employees', JSON.stringify(employees));
    saveData();
    renderEmployees();
    renderEmployeesPage();
    updateTotals();
    document.getElementById('new-employee-dialog').close();
    clearEmployeeForm();
    resetEmployeeDialogUI();
}

function clearEmployeeForm() {
    document.getElementById('employee-name').value = '';
    document.getElementById('employee-age').value = '';
    document.getElementById('employee-description').value = '';
    document.getElementById('employee-position').value = '';
    document.getElementById('employee-salary').value = '';
    document.getElementById('employee-contact').value = '';
    document.getElementById('shift-start').value = '';
    document.getElementById('shift-end').value = '';
    document.getElementById('employee-warehouse').value = '';
    document.getElementById('employee-absence-days').value = '';
    document.querySelectorAll('.employee-product-checkbox, .employee-service-checkbox, .employee-asset-checkbox').forEach(el => el.checked = false);
}

function resetEmployeeDialogUI() {
    const dialog = document.getElementById('new-employee-dialog');
    const title = dialog.querySelector('h3');
    const submitBtn = dialog.querySelector('button.button-primary');
    
    title.textContent = 'Add New Employee';
    submitBtn.textContent = 'Add Employee';
    window.editingEmployeeId = null;
}

function renderEmployees() {
    const list = document.getElementById('employees-list');
    if (!list) return;
    
    if (employees.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 20px;">No employees yet</p>';
        list.className = '';
        return;
    }
    
    list.className = 'products-grid';
    list.innerHTML = employees.map(emp => `
        <div class="product-card">
            <div class="product-image" style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold;">
                ${emp.name.charAt(0).toUpperCase()}
            </div>
            <div class="product-details">
                <h4 class="product-name">${emp.name}</h4>
                <span class="product-category">${emp.position}</span>
                <p class="product-description">${emp.contact || 'No contact information'}</p>
                <p class="product-price">${formatAmount(emp.salary)}<span style="font-size: 12px;">/month</span></p>
                <p class="product-stock">Shift: ${emp.shift || 'Not set'}</p>
                <button onclick="deleteEmployee('${emp.id}')" class="button button-danger" style="width: 100%; margin-top: 10px;">Delete Employee</button>
            </div>
        </div>
    `).join('');
    
    if (typeof updateDeductionsCards === 'function') updateDeductionsCards();
}

function renderEmployeesPage() {
    const list = document.getElementById('employees-page-list');
    if (!list) return;
    
    if (employees.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 40px;">No employees found</p>';
        return;
    }
    
    list.innerHTML = employees.map(emp => {
        const warehouse = emp.warehouseId ? warehouses.find(w => w.id === emp.warehouseId) : null;
        const warehouseName = warehouse ? warehouse.name : 'Not assigned';
        
        return `
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #3b82f6, #1e40af); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 24px;">
                                ${emp.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h4 style="margin: 0 0 5px 0; font-size: 18px; font-weight: 600;">${emp.name}</h4>
                                <p style="margin: 0; color: #6b7280; font-size: 14px;">${emp.position}${emp.age ? '  Age: ' + emp.age : ''}</p>
                            </div>
                        </div>
                        
                        ${emp.description ? `<p style="margin: 0 0 10px 0; color: #4b5563; font-size: 14px;">${emp.description}</p>` : ''}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                            <div>
                                <p style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Contact</p>
                                <p style="margin: 0; color: #1f2937;">${emp.contact || 'N/A'}</p>
                            </div>
                            <div>
                                <p style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Salary Status</p>
                                <div style="font-size: 13px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                        <span>Total:</span>
                                        <span style="font-weight: 600;">${formatAmount(emp.salary)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px; color: #059669;">
                                        <span>Paid:</span>
                                        <span style="font-weight: 600;">${formatAmount(emp.salaryPaid || 0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; color: #dc2626;">
                                        <span>Remaining:</span>
                                        <span style="font-weight: 600;">${formatAmount(emp.salary - (emp.salaryPaid || 0))}</span>
                                    </div>
                                </div>
                                <button onclick="openSalaryDialog('${emp.id}')" style="margin-top: 5px; width: 100%; padding: 4px; font-size: 11px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;">Manage</button>
                            </div>
                            <div>
                                <p style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Shift</p>
                                <p style="margin: 0; color: #1f2937;">${emp.shift || 'Not set'}</p>
                            </div>
                            <div>
                                <p style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Warehouse</p>
                                <p style="margin: 0; color: #1f2937;">${warehouseName}</p>
                            </div>
                        </div>
                        
                        ${emp.productsManaged && emp.productsManaged.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <p style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Products Managed</p>
                                <p style="margin: 0; color: #1f2937; font-size: 13px;">${emp.productsManaged.join(', ')}</p>
                            </div>
                        ` : ''}
                        
                        ${emp.servicesManaged && emp.servicesManaged.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <p style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Services Managed</p>
                                <p style="margin: 0; color: #1f2937; font-size: 13px;">${emp.servicesManaged.join(', ')}</p>
                            </div>
                        ` : ''}
                        
                        ${emp.assetsManaged && emp.assetsManaged.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <p style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Assets Managed</p>
                                <p style="margin: 0; color: #1f2937; font-size: 13px;">${emp.assetsManaged.length} asset(s)</p>
                            </div>
                        ` : ''}
                        
                        ${emp.absenceDays && emp.absenceDays.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <p style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Absence Days</p>
                                <p style="margin: 0; color: #1f2937; font-size: 13px;">${emp.absenceDays.join(', ')}</p>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-direction: column; margin-left: 15px;">
                        <button onclick="editEmployee('${emp.id}')" class="button button-primary" style="padding: 8px 12px; font-size: 13px;">Edit</button>
                        <button onclick="deleteEmployee('${emp.id}')" class="button button-danger" style="padding: 8px 12px; font-size: 13px;">Delete</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    updateEmployeesPageCards();
}

function updateEmployeesPageCards() {
    const totalEl = document.getElementById('employees-page-total');
    const payrollEl = document.getElementById('employees-page-payroll');
    const absentEl = document.getElementById('employees-page-absent');
    const avgSalaryEl = document.getElementById('employees-page-avg-salary');
    
    const total = employees.length;
    const payroll = employees.reduce((sum, e) => sum + e.salary, 0);
    const avgSalary = total > 0 ? payroll / total : 0;
    
    const today = new Date().toISOString().split('T')[0];
    const absent = employees.filter(e => e.absenceDays && e.absenceDays.includes(today)).length;
    
    if (totalEl) totalEl.textContent = total;
    if (payrollEl) payrollEl.textContent = formatAmount(payroll);
    if (absentEl) absentEl.textContent = absent;
    if (avgSalaryEl) avgSalaryEl.textContent = formatAmount(avgSalary);
}

function filterEmployeesPage() {
    const searchTerm = document.getElementById('employees-page-search').value.toLowerCase();
    const filterType = document.getElementById('employees-page-filter').value;
    
    let filtered = employees.filter(emp => 
        emp.name.toLowerCase().includes(searchTerm) || 
        emp.position.toLowerCase().includes(searchTerm) ||
        (emp.contact && emp.contact.toLowerCase().includes(searchTerm))
    );
    
    if (filterType === 'warehouse') {
        const uniqueWarehouses = [...new Set(employees.map(e => e.warehouseId).filter(Boolean))];
        if (uniqueWarehouses.length > 0) {
            filtered = filtered.filter(emp => emp.warehouseId === uniqueWarehouses[0]);
        }
    } else if (filterType === 'position') {
        const uniquePositions = [...new Set(employees.map(e => e.position))];
        if (uniquePositions.length > 0) {
            filtered = filtered.filter(emp => emp.position === uniquePositions[0]);
        }
    }
    
    const list = document.getElementById('employees-page-list');
    if (filtered.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 40px;">No employees match your search</p>';
        return;
    }
    
    list.innerHTML = filtered.map(emp => {
        const warehouse = emp.warehouseId ? warehouses.find(w => w.id === emp.warehouseId) : null;
        const warehouseName = warehouse ? warehouse.name : 'Not assigned';
        
        return `
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #3b82f6, #1e40af); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 24px;">
                                ${emp.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h4 style="margin: 0 0 5px 0; font-size: 18px; font-weight: 600;">${emp.name}</h4>
                                <p style="margin: 0; color: #6b7280; font-size: 14px;">${emp.position}${emp.age ? '  Age: ' + emp.age : ''}</p>
                            </div>
                        </div>
                        
                        ${emp.description ? `<p style="margin: 0 0 10px 0; color: #4b5563; font-size: 14px;">${emp.description}</p>` : ''}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                            <div>
                                <p style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Contact</p>
                                <p style="margin: 0; color: #1f2937;">${emp.contact || 'N/A'}</p>
                            </div>
                            <div>
                                <p style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Salary Status</p>
                                <div style="font-size: 13px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                        <span>Total:</span>
                                        <span style="font-weight: 600;">${formatAmount(emp.salary)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 2px; color: #059669;">
                                        <span>Paid:</span>
                                        <span style="font-weight: 600;">${formatAmount(emp.salaryPaid || 0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; color: #dc2626;">
                                        <span>Remaining:</span>
                                        <span style="font-weight: 600;">${formatAmount(emp.salary - (emp.salaryPaid || 0))}</span>
                                    </div>
                                </div>
                                <button onclick="openSalaryDialog('${emp.id}')" style="margin-top: 5px; width: 100%; padding: 4px; font-size: 11px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;">Manage</button>
                            </div>
                            <div>
                                <p style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Shift</p>
                                <p style="margin: 0; color: #1f2937;">${emp.shift || 'Not set'}</p>
                            </div>
                            <div>
                                <p style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Warehouse</p>
                                <p style="margin: 0; color: #1f2937;">${warehouseName}</p>
                            </div>
                        </div>
                        
                        ${emp.productsManaged && emp.productsManaged.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <p style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Products Managed</p>
                                <p style="margin: 0; color: #1f2937; font-size: 13px;">${emp.productsManaged.join(', ')}</p>
                            </div>
                        ` : ''}
                        
                        ${emp.servicesManaged && emp.servicesManaged.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <p style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Services Managed</p>
                                <p style="margin: 0; color: #1f2937; font-size: 13px;">${emp.servicesManaged.join(', ')}</p>
                            </div>
                        ` : ''}
                        
                        ${emp.assetsManaged && emp.assetsManaged.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <p style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Assets Managed</p>
                                <p style="margin: 0; color: #1f2937; font-size: 13px;">${emp.assetsManaged.length} asset(s)</p>
                            </div>
                        ` : ''}
                        
                        ${emp.absenceDays && emp.absenceDays.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <p style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px; font-weight: 600; text-transform: uppercase;">Absence Days</p>
                                <p style="margin: 0; color: #1f2937; font-size: 13px;">${emp.absenceDays.join(', ')}</p>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-direction: column; margin-left: 15px;">
                        <button onclick="editEmployee('${emp.id}')" class="button button-primary" style="padding: 8px 12px; font-size: 13px;">Edit</button>
                        <button onclick="deleteEmployee('${emp.id}')" class="button button-danger" style="padding: 8px 12px; font-size: 13px;">Delete</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    renderAttendanceList();
    updateEmployeesPageCards();
}

function renderAttendanceList() {
    const container = document.getElementById('attendance-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (employees.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #6b7280;">No employees found.</p>';
        return;
    }
    
    employees.forEach(emp => {
        const row = document.createElement('div');
        row.className = 'list-item';
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.alignItems = 'center';
        
        // Check if already marked absent today
        const isAbsent = checkIsAbsent(emp.id);
        
        row.innerHTML = `
            <div>
                <div class="item-title">${emp.name}</div>
                <div class="item-subtitle">${emp.position}</div>
                ${isAbsent ? `<span style="font-size: 12px; color: #ef4444;">Absent: ${isAbsent.reason}</span>` : ''}
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="markPresent('${emp.id}')" class="button ${!isAbsent ? 'button-success' : 'button-secondary'}" style="padding: 5px 10px; font-size: 12px;">Present</button>
                <button onclick="openAbsenceDialog('${emp.id}')" class="button ${isAbsent ? 'button-danger' : 'button-secondary'}" style="padding: 5px 10px; font-size: 12px;">Absent</button>
            </div>
        `;
        container.appendChild(row);
    });
}

function checkIsAbsent(empId) {
    // In a real app, check against today's date
    // For now, check if 'absenceRecord' exists in employee object or a separate list
    // Let's assume we store it in a global 'attendanceRecords' array
    if (!window.attendanceRecords) window.attendanceRecords = [];
    
    const today = new Date().toISOString().split('T')[0];
    return window.attendanceRecords.find(r => r.employeeId === empId && r.date.startsWith(today));
}

function markPresent(empId) {
    if (!window.attendanceRecords) window.attendanceRecords = [];
    const today = new Date().toISOString().split('T')[0];
    
    // Remove absence record if exists
    window.attendanceRecords = window.attendanceRecords.filter(r => !(r.employeeId === empId && r.date.startsWith(today)));
    
    renderAttendanceList();
    showMessage('Employee marked as present.', 'success');
}

function openAbsenceDialog(empId) {
    const emp = employees.find(e => e.id === empId);
    if (!emp) return;
    
    document.getElementById('absent-employee-name').value = emp.name;
    document.getElementById('absent-employee-id').value = emp.id;
    document.getElementById('absence-reason').value = '';
    document.getElementById('temp-shift').value = '';
    document.getElementById('salary-cut').value = '';
    
    // Populate replacement dropdown
    const replacementSelect = document.getElementById('replacement-employee');
    replacementSelect.innerHTML = '<option value="">Select replacement...</option>';
    employees.filter(e => e.id !== empId).forEach(e => {
        replacementSelect.innerHTML += `<option value="${e.id}">${e.name}</option>`;
    });
    
    document.getElementById('attendance-dialog').showModal();
}

function saveAbsence() {
    const empId = document.getElementById('absent-employee-id').value;
    const reason = document.getElementById('absence-reason').value;
    const replacementId = document.getElementById('replacement-employee').value;
    const shift = document.getElementById('temp-shift').value;
    const salaryCut = document.getElementById('salary-cut').value;
    
    if (!window.attendanceRecords) window.attendanceRecords = [];
    
    const absenceRecord = {
        id: generateId(),
        employeeId: empId,
        date: new Date().toISOString(),
        reason,
        replacementId,
        shift,
        salaryCut
    };
    
    window.attendanceRecords.push(absenceRecord);
    
    document.getElementById('attendance-dialog').close();
    renderAttendanceList();
    showMessage('Absence recorded.', 'success');
}

function editEmployee(id) {
    const employee = employees.find(e => e.id === id);
    if (!employee) {
        showMessage('Employee not found', 'error');
        return;
    }
    
    document.getElementById('employee-name').value = employee.name;
    document.getElementById('employee-age').value = employee.age || '';
    document.getElementById('employee-description').value = employee.description || '';
    document.getElementById('employee-position').value = employee.position;
    document.getElementById('employee-salary').value = employee.salary;
    document.getElementById('employee-contact').value = employee.contact;
    
    if (employee.shift && employee.shift !== 'Not set') {
        const [start, end] = employee.shift.split(' - ');
        document.getElementById('shift-start').value = start;
        document.getElementById('shift-end').value = end;
    }
    
    document.getElementById('employee-warehouse').value = employee.warehouseId || '';
    document.getElementById('employee-absence-days').value = (employee.absenceDays || []).join(', ');
    
    initializeEmployeeDialog();
    
    if (employee.productsManaged) {
        employee.productsManaged.forEach(product => {
            const checkbox = document.querySelector(`.employee-product-checkbox[value="${product}"]`);
            if (checkbox) checkbox.checked = true;
        });
    }
    
    if (employee.servicesManaged) {
        employee.servicesManaged.forEach(service => {
            const checkbox = document.querySelector(`.employee-service-checkbox[value="${service}"]`);
            if (checkbox) checkbox.checked = true;
        });
    }
    
    if (employee.assetsManaged) {
        employee.assetsManaged.forEach(asset => {
            const checkbox = document.querySelector(`.employee-asset-checkbox[value="${asset}"]`);
            if (checkbox) checkbox.checked = true;
        });
    }
    
    const dialog = document.getElementById('new-employee-dialog');
    const oldTitle = dialog.querySelector('h3');
    oldTitle.textContent = 'Edit Employee';
    
    const oldSubmitBtn = dialog.querySelector('button.button-primary');
    oldSubmitBtn.textContent = 'Update Employee';
    
    const editingId = id;
    window.editingEmployeeId = editingId;
    
    dialog.showModal();
}

function deleteEmployee(id) {
    if (!confirm('Are you sure you want to delete this employee?')) return;
    
    employees = employees.filter(e => e.id !== id);
    localStorage.setItem('epsilonAproxi_employees', JSON.stringify(employees));
    saveData();
    renderEmployees();
    renderEmployeesPage();
    updateTotals();
    showMessage('Employee deleted', 'success');
}

function openSalaryDialog(id) {
    const emp = employees.find(e => e.id === id);
    if (!emp) return;
    
    document.getElementById('salary-employee-id').value = emp.id;
    document.getElementById('salary-employee-name').value = emp.name;
    document.getElementById('salary-total-amount').value = formatAmount(emp.salary);
    document.getElementById('salary-paid-amount').value = emp.salaryPaid || 0;
    
    document.getElementById('salary-payment-dialog').showModal();
}

function saveSalaryPayment() {
    const id = document.getElementById('salary-employee-id').value;
    const paidAmount = parseFloat(document.getElementById('salary-paid-amount').value) || 0;
    
    const empIndex = employees.findIndex(e => e.id === id);
    if (empIndex === -1) return;
    
    employees[empIndex].salaryPaid = paidAmount;
    employees[empIndex].lastPaymentDate = new Date().toISOString();
    
    saveData();
    renderEmployeesPage();
    document.getElementById('salary-payment-dialog').close();
    showMessage('Salary payment updated', 'success');
}
// Mock Data for 5 Different Businesses
const mockBusinessData = {
    glen: {
        businessName: "Glen's Tech Repair",
        ownerName: "Glen Martinez",
        businessType: "Technology",
        location: "San Francisco, CA",
        budget: 15000,
        productCatalog: {
            "Screen Replacement": { sellingPrice: 150.00, buyingPrice: 80.00, stock: 25, id: 'glen_p1', reorderPoint: 5 },
            "Battery Replacement": { sellingPrice: 75.00, buyingPrice: 35.00, stock: 40, id: 'glen_p2', reorderPoint: 10 },
            "Phone Case": { sellingPrice: 25.00, buyingPrice: 10.00, stock: 100, id: 'glen_p3', reorderPoint: 20 },
            "Charging Cable": { sellingPrice: 15.00, buyingPrice: 5.00, stock: 150, id: 'glen_p4', reorderPoint: 30 }
        },
        salesHistory: [
            { id: 'glen_s1', product: "Screen Replacement", quantity: 3, unitPrice: 150.00, date: new Date(Date.now() - 86400000) },
            { id: 'glen_s2', product: "Battery Replacement", quantity: 5, unitPrice: 75.00, date: new Date(Date.now() - 172800000) },
            { id: 'glen_s3', product: "Phone Case", quantity: 12, unitPrice: 25.00, date: new Date(Date.now() - 259200000) }
        ],
        fixedDeductions: [
            { name: "Shop Rent", amount: 2500.00, id: 'glen_d1', isPaid: false, amountPaid: 0 },
            { name: "Utilities", amount: 350.00, id: 'glen_d2', isPaid: true, amountPaid: 350.00 },
            { name: "Insurance", amount: 450.00, id: 'glen_d3', isPaid: false, amountPaid: 0 }
        ]
    },
    
    warren: {
        businessName: "Warren's Coffee House",
        ownerName: "Warren Adrian",
        businessType: "Restaurant",
        location: "Seattle, WA",
        budget: 25000,
        productCatalog: {
            "Espresso": { sellingPrice: 4.50, buyingPrice: 1.20, stock: 500, id: 'warren_p1', reorderPoint: 100 },
            "Cappuccino": { sellingPrice: 5.50, buyingPrice: 1.80, stock: 450, id: 'warren_p2', reorderPoint: 100 },
            "Croissant": { sellingPrice: 3.50, buyingPrice: 1.00, stock: 80, id: 'warren_p3', reorderPoint: 20 },
            "Muffin": { sellingPrice: 4.00, buyingPrice: 1.50, stock: 60, id: 'warren_p4', reorderPoint: 15 },
            "Sandwich": { sellingPrice: 8.50, buyingPrice: 3.50, stock: 40, id: 'warren_p5', reorderPoint: 10 }
        },
        salesHistory: [
            { id: 'warren_s1', product: "Espresso", quantity: 45, unitPrice: 4.50, date: new Date(Date.now() - 86400000) },
            { id: 'warren_s2', product: "Cappuccino", quantity: 38, unitPrice: 5.50, date: new Date(Date.now() - 86400000) },
            { id: 'warren_s3', product: "Croissant", quantity: 22, unitPrice: 3.50, date: new Date(Date.now() - 172800000) },
            { id: 'warren_s4', product: "Sandwich", quantity: 15, unitPrice: 8.50, date: new Date(Date.now() - 259200000) }
        ],
        fixedDeductions: [
            { name: "Rent", amount: 4500.00, id: 'warren_d1', isPaid: false, amountPaid: 0 },
            { name: "Staff Salaries", amount: 8000.00, id: 'warren_d2', isPaid: true, amountPaid: 8000.00 },
            { name: "Equipment Lease", amount: 1200.00, id: 'warren_d3', isPaid: false, amountPaid: 600.00 },
            { name: "Supplies", amount: 800.00, id: 'warren_d4', isPaid: true, amountPaid: 800.00 }
        ]
    },
    
    jaydon: {
        businessName: "Jaydon's Fitness Studio",
        ownerName: "Jaydon Thompson",
        businessType: "Services",
        location: "Miami, FL",
        budget: 30000,
        productCatalog: {
            "Protein Powder": { sellingPrice: 45.00, buyingPrice: 22.00, stock: 35, id: 'jaydon_p1', reorderPoint: 10 },
            "Yoga Mat": { sellingPrice: 30.00, buyingPrice: 12.00, stock: 50, id: 'jaydon_p2', reorderPoint: 15 },
            "Water Bottle": { sellingPrice: 15.00, buyingPrice: 6.00, stock: 75, id: 'jaydon_p3', reorderPoint: 20 },
            "Resistance Bands": { sellingPrice: 25.00, buyingPrice: 10.00, stock: 40, id: 'jaydon_p4', reorderPoint: 10 }
        },
        salesHistory: [
            { id: 'jaydon_s1', product: "Protein Powder", quantity: 8, unitPrice: 45.00, date: new Date(Date.now() - 86400000) },
            { id: 'jaydon_s2', product: "Yoga Mat", quantity: 6, unitPrice: 30.00, date: new Date(Date.now() - 172800000) },
            { id: 'jaydon_s3', product: "Water Bottle", quantity: 15, unitPrice: 15.00, date: new Date(Date.now() - 259200000) },
            { id: 'jaydon_s4', product: "Resistance Bands", quantity: 10, unitPrice: 25.00, date: new Date(Date.now() - 345600000) }
        ],
        fixedDeductions: [
            { name: "Studio Rent", amount: 3500.00, id: 'jaydon_d1', isPaid: true, amountPaid: 3500.00 },
            { name: "Trainer Salaries", amount: 6000.00, id: 'jaydon_d2', isPaid: false, amountPaid: 3000.00 },
            { name: "Equipment Maintenance", amount: 500.00, id: 'jaydon_d3', isPaid: false, amountPaid: 0 },
            { name: "Marketing", amount: 1000.00, id: 'jaydon_d4', isPaid: true, amountPaid: 1000.00 }
        ]
    },
    
    vicor: {
        businessName: "Vicor's Auto Parts",
        ownerName: "Vicor Rodriguez",
        businessType: "Retail",
        location: "Houston, TX",
        budget: 50000,
        productCatalog: {
            "Oil Filter": { sellingPrice: 12.00, buyingPrice: 5.00, stock: 200, id: 'vicor_p1', reorderPoint: 50 },
            "Brake Pads": { sellingPrice: 65.00, buyingPrice: 30.00, stock: 80, id: 'vicor_p2', reorderPoint: 20 },
            "Air Filter": { sellingPrice: 18.00, buyingPrice: 8.00, stock: 150, id: 'vicor_p3', reorderPoint: 40 },
            "Spark Plugs": { sellingPrice: 8.00, buyingPrice: 3.00, stock: 300, id: 'vicor_p4', reorderPoint: 75 },
            "Wiper Blades": { sellingPrice: 22.00, buyingPrice: 10.00, stock: 120, id: 'vicor_p5', reorderPoint: 30 }
        },
        salesHistory: [
            { id: 'vicor_s1', product: "Oil Filter", quantity: 25, unitPrice: 12.00, date: new Date(Date.now() - 86400000) },
            { id: 'vicor_s2', product: "Brake Pads", quantity: 12, unitPrice: 65.00, date: new Date(Date.now() - 172800000) },
            { id: 'vicor_s3', product: "Spark Plugs", quantity: 40, unitPrice: 8.00, date: new Date(Date.now() - 259200000) },
            { id: 'vicor_s4', product: "Wiper Blades", quantity: 18, unitPrice: 22.00, date: new Date(Date.now() - 345600000) }
        ],
        fixedDeductions: [
            { name: "Warehouse Rent", amount: 5000.00, id: 'vicor_d1', isPaid: false, amountPaid: 2500.00 },
            { name: "Employee Wages", amount: 7500.00, id: 'vicor_d2', isPaid: true, amountPaid: 7500.00 },
            { name: "Insurance", amount: 1200.00, id: 'vicor_d3', isPaid: false, amountPaid: 0 },
            { name: "Utilities", amount: 600.00, id: 'vicor_d4', isPaid: true, amountPaid: 600.00 }
        ]
    },
    
    dylan: {
        businessName: "Dylan's Fashion Boutique",
        ownerName: "Dylan Chen",
        businessType: "Retail",
        location: "New York, NY",
        budget: 40000,
        productCatalog: {
            "Designer T-Shirt": { sellingPrice: 45.00, buyingPrice: 18.00, stock: 60, id: 'dylan_p1', reorderPoint: 15 },
            "Jeans": { sellingPrice: 85.00, buyingPrice: 40.00, stock: 45, id: 'dylan_p2', reorderPoint: 10 },
            "Dress": { sellingPrice: 120.00, buyingPrice: 55.00, stock: 30, id: 'dylan_p3', reorderPoint: 8 },
            "Sneakers": { sellingPrice: 95.00, buyingPrice: 45.00, stock: 50, id: 'dylan_p4', reorderPoint: 12 },
            "Handbag": { sellingPrice: 150.00, buyingPrice: 70.00, stock: 25, id: 'dylan_p5', reorderPoint: 5 },
            "Sunglasses": { sellingPrice: 65.00, buyingPrice: 25.00, stock: 40, id: 'dylan_p6', reorderPoint: 10 }
        },
        salesHistory: [
            { id: 'dylan_s1', product: "Designer T-Shirt", quantity: 8, unitPrice: 45.00, date: new Date(Date.now() - 86400000) },
            { id: 'dylan_s2', product: "Jeans", quantity: 5, unitPrice: 85.00, date: new Date(Date.now() - 172800000) },
            { id: 'dylan_s3', product: "Dress", quantity: 3, unitPrice: 120.00, date: new Date(Date.now() - 259200000) },
            { id: 'dylan_s4', product: "Sneakers", quantity: 7, unitPrice: 95.00, date: new Date(Date.now() - 345600000) },
            { id: 'dylan_s5', product: "Handbag", quantity: 4, unitPrice: 150.00, date: new Date(Date.now() - 432000000) }
        ],
        fixedDeductions: [
            { name: "Boutique Rent", amount: 6500.00, id: 'dylan_d1', isPaid: false, amountPaid: 0 },
            { name: "Staff Salaries", amount: 5500.00, id: 'dylan_d2', isPaid: true, amountPaid: 5500.00 },
            { name: "Marketing & Ads", amount: 2000.00, id: 'dylan_d3', isPaid: false, amountPaid: 1000.00 },
            { name: "Utilities", amount: 450.00, id: 'dylan_d4', isPaid: true, amountPaid: 450.00 },
            { name: "Website Hosting", amount: 150.00, id: 'dylan_d5', isPaid: true, amountPaid: 150.00 }
        ]
    }
};

// Function to load mock data for a specific user
function loadMockData(userName) {
    const userData = mockBusinessData[userName.toLowerCase()];
    
    if (!userData) {
        console.error(`No mock data found for user: ${userName}`);
        return false;
    }
    
    // Load business information
    document.getElementById('business-name-input').value = userData.businessName;
    document.getElementById('owner-name-input').value = userData.ownerName;
    document.getElementById('businessType').value = userData.businessType;
    document.getElementById('location').value = userData.location;
    
    // Load budget
    budgetAmount = userData.budget;
    
    // Load product catalog
    productCatalog = { ...userData.productCatalog };
    
    // Load sales history
    salesHistory = userData.salesHistory.map(sale => ({
        ...sale,
        date: new Date(sale.date)
    }));
    
    // Load deductions
    fixedDeductions = [...userData.fixedDeductions];
    
    // Initialize stock history
    stockHistory = {};
    Object.keys(productCatalog).forEach(productName => {
        stockHistory[productName] = [{ 
            date: new Date(), 
            stock: productCatalog[productName].stock 
        }];
    });
    
    // Save and update
    saveData();
    saveAccountSettings();
    updateTotals();
    
    showMessage(`Mock data loaded for ${userData.businessName}!`, 'success');
    return true;
}

// Function to get all available mock users
function getMockUsers() {
    return Object.keys(mockBusinessData);
}

// Export for use in main application
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { mockBusinessData, loadMockData, getMockUsers };
}

// --- UTILITY FUNCTIONS ---
const formatAmount = (amount) => {
    const currency = currencyMap[currentCurrency];
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currency.code,
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount);
};

const showMessage = (msg, type = 'success') => {
    const msgBox = document.getElementById('message-box');
    if (!msgBox) return;
    msgBox.textContent = msg;
    msgBox.style.cssText = `
        position: fixed; top: 16px; right: 16px; padding: 12px 20px; border-radius: 8px; 
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); color: white; z-index: 50; 
        transition: opacity 0.3s ease-in-out; opacity: 1;
    `;

    if (type === 'success') {
        msgBox.style.backgroundColor = 'var(--color-secondary)';
    } else if (type === 'error') {
        msgBox.style.backgroundColor = 'var(--color-danger)';
    } else {
        msgBox.style.backgroundColor = 'var(--color-text-dark)';
    }

    setTimeout(() => {
        msgBox.style.opacity = '0';
    }, 3000);
};

const generateId = () => Math.random().toString(36).substring(2, 9);

// --- STORAGE FUNCTIONS ---
const STORAGE_KEYS = {
    products: 'epsilon_products',
    sales: 'epsilon_sales',
    deductions: 'epsilon_deductions',
    currency: 'epsilon_currency',
    budget: 'epsilon_budget',
    clients: 'epsilon_clients',
    notifications: 'epsilon_notifications',
    goals: 'epsilon_goals',
    warehouses: 'epsilon_warehouses'
};

let notifications = [];

function checkDeductionDeadlines() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    fixedDeductions.forEach(deduction => {
        if (!deduction.deadline || deduction.isPaid) return;
        
        const deadline = new Date(deduction.deadline);
        deadline.setHours(0, 0, 0, 0);
        const daysUntil = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
        
        const existingNotif = notifications.find(n => 
            n.relatedId === deduction.id && n.type === 'deadline'
        );
        
        if (daysUntil < 0 && !existingNotif) {
            addNotification(
                `Payment OVERDUE: "${deduction.name}" was due ${Math.abs(daysUntil)} day(s) ago! Amount: ${formatAmount(deduction.amount)}`,
                'error',
                deduction.id
            );
        } else if (daysUntil >= 0 && daysUntil <= 3 && !existingNotif) {
            addNotification(
                `Payment Due Soon: "${deduction.name}" is due in ${daysUntil} day(s). Amount: ${formatAmount(deduction.amount)}`,
                'warning',
                deduction.id
            );
        } else if (existingNotif && (daysUntil > 3 || daysUntil < -7)) {
            notifications = notifications.filter(n => n.id !== existingNotif.id);
            saveData();
            renderNotifications();
        }
    });
}

function addNotification(message, type = 'info', relatedId = null, category = 'system') {
    const notification = {
        id: generateId(),
        message,
        type: type === 'deadline' ? 'warning' : type,
        timestamp: new Date().toISOString(),
        read: false,
        relatedId: relatedId,
        category: category
    };
    
    notifications.unshift(notification);
    saveData();
    renderNotifications();
    updateNotificationBadge();
}

function saveData() {
    const data = {
        productCatalog,
        salesHistory,
        fixedDeductions,
        currentCurrency,
        clients,
        customers,
        stockHistory
    };
    localStorage.setItem("epsilonData", JSON.stringify(data));
    localStorage.setItem(STORAGE_KEYS.budget, budgetAmount.toString());
    localStorage.setItem(STORAGE_KEYS.notifications, JSON.stringify(notifications));
    localStorage.setItem(STORAGE_KEYS.goals, JSON.stringify(goals));
    localStorage.setItem(STORAGE_KEYS.warehouses, JSON.stringify(warehouses));
    localStorage.setItem('epsilon_services', JSON.stringify(serviceCatalog));
    localStorage.setItem('epsilon_service_history', JSON.stringify(serviceHistory));
    
    updateShowcaseDisplay();
}

function updateShowcaseDisplay() {
    const currentPage = document.querySelector('.page:not([style*="display: none"])');
    if (currentPage && currentPage.id === 'business-showcase-page') {
        renderBusinesses();
    } else if (currentPage && currentPage.id === 'business-detail-page' && currentViewingBusiness === null) {
        renderUserBusinessProducts();
    }
}

function loadData() {
    const saved = localStorage.getItem("epsilonData");
    if (saved) {
        try {
            const data = JSON.parse(saved);
            productCatalog = data.productCatalog || {};
            salesHistory = data.salesHistory || [];
            fixedDeductions = data.fixedDeductions || [];
            currentCurrency = data.currentCurrency || '$';
            clients = data.clients || [];
            customers = data.customers || [];
            stockHistory = data.stockHistory || {};
            
            // Initialize stock history for existing products if not present
            Object.keys(productCatalog).forEach(productName => {
                if (!stockHistory[productName] || stockHistory[productName].length === 0) {
                    stockHistory[productName] = [{ date: new Date(), stock: productCatalog[productName].stock || 0 }];
                }
            });
        } catch (err) {
            console.error("Save data corrupted :", err);
        }
    }
    
    const savedGoals = localStorage.getItem(STORAGE_KEYS.goals);
    if (savedGoals) {
        try {
            goals = JSON.parse(savedGoals);
        } catch (err) {
            goals = [];
        }
    }
    
    const savedBudget = localStorage.getItem(STORAGE_KEYS.budget);
    if (savedBudget) {
        budgetAmount = parseFloat(savedBudget);
        document.getElementById('total-budget').textContent = formatAmount(budgetAmount);
        const dashboardBudget = document.getElementById('dashboard-budget-display');
        if (dashboardBudget) dashboardBudget.textContent = formatAmount(budgetAmount);
    }
    
    const savedNotifications = localStorage.getItem(STORAGE_KEYS.notifications);
    if (savedNotifications) {
        try {
            notifications = JSON.parse(savedNotifications);
        } catch (err) {
            notifications = [];
        }
    }
    
    const savedWarehouses = localStorage.getItem(STORAGE_KEYS.warehouses);
    if (savedWarehouses) {
        try {
            warehouses = JSON.parse(savedWarehouses);
        } catch (err) {
            warehouses = [];
        }
    }
    
    const savedServices = localStorage.getItem('epsilon_services');
    if (savedServices) {
        try {
            serviceCatalog = JSON.parse(savedServices);
        } catch (err) {
            serviceCatalog = {};
        }
    }
    
    const savedServiceHistory = localStorage.getItem('epsilon_service_history');
    if (savedServiceHistory) {
        try {
            serviceHistory = JSON.parse(savedServiceHistory);
        } catch (err) {
            serviceHistory = [];
        }
    }
}

// --- FINANCIAL CALCULATIONS ---
function calculateFinancials() {
    let totalRevenue = 0;
    let totalCostOfGoodsSold = 0;
    let totalFixedDeductions = fixedDeductions.reduce((sum, d) => sum + d.amount, 0);

    salesHistory.forEach(sale => {
        totalRevenue += sale.quantity * sale.unitPrice;
        const product = productCatalog[sale.product];
        if (product) {
            totalCostOfGoodsSold += sale.quantity * product.buyingPrice;
        }
    });

    const grossProfit = totalRevenue - totalCostOfGoodsSold;
    const netProfitLoss = grossProfit - totalFixedDeductions;
    
    return {
        totalRevenue,
        totalCostOfGoodsSold,
        totalFixedDeductions,
        grossProfit,
        netProfitLoss
    };
}

function calculateExpiredProductLoss() {
    let totalLoss = 0;
    const today = new Date();
    
    Object.keys(productCatalog).forEach(productName => {
        const product = productCatalog[productName];
        
        if (product.expiryDate) {
            const expiryDate = new Date(product.expiryDate);
            
            // Check if product has expired
            if (expiryDate < today && product.stock > 0) {
                // Calculate loss: quantity  buying price
                const loss = product.stock * product.buyingPrice;
                totalLoss += loss;
            }
        }
    });
    
    return totalLoss;
}

function calculateMonthlyMetrics() {
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    let monthlyRevenue = 0;
    let monthlyCOGS = 0;
    
    salesHistory.forEach(sale => {
        const saleDate = new Date(sale.date);
        if (saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear) {
            const saleAmount = sale.quantity * sale.unitPrice;
            monthlyRevenue += saleAmount;
            
            const product = productCatalog[sale.product];
            if (product) {
                monthlyCOGS += sale.quantity * product.buyingPrice;
            }
        }
    });
    
    let monthlyFixedDeductions = 0;
    fixedDeductions.forEach(deduction => {
        const deductionDate = new Date(deduction.date);
        if (deductionDate.getMonth() === currentMonth && deductionDate.getFullYear() === currentYear) {
            monthlyFixedDeductions += deduction.amount;
        }
    });
    
    let monthlySalaries = 0;
    if (employees && Array.isArray(employees)) {
        employees.forEach(emp => {
            if (emp.salary) {
                monthlySalaries += emp.salary;
            }
        });
    }
    
    const totalMonthlyDeductions = monthlyFixedDeductions + monthlySalaries;
    const monthlyGrossProfit = monthlyRevenue - monthlyCOGS;
    const monthlyNetProfit = monthlyGrossProfit - totalMonthlyDeductions;
    
    return {
        monthlyRevenue,
        monthlyCOGS,
        monthlyFixedDeductions,
        monthlySalaries,
        totalMonthlyDeductions,
        monthlyGrossProfit,
        monthlyNetProfit
    };
}

function updateMonthlyMetricsCards() {
    const {
        monthlyRevenue,
        monthlyCOGS,
        monthlyFixedDeductions,
        monthlySalaries,
        totalMonthlyDeductions,
        monthlyNetProfit
    } = calculateMonthlyMetrics();
    
    const monthlyRevenueEl = document.getElementById('monthly-revenue');
    const monthlyCogsEl = document.getElementById('monthly-cogs');
    const monthlySalariesEl = document.getElementById('monthly-salaries');
    const monthlyDeductionsEl = document.getElementById('monthly-deductions');
    const monthlyNetProfitEl = document.getElementById('monthly-net-profit');
    
    if (monthlyRevenueEl) monthlyRevenueEl.textContent = formatAmount(monthlyRevenue);
    if (monthlyCogsEl) monthlyCogsEl.textContent = formatAmount(monthlyCOGS);
    if (monthlySalariesEl) monthlySalariesEl.textContent = formatAmount(monthlySalaries);
    if (monthlyDeductionsEl) monthlyDeductionsEl.textContent = formatAmount(totalMonthlyDeductions);
    
    if (monthlyNetProfitEl) {
        monthlyNetProfitEl.textContent = formatAmount(monthlyNetProfit);
        monthlyNetProfitEl.classList.remove('text-secondary', 'text-danger');
        monthlyNetProfitEl.classList.add(monthlyNetProfit >= 0 ? 'text-secondary' : 'text-danger');
    }
}

function updateTotals() {
    const { totalRevenue, totalCostOfGoodsSold, totalFixedDeductions, netProfitLoss } = calculateFinancials();
    
    const revenueEl = document.getElementById('total-revenue');
    const costEl = document.getElementById('total-cost');
    const profitEl = document.getElementById('net-profit');
    const fixedCostEl = document.getElementById('total-fixed-cost'); 
    const totalCost = totalCostOfGoodsSold + totalFixedDeductions;

    if (revenueEl) revenueEl.textContent = formatAmount(totalRevenue);
    if (fixedCostEl) fixedCostEl.textContent = formatAmount(totalFixedDeductions);
    if (costEl) costEl.textContent = formatAmount(totalCost);
    
    if (profitEl) {
        profitEl.textContent = formatAmount(netProfitLoss);
        profitEl.classList.remove('text-secondary', 'text-danger');
        profitEl.classList.add(netProfitLoss >= 0 ? 'text-secondary' : 'text-danger');
    }

    // Update expired product loss
    const expiredLoss = calculateExpiredProductLoss();
    const expiredLossEl = document.getElementById('empty');
    if (expiredLossEl) {
        expiredLossEl.textContent = formatAmount(expiredLoss);
    }

    // Update monthly metrics cards
    updateMonthlyMetricsCards();

    renderProductCatalog();
    renderSalesHistory();
    renderDeductions();
    updateProductDropdowns();
    renderPOSProducts();
    
    const productCountEl = document.getElementById('product-count');
    if (productCountEl) {
        productCountEl.textContent = Object.keys(productCatalog).length;
    }

    const deductionCountEl = document.getElementById('total-deduction-count');
    if (deductionCountEl) {
        deductionCountEl.textContent = fixedDeductions.length;
    }
    
    updateBudgetProgress();
}

// --- BUDGET FUNCTIONS ---
function changeBudget() {
    const budgetInput = document.getElementById('budget-input');
    const budgetValue = parseFloat(budgetInput.value);
    
    if (isNaN(budgetValue) || budgetValue <= 0) {
        showMessage("Please enter a valid budget amount", 'error');
        return;
    }
    
    budgetAmount = budgetValue;
    document.getElementById('total-budget').textContent = formatAmount(budgetAmount);
    const dashboardBudget = document.getElementById('dashboard-budget-display');
    if (dashboardBudget) dashboardBudget.textContent = formatAmount(budgetAmount);
    
    updateBudgetProgress();
    saveData();
    document.getElementById('budget-dialog').close();
    showMessage(`Budget set to ${formatAmount(budgetAmount)}`, 'success');
}

function updateBudgetProgress() {
    const { totalRevenue } = calculateFinancials();
    const progressBar = document.getElementById('budget-progress-bar');
    
    if (budgetAmount > 0 && progressBar) {
        const percentage = Math.min((totalRevenue / budgetAmount) * 100, 100);
        progressBar.style.width = `${percentage}%`;
        
        if (percentage >= 100) {
            progressBar.style.backgroundColor = '#ef4444';
        } else if (percentage >= 75) {
            progressBar.style.backgroundColor = '#f97316';
        } else {
            progressBar.style.backgroundColor = 'var(--color-budget)';
        }
    } else if (progressBar) {
        progressBar.style.width = '0%';
    }
}

// --- SALES FUNCTIONS ---
function renderPOSProducts(filteredProducts = null) {
    const grid = document.getElementById('pos-products-grid');
    if (!grid) return;
    
    const products = filteredProducts || Object.keys(productCatalog);
    
    if (products.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 20px; grid-column: 1/-1;">No products available</p>';
        return;
    }
    
    grid.innerHTML = products.map(name => {
        const product = productCatalog[name];
        const isOutOfStock = product.stock === 0;
        
        return `
            <div class="pos-product-item ${isOutOfStock ? 'out-of-stock' : ''}" 
                 onclick="${isOutOfStock ? '' : `addToPOSCart('${name}')`}"
                 style="opacity: ${isOutOfStock ? '0.6' : '1'}; cursor: ${isOutOfStock ? 'not-allowed' : 'pointer'};"
                 title="${name}">
                <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; font-size: 14px;">${name}</div>
                <div class="pos-product-item-price">${formatAmount(product.sellingPrice)}</div>
                <div class="pos-product-item-stock">${isOutOfStock ? 'Out of Stock' : `Stock: ${product.stock}`}</div>
            </div>
        `;
    }).join('');
}

let posMode = 'products';

function setPOSMode(mode) {
    posMode = mode;
    
    const productsBtn = document.getElementById('pos-products-btn');
    const servicesBtn = document.getElementById('pos-services-btn');
    const title = document.getElementById('pos-items-title');
    const grid = document.getElementById('pos-products-grid');
    
    if (mode === 'products') {
        if (productsBtn) productsBtn.className = 'button button-primary';
        if (servicesBtn) servicesBtn.className = 'button button-secondary';
        if (title) title.textContent = 'Products';
        renderPOSProducts();
    } else {
        if (productsBtn) productsBtn.className = 'button button-secondary';
        if (servicesBtn) servicesBtn.className = 'button button-primary';
        if (title) title.textContent = 'Services';
        renderPOSServices();
    }
}

function filterPOSProducts() {
    const search = document.getElementById('pos-search').value.toLowerCase().trim();
    if (!search) {
        posMode === 'products' ? renderPOSProducts() : renderPOSServices();
        return;
    }
    
    if (posMode === 'products') {
        const filtered = Object.keys(productCatalog).filter(name => 
            name.toLowerCase().includes(search)
        );
        renderPOSProducts(filtered);
    } else {
        const filtered = Object.keys(serviceCatalog).filter(name => 
            name.toLowerCase().includes(search)
        );
        renderPOSServices(filtered);
    }
}

function filterPOSItems() {
    filterPOSProducts();
}

function renderPOSServices(filteredServices = null) {
    const grid = document.getElementById('pos-products-grid');
    if (!grid) return;
    
    const services = filteredServices || Object.keys(serviceCatalog);
    
    if (services.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 20px; grid-column: 1/-1;">No services available</p>';
        return;
    }
    
    grid.innerHTML = services.map(name => {
        const service = serviceCatalog[name];
        
        return `
            <div class="pos-product-item" 
                 onclick="addServiceToPOSCart('${name}')"
                 title="${name}">
                <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; font-size: 14px;">${name}</div>
                <div class="pos-product-item-price">${formatAmount(service.price)}</div>
                <div class="pos-product-item-stock">${service.duration} mins</div>
            </div>
        `;
    }).join('');
}

function addServiceToPOSCart(serviceName) {
    const service = serviceCatalog[serviceName];
    if (!service) {
        showMessage('Service not found', 'error');
        return;
    }
    
    const existingItem = posCart.find(item => item.product === serviceName && item.type === 'service');
    
    if (existingItem) {
        existingItem.quantity++;
    } else {
        posCart.push({
            product: serviceName,
            type: 'service',
            quantity: 1,
            price: service.price
        });
    }
    
    renderPOSCart();
}

function addToPOSCart(productName) {
    const product = productCatalog[productName];
    if (!product || product.stock === 0) {
        showMessage('Product out of stock', 'error');
        return;
    }
    
    const existingItem = posCart.find(item => item.product === productName);
    
    if (existingItem) {
        if (existingItem.quantity >= product.stock) {
            showMessage('Cannot add more - insufficient stock', 'error');
            return;
        }
        existingItem.quantity++;
    } else {
        posCart.push({
            product: productName,
            quantity: 1,
            price: product.sellingPrice
        });
    }
    
    renderPOSCart();
}

function updatePOSCartQuantity(productName, change) {
    const item = posCart.find(i => i.product === productName);
    if (!item) return;
    
    const product = productCatalog[productName];
    const newQuantity = item.quantity + change;
    
    if (newQuantity <= 0) {
        posCart = posCart.filter(i => i.product !== productName);
    } else if (newQuantity <= product.stock) {
        item.quantity = newQuantity;
    } else {
        showMessage('Insufficient stock', 'error');
        return;
    }
    
    renderPOSCart();
}

function renderPOSCart() {
    const cartDiv = document.getElementById('pos-cart');
    const subtotalEl = document.getElementById('pos-subtotal');
    const totalEl = document.getElementById('pos-total');
    
    if (!cartDiv) return;
    
    if (posCart.length === 0) {
        cartDiv.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 20px;">Cart is empty</p>';
        if (subtotalEl) subtotalEl.textContent = formatAmount(0);
        if (totalEl) totalEl.textContent = formatAmount(0);
        return;
    }
    
    let subtotal = 0;
    
    cartDiv.innerHTML = posCart.map(item => {
        const itemTotal = item.quantity * item.price;
        subtotal += itemTotal;
        
        return `
            <div class="pos-cart-item">
                <div class="pos-cart-item-info">
                    <div class="pos-cart-item-name">${item.product}</div>
                    <div class="pos-cart-item-details">${formatAmount(item.price)} each  ${item.quantity}</div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; margin: 0 12px;">
                    <button onclick="updatePOSCartQuantity('${item.product}', -1)" style="width: 30px; height: 30px; border-radius: 4px; border: 1px solid var(--color-border-light); background: var(--color-card-bg); cursor: pointer; font-weight: 600;"></button>
                    <span style="min-width: 35px; text-align: center; font-weight: 600;">${item.quantity}</span>
                    <button onclick="updatePOSCartQuantity('${item.product}', 1)" style="width: 30px; height: 30px; border-radius: 4px; border: 1px solid var(--color-border-light); background: var(--color-card-bg); cursor: pointer; font-weight: 600;">+</button>
                </div>
                <div class="pos-cart-item-price">${formatAmount(itemTotal)}</div>
            </div>
        `;
    }).join('');
    
    if (subtotalEl) subtotalEl.textContent = formatAmount(subtotal);
    if (totalEl) totalEl.textContent = formatAmount(subtotal);
}

function clearPOSCart() {
    if (posCart.length === 0) return;
    
    if (confirm('Clear all items from cart?')) {
        posCart = [];
        renderPOSCart();
        showMessage('Cart cleared', 'success');
    }
}

function completePOSSale() {
    if (posCart.length === 0) {
        showMessage('Cart is empty', 'error');
        return;
    }
    
    renderPOSCustomersList();
    
    // Populate transaction tools
    const toolSelect = document.getElementById('pos-transaction-tool');
    toolSelect.innerHTML = transactionTools.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
    
    // Set default amount paid to total
    const total = posCart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
    document.getElementById('pos-amount-paid').value = total.toFixed(2);
    
    document.getElementById('customer-selection-dialog').showModal();
    
    // Close scanner if open
    closePOSScanner();
}

let selectedCustomerId = null;

function renderPOSCustomersList() {
    const customersList = document.getElementById('pos-customers-list');
    customersList.innerHTML = '';
    
    customers.forEach(customer => {
        const button = document.createElement('button');
        button.style.cssText = `
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 5px;
            text-align: left;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        `;
        const debtInfo = customer.debt > 0 ? `<br><span style="font-size: 12px; color: #dc2626; font-weight: 600;">Debt: ${formatAmount(customer.debt)}</span>` : '';
        button.innerHTML = `<strong>${customer.name}</strong><br><span style="font-size: 12px; color: #6b7280;">${customer.email}</span>${debtInfo}`;
        button.onmouseover = () => button.style.background = '#e5e7eb';
        button.onmouseout = () => button.style.background = '#f3f4f6';
        button.onclick = () => selectPOSCustomer(customer.id);
        customersList.appendChild(button);
    });
    
    if (customers.length === 0) {
        customersList.innerHTML = '<p style="text-align: center; color: #9ca3af;">No customers found. Create one below.</p>';
    }
}

function filterPOSCustomers() {
    const searchTerm = document.getElementById('pos-customer-search').value.toLowerCase();
    const buttons = document.querySelectorAll('#pos-customers-list button');
    
    buttons.forEach(btn => {
        const text = btn.textContent.toLowerCase();
        btn.style.display = text.includes(searchTerm) ? 'block' : 'none';
    });
}

function selectPOSCustomer(customerId) {
    selectedCustomerId = customerId;
    document.getElementById('pos-customer-search').value = customers.find(c => c.id === customerId).name;
    document.getElementById('pos-new-customer-name').value = '';
}

function confirmPOSSaleCustomer() {
    let customerId = selectedCustomerId;
    const amountPaid = parseFloat(document.getElementById('pos-amount-paid').value) || 0;
    const paymentMethod = document.getElementById('pos-transaction-tool').value;
    
    if (!customerId) {
        const newCustomerName = document.getElementById('pos-new-customer-name').value.trim();
        if (newCustomerName) {
            const newCustomer = {
                id: generateId(),
                name: newCustomerName,
                email: `${newCustomerName.toLowerCase().replace(/\s+/g, '.')}@pos`,
                phone: '',
                age: null,
                description: 'Created from POS sale',
                createdAt: new Date().toISOString(),
                totalSpent: 0,
                purchaseCount: 0,
                favoriteProducts: {},
                lastPurchaseDate: null,
                debt: 0
            };
            customers.push(newCustomer);
            customerId = newCustomer.id;
        }
    }
    
    const total = posCart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
    const debt = Math.max(0, total - amountPaid);
    
    posCart.forEach(item => {
        if (item.type === 'service') {
            logServiceCompletion(item.product);
            return;
        }
        const product = productCatalog[item.product];
        if (!product) return;
        
        const sale = {
            id: generateId(),
            product: item.product,
            quantity: item.quantity,
            unitPrice: item.price,
            date: new Date(),
            customerId: customerId,
            amountPaid: amountPaid,
            paymentMethod: paymentMethod
        };
        
        product.stock -= item.quantity;
        
        if (!stockHistory[item.product]) {
            stockHistory[item.product] = [];
        }
        stockHistory[item.product].push({ date: new Date(), stock: product.stock });
        
        salesHistory.push(sale);
        
        if (customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (customer) {
                customer.totalSpent += item.quantity * item.price;
                customer.purchaseCount += 1;
                customer.favoriteProducts[item.product] = (customer.favoriteProducts[item.product] || 0) + item.quantity;
                customer.lastPurchaseDate = new Date().toISOString();
            }
        }
    });
    
    if (customerId && debt > 0) {
        const customer = customers.find(c => c.id === customerId);
        if (customer) {
            customer.debt = (customer.debt || 0) + debt;
        }
    }
    
    saveData();
    updateTotals();
    updateCustomerStats();
    renderCustomers();
    updateTransactionMethodsChart();
    
    posCart = [];
    renderPOSCart();
    renderPOSProducts();
    
    selectedCustomerId = null;
    document.getElementById('pos-customer-search').value = '';
    document.getElementById('pos-new-customer-name').value = '';
    document.getElementById('customer-selection-dialog').close();
    
    checkLowStock();

    if (debt > 0) {
        showMessage(`Sale completed. Customer debt increased by ${formatAmount(debt)}`, 'warning');
    } else {
        showMessage('Sale completed successfully', 'success');
    }
}

function logSale() {
    const productSelect = document.getElementById('product-select-sale');
    const quantityInput = document.getElementById('quantity-input-sale');
    
    const productName = productSelect.value;
    const quantity = parseInt(quantityInput.value);
    
    if (!productName || !quantity || quantity <= 0) {
        showMessage("Please select a product and enter a valid quantity.", 'error');
        return;
    }
    
    const product = productCatalog[productName];
    if (!product) {
        showMessage("Product not found in catalog.", 'error');
        return;
    }
    
    if (product.stock < quantity) {
        showMessage(`Insufficient stock! Available: ${product.stock}`, 'error');
        return;
    }
    
    const sale = {
        id: generateId(),
        product: productName,
        quantity: quantity,
        unitPrice: product.sellingPrice,
        date: new Date()
    };
    
    product.stock -= quantity;
    
    // Track stock reduction
    if (!stockHistory[productName]) {
        stockHistory[productName] = [];
    }
    stockHistory[productName].push({ date: new Date(), stock: product.stock });
    
    salesHistory.push(sale);
    saveData();
    updateTotals();
    
    productSelect.value = "";
    quantityInput.value = "";
    
    showMessage(`Sale recorded: ${quantity}  ${productName}`, 'success');
    checkLowStock();
}

function checkLowStock() {
    Object.keys(productCatalog).forEach(name => {
        const product = productCatalog[name];
        if (product.stock === 0) {
            addNotification(`${name} is OUT OF STOCK!`, 'error');
        } else if (product.stock <= (product.reorderPoint || 5)) {
            addNotification(`${name} is low on stock (${product.stock} remaining)`, 'warning');
        }
    });
}

function renderSalesHistory() {
    const historyList = document.getElementById("history-list");
    if (!historyList) return;

    if (salesHistory.length === 0) {
        historyList.innerHTML = `<p style="padding: 16px; text-align: center; color: #9ca3af; font-style: italic;">No sales recorded yet.</p>`;
        return;
    }

    historyList.innerHTML = "";
    const sorted = salesHistory.slice().sort((a, b) => b.date - a.date);

    sorted.forEach(sale => {
        const total = sale.quantity * sale.unitPrice;
        const entry = document.createElement("div");
        entry.className = "list-item";
        
        const product = productCatalog[sale.product];
        const buyingPrice = product ? product.buyingPrice : 0;
        const profit = (sale.unitPrice - buyingPrice) * sale.quantity;
        const profitColorClass = profit >= 0 ? 'text-secondary' : 'text-danger';

        entry.innerHTML = `
            <div style="flex-grow: 1;">
                <div class="list-item-main">${sale.product}</div>
                <div class="list-item-detail">
                    Qty: ${sale.quantity} @ ${formatAmount(sale.unitPrice)}
                </div>
                <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">${new Date(sale.date).toLocaleString()}</div>
            </div>
            <div style="text-align: right;">
                <div class="list-total">${formatAmount(total)}</div>
                <div class="${profitColorClass}" style="font-size: 13px;">
                    Profit: ${formatAmount(profit)}
                </div>
            </div>
        `;
        historyList.appendChild(entry);
    });
}

function updateProductDropdowns() {
    const productSelectSale = document.getElementById('product-select-sale');
    
    if (productSelectSale) {
        const productNames = Object.keys(productCatalog);
        productSelectSale.innerHTML = '<option value="" disabled selected>Select a product...</option>';
        productSelectSale.innerHTML += productNames.map(name => 
            `<option value="${name}">${name} (${formatAmount(productCatalog[name].sellingPrice)})</option>`
        ).join('');
    }
}

// --- DEDUCTIONS FUNCTIONS ---
let deductionReceiptData = null;

function previewDeductionReceipt(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        deductionReceiptData = e.target.result;
        const preview = document.getElementById('deduction-receipt-preview');
        preview.src = e.target.result;
        preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
}

function addDeduction() {
    const nameInput = document.getElementById('new-deduction-name');
    const amountInput = document.getElementById('new-deduction-amount');
    const deadlineInput = document.getElementById('deduction-deadline');
    const paymentStatus = document.querySelector('input[name="payment-status"]:checked');

    const name = nameInput.value.trim();
    const amount = parseFloat(amountInput.value);
    const deadline = deadlineInput.value;
    const isPaid = paymentStatus ? paymentStatus.value === 'paid' : false;

    if (!name || isNaN(amount) || amount <= 0) {
        showMessage("Invalid name or amount.", 'error');
        return;
    }
    
    const deduction = { 
        name: name, 
        amount: amount, 
        id: generateId(),
        receipt: deductionReceiptData || null,
        deadline: deadline || null,
        isPaid: isPaid,
        createdAt: new Date().toISOString()
    };
    
    fixedDeductions.push(deduction);
    nameInput.value = '';
    amountInput.value = '';
    deadlineInput.value = '';
    document.querySelector('input[name="payment-status"][value="unpaid"]').checked = true;
    document.getElementById('deduction-receipt').value = '';
    document.getElementById('deduction-receipt-preview').style.display = 'none';
    deductionReceiptData = null;
    
    showMessage(`Deduction "${name}" of ${formatAmount(amount)} added.`);
    saveData();
    updateTotals();
    checkDeductionDeadlines();
}

function deleteDeduction(id) {
    const initialLength = fixedDeductions.length;
    fixedDeductions = fixedDeductions.filter(d => d.id !== id);
    
    if (fixedDeductions.length < initialLength) {
        showMessage('Deduction deleted.', 'success');
        saveData();
        updateTotals();
    }
}

function togglePaymentStatus(deductionId) {
    const deduction = fixedDeductions.find(d => d.id === deductionId);
    if (!deduction) return;
    
    deduction.isPaid = !deduction.isPaid;
    saveData();
    renderDeductions();
    checkDeductionDeadlines();
    showMessage(`Payment status updated for "${deduction.name}"`, 'success');
}

function renderDeductions(filteredData = null) {
    const deductionsList = document.getElementById('deductions-list');
    if (!deductionsList) return;

    const dataToRender = filteredData || fixedDeductions;

    if (dataToRender.length === 0) {
        deductionsList.innerHTML = `<p style="padding: 16px; text-align: center; color: #9ca3af; font-style: italic;">No fixed deductions recorded.</p>`;
        deductionsList.className = '';
        return;
    }

    deductionsList.className = 'products-grid';
    deductionsList.innerHTML = '';
    
    dataToRender.forEach(deduction => {
        let deadlineText = '';
        let deadlineColor = '#6b7280';
        let statusBadgeColor = '#ef4444';
        let statusBadgeText = 'UNPAID';
        
        if (deduction.deadline) {
            const deadline = new Date(deduction.deadline);
            const today = new Date();
            const daysUntil = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
            
            deadlineText = `Due: ${deadline.toLocaleDateString()}`;
            
            if (!deduction.isPaid) {
                if (daysUntil < 0) {
                    deadlineColor = '#ef4444';
                    deadlineText = ` OVERDUE by ${Math.abs(daysUntil)}d`;
                } else if (daysUntil <= 3) {
                    deadlineColor = '#f97316';
                    deadlineText = ` Due in ${daysUntil}d`;
                } else if (daysUntil <= 7) {
                    deadlineColor = '#f59e0b';
                    deadlineText = `Due in ${daysUntil}d`;
                }
            }
        }
        
        if (deduction.isPaid) {
            statusBadgeColor = '#10b981';
            statusBadgeText = ' PAID';
        }

        const receiptButton = deduction.receipt ? `<button onclick="viewReceipt('${deduction.id}')" class="button button-primary" style="width: 100%; margin-top: 8px; padding: 8px; font-size: 12px;">View Receipt</button>` : '';

        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
            <div class="product-image" style="background: ${deduction.isPaid ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'}; color: white; font-size: 14px;">
                ${statusBadgeText}
            </div>
            <div class="product-details">
                <h4 class="product-name">${deduction.name}</h4>
                <span class="product-category">Deduction</span>
                ${deadlineText ? `<p class="product-description" style="color: ${deadlineColor}; font-weight: 600;">${deadlineText}</p>` : '<p class="product-description">No deadline set</p>'}
                <p class="product-price">${formatAmount(deduction.amount)}</p>
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button onclick="togglePaymentStatus('${deduction.id}')" class="button button-${deduction.isPaid ? 'secondary' : 'orange'}" style="flex: 1; padding: 8px; font-size: 12px;">
                        ${deduction.isPaid ? 'Mark Unpaid' : 'Mark Paid'}
                    </button>
                    <button onclick="deleteDeduction('${deduction.id}')" class="button button-danger" style="flex: 1; padding: 8px; font-size: 12px;">Delete</button>
                </div>
                ${receiptButton}
            </div>
        `;
        deductionsList.appendChild(card);
    });
    lucide.createIcons();
}

// Filter deductions by search term
function filterDeductions() {
    const searchTerm = document.getElementById('deductions-search').value.toLowerCase();
    const filtered = fixedDeductions.filter(deduction => 
        deduction.name.toLowerCase().includes(searchTerm)
    );
    renderDeductions(filtered);
}

function viewReceipt(deductionId) {
    const deduction = fixedDeductions.find(d => d.id === deductionId);
    if (!deduction || !deduction.receipt) return;
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Receipt - ${deduction.name}</h3>
                <button class="close-button" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <img src="${deduction.receipt}" style="max-width: 100%; border-radius: 8px;">
            <p style="margin-top: 10px; color: var(--color-text-medium);">Amount: ${formatAmount(deduction.amount)}</p>
        </div>
    `;
    document.body.appendChild(modal);
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

// --- PRODUCTS FUNCTIONS ---
let productBarcodeData = null;

function generateProductBarcode() {
    const nameInput = document.getElementById('new-product-name');
    const name = nameInput.value.trim();
    
    if (!name) {
        showMessage("Please enter a product name first.", 'error');
        return;
    }
    
    // Generate barcode using barcode API
    const barcodeValue = Date.now().toString().slice(-12); // Use timestamp as barcode
    const barcodeUrl = `https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(barcodeValue)}&code=Code128&translate-esc=on`;
    
    productBarcodeData = barcodeUrl;
    productBarcodeValue = barcodeValue; // Store the value
    
    const container = document.getElementById('product-barcode-container');
    const preview = document.getElementById('product-barcode-preview');
    preview.src = barcodeUrl;
    container.style.display = 'block';
    
    showMessage(`Barcode generated for "${name}"`, 'success');
}

function uploadProductBarcode(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        productBarcodeData = e.target.result;
        const container = document.getElementById('product-barcode-container');
        const preview = document.getElementById('product-barcode-preview');
        preview.src = e.target.result;
        container.style.display = 'block';
        
        // Try to read barcode from image
        Html5Qrcode.scanFile(file, true)
        .then(decodedText => {
            productBarcodeValue = decodedText;
            showMessage(`Barcode detected: ${decodedText}`, 'success');
        })
        .catch(err => {
            console.log("Error scanning uploaded barcode: ", err);
            showMessage('Could not detect barcode in image. Please ensure it is clear.', 'warning');
            productBarcodeValue = null;
        });
        
        showMessage('Barcode uploaded successfully', 'success');
    };
    reader.readAsDataURL(file);
}

function addProduct() {
    const nameInput = document.getElementById('new-product-name');
    const sellInput = document.getElementById('new-product-sell');
    const buyInput = document.getElementById('new-product-buy');
    const stockInput = document.getElementById('new-product-stock');
    const reorderInput = document.getElementById('new-product-reorder');
    const supplierInput = document.getElementById('new-product-supplier');
    const expiryInput = document.getElementById('new-product-expiry');

    const name = nameInput.value.trim();
    const sellingPrice = parseFloat(sellInput.value);
    const buyingPrice = parseFloat(buyInput.value);
    const stock = parseInt(stockInput.value) || 0;
    const reorderPoint = parseInt(reorderInput.value) || 5;
    const supplier = supplierInput.value.trim();
    const expiryDate = expiryInput.value;

    if (!name || isNaN(sellingPrice) || sellingPrice < 0 || isNaN(buyingPrice) || buyingPrice < 0) {
        showMessage("I need valid numbers and a name.", 'error');
        return;
    }

    if (productCatalog[name]) {
        showMessage("That product name already exists.", 'error');
        return;
    }
    
    productCatalog[name] = { 
        product: name, 
        sellingPrice, 
        buyingPrice, 
        stock, 
        id: generateId(),
        barcode: productBarcodeData || null,
        barcodeValue: productBarcodeValue || null,
        reorderPoint,
        supplier: supplier || null,
        expiryDate: expiryDate || null
    };
    
    if (!stockHistory[name]) {
        stockHistory[name] = [];
    }
    stockHistory[name].push({ date: new Date(), stock: stock });
    
    nameInput.value = '';
    sellInput.value = '';
    buyInput.value = '';
    stockInput.value = '';
    reorderInput.value = '';
    supplierInput.value = '';
    expiryInput.value = '';
    document.getElementById('product-barcode-container').style.display = 'none';
    productBarcodeData = null;
    productBarcodeValue = null;
    
    showMessage(`Product "${name}" added to catalog.`);
    showNotification(`Product "${name}" created successfully with ${stock} units in stock!`, 'success');
    saveData();
    updateTotals();
    checkInventoryAlerts();
}

function deleteProduct(name) {
    delete productCatalog[name];
    showMessage(`Product "${name}" deleted.`);
    showNotification(`Product "${name}" has been deleted from catalog.`, 'warning');
    saveData();
    updateTotals();
}

function editStock(productName) {
    const product = productCatalog[productName];
    if (!product) return;
    
    const oldStock = product.stock;
    const newStock = prompt(`Edit stock for "${productName}"\nCurrent stock: ${product.stock}`, product.stock);
    if (newStock === null) return;
    
    const stockValue = parseInt(newStock);
    if (isNaN(stockValue) || stockValue < 0) {
        showMessage("Please enter a valid stock number.", 'error');
        return;
    }
    
    product.stock = stockValue;
    
    // Track stock change
    if (!stockHistory[productName]) {
        stockHistory[productName] = [];
    }
    stockHistory[productName].push({ date: new Date(), stock: stockValue });
    
    saveData();
    updateTotals();
    showMessage(`Stock updated for "${productName}": ${stockValue}`, 'success');
    
    // Notification for restocking
    if (stockValue > oldStock) {
        showNotification(`Product "${productName}" restocked! Stock increased from ${oldStock} to ${stockValue} units.`, 'info');
    } else if (stockValue < oldStock) {
        showNotification(`Product "${productName}" stock reduced from ${oldStock} to ${stockValue} units.`, 'warning');
    }
    
    checkLowStock();
}

function renderProductCatalog() {
    const productListContainer = document.getElementById('product-list-container');
    if (!productListContainer) return;
    
    const productsArray = Object.keys(productCatalog).map(key => ({ product: key, ...productCatalog[key] }));

    if (productsArray.length === 0) {
        productListContainer.innerHTML = `<p style="padding: 16px; text-align: center; color: #9ca3af; font-style: italic;">No products defined.</p>`;
        productListContainer.className = 'list-container';
        return;
    }

    productListContainer.className = 'products-grid';
    productListContainer.innerHTML = productsArray.map(product => {
        const stock = product.stock || 0;
        const reorderPoint = product.reorderPoint || 5;
        
        let stockColor = '#3b82f6';
        let stockBadge = 'Normal';
        if (stock === 0) {
            stockColor = '#ef4444';
            stockBadge = 'OUT OF STOCK';
        } else if (stock <= reorderPoint) {
            stockColor = '#f97316';
            stockBadge = 'LOW STOCK';
        }
        
        let expiryText = 'No expiry';
        let expiryColor = '#6b7280';
        if (product.expiryDate) {
            const expiryDate = new Date(product.expiryDate);
            const daysUntilExpiry = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
            
            if (daysUntilExpiry < 0) {
                expiryColor = '#ef4444';
                expiryText = `EXPIRED ${Math.abs(daysUntilExpiry)}d ago`;
            } else if (daysUntilExpiry <= 7) {
                expiryColor = '#f97316';
                expiryText = `Expires in ${daysUntilExpiry}d`;
            } else {
                expiryText = `Expires: ${expiryDate.toLocaleDateString()}`;
            }
        }
        
        const barcodeBtn = product.barcode ? `<button onclick="viewBarcode('${product.product}')" class="button button-secondary" style="flex: 1; padding: 8px; font-size: 11px;">Barcode</button>` : '';
        
        return `
        <div class="product-card">
            <div class="product-image" style="background: linear-gradient(135deg, ${stockColor} 0%, ${stockColor}dd 100%); color: white; font-size: 12px;">
                ${stockBadge}
            </div>
            <div class="product-details">
                <h4 class="product-name">${product.product}</h4>
                <span class="product-category">${product.supplier || 'No supplier'}</span>
                <p class="product-description" style="color: ${expiryColor};">${expiryText}</p>
                <p class="product-price">Sell: ${formatAmount(product.sellingPrice)}</p>
                <p class="product-stock">Stock: ${stock} units (Reorder at ${reorderPoint})</p>
                <p class="product-stock" style="color: #6b7280;">Cost: ${formatAmount(product.buyingPrice)}</p>
                <div style="display: flex; gap: 8px; margin-top: 10px;">
                    <button onclick="editStock('${product.product}')" class="button button-primary" style="flex: 1; padding: 8px; font-size: 12px;">Edit Stock</button>
                    <button onclick="deleteProduct('${product.product}')" class="button button-danger" style="flex: 1; padding: 8px; font-size: 12px;">Delete</button>
                    ${barcodeBtn}
                </div>
            </div>
        </div>
    `}).join('');
    lucide.createIcons();
}

function viewBarcode(productName) {
    const product = productCatalog[productName];
    if (!product || !product.barcode) return;
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'flex';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <div class="modal-header">
                <h3>Barcode - ${productName}</h3>
                <button class="close-button" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <img src="${product.barcode}" style="max-width: 100%; border-radius: 8px; background: white; padding: 20px;">
            <div style="margin-top: 15px; text-align: left;">
                <p style="color: var(--color-text-medium); margin: 5px 0;">Selling Price: ${formatAmount(product.sellingPrice)}</p>
                <p style="color: var(--color-text-medium); margin: 5px 0;">Stock: ${product.stock || 0} units</p>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

// --- CLIENT FUNCTIONS ---
function addClient() {
    const nameInput = document.querySelector('#client-dialog input[placeholder="name"]');
    const contactInput = document.querySelector('#client-dialog input[placeholder="contact"]');
    const typeSelect = document.querySelector('#client-dialog select');
    const descriptionInput = document.querySelector('#client-dialog textarea');
    
    const name = nameInput.value.trim();
    const contact = contactInput.value.trim();
    const type = typeSelect.value;
    const description = descriptionInput.value.trim();
    
    if (!name || !contact) {
        showMessage("Please enter both name and contact information.", 'error');
        return;
    }
    
    const newClient = {
        id: generateId(),
        name,
        contact,
        type,
        description,
        createdAt: new Date().toISOString()
    };
    
    clients.push(newClient);
    
    nameInput.value = '';
    contactInput.value = '';
    typeSelect.value = 'Client';
    descriptionInput.value = 'Description...';
    
    document.getElementById('client-dialog').close();
    renderClients();
    saveData();
    showMessage(`${type} "${name}" added successfully!`);
}

function deleteClient(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    
    if (confirm(`Are you sure you want to delete ${client.type} "${client.name}"?`)) {
        clients = clients.filter(c => c.id !== clientId);
        renderClients();
        saveData();
        showMessage(`${client.type} "${client.name}" deleted.`);
    }
}

function filterClients() {
    const searchInput = document.getElementById('client-search');
    if (!searchInput) return;
    
    const searchTerm = searchInput.value.toLowerCase().trim();
    const clientList = document.getElementById('client-list');
    
    if (!searchTerm) {
        renderClients();
        return;
    }
    
    const filteredClients = clients.filter(client => 
        client.name.toLowerCase().includes(searchTerm) || 
        client.contact.toLowerCase().includes(searchTerm) ||
        (client.description && client.description.toLowerCase().includes(searchTerm))
    );
    
    // Update statistics
    const totalClients = clients.filter(c => c.type === 'Client').length;
    const totalContractors = clients.filter(c => c.type === 'Contractor').length;
    const totalContacts = clients.length;
    
    const totalClientsEl = document.getElementById('total-clients-stat');
    const totalContractorsEl = document.getElementById('total-contractors-stat');
    const totalContactsEl = document.getElementById('total-contacts-stat');
    
    if (totalClientsEl) totalClientsEl.textContent = totalClients;
    if (totalContractorsEl) totalContractorsEl.textContent = totalContractors;
    if (totalContactsEl) totalContactsEl.textContent = totalContacts;
    
    if (filteredClients.length === 0) {
        clientList.innerHTML = `
            <div style="grid-column: 1 / -1; padding: 60px 20px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 15px;"></div>
                <p style="color: #9ca3af; font-size: 16px;">No results found for "${searchTerm}"</p>
                <p style="color: #d1d5db; font-size: 14px;">Try a different search term.</p>
            </div>
        `;
        return;
    }
    
    clientList.innerHTML = filteredClients.map(client => `
        <div class="card" style="
            border-radius: 10px;
            overflow: hidden;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
            border-top: 4px solid ${client.type === 'Client' ? 'var(--color-primary)' : 'var(--color-orange)'};
            background: white;
        " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 16px rgba(0, 0, 0, 0.12)';" 
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.08)';">
            
            <div style="padding: 20px;">
                <!-- Header with Type Badge -->
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                    <div>
                        <h3 style="margin: 0 0 5px 0; color: var(--color-text-dark); font-size: 18px; font-weight: 700;">
                            ${client.name}
                        </h3>
                        <span style="
                            display: inline-block;
                            padding: 4px 12px;
                            border-radius: 20px;
                            font-size: 12px;
                            font-weight: 600;
                            background: ${client.type === 'Client' ? 'rgba(59, 130, 246, 0.1)' : 'rgba(249, 115, 22, 0.1)'};
                            color: ${client.type === 'Client' ? '#2563eb' : '#ea580c'};
                        ">
                            ${client.type === 'Client' ? ' Client' : ' Contractor'}
                        </span>
                    </div>
                    <button onclick="deleteClient('${client.id}')" 
                            style="background: none; border: none; cursor: pointer; padding: 5px; opacity: 0.6; transition: opacity 0.2s;"
                            onmouseover="this.style.opacity='1';"
                            onmouseout="this.style.opacity='0.6';"
                            aria-label="Delete Client">
                        <svg xmlns="http://www.w3.org/2000/svg" style="height: 20px; width: 20px; color: var(--color-danger);" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                <!-- Contact Information -->
                <div style="border-top: 1px solid #f3f4f6; padding-top: 12px;">
                    <div style="margin-bottom: 10px;">
                        <span style="color: #9ca3af; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;"> Contact</span>
                        <p style="margin: 5px 0 0 0; color: var(--color-text-dark); font-weight: 500; word-break: break-all;">
                            ${client.contact}
                        </p>
                    </div>
                    
                    ${client.description ? `
                        <div style="margin-top: 10px;">
                            <span style="color: #9ca3af; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;"> Notes</span>
                            <p style="margin: 5px 0 0 0; color: var(--color-text-medium); line-height: 1.5; font-size: 14px;">
                                ${client.description}
                            </p>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `).join('');
}

function renderClients() {
    const clientList = document.getElementById('client-list');
    if (!clientList) return;
    
    // Update statistics
    const totalClients = clients.filter(c => c.type === 'Client').length;
    const totalContractors = clients.filter(c => c.type === 'Contractor').length;
    const totalContacts = clients.length;
    
    const totalClientsEl = document.getElementById('total-clients-stat');
    const totalContractorsEl = document.getElementById('total-contractors-stat');
    const totalContactsEl = document.getElementById('total-contacts-stat');
    
    if (totalClientsEl) totalClientsEl.textContent = totalClients;
    if (totalContractorsEl) totalContractorsEl.textContent = totalContractors;
    if (totalContactsEl) totalContactsEl.textContent = totalContacts;
    
    if (clients.length === 0) {
        clientList.innerHTML = `
            <div style="grid-column: 1 / -1; padding: 60px 20px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 15px;"></div>
                <p style="color: #9ca3af; font-size: 16px;">No clients or contractors added yet.</p>
                <p style="color: #d1d5db; font-size: 14px;">Click "Add Client/Contractor" to get started.</p>
            </div>
        `;
        return;
    }
    
    clientList.innerHTML = clients.map(client => `
        <div class="card" style="
            border-radius: 10px;
            overflow: hidden;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
            border-top: 4px solid ${client.type === 'Client' ? 'var(--color-primary)' : 'var(--color-orange)'};
            background: white;
        " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 16px rgba(0, 0, 0, 0.12)';" 
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.08)';">
            
            <div style="padding: 20px;">
                <!-- Header with Type Badge -->
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                    <div>
                        <h3 style="margin: 0 0 5px 0; color: var(--color-text-dark); font-size: 18px; font-weight: 700;">
                            ${client.name}
                        </h3>
                        <span style="
                            display: inline-block;
                            padding: 4px 12px;
                            border-radius: 20px;
                            font-size: 12px;
                            font-weight: 600;
                            background: ${client.type === 'Client' ? 'rgba(59, 130, 246, 0.1)' : 'rgba(249, 115, 22, 0.1)'};
                            color: ${client.type === 'Client' ? '#2563eb' : '#ea580c'};
                        ">
                            ${client.type === 'Client' ? ' Client' : ' Contractor'}
                        </span>
                    </div>
                    <button onclick="deleteClient('${client.id}')" 
                            style="background: none; border: none; cursor: pointer; padding: 5px; opacity: 0.6; transition: opacity 0.2s;"
                            onmouseover="this.style.opacity='1';"
                            onmouseout="this.style.opacity='0.6';"
                            aria-label="Delete Client">
                        <svg xmlns="http://www.w3.org/2000/svg" style="height: 20px; width: 20px; color: var(--color-danger);" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                <!-- Contact Information -->
                <div style="border-top: 1px solid #f3f4f6; padding-top: 12px;">
                    <div style="margin-bottom: 10px;">
                        <span style="color: #9ca3af; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;"> Contact</span>
                        <p style="margin: 5px 0 0 0; color: var(--color-text-dark); font-weight: 500; word-break: break-all;">
                            ${client.contact}
                        </p>
                    </div>
                    
                    ${client.description ? `
                        <div style="margin-top: 10px;">
                            <span style="color: #9ca3af; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;"> Notes</span>
                            <p style="margin: 5px 0 0 0; color: var(--color-text-medium); line-height: 1.5; font-size: 14px;">
                                ${client.description}
                            </p>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `).join('');
}

// --- CALCULATOR FUNCTIONS ---
function calculateProfitMargin() {
    const revenueInput = document.getElementById('calc-revenue');
    const cogsInput = document.getElementById('calc-cogs');
    const resultEl = document.getElementById('calc-result');

    const revenue = parseFloat(revenueInput.value);
    const cogs = parseFloat(cogsInput.value);

    if (isNaN(revenue) || isNaN(cogs) || revenue < 0 || cogs < 0) {
        resultEl.innerHTML = `<p class="text-danger" style="font-weight: 500; margin-top: 16px;">Error: Invalid input. Use positive numbers.</p>`;
        return;
    }

    const grossProfit = revenue - cogs;
    const profitMargin = (revenue > 0) ? (grossProfit / revenue) * 100 : 0;
    const profitColorClass = grossProfit >= 0 ? 'text-secondary' : 'text-danger';

    let html = `
        <div style="margin-top: 24px; padding: 16px; border-radius: 8px; background-color: #f9fafb; border: 1px solid #e5e7eb;">
            <h4 style="font-size: 18px; font-weight: 700; color: var(--color-text-dark); margin-bottom: 12px;">Calculation Results:</h4>
            <ul style="list-style: none; padding: 0;">
                <li style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span class="text-gray-medium">Gross Profit:</span>
                    <span class="${profitColorClass}" style="font-weight: bold;">${formatAmount(grossProfit)}</span>
                </li>
                <li style="display: flex; justify-content: space-between;">
                    <span class="text-gray-medium">Profit Margin (% of Revenue):</span>
                    <span class="text-primary" style="font-weight: bold; font-size: 18px;">${profitMargin.toFixed(2)}%</span>
                </li>
            </ul>
        </div>
    `;
    resultEl.innerHTML = html;
}

function calculateROI() {
    const gainInput = document.getElementById('roi-gain');
    const costInput = document.getElementById('roi-cost');
    const resultEl = document.getElementById('roi-result');

    const gain = parseFloat(gainInput.value);
    const cost = parseFloat(costInput.value);

    if (isNaN(gain) || isNaN(cost) || cost <= 0) {
        resultEl.textContent = "Please enter valid numbers for both fields.";
        resultEl.style.color = 'var(--color-danger)';
        return;
    }

    const roi = ((gain - cost) / cost) * 100;
    const formatted = roi.toFixed(2);

    resultEl.textContent = `ROI: ${formatted}%`;
    resultEl.style.color = roi >= 0 ? 'var(--color-secondary)' : 'var(--color-danger)';
}

function calculateBreakEven() {
    const fixedCostsInput = document.getElementById('be-fixed-costs');
    const unitPriceInput = document.getElementById('be-unit-price');
    const unitCostInput = document.getElementById('be-unit-cost');
    const resultEl = document.getElementById('be-result');

    const fixedCosts = parseFloat(fixedCostsInput.value);
    const unitPrice = parseFloat(unitPriceInput.value);
    const unitCost = parseFloat(unitCostInput.value);

    if (isNaN(fixedCosts) || isNaN(unitPrice) || isNaN(unitCost) || fixedCosts < 0 || unitPrice <= 0 || unitCost < 0) {
        resultEl.innerHTML = `<p style="color: #dc2626; margin-top: 12px; font-size: 14px;">Error: Enter valid numbers. Unit price must be greater than 0.</p>`;
        return;
    }

    const contribution = unitPrice - unitCost;
    
    if (contribution <= 0) {
        resultEl.innerHTML = `<p style="color: #dc2626; margin-top: 12px; font-size: 14px;">Error: Unit price must be higher than unit cost.</p>`;
        return;
    }

    const breakEvenUnits = fixedCosts / contribution;
    const breakEvenRevenue = breakEvenUnits * unitPrice;

    resultEl.innerHTML = `
        <div style="margin-top: 12px; padding: 12px; background-color: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: #6b7280;">Units to Break Even:</span>
                <strong style="color: #1f2937;">${breakEvenUnits.toFixed(0)} units</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: #6b7280;">Break-Even Revenue:</span>
                <strong style="color: #1f2937;">${formatAmount(breakEvenRevenue)}</strong>
            </div>
        </div>
    `;
}

function calculateInventoryTurnover() {
    const cogsInput = document.getElementById('it-cogs');
    const avgInventoryInput = document.getElementById('it-avg-inventory');
    const resultEl = document.getElementById('it-result');

    const cogs = parseFloat(cogsInput.value);
    const avgInventory = parseFloat(avgInventoryInput.value);

    if (isNaN(cogs) || isNaN(avgInventory) || cogs < 0 || avgInventory <= 0) {
        resultEl.innerHTML = `<p style="color: #dc2626; margin-top: 12px; font-size: 14px;">Error: Enter valid numbers. Inventory must be greater than 0.</p>`;
        return;
    }

    const turnover = cogs / avgInventory;
    const daysInventoryOutstanding = 365 / turnover;

    resultEl.innerHTML = `
        <div style="margin-top: 12px; padding: 12px; background-color: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: #6b7280;">Inventory Turnover Ratio:</span>
                <strong style="color: #1f2937;">${turnover.toFixed(2)}x</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: #6b7280;">Days to Sell Inventory:</span>
                <strong style="color: #1f2937;">${daysInventoryOutstanding.toFixed(1)} days</strong>
            </div>
        </div>
    `;
}

function calculateGrossProfit() {
    const revenueInput = document.getElementById('gp-revenue');
    const cogsInput = document.getElementById('gp-cogs');
    const resultEl = document.getElementById('gp-result');

    const revenue = parseFloat(revenueInput.value);
    const cogs = parseFloat(cogsInput.value);

    if (isNaN(revenue) || isNaN(cogs) || revenue < 0 || cogs < 0) {
        resultEl.innerHTML = `<p style="color: #dc2626; margin-top: 12px; font-size: 14px;">Error: Enter valid numbers.</p>`;
        return;
    }

    const grossProfit = revenue - cogs;
    const grossProfitRatio = revenue > 0 ? (grossProfit / revenue) * 100 : 0;

    resultEl.innerHTML = `
        <div style="margin-top: 12px; padding: 12px; background-color: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: #6b7280;">Gross Profit:</span>
                <strong style="color: ${grossProfit >= 0 ? '#059669' : '#dc2626'};">${formatAmount(grossProfit)}</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: #6b7280;">Gross Profit Ratio:</span>
                <strong style="color: #1f2937;">${grossProfitRatio.toFixed(2)}%</strong>
            </div>
        </div>
    `;
}

function calculateSalesTax() {
    const subtotalInput = document.getElementById('st-subtotal');
    const rateInput = document.getElementById('st-rate');
    const resultEl = document.getElementById('st-result');

    const subtotal = parseFloat(subtotalInput.value);
    const rate = parseFloat(rateInput.value);

    if (isNaN(subtotal) || isNaN(rate) || subtotal < 0 || rate < 0) {
        resultEl.innerHTML = `<p style="color: #dc2626; margin-top: 12px; font-size: 14px;">Error: Enter valid numbers.</p>`;
        return;
    }

    const taxAmount = subtotal * (rate / 100);
    const total = subtotal + taxAmount;

    resultEl.innerHTML = `
        <div style="margin-top: 12px; padding: 12px; background-color: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: #6b7280;">Tax Amount:</span>
                <strong style="color: #1f2937;">${formatAmount(taxAmount)}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 16px;">
                <span style="color: #6b7280;">Total:</span>
                <strong style="color: #1f2937;">${formatAmount(total)}</strong>
            </div>
        </div>
    `;
}

// --- SETTINGS FUNCTIONS ---
function changeCurrency(newCurrency) {
    currentCurrency = newCurrency;
    
    document.querySelectorAll('input[name="currency-radio"]').forEach(radio => {
        radio.checked = radio.value === newCurrency;
    });
    
    const sellLabel = document.querySelector('label[for="new-product-sell"]');
    const buyLabel = document.querySelector('label[for="new-product-buy"]');
    
    if (sellLabel) sellLabel.textContent = `Selling Price (${newCurrency})`;
    if (buyLabel) buyLabel.textContent = `Buying Price / COGS (${newCurrency})`;

    showMessage(`Currency set to ${newCurrency}.`);
    saveData();
    updateTotals();
    calculateInventoryCost();
}

function toggleTheme() {
    const body = document.body;
    const isDarkMode = body.classList.toggle("dark-mode");
    const themeButton = document.getElementById('theme-toggle-btn');
    
    localStorage.setItem("theme", isDarkMode ? "dark" : "light");
    
    if (themeButton) {
        themeButton.style.transform = 'rotate(180deg)';
        setTimeout(() => {
            themeButton.style.transform = 'rotate(0deg)';
        }, 300);
    }
    
    if (isDarkMode) {
        document.documentElement.style.colorScheme = 'dark';
    } else {
        document.documentElement.style.colorScheme = 'light';
    }
}

function initTheme() {
    const savedTheme = localStorage.getItem("theme");
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    const shouldBeDark = savedTheme === "dark" || (savedTheme === null && prefersDark);
    
    if (shouldBeDark && !document.body.classList.contains("dark-mode")) {
        document.body.classList.add("dark-mode");
        document.documentElement.style.colorScheme = 'dark';
    } else if (!shouldBeDark && document.body.classList.contains("dark-mode")) {
        document.body.classList.remove("dark-mode");
        document.documentElement.style.colorScheme = 'light';
    }
    
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    if (darkModeToggle) {
        darkModeToggle.checked = document.body.classList.contains("dark-mode");
    }
    
    const savedAccentColor = localStorage.getItem("accentColor");
    if (savedAccentColor) {
        document.documentElement.style.setProperty('--color-primary', savedAccentColor);
        updateAccentColorSelection(savedAccentColor);
    }
}

function changeAccentColor(color, element) {
    document.documentElement.style.setProperty('--color-primary', color);
    localStorage.setItem("accentColor", color);
    
    document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.remove('active');
    });
    
    if (element && element.closest('.color-option')) {
        element.closest('.color-option').classList.add('active');
    }
}

function updateAccentColorSelection(color) {
    document.querySelectorAll('.color-option').forEach(opt => {
        const preview = opt.querySelector('.color-preview');
        let isMatch = false;
        
        if (preview) {
            const bgColor = preview.style.backgroundColor || window.getComputedStyle(preview).backgroundColor;
            const rgbColor = rgbToHex(bgColor);
            isMatch = rgbColor === color.toLowerCase() || bgColor.includes(color);
        }
        
        if (isMatch) {
            opt.classList.add('active');
        } else {
            opt.classList.remove('active');
        }
    });
}

function rgbToHex(rgb) {
    if (rgb.startsWith('#')) return rgb.toLowerCase();
    
    const match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
    if (!match) return rgb.toLowerCase();
    
    const r = parseInt(match[1]).toString(16).padStart(2, '0');
    const g = parseInt(match[2]).toString(16).padStart(2, '0');
    const b = parseInt(match[3]).toString(16).padStart(2, '0');
    
    return `#${r}${g}${b}`;
}

function toggleDarkModeFromSettings() {
    toggleTheme();
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    if (darkModeToggle) {
        darkModeToggle.checked = document.body.classList.contains("dark-mode");
    }
}

// --- CHART FUNCTIONS ---
function renderCharts() {
    const productTotals = {};
    let totalRevenue = 0;

    salesHistory.forEach(sale => {
        const revenue = sale.unitPrice * sale.quantity;
        productTotals[sale.product] = (productTotals[sale.product] || 0) + revenue;
        totalRevenue += revenue;
    });

    const labels = Object.keys(productTotals);
    const revenueData = labels.map(p => productTotals[p]);
    const percentageData = revenueData.map(val => ((val / totalRevenue) * 100).toFixed(2));

    if (window.revenueChartInstance) window.revenueChartInstance.destroy();
    if (window.percentageChartInstance) window.percentageChartInstance.destroy();

    const ctx1 = document.getElementById('revenueChart')?.getContext('2d');
    if (ctx1) {
        window.revenueChartInstance = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Total Revenue',
                    data: revenueData,
                    backgroundColor: '#3b82f6'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: 10
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'Revenue by Product',
                        font: { size: 14 }
                    }
                }
            }
        });
    }

    const ctx2 = document.getElementById('percentageChart')?.getContext('2d');
    if (ctx2) {
        window.percentageChartInstance = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    label: 'Contribution (%)',
                    data: percentageData,
                    backgroundColor: ['#3b82f6', '#10b981', '#f97316', '#ef4444', '#6366f1']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: 10
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'right'
                    },
                    title: {
                        display: true,
                        text: 'Product Contribution (%)',
                        font: { size: 14 }
                    }
                }
            }
        });
    }
}

function renderDeductionsChart() {
    if (window.deductionsChartInstance) {
        window.deductionsChartInstance.destroy();
    }

    const labels = fixedDeductions.map(d => d.name);
    const data = fixedDeductions.map(d => d.amount);

    const ctx = document.getElementById('deductionsChart')?.getContext('2d');
    if (ctx) {
        window.deductionsChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Fixed Deductions',
                    data: data,
                    backgroundColor: ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#22c55e', '#14b8a6'],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: 10
                },
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: { size: 12 }
                        }
                    },
                    title: {
                        display: true,
                        text: 'Distribution of Fixed Deductions',
                        font: { size: 14 }
                    }
                }
            }
        });
    }
}

function renderMonthlyTrendsChart() {
    const monthlyData = {};
    
    const now = new Date();
    for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        monthlyData[monthKey] = {
            month: date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }),
            revenue: 0,
            cost: 0,
            profit: 0
        };
    }
    
    salesHistory.forEach(sale => {
        const saleDate = new Date(sale.date);
        const monthKey = `${saleDate.getFullYear()}-${String(saleDate.getMonth() + 1).padStart(2, '0')}`;
        
        if (monthlyData[monthKey]) {
            const revenue = sale.unitPrice * sale.quantity;
            const product = productCatalog[sale.product];
            const cost = product ? product.buyingPrice * sale.quantity : 0;
            
            monthlyData[monthKey].revenue += revenue;
            monthlyData[monthKey].cost += cost;
            monthlyData[monthKey].profit += (revenue - cost);
        }
    });
    
    const labels = Object.values(monthlyData).map(data => data.month);
    const revenueData = Object.values(monthlyData).map(data => data.revenue);
    const costData = Object.values(monthlyData).map(data => data.cost);
    const profitData = Object.values(monthlyData).map(data => data.profit);
    
    if (window.monthlyTrendsChartInstance) {
        window.monthlyTrendsChartInstance.destroy();
    }
    
    const ctx = document.getElementById('monthly-trends')?.getContext('2d');
    if (ctx) {
        window.monthlyTrendsChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Revenue',
                        data: revenueData,
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderColor: '#3b82f6',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Cost',
                        data: costData,
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderColor: '#ef4444',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Profit',
                        data: profitData,
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderColor: '#10b981',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatAmount(value);
                            }
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Monthly Revenue, Cost & Profit Trends'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += formatAmount(context.raw);
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }
}

function renderTopProductsChart() {
    const productQuantities = {};
    
    salesHistory.forEach(sale => {
        productQuantities[sale.product] = (productQuantities[sale.product] || 0) + sale.quantity;
    });
    
    const sortedProducts = Object.entries(productQuantities)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
    
    const labels = sortedProducts.map(p => p[0]);
    const data = sortedProducts.map(p => p[1]);
    
    if (window.topProductsChartInstance) {
        window.topProductsChartInstance.destroy();
    }
    
    const ctx = document.getElementById('topProductsChart')?.getContext('2d');
    if (ctx) {
        window.topProductsChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Units Sold',
                    data: data,
                    backgroundColor: [
                        '#3b82f6', '#10b981', '#f97316', '#ef4444', '#8b5cf6',
                        '#ec4899', '#14b8a6', '#f59e0b', '#06b6d4', '#6366f1'
                    ],
                    borderRadius: 8
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Top 10 Products by Quantity Sold'
                    }
                }
            }
        });
    }
}

function renderProfitMarginChart() {
    const productMetrics = {};
    
    salesHistory.forEach(sale => {
        if (!productMetrics[sale.product]) {
            const product = productCatalog[sale.product];
            productMetrics[sale.product] = {
                revenue: 0,
                cost: 0
            };
        }
        
        const revenue = sale.unitPrice * sale.quantity;
        const cost = (productCatalog[sale.product]?.buyingPrice || 0) * sale.quantity;
        
        productMetrics[sale.product].revenue += revenue;
        productMetrics[sale.product].cost += cost;
    });
    
    const margins = Object.entries(productMetrics).map(([product, metrics]) => ({
        product,
        margin: metrics.revenue > 0 ? ((metrics.revenue - metrics.cost) / metrics.revenue * 100).toFixed(2) : 0
    })).sort((a, b) => b.margin - a.margin).slice(0, 10);
    
    const labels = margins.map(m => m.product);
    const data = margins.map(m => parseFloat(m.margin));
    
    if (window.profitMarginChartInstance) {
        window.profitMarginChartInstance.destroy();
    }
    
    const ctx = document.getElementById('profitMarginChart')?.getContext('2d');
    if (ctx) {
        window.profitMarginChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Profit Margin (%)',
                    data: data,
                    backgroundColor: 'rgba(16, 185, 129, 0.8)',
                    borderColor: '#10b981',
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Profit Margin by Product (%)'
                    }
                }
            }
        });
    }
}

function renderSalesDistributionChart() {
    const categoryCounts = {};
    const productCategories = {};
    
    Object.keys(productCatalog).forEach(product => {
        const category = productCatalog[product].category || 'Uncategorized';
        productCategories[product] = category;
    });
    
    salesHistory.forEach(sale => {
        const category = productCategories[sale.product] || 'Uncategorized';
        categoryCounts[category] = (categoryCounts[category] || 0) + sale.quantity;
    });
    
    const labels = Object.keys(categoryCounts);
    const data = Object.values(categoryCounts);
    
    if (window.salesDistributionChartInstance) {
        window.salesDistributionChartInstance.destroy();
    }
    
    const ctx = document.getElementById('salesDistributionChart')?.getContext('2d');
    if (ctx) {
        window.salesDistributionChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Sales by Category',
                    data: data,
                    backgroundColor: [
                        '#3b82f6', '#10b981', '#f97316', '#ef4444', '#8b5cf6',
                        '#ec4899', '#14b8a6', '#f59e0b'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Sales Distribution by Category'
                    }
                }
            }
        });
    }
}

function renderRevenueVsExpensesChart() {
    const monthlyData = {};
    
    const now = new Date();
    for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        monthlyData[monthKey] = {
            month: date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }),
            revenue: 0,
            expense: 0
        };
    }
    
    salesHistory.forEach(sale => {
        const saleDate = new Date(sale.date);
        const monthKey = `${saleDate.getFullYear()}-${String(saleDate.getMonth() + 1).padStart(2, '0')}`;
        
        if (monthlyData[monthKey]) {
            const revenue = sale.unitPrice * sale.quantity;
            const product = productCatalog[sale.product];
            const cost = product ? product.buyingPrice * sale.quantity : 0;
            
            monthlyData[monthKey].revenue += revenue;
            monthlyData[monthKey].expense += cost;
        }
    });
    
    fixedDeductions.forEach(deduction => {
        const monthKey = Object.keys(monthlyData)[Math.floor(Math.random() * Object.keys(monthlyData).length)];
        if (monthlyData[monthKey]) {
            monthlyData[monthKey].expense += deduction.amount;
        }
    });
    
    const labels = Object.values(monthlyData).map(data => data.month);
    const revenueData = Object.values(monthlyData).map(data => data.revenue);
    const expenseData = Object.values(monthlyData).map(data => data.expense);
    
    if (window.revenueVsExpensesChartInstance) {
        window.revenueVsExpensesChartInstance.destroy();
    }
    
    const ctx = document.getElementById('revenueVsExpensesChart')?.getContext('2d');
    if (ctx) {
        window.revenueVsExpensesChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Revenue',
                        data: revenueData,
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: '#10b981',
                        borderWidth: 1,
                        borderRadius: 8
                    },
                    {
                        label: 'Expenses',
                        data: expenseData,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        borderColor: '#ef4444',
                        borderWidth: 1,
                        borderRadius: 8
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatAmount(value);
                            }
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Monthly Revenue vs Expenses'
                    }
                }
            }
        });
    }
}

function renderTopCustomersChart() {
    if (window.topCustomersChartInstance) {
        window.topCustomersChartInstance.destroy();
    }
    
    const ctx = document.getElementById('topCustomersChart')?.getContext('2d');
    if (ctx && customers.length > 0) {
        const sorted = [...customers].sort((a, b) => (b.totalSpent || 0) - (a.totalSpent || 0)).slice(0, 10);
        
        window.topCustomersChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sorted.map(c => c.name),
                datasets: [{
                    label: 'Total Spent',
                    data: sorted.map(c => c.totalSpent || 0),
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(16, 185, 129, 0.8)',
                        'rgba(249, 115, 22, 0.8)',
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(139, 92, 246, 0.8)',
                        'rgba(14, 165, 233, 0.8)',
                        'rgba(236, 72, 153, 0.8)',
                        'rgba(34, 197, 94, 0.8)',
                        'rgba(168, 85, 247, 0.8)',
                        'rgba(59, 130, 246, 0.6)'
                    ],
                    borderColor: '#3b82f6',
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatAmount(value);
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
}

function renderCustomerSpendingChart() {
    if (window.customerSpendingChartInstance) {
        window.customerSpendingChartInstance.destroy();
    }
    
    const ctx = document.getElementById('customerSpendingChart')?.getContext('2d');
    if (ctx && customers.length > 0) {
        const spendingRanges = {
            '0-100': 0,
            '100-500': 0,
            '500-1000': 0,
            '1000-5000': 0,
            '5000+': 0
        };
        
        customers.forEach(c => {
            const spent = c.totalSpent || 0;
            if (spent < 100) spendingRanges['0-100']++;
            else if (spent < 500) spendingRanges['100-500']++;
            else if (spent < 1000) spendingRanges['500-1000']++;
            else if (spent < 5000) spendingRanges['1000-5000']++;
            else spendingRanges['5000+']++;
        });
        
        window.customerSpendingChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(spendingRanges),
                datasets: [{
                    data: Object.values(spendingRanges),
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(16, 185, 129, 0.8)',
                        'rgba(249, 115, 22, 0.8)',
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(139, 92, 246, 0.8)'
                    ],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
}

function renderCustomerFrequencyChart() {
    if (window.customerFrequencyChartInstance) {
        window.customerFrequencyChartInstance.destroy();
    }
    
    const ctx = document.getElementById('customerFrequencyChart')?.getContext('2d');
    if (ctx && customers.length > 0) {
        const sorted = [...customers].sort((a, b) => (b.purchaseCount || 0) - (a.purchaseCount || 0)).slice(0, 10);
        
        window.customerFrequencyChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sorted.map(c => c.name),
                datasets: [{
                    label: 'Purchase Count',
                    data: sorted.map(c => c.purchaseCount || 0),
                    backgroundColor: 'rgba(139, 92, 246, 0.8)',
                    borderColor: '#8b5cf6',
                    borderWidth: 1,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
}

function renderAdvancedCharts() {
    renderTopProductsChart();
    renderProfitMarginChart();
    renderSalesDistributionChart();
    renderRevenueVsExpensesChart();
    renderTopCustomersChart();
    renderCustomerSpendingChart();
    renderCustomerFrequencyChart();
}

// --- SMART INVENTORY FUNCTIONS ---
function checkInventoryAlerts() {
    Object.keys(productCatalog).forEach(productName => {
        const product = productCatalog[productName];
        const stock = product.stock || 0;
        const reorderPoint = product.reorderPoint || 5;
        
        // Stock alerts
        if (stock === 0) {
            showNotification(` OUT OF STOCK: "${productName}" has 0 units remaining!`, 'error', 'lowStock');
        } else if (stock <= reorderPoint) {
            const supplierMsg = product.supplier ? ` Contact: ${product.supplier}` : '';
            showNotification(` REORDER ALERT: "${productName}" at ${stock} units (reorder point: ${reorderPoint}).${supplierMsg}`, 'warning', 'lowStock');
        }
        
        // Expiry alerts
        if (product.expiryDate) {
            const expiryDate = new Date(product.expiryDate);
            const today = new Date();
            const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
            
            if (daysUntilExpiry < 0) {
                showNotification(` EXPIRED: "${productName}" expired ${Math.abs(daysUntilExpiry)} days ago!`, 'error', 'expiry');
            } else if (daysUntilExpiry <= 7) {
                showNotification(` EXPIRING SOON: "${productName}" expires in ${daysUntilExpiry} days!`, 'warning', 'expiry');
            } else if (daysUntilExpiry <= 30) {
                showNotification(` "${productName}" expires in ${daysUntilExpiry} days`, 'info', 'expiry');
            }
        }
    });
}

function checkLowStock() {
    checkInventoryAlerts();
}

function showNotification(msg, type = 'info', category = 'system') {
    const notification = {
        id: generateId(),
        message: msg,
        type: type,
        timestamp: new Date().toISOString(),
        category: category
    };
    
    notifications.unshift(notification);
    
    if (notifications.length > 50) {
        notifications = notifications.slice(0, 50);
    }
    
    localStorage.setItem(STORAGE_KEYS.notifications, JSON.stringify(notifications));
    updateNotificationBadge();
    renderNotifications();
}

function deleteNotification(notificationId) {
    notifications = notifications.filter(n => n.id !== notificationId);
    localStorage.setItem(STORAGE_KEYS.notifications, JSON.stringify(notifications));
    updateNotificationBadge();
    renderNotifications();
}

function updateNotificationBadge() {
    const badge = document.getElementById('notification-badge');
    const headerBadge = document.getElementById('header-notification-badge');
    const hasNotifications = notifications.length > 0;
    
    if (badge) badge.style.display = hasNotifications ? 'block' : 'none';
    if (headerBadge) headerBadge.style.display = hasNotifications ? 'block' : 'none';
}

function renderNotifications() {
    const notificationBar = document.getElementById('notification-bar');
    if (!notificationBar) return;
    
    const filteredNotifications = notifications.filter(notif => {
        const category = notif.category || 'system';
        
        if (category === 'lowStock' && !notificationPrefs.lowStock) return false;
        if (category === 'expiry' && !notificationPrefs.expiry) return false;
        if (category === 'payments' && !notificationPrefs.payments) return false;
        if (category === 'system' && !notificationPrefs.system) return false;
        
        return true;
    });
    
    if (filteredNotifications.length === 0) {
        notificationBar.innerHTML = '<p style="text-align: center; color: var(--color-text-medium); padding: 20px;">No notifications yet.</p>';
        return;
    }
    
    notificationBar.innerHTML = filteredNotifications.map(notif => {
        const date = new Date(notif.timestamp);
        const timeStr = date.toLocaleString();
        
        const icons = {
            success: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
            error: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
            info: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
            warning: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
        };
        
        return `
            <div class="notification ${notif.type}">
                <div class="notification-content">
                    <div class="notification-icon">${icons[notif.type] || icons.info}</div>
                    <div class="notification-text">${notif.message}</div>
                    <div class="notification-time">${timeStr}</div>
                </div>
                <button class="notification-close" onclick="deleteNotification('${notif.id}')" aria-label="Close notification">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
        `;
    }).join('');
}

// --- SMART INVENTORY PAGE FUNCTIONS ---
function renderInventoryPage() {
    const alerts = [];
    let outOfStock = 0, lowStock = 0, expired = 0, expiringSoon = 0;
    
    Object.keys(productCatalog).forEach(productName => {
        const product = productCatalog[productName];
        const stock = product.stock || 0;
        const reorderPoint = product.reorderPoint || 5;
        
        if (stock === 0) {
            outOfStock++;
            alerts.push({ type: 'error', icon: '', product: productName, message: 'OUT OF STOCK', detail: `0 units remaining`, supplier: product.supplier });
        } else if (stock <= reorderPoint) {
            lowStock++;
            alerts.push({ type: 'warning', icon: '', product: productName, message: 'REORDER NEEDED', detail: `${stock} units (reorder at ${reorderPoint})`, supplier: product.supplier });
        }
        
        if (product.expiryDate) {
            const expiryDate = new Date(product.expiryDate);
            const daysUntilExpiry = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
            
            if (daysUntilExpiry < 0) {
                expired++;
                alerts.push({ type: 'error', icon: '', product: productName, message: 'EXPIRED', detail: `${Math.abs(daysUntilExpiry)} days ago`, supplier: product.supplier });
            } else if (daysUntilExpiry <= 7) {
                expiringSoon++;
                alerts.push({ type: 'warning', icon: '', product: productName, message: 'EXPIRING SOON', detail: `${daysUntilExpiry} days remaining`, supplier: product.supplier });
            }
        }
    });
    
    document.getElementById('out-of-stock-count').textContent = outOfStock;
    document.getElementById('low-stock-count').textContent = lowStock;
    document.getElementById('expired-count').textContent = expired;
    document.getElementById('expiring-soon-count').textContent = expiringSoon;
    
    const alertsList = document.getElementById('inventory-alerts-list');
    if (alerts.length === 0) {
        alertsList.innerHTML = '<p style="text-align: center; color: #10b981; padding: 20px; font-weight: 600;"> All inventory levels are healthy!</p>';
    } else {
        alertsList.innerHTML = alerts.map(alert => `
            <div class="notification ${alert.type}" style="margin-bottom: 10px;">
                <div class="notification-content">
                    <div class="notification-icon">${alert.icon}</div>
                    <div style="flex-grow: 1;">
                        <div style="font-weight: 600; margin-bottom: 4px;">${alert.product}</div>
                        <div style="font-size: 13px; color: var(--color-text-medium);">${alert.message}: ${alert.detail}</div>
                        ${alert.supplier ? `<div style="font-size: 11px; color: var(--color-text-medium); margin-top: 2px;"> Supplier: ${alert.supplier}</div>` : ''}
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    const supplierMap = {};
    Object.keys(productCatalog).forEach(productName => {
        const product = productCatalog[productName];
        if (product.supplier) {
            if (!supplierMap[product.supplier]) {
                supplierMap[product.supplier] = [];
            }
            supplierMap[product.supplier].push({ name: productName, stock: product.stock || 0 });
        }
    });
    
    const supplierList = document.getElementById('supplier-list');
    if (Object.keys(supplierMap).length === 0) {
        supplierList.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 20px;">No suppliers assigned to products yet.</p>';
    } else {
        supplierList.innerHTML = Object.keys(supplierMap).map(supplier => `
            <div class="list-item" style="flex-direction: column; align-items: flex-start; margin-bottom: 12px;">
                <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;"> ${supplier}</div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    ${supplierMap[supplier].map(p => `
                        <span style="background: #f3f4f6; padding: 4px 10px; border-radius: 6px; font-size: 13px;">
                            ${p.name} <span style="color: var(--color-primary); font-weight: 600;">(${p.stock})</span>
                        </span>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }
}

// --- MOBILE NAVIGATION FUNCTIONS ---
function toggleSidebar() {
    const navBar = document.getElementById('nav-bar');
    const overlay = document.getElementById('nav-overlay');
    
    if (navBar && overlay) {
        navBar.classList.toggle('active');
        overlay.classList.toggle('active');
    }
}

function closeSidebar() {
    const navBar = document.getElementById('nav-bar');
    const overlay = document.getElementById('nav-overlay');
    
    if (navBar) navBar.classList.remove('active');
    if (overlay) {
        overlay.classList.remove('active');
        overlay.style.display = 'none';
    }
    document.body.style.overflow = '';
}

function closeSidebarOnMobile() {
    if (window.innerWidth <= 768) {
        closeSidebar();
    }
}

// --- PAGE NAVIGATION ---
function showPage(pageId) {
    const aiPage = document.getElementById('AI-page');
    const isAICollapsed = aiPage.classList.contains('collapsed');
    
    document.querySelectorAll('.page').forEach(page => {
        if (page.id === 'AI-page' && isAICollapsed) {
            // Keep AI page visible if collapsed
            return;
        }
        page.classList.remove('active');
    });
    
    if (pageId === 'AI-page') {
        aiPage.classList.add('active');
        if (isAICollapsed) {
            window.toggleAICollapse();
        }
    } else {
        document.getElementById(pageId).classList.add('active');
    }

    document.querySelectorAll('.nav-button').forEach(btn => {
        btn.classList.remove('active-nav');
    });
    const activeBtn = document.querySelector(`.nav-button[data-page='${pageId}']`);
    if (activeBtn) {
        activeBtn.classList.add('active-nav');
    }

    if (['dashboard-page', 'sales-history-page', 'products-page', 'deductions-page', 'settings-page'].includes(pageId)) {
        updateTotals(); 
    }
    
    if (pageId === 'settings-page') {
        renderNotifications();
        updateNotificationBadge();
    }

    if (pageId === 'chartsPage' || pageId === 'pie-page-chart') {
        renderCharts();
    }
    if (pageId === 'deductions-chart-page') renderDeductionsChart();
    
    if (pageId === 'lineChart') {
        setTimeout(() => {
            renderMonthlyTrendsChart();
        }, 100);
    }
    
    if (pageId === 'advanced-charts') {
        setTimeout(() => {
            renderAdvancedCharts();
        }, 100);
    }
    
    if (pageId === 'Clients') {
        renderClients();
    }
    
    if (pageId === 'p-s-d') {
        setTimeout(() => {
            renderProductStockChart();
        }, 100);
    }
    
    if (pageId === 'lab-page') {
        runSalesForecast();
    }
    
    if (pageId === 'reports-page') {
        const breakEvenSelect = document.getElementById('breakeven-product');
        if (breakEvenSelect) {
            breakEvenSelect.innerHTML = '<option value="">Select a product...</option>';
            Object.keys(productCatalog).forEach(name => {
                breakEvenSelect.innerHTML += `<option value="${name}">${name}</option>`;
            });
        }
    }
    
    if (pageId === 'goals-page') {
        renderGoals();
    }
    
    if (pageId === 'warehouse-page') {
        renderWarehouses();
        updateWarehouseStats();
    }
    
    if (pageId === 'inventory-page') {
        renderInventoryPage();
    }
}

function renderProductStockChart() {
    if (window.productStockChartInstance) {
        window.productStockChartInstance.destroy();
    }

    const datasets = [];
    const colors = ['#3b82f6', '#10b981', '#f97316', '#ef4444', '#6366f1', '#8b5cf6', '#ec4899', '#14b8a6'];
    let colorIndex = 0;

    // Create a dataset for each product
    Object.keys(stockHistory).forEach(productName => {
        const history = stockHistory[productName];
        if (history && history.length > 0) {
            const data = history.map(entry => ({
                x: new Date(entry.date),
                y: entry.stock
            }));

            datasets.push({
                label: productName,
                data: data,
                borderColor: colors[colorIndex % colors.length],
                backgroundColor: colors[colorIndex % colors.length] + '20',
                tension: 0.4,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            });
            colorIndex++;
        }
    });

    const ctx = document.getElementById('product-stock-data')?.getContext('2d');
    if (ctx) {
        window.productStockChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'MMM d'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Stock Level'
                        },
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Product Stock Trends Over Time',
                        font: {
                            size: 16
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + ' units';
                            }
                        }
                    }
                }
            }
        });
    }
}

// --- QR/BARCODE SCANNER FUNCTIONS ---
let html5QrCode = null;

function startScanner() {
    const qrReader = document.getElementById('qr-reader');
    if (!qrReader) return;
    
    html5QrCode = new Html5Qrcode("qr-reader");
    
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
    
    // Try rear camera first (mobile), fallback to any available camera (laptop)
    Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
            const cameraId = cameras[cameras.length - 1].id; // Use last camera (usually rear on mobile)
            html5QrCode.start(
                cameraId,
                config,
                (decodedText) => {
                    document.getElementById('scan-result').style.display = 'block';
                    document.getElementById('scan-result-text').textContent = decodedText;
                    showMessage(`Scanned: ${decodedText}`, 'success');
                    
                    // Check if the scanned text is a URL and open it
                    if (decodedText.match(/^(https?:\/\/|www\.)/i)) {
                        const url = decodedText.startsWith('http') ? decodedText : 'https://' + decodedText;
                        window.open(url, '_blank');
                        showMessage('Opening link...', 'info');
                    }
                },
                (errorMessage) => {
                    // Ignore errors during scanning
                }
            );
        }
    }).catch((err) => {
        showMessage('Unable to start camera. Please check permissions.', 'error');
        console.error(err);
    });
}

function stopScanner() {
    if (html5QrCode) {
        html5QrCode.stop().then(() => {
            html5QrCode = null;
            document.getElementById('scan-result').style.display = 'none';
        }).catch((err) => {
            console.error(err);
            html5QrCode = null;
        });
    }
}

// --- CURRENCY CONVERTER ---
async function convert() {
    const from = document.getElementById("from")?.value;
    const to = document.getElementById("to")?.value;
    const amount = document.getElementById("amount")?.value;
    const resultEl = document.getElementById("result");

    if (!amount || !from || !to) {
        if (resultEl) resultEl.innerText = "Please fill all fields";
        return;
    }

    try {
        const url = `https://api.exchangerate-api.com/v4/latest/${from}`;
        const res = await fetch(url);
        const data = await res.json();
        const rate = data.rates[to];
        const converted = amount * rate;
        if (resultEl) resultEl.innerText = `${amount} ${from} = ${converted.toFixed(2)} ${to}`;
    } catch (error) {
        if (resultEl) resultEl.innerText = "Conversion failed. Try again.";
    }
}

// --- EXPORT FUNCTION ---
function exportData(format) {
    const data = {
        budget: budgetAmount,
        currency: currentCurrency,
        products: productCatalog,
        sales: salesHistory,
        deductions: fixedDeductions,
        clients: clients,
        exportDate: new Date().toISOString()
    };
    
    const date = new Date().toISOString().split('T')[0];
    let dataUri, fileName;
    
    if (format === 'json') {
        const dataStr = JSON.stringify(data, null, 2);
        dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        fileName = `epsilon_data_${date}.json`;
    } else if (format === 'txt') {
        let txtContent = `EPSILON APROXI DATA EXPORT\n`;
        txtContent += `Export Date: ${new Date().toLocaleString()}\n\n`;
        txtContent += `=== BUDGET ===\n${formatAmount(budgetAmount)}\n\n`;
        txtContent += `=== PRODUCTS ===\n`;
        Object.keys(productCatalog).forEach(name => {
            const p = productCatalog[name];
            txtContent += `${name}: Sell ${formatAmount(p.sellingPrice)}, Buy ${formatAmount(p.buyingPrice)}, Stock ${p.stock}\n`;
        });
        txtContent += `\n=== SALES ===\n`;
        salesHistory.forEach(s => {
            txtContent += `${new Date(s.date).toLocaleString()} - ${s.product} x${s.quantity} @ ${formatAmount(s.unitPrice)}\n`;
        });
        txtContent += `\n=== DEDUCTIONS ===\n`;
        fixedDeductions.forEach(d => {
            txtContent += `${d.name}: ${formatAmount(d.amount)}\n`;
        });
        dataUri = 'data:text/plain;charset=utf-8,'+ encodeURIComponent(txtContent);
        fileName = `epsilon_data_${date}.txt`;
    } else if (format === 'excel') {
        let csv = 'EPSILON APROXI DATA EXPORT\n\n';
        csv += 'PRODUCTS\n';
        csv += 'Name,Selling Price,Buying Price,Stock\n';
        Object.keys(productCatalog).forEach(name => {
            const p = productCatalog[name];
            csv += `${name},${p.sellingPrice},${p.buyingPrice},${p.stock}\n`;
        });
        csv += '\nSALES\n';
        csv += 'Date,Product,Quantity,Unit Price,Total\n';
        salesHistory.forEach(s => {
            csv += `${new Date(s.date).toLocaleString()},${s.product},${s.quantity},${s.unitPrice},${s.quantity * s.unitPrice}\n`;
        });
        csv += '\nDEDUCTIONS\n';
        csv += 'Name,Amount\n';
        fixedDeductions.forEach(d => {
            csv += `${d.name},${d.amount}\n`;
        });
        dataUri = 'data:text/csv;charset=utf-8,'+ encodeURIComponent(csv);
        fileName = `epsilon_data_${date}.csv`;
    }
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', fileName);
    linkElement.click();
    
    document.getElementById('export-dialog').close();
    showMessage(`Data exported as ${format.toUpperCase()} successfully!`);
}

function exportAllData() {
    exportData('json');
}

// --- ACCOUNT SETTINGS FUNCTIONS ---
function saveAccountSettings() {
    const businessName = document.getElementById('business-name-input').value.trim();
    const ownerName = document.getElementById('owner-name-input').value.trim();
    const location = document.getElementById('location').value.trim();
    const businessType = document.getElementById('businessType').value;
    const phoneNumber = document.getElementById('business-phone').value.trim();
    const emailAddress = document.getElementById('business-email').value.trim();
    const logoSrc = document.getElementById('business-logo-img').src;

    const accountSettings = {
        businessName,
        ownerName,
        location,
        businessType,
        phoneNumber,
        emailAddress,
        businessLogo: logoSrc,
        lastUpdated: new Date().toISOString()
    };

    localStorage.setItem('epsilon_account_settings', JSON.stringify(accountSettings));
    
    // Update display elements
    const businessNameDisplay = document.getElementById('businessName');
    const ownerNameDisplay = document.getElementById('ownerName');
    const headerProfilePic = document.getElementById('header-profile-pic');
    const dashboardBusinessName = document.getElementById('dashboard-business-name');
    
    if (businessNameDisplay) businessNameDisplay.textContent = businessName || 'Unknown';
    if (ownerNameDisplay) ownerNameDisplay.textContent = ownerName || 'Unknown';
    if (headerProfilePic) headerProfilePic.src = logoSrc;
    if (dashboardBusinessName) dashboardBusinessName.textContent = businessName || 'Unknown Business';
    
    updateShowcaseDisplay();
    
    document.getElementById('account-settings-dialog').close();
    showMessage('Account settings saved successfully!', 'success');
}

function loadAccountSettings() {
    const saved = localStorage.getItem('epsilon_account_settings');
    if (saved) {
        try {
            const settings = JSON.parse(saved);
            
            // Populate form fields
            if (settings.businessName) document.getElementById('business-name-input').value = settings.businessName;
            if (settings.ownerName) document.getElementById('owner-name-input').value = settings.ownerName;
            if (settings.location) document.getElementById('location').value = settings.location;
            if (settings.businessType) document.getElementById('businessType').value = settings.businessType;
            if (settings.phoneNumber) document.getElementById('business-phone').value = settings.phoneNumber;
            if (settings.emailAddress) document.getElementById('business-email').value = settings.emailAddress;
            if (settings.businessLogo) document.getElementById('business-logo-img').src = settings.businessLogo;
            
            // Update display elements
            const businessNameDisplay = document.getElementById('businessName');
            const ownerNameDisplay = document.getElementById('ownerName');
            const headerProfilePic = document.getElementById('header-profile-pic');
            
            if (businessNameDisplay) businessNameDisplay.textContent = settings.businessName || 'Unknown';
            if (ownerNameDisplay) ownerNameDisplay.textContent = settings.ownerName || 'Unknown';
            if (headerProfilePic && settings.businessLogo) headerProfilePic.src = settings.businessLogo;
            
            const dashboardBusinessName = document.getElementById('dashboard-business-name');
            if (dashboardBusinessName) dashboardBusinessName.textContent = settings.businessName || 'Unknown Business';
        } catch (err) {
            console.error('Failed to load account settings:', err);
        }
    }
}

// --- CLIENT FUNCTIONS ---
function createClient() {
    const nameInput = document.querySelector('#client-dialog input[placeholder="Enter name or organization"]');
    const contactInput = document.querySelector('#client-dialog input[placeholder="Phone number or email"]');
    const typeSelect = document.querySelector('#client-dialog select');
    const descriptionInput = document.querySelector('#descriptionClient');
    
    const name = nameInput.value.trim();
    const contact = contactInput.value.trim();
    const type = typeSelect.value;
    const description = descriptionInput.value.trim();
    
    if (!name || !contact) {
        showMessage("Please enter both name and contact information.", 'error');
        return;
    }
    
    const newClient = {
        id: generateId(),
        name,
        contact,
        type,
        description: description && description !== 'Add any additional notes...' ? description : '',
        createdAt: new Date().toISOString()
    };
    
    clients.push(newClient);
    
    nameInput.value = '';
    contactInput.value = '';
    typeSelect.value = 'Client';
    descriptionInput.value = '';
    
    document.getElementById('client-dialog').close();
    renderClients();
    saveData();
    showMessage(`${type} "${name}" added successfully!`);
}

function createCustomer() {
    const nameInput = document.getElementById('customer-name-input');
    const emailInput = document.getElementById('customer-email-input');
    const phoneInput = document.getElementById('customer-phone-input');
    const ageInput = document.getElementById('customer-age-input');
    const descriptionInput = document.getElementById('customer-description-input');
    
    const name = nameInput.value.trim();
    const email = emailInput.value.trim();
    const phone = phoneInput.value.trim();
    const age = ageInput.value ? parseInt(ageInput.value) : null;
    const description = descriptionInput.value.trim();
    
    if (!name || !email) {
        showMessage("Please enter at least name and email.", 'error');
        return;
    }
    
    const newCustomer = {
        id: generateId(),
        name,
        email,
        phone,
        age,
        description,
        createdAt: new Date().toISOString(),
        totalSpent: 0,
        purchaseCount: 0,
        favoriteProducts: {},
        lastPurchaseDate: null
    };
    
    customers.push(newCustomer);
    
    nameInput.value = '';
    emailInput.value = '';
    phoneInput.value = '';
    ageInput.value = '';
    descriptionInput.value = '';
    
    document.getElementById('customer-dialog').close();
    renderCustomers();
    updateCustomerStats();
    saveData();
    showMessage(`Customer "${name}" added successfully!`, 'success');
}

function filterCustomers() {
    const searchTerm = document.getElementById('customer-search').value.toLowerCase();
    const customerCards = document.querySelectorAll('#customers-list [data-customer-id]');
    
    customerCards.forEach(card => {
        const name = card.getAttribute('data-customer-name').toLowerCase();
        const email = card.getAttribute('data-customer-email').toLowerCase();
        const phone = card.getAttribute('data-customer-phone').toLowerCase();
        
        const matches = name.includes(searchTerm) || email.includes(searchTerm) || phone.includes(searchTerm);
        card.style.display = matches ? 'block' : 'none';
    });
}

function renderCustomers() {
    const customersList = document.getElementById('customers-list');
    if (!customersList) return;
    
    customersList.innerHTML = '';
    
    customers.forEach(customer => {
        const topProduct = Object.keys(customer.favoriteProducts).sort((a, b) => 
            (customer.favoriteProducts[b] || 0) - (customer.favoriteProducts[a] || 0)
        )[0];
        
        const card = document.createElement('div');
        card.setAttribute('data-customer-id', customer.id);
        card.setAttribute('data-customer-name', customer.name);
        card.setAttribute('data-customer-email', customer.email);
        card.setAttribute('data-customer-phone', customer.phone);
        card.style.cssText = `
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #3b82f6;
        `;
        
        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <div>
                    <h4 style="margin: 0 0 5px 0; font-size: 18px; color: #1f2937;">${customer.name}</h4>
                    <p style="margin: 0; color: #6b7280; font-size: 14px;">${customer.email}</p>
                </div>
                <button onclick="deleteCustomer('${customer.id}')" class="button button-danger" style="padding: 6px 12px; font-size: 12px;">Delete</button>
            </div>
            
            <div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 14px;">
                <div style="margin-bottom: 6px;"><strong>Phone:</strong> ${customer.phone || 'N/A'}</div>
                <div style="margin-bottom: 6px;"><strong>Age:</strong> ${customer.age || 'N/A'}</div>
                <div style="margin-bottom: 6px;"><strong>Total Spent:</strong> $${customer.totalSpent.toFixed(2)}</div>
                <div style="margin-bottom: 6px;"><strong>Purchases:</strong> ${customer.purchaseCount}</div>
                ${topProduct ? `<div><strong>Top Product:</strong> ${topProduct} (${customer.favoriteProducts[topProduct]} times)</div>` : '<div><strong>Top Product:</strong> None</div>'}
            </div>
            
            ${customer.description ? `<div style="background: #f0f9ff; padding: 10px; border-radius: 6px; border-left: 3px solid #3b82f6; font-size: 13px; color: #1e40af; margin-bottom: 12px;"><strong>Notes:</strong> ${customer.description}</div>` : ''}
            
            <div style="color: #6b7280; font-size: 12px;">
                Added: ${new Date(customer.createdAt).toLocaleDateString()}
                ${customer.lastPurchaseDate ? `<br>Last Purchase: ${new Date(customer.lastPurchaseDate).toLocaleDateString()}` : ''}
            </div>
        `;
        
        customersList.appendChild(card);
    });
    
    updateCustomerStats();
}

function deleteCustomer(customerId) {
    if (confirm('Are you sure you want to delete this customer?')) {
        customers = customers.filter(c => c.id !== customerId);
        renderCustomers();
        updateCustomerStats();
        saveData();
        showMessage('Customer deleted successfully', 'success');
    }
}

function updateCustomerStats() {
    const totalCustomers = customers.length;
    const totalRevenue = customers.reduce((sum, c) => sum + (c.totalSpent || 0), 0);
    const topCustomer = customers.sort((a, b) => (b.totalSpent || 0) - (a.totalSpent || 0))[0];
    
    const totalCustomersStatElem = document.getElementById('total-customers-stat');
    const revenueElem = document.getElementById('customer-total-revenue');
    const topCustomerElem = document.getElementById('top-customer-stat');
    
    if (totalCustomersStatElem) totalCustomersStatElem.textContent = totalCustomers;
    if (revenueElem) revenueElem.textContent = `$${totalRevenue.toFixed(2)}`;
    if (topCustomerElem) topCustomerElem.textContent = topCustomer ? topCustomer.name : '--';
}

// --- TRANSACTION TOOLS FUNCTIONS ---
function addTransactionTool() {
    const name = document.getElementById('new-tool-name').value.trim();
    const description = document.getElementById('new-tool-description').value.trim();
    
    if (!name) {
        showMessage('Please enter a tool name', 'error');
        return;
    }
    
    transactionTools.push({
        id: generateId(),
        name,
        description
    });
    
    localStorage.setItem('epsilonAproxi_transactionTools', JSON.stringify(transactionTools));
    document.getElementById('new-tool-name').value = '';
    document.getElementById('new-tool-description').value = '';
    
    renderTransactionTools();
    showMessage(`Transaction tool "${name}" added`, 'success');
}

function renderTransactionTools() {
    const list = document.getElementById('transaction-tools-list');
    if (!list) return;
    
    list.innerHTML = transactionTools.map(tool => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f3f4f6;">
            <div>
                <strong>${tool.name}</strong>
                <p style="margin: 0; font-size: 12px; color: #6b7280;">${tool.description || ''}</p>
            </div>
            <button onclick="deleteTransactionTool('${tool.id}')" class="button button-danger" style="padding: 4px 8px; font-size: 12px;">Delete</button>
        </div>
    `).join('');
    
    updateTransactionMethodsChart();
}

function deleteTransactionTool(id) {
    if (confirm('Are you sure you want to delete this tool?')) {
        transactionTools = transactionTools.filter(t => t.id !== id);
        localStorage.setItem('epsilonAproxi_transactionTools', JSON.stringify(transactionTools));
        renderTransactionTools();
        showMessage('Transaction tool deleted', 'success');
    }
}

function updateTransactionMethodsChart() {
    const ctx = document.getElementById('transaction-methods-chart');
    if (!ctx) return;
    
    // Calculate usage from salesHistory
    const usage = {};
    transactionTools.forEach(t => usage[t.name] = 0);
    
    salesHistory.forEach(sale => {
        if (sale.paymentMethod) {
            usage[sale.paymentMethod] = (usage[sale.paymentMethod] || 0) + 1;
        }
    });
    
    const labels = Object.keys(usage);
    const data = Object.values(usage);
    
    if (window.transactionChart) {
        window.transactionChart.destroy();
    }
    
    window.transactionChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Transactions Count',
                data: data,
                backgroundColor: '#3b82f6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// --- AI COLLAPSE/DRAG FUNCTIONS ---
let aiCollapsed = false;
let isDragging = false;
let currentX, currentY, initialX, initialY;

window.toggleAICollapse = function() {
    const aiPage = document.getElementById('AI-page');
    aiCollapsed = !aiCollapsed;
    
    if (aiCollapsed) {
        aiPage.classList.add('collapsed');
        aiPage.style.position = 'fixed';
        aiPage.style.bottom = '20px';
        aiPage.style.right = '20px';
        aiPage.style.left = 'auto';
        aiPage.style.top = 'auto';
    } else {
        aiPage.classList.remove('collapsed');
        aiPage.style.position = 'relative';
        aiPage.style.bottom = 'auto';
        aiPage.style.right = 'auto';
        aiPage.style.left = '0';
        aiPage.style.top = 'auto';
    }
};

function dragStart(e) {
    const aiPage = document.getElementById('AI-page');
    if (!aiCollapsed || e.target.closest('#input-container') || e.target.closest('#messages')) return;
    
    isDragging = true;
    initialX = e.clientX - (parseInt(aiPage.style.left) || 0);
    initialY = e.clientY - (parseInt(aiPage.style.top) || 0);
}

function drag(e) {
    if (!isDragging) return;
    e.preventDefault();
    
    const aiPage = document.getElementById('AI-page');
    currentX = e.clientX - initialX;
    currentY = e.clientY - initialY;
    
    aiPage.style.left = currentX + 'px';
    aiPage.style.top = currentY + 'px';
    aiPage.style.right = 'auto';
    aiPage.style.bottom = 'auto';
}

function dragEnd() {
    isDragging = false;
}

// --- NODE EDITOR FUNCTIONS ---
let nodes = [];
let connections = [];
let nodeCounter = 0;
let selectedNode = null;
let connectingMode = false;
let connectingFrom = null;

function addNode() {
    const graphArea = document.getElementById('graph-area');
    const nodeId = `node-${nodeCounter++}`;
    const colors = ['#3b82f6', '#10b981', '#f97316', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#eab308'];
    const randomColor = colors[Math.floor(Math.random() * colors.length)];
    
    const node = document.createElement('div');
    node.className = 'node';
    node.id = nodeId;
    node.style.left = `${Math.random() * 400 + 100}px`;
    node.style.top = `${Math.random() * 400 + 100}px`;
    node.style.borderLeftColor = randomColor;
    node.innerHTML = `
        <h3>Node ${nodeCounter}</h3>
        <p>Drag to move</p>
        <div class="node-resize-handle"></div>
    `;
    
    node.addEventListener('mousedown', startDrag);
    node.addEventListener('contextmenu', showContextMenu);
    graphArea.appendChild(node);
    
    nodes.push({ 
        id: nodeId, 
        x: parseInt(node.style.left), 
        y: parseInt(node.style.top), 
        name: `Node ${nodeCounter}`, 
        description: 'Drag to move',
        color: randomColor,
        width: 200,
        height: 80
    });
    showStatus('Node added successfully', 'success');
}

function deleteNode(nodeId) {
    const node = document.getElementById(nodeId);
    if (node) {
        node.remove();
        nodes = nodes.filter(n => n.id !== nodeId);
        connections = connections.filter(c => c.from !== nodeId && c.to !== nodeId);
        drawConnections();
        showStatus('Node deleted', 'success');
        hideContextMenu();
    }
}

function showContextMenu(e) {
    e.preventDefault();
    const menu = document.getElementById('context-menu');
    selectedNode = e.currentTarget.id;
    menu.style.display = 'block';
    menu.style.left = `${e.pageX}px`;
    menu.style.top = `${e.pageY}px`;
}

function hideContextMenu() {
    document.getElementById('context-menu').style.display = 'none';
    selectedNode = null;
}

function renameNode() {
    if (!selectedNode) return;
    const nodeData = nodes.find(n => n.id === selectedNode);
    if (!nodeData) return;
    
    const newName = prompt('Enter new name:', nodeData.name);
    if (newName && newName.trim()) {
        nodeData.name = newName.trim();
        const nodeEl = document.getElementById(selectedNode);
        nodeEl.querySelector('h3').textContent = newName.trim();
        showStatus('Node renamed', 'success');
    }
    hideContextMenu();
}

function editDescription() {
    if (!selectedNode) return;
    const nodeData = nodes.find(n => n.id === selectedNode);
    if (!nodeData) return;
    
    const newDesc = prompt('Enter new description:', nodeData.description);
    if (newDesc && newDesc.trim()) {
        nodeData.description = newDesc.trim();
        const nodeEl = document.getElementById(selectedNode);
        nodeEl.querySelector('p').textContent = newDesc.trim();
        showStatus('Description updated', 'success');
    }
    hideContextMenu();
}

function startConnection() {
    if (!selectedNode) return;
    connectingMode = true;
    connectingFrom = selectedNode;
    document.getElementById(selectedNode).classList.add('connecting');
    showStatus('Click another node to connect', 'success');
    hideContextMenu();
}

function connectNodes(toNodeId) {
    if (!connectingMode || !connectingFrom || connectingFrom === toNodeId) return;
    
    const color = prompt('Enter connection color (e.g., #3b82f6, red, blue):', '#3b82f6');
    if (!color) return;
    
    connections.push({ from: connectingFrom, to: toNodeId, color: color });
    drawConnections();
    
    document.getElementById(connectingFrom).classList.remove('connecting');
    connectingMode = false;
    connectingFrom = null;
    showStatus('Nodes connected', 'success');
}

function deleteNodeFromMenu() {
    if (selectedNode) {
        deleteNode(selectedNode);
    }
}

function saveNodes() {
    const graphData = { nodes, connections };
    localStorage.setItem('epsilon_node_graph', JSON.stringify(graphData));
    showStatus('Graph saved successfully!', 'success');
}

function loadNodes() {
    const saved = localStorage.getItem('epsilon_node_graph');
    if (saved) {
        clearNodes(true);
        const graphData = JSON.parse(saved);
        nodes = graphData.nodes || [];
        connections = graphData.connections || [];
        
        nodes.forEach(nodeData => {
            const node = document.createElement('div');
            node.className = 'node';
            node.id = nodeData.id;
            node.style.left = `${nodeData.x}px`;
            node.style.top = `${nodeData.y}px`;
            node.innerHTML = `
                <h3>${nodeData.name || nodeData.id}</h3>
                <p>${nodeData.description || 'Drag to move'}</p>
            `;
            node.addEventListener('mousedown', startDrag);
            node.addEventListener('contextmenu', showContextMenu);
            document.getElementById('graph-area').appendChild(node);
        });
        
        drawConnections();
        showStatus('Graph loaded successfully!', 'success');
    } else {
        showStatus('No saved graph found', 'error');
    }
}

function clearNodes(silent = false) {
    document.querySelectorAll('.node').forEach(node => node.remove());
    nodes = [];
    connections = [];
    nodeCounter = 0;
    drawConnections();
    if (!silent) showStatus('All nodes cleared', 'success');
}

function showStatus(message, type) {
    const status = document.getElementById('status-message');
    status.textContent = message;
    status.style.display = 'block';
    status.style.backgroundColor = type === 'success' ? '#d1fae5' : '#fee2e2';
    status.style.color = type === 'success' ? '#065f46' : '#991b1b';
    setTimeout(() => { status.style.display = 'none'; }, 3000);
}

let draggedNode = null;
let offsetX = 0, offsetY = 0;
let zoomLevel = 1;
let panX = 0, panY = 0;
let isResizing = false;
let resizeStartWidth = 0;
let resizeStartHeight = 0;

function startDrag(e) {
    if (e.target.classList.contains('node-resize-handle')) {
        startResize(e);
        return;
    }
    
    if (e.target.tagName === 'BUTTON' || e.button === 2) return;
    
    if (connectingMode) {
        connectNodes(e.currentTarget.id);
        return;
    }
    
    draggedNode = e.currentTarget;
    draggedNode.classList.add('dragging');
    
    // Get current position 
    let nodeX = parseInt(draggedNode.style.left) || 0;
    let nodeY = parseInt(draggedNode.style.top) || 0;
    
    const graphArea = draggedNode.parentElement;
    const graphRect = graphArea.getBoundingClientRect();
    
    // Calculate the offset from mouse to node position, accounting for scale
    // We use the viewport coordinates and the graph area's position
    const nodeRect = draggedNode.getBoundingClientRect();
    offsetX = e.clientX - nodeRect.left;
    offsetY = e.clientY - nodeRect.top;
    
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', stopDrag);
    e.preventDefault();
}

function drag(e) {
    if (!draggedNode) return;
    const graphArea = draggedNode.parentElement;
    const graphRect = graphArea.getBoundingClientRect();
    
    // Get current node rect to position relative to viewport
    const newX = e.clientX - offsetX - graphRect.left;
    const newY = e.clientY - offsetY - graphRect.top;
    
    // Divide by zoom level to get actual position in the unscaled coordinate system
    let x = newX / zoomLevel;
    let y = newY / zoomLevel;
    
    // Constrain to bounds
    x = Math.max(0, x);
    y = Math.max(0, y);
    
    draggedNode.style.left = `${x}px`;
    draggedNode.style.top = `${y}px`;
    
    const nodeData = nodes.find(n => n.id === draggedNode.id);
    if (nodeData) {
        nodeData.x = x;
        nodeData.y = y;
    }
    drawConnections();
    updateMinimap();
}

function stopDrag() {
    if (draggedNode) {
        draggedNode.classList.remove('dragging');
    }
    draggedNode = null;
    document.removeEventListener('mousemove', drag);
    document.removeEventListener('mouseup', stopDrag);
}

function startResize(e) {
    if (e.button !== 0) return;
    e.stopPropagation();
    isResizing = true;
    const node = e.target.parentElement;
    resizeStartWidth = node.offsetWidth;
    resizeStartHeight = node.offsetHeight;
    draggedNode = node;
    draggedNode.classList.add('dragging');
    
    const startX = e.clientX;
    const startY = e.clientY;
    
    function resize(e) {
        if (!isResizing) return;
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
        const newWidth = Math.max(150, resizeStartWidth + deltaX);
        const newHeight = Math.max(80, resizeStartHeight + deltaY);
        
        draggedNode.style.width = `${newWidth}px`;
        draggedNode.style.minHeight = `${newHeight}px`;
        
        const nodeData = nodes.find(n => n.id === draggedNode.id);
        if (nodeData) {
            nodeData.width = newWidth;
            nodeData.height = newHeight;
        }
        drawConnections();
    }
    
    function stopResize() {
        isResizing = false;
        if (draggedNode) {
            draggedNode.classList.remove('dragging');
        }
        draggedNode = null;
        document.removeEventListener('mousemove', resize);
        document.removeEventListener('mouseup', stopResize);
    }
    
    document.addEventListener('mousemove', resize);
    document.addEventListener('mouseup', stopResize);
}

function drawConnections() {
    const svg = document.getElementById('connectionsSvg');
    svg.innerHTML = '';
    connections.forEach(conn => {
        const fromNode = document.getElementById(conn.from);
        const toNode = document.getElementById(conn.to);
        if (fromNode && toNode) {
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', parseInt(fromNode.style.left) + fromNode.offsetWidth / 2);
            line.setAttribute('y1', parseInt(fromNode.style.top) + fromNode.offsetHeight / 2);
            line.setAttribute('x2', parseInt(toNode.style.left) + toNode.offsetWidth / 2);
            line.setAttribute('y2', parseInt(toNode.style.top) + toNode.offsetHeight / 2);
            line.setAttribute('stroke', conn.color || '#3b82f6');
            line.setAttribute('stroke-width', '2');
            svg.appendChild(line);
        }
    });
    updateMinimap();
}

// --- Zoom & Pan Functions ---
function zoomIn() {
    zoomLevel = Math.min(zoomLevel + 0.2, 3);
    applyZoom();
}

function zoomOut() {
    zoomLevel = Math.max(zoomLevel - 0.2, 0.5);
    applyZoom();
}

function resetZoom() {
    zoomLevel = 1;
    panX = 0;
    panY = 0;
    applyZoom();
}

function applyZoom() {
    const graphArea = document.getElementById('graph-area');
    graphArea.style.transform = `scale(${zoomLevel}) translate(${panX}px, ${panY}px)`;
}

function updateMinimap() {
    const canvas = document.getElementById('minimap');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#f3f4f6';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = '#d1d5db';
    ctx.lineWidth = 1;
    ctx.strokeRect(0, 0, canvas.width - 1, canvas.height - 1);
    
    const graphArea = document.getElementById('graph-area');
    const scale = Math.min(canvas.width / graphArea.offsetWidth, canvas.height / graphArea.offsetHeight);
    
    nodes.forEach(nodeData => {
        ctx.fillStyle = nodeData.color || '#3b82f6';
        ctx.fillRect(
            nodeData.x * scale,
            nodeData.y * scale,
            Math.max(2, nodeData.width * scale),
            Math.max(2, nodeData.height * scale)
        );
    });
    
    connections.forEach(conn => {
        const fromNode = nodes.find(n => n.id === conn.from);
        const toNode = nodes.find(n => n.id === conn.to);
        if (fromNode && toNode) {
            ctx.strokeStyle = conn.color || '#3b82f6';
            ctx.lineWidth = 0.5;
            ctx.beginPath();
            ctx.moveTo(fromNode.x * scale + fromNode.width * scale / 2, fromNode.y * scale + fromNode.height * scale / 2);
            ctx.lineTo(toNode.x * scale + toNode.width * scale / 2, toNode.y * scale + toNode.height * scale / 2);
            ctx.stroke();
        }
    });
}

// --- Export/Import Functions ---
function exportGraph() {
    const graphData = { 
        nodes: nodes.map(n => ({...n})),
        connections: connections.map(c => ({...c})),
        metadata: {
            exportDate: new Date().toISOString(),
            version: '1.0'
        }
    };
    
    const dataStr = JSON.stringify(graphData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `graph-${Date.now()}.json`;
    link.click();
    URL.revokeObjectURL(url);
    
    showStatus('Graph exported successfully! ', 'success');
}

function importGraph() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const graphData = JSON.parse(event.target.result);
                clearNodes(true);
                
                nodes = graphData.nodes || [];
                connections = graphData.connections || [];
                
                const graphArea = document.getElementById('graph-area');
                nodes.forEach(nodeData => {
                    const node = document.createElement('div');
                    node.className = 'node';
                    node.id = nodeData.id;
                    node.style.left = `${nodeData.x}px`;
                    node.style.top = `${nodeData.y}px`;
                    node.style.width = `${nodeData.width || 200}px`;
                    node.style.minHeight = `${nodeData.height || 80}px`;
                    node.style.borderLeftColor = nodeData.color || '#3b82f6';
                    node.innerHTML = `
                        <h3>${nodeData.name || nodeData.id}</h3>
                        <p>${nodeData.description || 'Imported node'}</p>
                        <div class="node-resize-handle"></div>
                    `;
                    node.addEventListener('mousedown', startDrag);
                    node.addEventListener('contextmenu', showContextMenu);
                    graphArea.appendChild(node);
                });
                
                drawConnections();
                showStatus('Graph imported successfully! ', 'success');
            } catch (error) {
                showStatus('Error importing graph: ' + error.message, 'error');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

// --- AI LAB FUNCTIONS ---
function runSalesForecast() {
    const insights = document.getElementById('lab-insights');
    insights.innerHTML = '<p style="color: #6b7280;">Analyzing sales data...</p>';
    
    setTimeout(() => {
        const { totalRevenue } = calculateFinancials();
        const avgDailySales = totalRevenue / Math.max(salesHistory.length, 1);
        const forecast = avgDailySales * 30 * 1.15;
        
        document.getElementById('forecast-revenue').textContent = formatAmount(forecast);
        
        insights.innerHTML = `
            <h4 style="color: var(--color-primary); margin-bottom: 12px;"> Sales Forecast</h4>
            <p><strong>Predicted Revenue (30 days):</strong> ${formatAmount(forecast)}</p>
            <p><strong>Growth Rate:</strong> +15% (based on current trends)</p>
            <p><strong>Confidence:</strong> ${salesHistory.length > 10 ? 'High' : 'Medium'}</p>
            <p style="margin-top: 12px; color: #6b7280;">Based on ${salesHistory.length} historical transactions</p>
        `;
    }, 1000);
}

function analyzeTrends() {
    const insights = document.getElementById('lab-insights');
    insights.innerHTML = '<p style="color: #6b7280;">Analyzing business trends...</p>';
    
    setTimeout(() => {
        const productSales = {};
        salesHistory.forEach(sale => {
            productSales[sale.product] = (productSales[sale.product] || 0) + sale.quantity;
        });
        
        const sorted = Object.entries(productSales).sort((a, b) => b[1] - a[1]);
        const bestProduct = sorted[0] || ['No sales', 0];
        
        document.getElementById('best-product').textContent = bestProduct[0];
        
        const { netProfitLoss, totalRevenue } = calculateFinancials();
        const profitMargin = totalRevenue > 0 ? (netProfitLoss / totalRevenue * 100).toFixed(1) : 0;
        const riskScore = profitMargin < 10 ? 'High' : profitMargin < 25 ? 'Medium' : 'Low';
        
        document.getElementById('risk-score').textContent = riskScore;
        
        insights.innerHTML = `
            <h4 style="color: var(--color-secondary); margin-bottom: 12px;"> Trend Analysis</h4>
            <p><strong>Top Product:</strong> ${bestProduct[0]} (${bestProduct[1]} units sold)</p>
            <p><strong>Profit Margin:</strong> ${profitMargin}%</p>
            <p><strong>Risk Level:</strong> ${riskScore}</p>
            <p style="margin-top: 12px; color: #6b7280;">${riskScore === 'High' ? ' Consider reducing costs or increasing prices' : ' Business health looks good'}</p>
        `;
    }, 1000);
}

function optimizePricing() {
    const insights = document.getElementById('lab-insights');
    const recommendations = document.getElementById('product-recommendations');
    
    insights.innerHTML = '<p style="color: #6b7280;">Calculating optimal pricing...</p>';
    
    setTimeout(() => {
        const productAnalysis = [];
        
        Object.keys(productCatalog).forEach(name => {
            const product = productCatalog[name];
            const margin = ((product.sellingPrice - product.buyingPrice) / product.sellingPrice * 100).toFixed(1);
            const optimalPrice = product.buyingPrice * 2.5;
            const potentialIncrease = optimalPrice - product.sellingPrice;
            
            productAnalysis.push({
                name,
                current: product.sellingPrice,
                optimal: optimalPrice,
                margin: parseFloat(margin),
                increase: potentialIncrease
            });
        });
        
        productAnalysis.sort((a, b) => b.increase - a.increase);
        
        if (productAnalysis.length > 0) {
            document.getElementById('price-suggestion').textContent = formatAmount(productAnalysis[0].optimal);
            
            insights.innerHTML = `
                <h4 style="color: var(--color-orange); margin-bottom: 12px;"> Pricing Optimization</h4>
                <p><strong>Top Opportunity:</strong> ${productAnalysis[0].name}</p>
                <p><strong>Current Price:</strong> ${formatAmount(productAnalysis[0].current)}</p>
                <p><strong>Suggested Price:</strong> ${formatAmount(productAnalysis[0].optimal)}</p>
                <p><strong>Potential Increase:</strong> ${formatAmount(productAnalysis[0].increase)}</p>
            `;
            
            recommendations.innerHTML = productAnalysis.map(p => `
                <div class="list-item" style="margin-bottom: 10px;">
                    <div style="flex-grow: 1;">
                        <div style="font-weight: 600;">${p.name}</div>
                        <div style="font-size: 12px; color: #6b7280;">Current: ${formatAmount(p.current)} | Margin: ${p.margin}%</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 600; color: var(--color-secondary);">${formatAmount(p.optimal)}</div>
                        <div style="font-size: 12px; color: #6b7280;">${p.increase > 0 ? '+' : ''}${formatAmount(p.increase)}</div>
                    </div>
                </div>
            `).join('');
        }
    }, 1000);
}

function runWhatIfScenario() {
    const priceChange = parseFloat(document.getElementById('whatif-price').value) || 0;
    const volumeChange = parseFloat(document.getElementById('whatif-volume').value) || 0;
    const costChange = parseFloat(document.getElementById('whatif-cost').value) || 0;
    const newExpense = parseFloat(document.getElementById('whatif-expense').value) || 0;
    
    const { totalRevenue, totalCostOfGoodsSold, totalFixedDeductions, netProfitLoss } = calculateFinancials();
    
    const newRevenue = totalRevenue * (1 + priceChange / 100) * (1 + volumeChange / 100);
    const newCost = totalCostOfGoodsSold * (1 + costChange / 100);
    const newFixedCost = totalFixedDeductions + newExpense;
    const newProfit = newRevenue - newCost - newFixedCost;
    
    const profitChange = newProfit - netProfitLoss;
    const profitChangePercent = netProfitLoss !== 0 ? ((profitChange / Math.abs(netProfitLoss)) * 100).toFixed(1) : 0;
    
    document.getElementById('whatif-current-revenue').textContent = formatAmount(totalRevenue);
    document.getElementById('whatif-new-revenue').textContent = formatAmount(newRevenue);
    document.getElementById('whatif-current-profit').textContent = formatAmount(netProfitLoss);
    document.getElementById('whatif-new-profit').textContent = formatAmount(newProfit);
    document.getElementById('whatif-new-profit').style.color = newProfit >= 0 ? 'var(--color-secondary)' : 'var(--color-danger)';
    
    let recommendation = '';
    if (profitChange > 0) {
        recommendation = ` This scenario would INCREASE profit by ${formatAmount(Math.abs(profitChange))} (${Math.abs(profitChangePercent)}%). Consider implementing these changes!`;
    } else if (profitChange < 0) {
        recommendation = ` This scenario would DECREASE profit by ${formatAmount(Math.abs(profitChange))} (${Math.abs(profitChangePercent)}%). Not recommended.`;
    } else {
        recommendation = ` This scenario would have NO IMPACT on profit.`;
    }
    
    document.getElementById('whatif-recommendation').textContent = recommendation;
    document.getElementById('whatif-results').style.display = 'block';
    
    showStatus('Scenario calculated successfully', 'success');
}

// --- SIDEBAR TOGGLE ---
function toggleSidebar() {
    const navBar = document.getElementById('nav-bar');
    const mainContent = document.getElementById('main');
    navBar.classList.toggle('hidden');
    mainContent.classList.toggle('expanded');
}

// --- BREAK-EVEN ANALYSIS ---
function calculateBreakEven() {
    const productSelect = document.getElementById('breakeven-product');
    const productName = productSelect.value;
    
    if (!productName) {
        showMessage('Please select a product', 'error');
        return;
    }
    
    const product = productCatalog[productName];
    const { totalFixedDeductions } = calculateFinancials();
    
    const contributionMargin = product.sellingPrice - product.buyingPrice;
    const breakEvenUnits = Math.ceil(totalFixedDeductions / contributionMargin);
    const breakEvenRevenue = breakEvenUnits * product.sellingPrice;
    
    document.getElementById('breakeven-units').textContent = breakEvenUnits.toLocaleString();
    document.getElementById('breakeven-revenue').textContent = formatAmount(breakEvenRevenue);
    document.getElementById('contribution-margin').textContent = formatAmount(contributionMargin);
    
    const currentSales = salesHistory.filter(s => s.product === productName).reduce((sum, s) => sum + s.quantity, 0);
    const percentageToBreakEven = currentSales > 0 ? ((currentSales / breakEvenUnits) * 100).toFixed(1) : 0;
    
    let insight = '';
    if (currentSales >= breakEvenUnits) {
        insight = ` You've sold ${currentSales} units and already passed break-even! You're ${(currentSales - breakEvenUnits)} units into profit.`;
    } else {
        insight = ` You need to sell ${breakEvenUnits - currentSales} more units to break even. Currently at ${percentageToBreakEven}% of break-even point.`;
    }
    
    document.getElementById('breakeven-insight').textContent = insight;
    document.getElementById('breakeven-results').style.display = 'block';
}

// --- PDF REPORT GENERATION ---
function generateFinancialReport() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const accountSettings = JSON.parse(localStorage.getItem('epsilon_account_settings') || '{}');
    const businessName = accountSettings.businessName || 'My Business';
    const ownerName = accountSettings.ownerName || 'Owner';
    
    const { totalRevenue, totalCostOfGoodsSold, totalFixedDeductions, netProfitLoss } = calculateFinancials();
    
    doc.setFontSize(20);
    doc.text('FINANCIAL SUMMARY REPORT', 105, 20, { align: 'center' });
    
    doc.setFontSize(12);
    doc.text(businessName, 105, 30, { align: 'center' });
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 37, { align: 'center' });
    
    doc.setFontSize(14);
    doc.text('Key Metrics', 20, 55);
    doc.setFontSize(11);
    
    let y = 65;
    doc.text(`Total Revenue: ${formatAmount(totalRevenue)}`, 20, y);
    y += 10;
    doc.text(`Cost of Goods Sold: ${formatAmount(totalCostOfGoodsSold)}`, 20, y);
    y += 10;
    doc.text(`Fixed Deductions: ${formatAmount(totalFixedDeductions)}`, 20, y);
    y += 10;
    doc.text(`Net Profit/Loss: ${formatAmount(netProfitLoss)}`, 20, y);
    y += 15;
    
    doc.setFontSize(14);
    doc.text('Products', 20, y);
    y += 10;
    doc.setFontSize(10);
    
    Object.keys(productCatalog).forEach(name => {
        const p = productCatalog[name];
        doc.text(`${name}: Sell ${formatAmount(p.sellingPrice)} | Buy ${formatAmount(p.buyingPrice)} | Stock: ${p.stock}`, 20, y);
        y += 7;
        if (y > 270) {
            doc.addPage();
            y = 20;
        }
    });
    
    y += 10;
    doc.setFontSize(14);
    doc.text('Recent Sales', 20, y);
    y += 10;
    doc.setFontSize(10);
    
    salesHistory.slice(-10).reverse().forEach(sale => {
        doc.text(`${new Date(sale.date).toLocaleDateString()} - ${sale.product} x${sale.quantity} @ ${formatAmount(sale.unitPrice)}`, 20, y);
        y += 7;
        if (y > 270) {
            doc.addPage();
            y = 20;
        }
    });
    
    doc.save(`${businessName}_Financial_Report_${new Date().toISOString().split('T')[0]}.pdf`);
    showMessage('Financial report generated!', 'success');
}

function generateSalesReport() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const accountSettings = JSON.parse(localStorage.getItem('epsilon_account_settings') || '{}');
    const businessName = accountSettings.businessName || 'My Business';
    
    doc.setFontSize(20);
    doc.text('SALES REPORT', 105, 20, { align: 'center' });
    doc.setFontSize(12);
    doc.text(businessName, 105, 30, { align: 'center' });
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 37, { align: 'center' });
    
    let y = 55;
    doc.setFontSize(11);
    doc.text(`Total Transactions: ${salesHistory.length}`, 20, y);
    y += 10;
    
    const { totalRevenue } = calculateFinancials();
    doc.text(`Total Revenue: ${formatAmount(totalRevenue)}`, 20, y);
    y += 20;
    
    doc.setFontSize(14);
    doc.text('Sales History', 20, y);
    y += 10;
    doc.setFontSize(9);
    
    salesHistory.slice().reverse().forEach(sale => {
        const total = sale.quantity * sale.unitPrice;
        doc.text(`${new Date(sale.date).toLocaleString()} | ${sale.product} | Qty: ${sale.quantity} | ${formatAmount(sale.unitPrice)} | Total: ${formatAmount(total)}`, 20, y);
        y += 6;
        if (y > 280) {
            doc.addPage();
            y = 20;
        }
    });
    
    doc.save(`${businessName}_Sales_Report_${new Date().toISOString().split('T')[0]}.pdf`);
    showMessage('Sales report generated!', 'success');
}

function generateProductReport() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const accountSettings = JSON.parse(localStorage.getItem('epsilon_account_settings') || '{}');
    const businessName = accountSettings.businessName || 'My Business';
    
    doc.setFontSize(20);
    doc.text('PRODUCT CATALOG', 105, 20, { align: 'center' });
    doc.setFontSize(12);
    doc.text(businessName, 105, 30, { align: 'center' });
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 37, { align: 'center' });
    
    let y = 55;
    doc.setFontSize(11);
    doc.text(`Total Products: ${Object.keys(productCatalog).length}`, 20, y);
    y += 20;
    
    doc.setFontSize(14);
    doc.text('Product Details', 20, y);
    y += 10;
    
    Object.keys(productCatalog).forEach(name => {
        const p = productCatalog[name];
        const margin = ((p.sellingPrice - p.buyingPrice) / p.sellingPrice * 100).toFixed(1);
        
        doc.setFontSize(12);
        doc.text(name, 20, y);
        y += 7;
        doc.setFontSize(10);
        doc.text(`Selling Price: ${formatAmount(p.sellingPrice)}`, 25, y);
        y += 6;
        doc.text(`Buying Price: ${formatAmount(p.buyingPrice)}`, 25, y);
        y += 6;
        doc.text(`Stock: ${p.stock} units`, 25, y);
        y += 6;
        doc.text(`Profit Margin: ${margin}%`, 25, y);
        y += 12;
        
        if (y > 270) {
            doc.addPage();
            y = 20;
        }
    });
    
    doc.save(`${businessName}_Product_Catalog_${new Date().toISOString().split('T')[0]}.pdf`);
    showMessage('Product report generated!', 'success');
}

// --- GOAL TRACKING ---
function createGoal() {
    const type = document.getElementById('goal-type').value;
    const target = parseFloat(document.getElementById('goal-target').value);
    const name = document.getElementById('goal-name').value.trim();
    const deadline = document.getElementById('goal-deadline').value;
    
    if (!target || target <= 0 || !name || !deadline) {
        showMessage('Please fill all fields', 'error');
        return;
    }
    
    const goal = {
        id: generateId(),
        type,
        target,
        name,
        deadline,
        createdAt: new Date().toISOString(),
        completed: false
    };
    
    goals.push(goal);
    saveData();
    renderGoals();
    
    document.getElementById('goal-target').value = '';
    document.getElementById('goal-name').value = '';
    document.getElementById('goal-deadline').value = '';
    
    showMessage('Goal created!', 'success');
}

function renderGoals() {
    const goalsList = document.getElementById('goals-list');
    if (!goalsList) return;
    
    const activeGoals = goals.filter(g => !g.completed);
    const completedGoals = goals.filter(g => g.completed);
    
    document.getElementById('active-goals-count').textContent = activeGoals.length;
    document.getElementById('completed-goals-count').textContent = completedGoals.length;
    
    const avgProgress = activeGoals.length > 0 ? 
        (activeGoals.reduce((sum, g) => sum + calculateGoalProgress(g), 0) / activeGoals.length).toFixed(0) : 0;
    document.getElementById('avg-progress').textContent = `${avgProgress}%`;
    
    if (goals.length === 0) {
        goalsList.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No goals yet. Create one above!</p>';
        return;
    }
    
    goalsList.innerHTML = goals.map(goal => {
        const progress = calculateGoalProgress(goal);
        const daysLeft = Math.ceil((new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24));
        const isOverdue = daysLeft < 0;
        
        return `
            <div class="list-item" style="flex-direction: column; align-items: stretch; ${goal.completed ? 'opacity: 0.6;' : ''}">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div>
                        <h4 style="margin: 0; font-size: 16px;">${goal.name}</h4>
                        <p style="margin: 4px 0; font-size: 12px; color: #6b7280;">${goal.type.toUpperCase()} | Target: ${formatAmount(goal.target)}</p>
                    </div>
                    <button onclick="deleteGoal('${goal.id}')" style="background: none; border: none; cursor: pointer; color: #ef4444;"></button>
                </div>
                <div style="margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px;">
                        <span>${progress.toFixed(0)}% Complete</span>
                        <span style="color: ${isOverdue ? '#ef4444' : '#6b7280'};">${isOverdue ? 'Overdue' : `${daysLeft} days left`}</span>
                    </div>
                    <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${Math.min(progress, 100)}%; height: 100%; background: ${progress >= 100 ? '#10b981' : '#3b82f6'}; transition: width 0.3s;"></div>
                    </div>
                </div>
                ${!goal.completed && progress >= 100 ? `<button onclick="markGoalComplete('${goal.id}')" class="button button-secondary" style="padding: 6px 12px; font-size: 12px;"> Mark Complete</button>` : ''}
                ${goal.completed ? '<p style="margin: 0; color: #10b981; font-weight: 600; font-size: 12px;"> Completed!</p>' : ''}
            </div>
        `;
    }).join('');
}

function calculateGoalProgress(goal) {
    const { totalRevenue, netProfitLoss } = calculateFinancials();
    
    let current = 0;
    if (goal.type === 'revenue') current = totalRevenue;
    else if (goal.type === 'profit') current = netProfitLoss;
    else if (goal.type === 'sales') current = salesHistory.length;
    
    return (current / goal.target) * 100;
}

function markGoalComplete(goalId) {
    const goal = goals.find(g => g.id === goalId);
    if (goal) {
        goal.completed = true;
        goal.completedAt = new Date().toISOString();
        saveData();
        renderGoals();
        showMessage(' Goal completed! Congratulations!', 'success');
    }
}

function deleteGoal(goalId) {
    goals = goals.filter(g => g.id !== goalId);
    saveData();
    renderGoals();
    showMessage('Goal deleted', 'success');
}

// --- WAREHOUSE MANAGEMENT FUNCTIONS ---
function addWarehouse() {
    const name = document.getElementById('warehouse-name').value.trim();
    const address = document.getElementById('warehouse-address').value.trim();
    const capacity = parseInt(document.getElementById('warehouse-capacity').value);
    const clientId = document.getElementById('warehouse-client').value;
    const productSelect = document.getElementById('warehouse-products-select');
    const selectedProducts = Array.from(productSelect.selectedOptions).map(opt => opt.value);
    
    if (!name || !address || !capacity || capacity <= 0) {
        showMessage('Please fill all required fields with valid data', 'error');
        return;
    }
    
    const newWarehouse = {
        id: generateId(),
        name,
        address,
        capacity,
        clientId: clientId || null,
        products: selectedProducts,
        currentStock: 0,
        createdAt: new Date().toISOString()
    };
    
    warehouses.push(newWarehouse);
    
    document.getElementById('warehouse-name').value = '';
    document.getElementById('warehouse-address').value = '';
    document.getElementById('warehouse-capacity').value = '';
    document.getElementById('warehouse-client').value = '';
    productSelect.selectedIndex = -1;
    
    document.getElementById('new-warehouse-dialog').close();
    saveData();
    renderWarehouses();
    updateWarehouseStats();
    showMessage(`Warehouse "${name}" created successfully!`, 'success');
    showNotification(`New warehouse "${name}" added at ${address}`, 'success');
}

function editWarehouse(warehouseId) {
    const warehouse = warehouses.find(w => w.id === warehouseId);
    if (!warehouse) return;
    
    document.getElementById('edit-warehouse-id').value = warehouse.id;
    document.getElementById('edit-warehouse-name').value = warehouse.name;
    document.getElementById('edit-warehouse-address').value = warehouse.address;
    document.getElementById('edit-warehouse-capacity').value = warehouse.capacity;
    document.getElementById('edit-warehouse-client').value = warehouse.clientId || '';
    
    const productSelect = document.getElementById('edit-warehouse-products-select');
    Array.from(productSelect.options).forEach(opt => {
        opt.selected = warehouse.products.includes(opt.value);
    });
    
    populateWarehouseDropdowns('edit');
    document.getElementById('edit-warehouse-dialog').showModal();
}

function updateWarehouse() {
    const id = document.getElementById('edit-warehouse-id').value;
    const warehouse = warehouses.find(w => w.id === id);
    if (!warehouse) return;
    
    const name = document.getElementById('edit-warehouse-name').value.trim();
    const address = document.getElementById('edit-warehouse-address').value.trim();
    const capacity = parseInt(document.getElementById('edit-warehouse-capacity').value);
    const clientId = document.getElementById('edit-warehouse-client').value;
    const productSelect = document.getElementById('edit-warehouse-products-select');
    const selectedProducts = Array.from(productSelect.selectedOptions).map(opt => opt.value);
    
    if (!name || !address || !capacity || capacity <= 0) {
        showMessage('Please fill all required fields with valid data', 'error');
        return;
    }
    
    warehouse.name = name;
    warehouse.address = address;
    warehouse.capacity = capacity;
    warehouse.clientId = clientId || null;
    warehouse.products = selectedProducts;
    warehouse.updatedAt = new Date().toISOString();
    
    document.getElementById('edit-warehouse-dialog').close();
    saveData();
    renderWarehouses();
    updateWarehouseStats();
    showMessage(`Warehouse "${name}" updated successfully!`, 'success');
}

function deleteWarehouse(warehouseId) {
    const warehouse = warehouses.find(w => w.id === warehouseId);
    if (!warehouse) return;
    
    if (confirm(`Are you sure you want to delete warehouse "${warehouse.name}"?`)) {
        warehouses = warehouses.filter(w => w.id !== warehouseId);
        saveData();
        renderWarehouses();
        updateWarehouseStats();
        showMessage(`Warehouse "${warehouse.name}" deleted`, 'success');
        showNotification(`Warehouse "${warehouse.name}" has been removed`, 'warning');
    }
}

function viewWarehouseDetails(warehouseId) {
    const warehouse = warehouses.find(w => w.id === warehouseId);
    if (!warehouse) return;
    
    const client = warehouse.clientId ? clients.find(c => c.id === warehouse.clientId) : null;
    const totalStock = warehouse.products.reduce((sum, productName) => {
        const product = productCatalog[productName];
        return sum + (product ? product.stock : 0);
    }, 0);
    
    const utilizationPercent = warehouse.capacity > 0 ? ((totalStock / warehouse.capacity) * 100).toFixed(1) : 0;
    
    let html = `
        <div style="margin-bottom: 20px;">
            <h4 style="margin: 0 0 8px 0; color: var(--color-primary);">${warehouse.name}</h4>
            <p style="margin: 4px 0; color: var(--color-text-medium);"><strong>Address:</strong> ${warehouse.address}</p>
            <p style="margin: 4px 0; color: var(--color-text-medium);"><strong>Capacity:</strong> ${warehouse.capacity} units</p>
            <p style="margin: 4px 0; color: var(--color-text-medium);"><strong>Current Stock:</strong> ${totalStock} units</p>
            <p style="margin: 4px 0; color: var(--color-text-medium);"><strong>Utilization:</strong> ${utilizationPercent}%</p>
            ${client ? `<p style="margin: 4px 0; color: var(--color-text-medium);"><strong>Linked to:</strong> ${client.name} (${client.type})</p>` : '<p style="margin: 4px 0; color: var(--color-text-medium);"><strong>Linked to:</strong> None</p>'}
        </div>
        
        <div style="width: 100%; background-color: #e5e7eb; border-radius: 8px; height: 20px; margin-bottom: 20px; overflow: hidden;">
            <div style="height: 100%; background-color: ${utilizationPercent > 90 ? '#ef4444' : utilizationPercent > 70 ? '#f97316' : '#10b981'}; width: ${Math.min(utilizationPercent, 100)}%; transition: width 0.3s;"></div>
        </div>
        
        <h4 style="margin: 20px 0 10px 0;">Managed Products (${warehouse.products.length})</h4>
        <div style="max-height: 300px; overflow-y: auto;">
    `;
    
    if (warehouse.products.length === 0) {
        html += '<p style="color: var(--color-text-medium); text-align: center; padding: 20px;">No products assigned to this warehouse</p>';
    } else {
        warehouse.products.forEach(productName => {
            const product = productCatalog[productName];
            if (product) {
                html += `
                    <div style="padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; background: #f9fafb;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${productName}</strong>
                                <p style="margin: 4px 0; font-size: 13px; color: var(--color-text-medium);">Stock: ${product.stock} units</p>
                            </div>
                            <div style="text-align: right;">
                                <p style="margin: 0; font-size: 13px; color: var(--color-text-medium);">Sell: ${formatAmount(product.sellingPrice)}</p>
                                <p style="margin: 0; font-size: 13px; color: var(--color-text-medium);">Buy: ${formatAmount(product.buyingPrice)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        });
    }
    
    html += '</div>';
    
    document.getElementById('warehouse-details-title').textContent = warehouse.name;
    document.getElementById('warehouse-details-content').innerHTML = html;
    document.getElementById('warehouse-details-dialog').showModal();
}

function renderWarehouses() {
    const warehouseList = document.getElementById('warehouse-list');
    if (!warehouseList) return;
    
    if (warehouses.length === 0) {
        warehouseList.innerHTML = '<p style="padding: 20px; text-align: center; color: #9ca3af;">No warehouses added yet. Create your first warehouse!</p>';
        return;
    }
    
    warehouseList.innerHTML = warehouses.map(warehouse => {
        const client = warehouse.clientId ? clients.find(c => c.id === warehouse.clientId) : null;
        const totalStock = warehouse.products.reduce((sum, productName) => {
            const product = productCatalog[productName];
            return sum + (product ? product.stock : 0);
        }, 0);
        const utilizationPercent = warehouse.capacity > 0 ? ((totalStock / warehouse.capacity) * 100).toFixed(0) : 0;
        
        return `
            <div class="list-item" style="border-left: 4px solid var(--color-primary); margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); flex-direction: column; align-items: stretch;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <div style="flex-grow: 1;">
                        <div class="list-item-main">${warehouse.name}</div>
                        <div class="list-item-detail" style="margin-top: 4px;">
                             ${warehouse.address}
                        </div>
                        <div class="list-item-detail" style="margin-top: 4px;">
                            Capacity: <span class="text-primary" style="font-weight: 600;">${warehouse.capacity}</span> units | 
                            Stock: <span class="text-secondary" style="font-weight: 600;">${totalStock}</span> units
                        </div>
                        ${client ? `<div class="list-item-detail" style="margin-top: 4px;"> Linked to: <span style="font-weight: 600;">${client.name}</span> (${client.type})</div>` : ''}
                        <div class="list-item-detail" style="margin-top: 4px;">
                             Managing ${warehouse.products.length} product(s)
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button onclick="viewWarehouseDetails('${warehouse.id}')" style="background: var(--color-secondary); border: none; cursor: pointer; padding: 6px 12px; border-radius: 6px; color: white; font-size: 12px; font-weight: 600;" title="View Details">
                            View
                        </button>
                        <button onclick="editWarehouse('${warehouse.id}')" style="background: var(--color-primary); border: none; cursor: pointer; padding: 6px 12px; border-radius: 6px; color: white; font-size: 12px; font-weight: 600;" title="Edit">
                            Edit
                        </button>
                        <button onclick="deleteWarehouse('${warehouse.id}')" style="background: none; border: none; cursor: pointer; padding: 8px;" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" style="height: 20px; width: 20px; color: var(--color-danger);" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div style="width: 100%; background-color: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden;">
                    <div style="height: 100%; background-color: ${utilizationPercent > 90 ? '#ef4444' : utilizationPercent > 70 ? '#f97316' : '#10b981'}; width: ${Math.min(utilizationPercent, 100)}%; transition: width 0.3s;"></div>
                </div>
                <div style="text-align: right; font-size: 11px; color: var(--color-text-medium); margin-top: 4px;">
                    Utilization: ${utilizationPercent}%
                </div>
            </div>
        `;
    }).join('');
}

function updateWarehouseStats() {
    const totalWarehousesEl = document.getElementById('total-warehouses');
    const warehouseProductsEl = document.getElementById('warehouse-products');
    const totalCapacityEl = document.getElementById('total-capacity');
    const linkedClientsEl = document.getElementById('linked-clients');
    
    if (totalWarehousesEl) totalWarehousesEl.textContent = warehouses.length;
    
    const uniqueProducts = new Set();
    warehouses.forEach(w => w.products.forEach(p => uniqueProducts.add(p)));
    if (warehouseProductsEl) warehouseProductsEl.textContent = uniqueProducts.size;
    
    const totalCapacity = warehouses.reduce((sum, w) => sum + w.capacity, 0);
    if (totalCapacityEl) totalCapacityEl.textContent = totalCapacity;
    
    const linkedClients = new Set(warehouses.filter(w => w.clientId).map(w => w.clientId));
    if (linkedClientsEl) linkedClientsEl.textContent = linkedClients.size;
}

function populateWarehouseDropdowns(mode = 'new') {
    const prefix = mode === 'new' ? 'warehouse' : 'edit-warehouse';
    const clientSelect = document.getElementById(`${prefix}-client`);
    const productSelect = document.getElementById(`${prefix}-products-select`);
    
    if (clientSelect) {
        clientSelect.innerHTML = '<option value="">None</option>';
        clients.forEach(client => {
            clientSelect.innerHTML += `<option value="${client.id}">${client.name} (${client.type})</option>`;
        });
    }
    
    if (productSelect) {
        productSelect.innerHTML = '';
        Object.keys(productCatalog).forEach(productName => {
            productSelect.innerHTML += `<option value="${productName}">${productName}</option>`;
        });
    }
}

// --- WAREHOUSE TRANSFER FUNCTIONS ---
function updateTransferProducts() {
    const fromSelect = document.getElementById('transfer-from');
    const productSelect = document.getElementById('transfer-product');
    const stockInfo = document.getElementById('transfer-stock-info');
    
    if (!fromSelect || !productSelect) return;
    
    const warehouseId = fromSelect.value;
    productSelect.innerHTML = '<option value="">Select product</option>';
    stockInfo.textContent = '';
    
    if (!warehouseId) return;
    
    const warehouse = warehouses.find(w => w.id === warehouseId);
    if (!warehouse || !warehouse.products || warehouse.products.length === 0) {
        productSelect.innerHTML = '<option value="">No products in this warehouse</option>';
        return;
    }
    
    warehouse.products.forEach(productName => {
        const product = productCatalog[productName];
        if (product) {
            productSelect.innerHTML += `<option value="${productName}">${productName} (Stock: ${product.stock || 0})</option>`;
        }
    });
}

function updateTransferStock() {
    const productSelect = document.getElementById('transfer-product');
    const stockInfo = document.getElementById('transfer-stock-info');
    
    if (!productSelect || !stockInfo) return;
    
    const productName = productSelect.value;
    if (!productName) {
        stockInfo.textContent = '';
        return;
    }
    
    const product = productCatalog[productName];
    if (product) {
        stockInfo.textContent = `Available stock: ${product.stock || 0} units`;
        stockInfo.style.color = product.stock > 0 ? '#10b981' : '#ef4444';
    }
}

function executeTransfer() {
    const fromSelect = document.getElementById('transfer-from');
    const toSelect = document.getElementById('transfer-to');
    const productSelect = document.getElementById('transfer-product');
    const quantityInput = document.getElementById('transfer-quantity');
    
    const fromWarehouseId = fromSelect.value;
    const toWarehouseId = toSelect.value;
    const productName = productSelect.value;
    const quantity = parseInt(quantityInput.value);
    
    if (!fromWarehouseId || !toWarehouseId) {
        showMessage('Please select both warehouses', 'error');
        return;
    }
    
    if (fromWarehouseId === toWarehouseId) {
        showMessage('Source and destination must be different', 'error');
        return;
    }
    
    if (!productName) {
        showMessage('Please select a product', 'error');
        return;
    }
    
    if (!quantity || quantity <= 0) {
        showMessage('Please enter a valid quantity', 'error');
        return;
    }
    
    const fromWarehouse = warehouses.find(w => w.id === fromWarehouseId);
    const toWarehouse = warehouses.find(w => w.id === toWarehouseId);
    
    if (!fromWarehouse || !toWarehouse) {
        showMessage('Warehouse not found', 'error');
        return;
    }
    
    if (!fromWarehouse.products || !fromWarehouse.products.includes(productName)) {
        showMessage('Product not in source warehouse', 'error');
        return;
    }
    
    const product = productCatalog[productName];
    if (!product || product.stock < quantity) {
        showMessage(`Insufficient stock! Available: ${product.stock || 0}`, 'error');
        return;
    }
    
    if (!toWarehouse.products) toWarehouse.products = [];
    if (!toWarehouse.products.includes(productName)) {
        toWarehouse.products.push(productName);
    }
    
    saveData();
    renderWarehouses();
    
    document.getElementById('transfer-dialog').close();
    fromSelect.value = '';
    toSelect.value = '';
    productSelect.innerHTML = '<option value="">Select product</option>';
    quantityInput.value = '';
    document.getElementById('transfer-stock-info').textContent = '';
    
    showMessage(`Transferred ${quantity} units of "${productName}" from ${fromWarehouse.name} to ${toWarehouse.name}`, 'success');
    addNotification(`Transfer: ${quantity} units of "${productName}" moved from ${fromWarehouse.name} to ${toWarehouse.name}`, 'info');
}

// --- RECEIPT SCANNER (OCR) ---
function scanReceipt(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('receipt-preview').src = e.target.result;
        document.getElementById('ocr-progress').style.display = 'block';
        document.getElementById('ocr-results').style.display = 'none';
        
        Tesseract.recognize(e.target.result, 'eng', {
            logger: m => {
                if (m.status === 'recognizing text') {
                    document.getElementById('ocr-progress-bar').style.width = `${m.progress * 100}%`;
                }
            }
        }).then(({ data: { text } }) => {
            document.getElementById('ocr-progress').style.display = 'none';
            document.getElementById('ocr-results').style.display = 'block';
            document.getElementById('ocr-text').value = text;
            
            const amountMatch = text.match(/\$?\d+\.\d{2}|\d+,\d{3}\.\d{2}/);
            if (amountMatch) {
                const amount = parseFloat(amountMatch[0].replace(/[$,]/g, ''));
                document.getElementById('ocr-amount').value = amount;
            }
            
            showMessage('Receipt scanned successfully!', 'success');
        }).catch(err => {
            console.error(err);
            document.getElementById('ocr-progress').style.display = 'none';
            showMessage('Failed to scan receipt', 'error');
        });
    };
    reader.readAsDataURL(file);
}

function saveScannedExpense() {
    const name = document.getElementById('ocr-expense-name').value.trim();
    const amount = parseFloat(document.getElementById('ocr-amount').value);
    
    if (!name || !amount || amount <= 0) {
        showMessage('Please enter valid expense details', 'error');
        return;
    }
    
    fixedDeductions.push({ name, amount, id: generateId() });
    saveData();
    updateTotals();
    
    document.getElementById('ocr-expense-name').value = '';
    document.getElementById('ocr-amount').value = '';
    document.getElementById('ocr-text').value = '';
    document.getElementById('ocr-results').style.display = 'none';
    
    showMessage('Expense added from receipt!', 'success');
}

// --- INITIALIZATION ---
setInterval(() => {
    const canvas = document.getElementById('monthly-trends');
    if (canvas) canvas.style.height = '400px';
}, 1);

// Drag functionality for AI page
//let isDragging = false;
let dragOffsetX = 0;
let dragOffsetY = 0;
let dragElement = null;

function dragStart(e) {
    const aiPage = document.getElementById('AI-page');
    if (!aiPage || !aiPage.classList.contains('collapsed')) return;
    
    isDragging = true;
    dragElement = aiPage;
    const rect = aiPage.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;
    aiPage.style.cursor = 'grabbing';
    e.preventDefault();
}

function drag(e) {
    if (!isDragging || !dragElement) return;
    
    const x = e.clientX - dragOffsetX;
    const y = e.clientY - dragOffsetY;
    
    dragElement.style.left = `${x}px`;
    dragElement.style.top = `${y}px`;
    dragElement.style.right = 'auto';
    dragElement.style.bottom = 'auto';
    e.preventDefault();
}

function dragEnd(e) {
    if (isDragging && dragElement) {
        dragElement.style.cursor = 'move';
    }
    isDragging = false;
    dragElement = null;
}

document.addEventListener('DOMContentLoaded', () => {
    const aiPage = document.getElementById('AI-page');
    const collapseToggle = document.querySelector('.collapse-toggle');
    
    // Attach drag listeners to the AI page when collapsed
    if (aiPage) {
        aiPage.addEventListener('mousedown', dragStart);
    }
    
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);
    
    document.addEventListener('click', (e) => {
        if (!e.target.closest('#context-menu') && !e.target.closest('.node')) {
            hideContextMenu();
        }
    });
    
    loadData();
    loadAccountSettings();
    renderNotifications();
    updateNotificationBadge();
    updateTotals();
    calculateInventoryCost();
    checkDeductionDeadlines();
    
    setInterval(checkDeductionDeadlines, 3600000);
    
    const initialCurrencyRadio = document.querySelector(`input[name="currency-radio"][value="${currentCurrency}"]`);
    if (initialCurrencyRadio) {
        initialCurrencyRadio.checked = true;
    }

    showPage('dashboard-page');
    lucide.createIcons();
    
    const sidebarToggle = document.getElementById('sidebar-toggle');
    if (sidebarToggle) {
        sidebarToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const navBar = document.getElementById('nav-bar');
            const overlay = document.getElementById('nav-overlay');
            if (navBar) navBar.classList.toggle('active');
            if (overlay) overlay.classList.toggle('active');
        });
    }
    
    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', (e) => {
        const navBar = document.getElementById('nav-bar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        
        if (window.innerWidth <= 768 && 
            navBar && 
            navBar.classList.contains('active') && 
            !navBar.contains(e.target) && 
            !sidebarToggle.contains(e.target)) {
            const navBar = document.getElementById('nav-bar');
            const overlay = document.getElementById('nav-overlay');
            if (navBar) navBar.classList.remove('active');
            if (overlay) overlay.classList.remove('active');
        }
    });

    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") {
        document.body.classList.add("dark-mode");
    }
    
    // Handle window resize
    window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
            const navBar = document.getElementById('nav-bar');
            const overlay = document.getElementById('nav-overlay');
            if (navBar) navBar.classList.remove('active');
            if (overlay) overlay.classList.remove('active');
        }
    });

    // Add event listeners
    const logoFileInput = document.getElementById('logo-file');
    if (logoFileInput) {
        logoFileInput.addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const imgElement = document.getElementById('business-logo-img');
                const headerProfilePic = document.getElementById('header-profile-pic');
                
                if (imgElement) imgElement.src = e.target.result;
                if (headerProfilePic) headerProfilePic.src = e.target.result;
                
                const settings = JSON.parse(localStorage.getItem('epsilon_account_settings') || '{}');
                settings.businessLogo = e.target.result;
                localStorage.setItem('epsilon_account_settings', JSON.stringify(settings));
                
                updateShowcaseDisplay();
                showMessage("Profile picture updated!", "success");
            };
            reader.readAsDataURL(file);
        });
    }

    // Scanner dialog event listener
    const scannerDialog = document.getElementById('scanner-dialog');
    if (scannerDialog) {
        scannerDialog.addEventListener('close', () => {
            stopScanner();
        });
    }
    
    const scannerButton = document.querySelector('button[onclick*="scanner-dialog"]');
    if (scannerButton) {
        scannerButton.addEventListener('click', () => {
            setTimeout(() => startScanner(), 300);
        });
    }
    
    if (typeof populateWarehouseDropdowns === 'function') {
        populateWarehouseDropdowns('new');
        populateWarehouseDropdowns('edit');
    }
    
    // Setup transfer dialog
    const transferBtn = document.querySelector('button[onclick*="transfer-dialog"]');
    if (transferBtn) {
        transferBtn.addEventListener('click', () => {
            setTimeout(() => {
                const fromSelect = document.getElementById('transfer-from');
                const toSelect = document.getElementById('transfer-to');
                if (fromSelect && toSelect) {
                    fromSelect.innerHTML = '<option value="">Select source warehouse</option>';
                    toSelect.innerHTML = '<option value="">Select destination warehouse</option>';
                    warehouses.forEach(w => {
                        fromSelect.innerHTML += `<option value="${w.id}">${w.name}</option>`;
                        toSelect.innerHTML += `<option value="${w.id}">${w.name}</option>`;
                    });
                }
            }, 100);
        });
    }
    
    const salesSearch = document.getElementById('sales-search');
    if (salesSearch) {
        salesSearch.addEventListener("input", function () {
            const query = this.value.toLowerCase().trim();
            const historyList = document.getElementById("history-list");

            if (!salesHistory || salesHistory.length === 0) return;

            historyList.innerHTML = "";
            const sorted = salesHistory.slice().sort((a, b) => b.date - a.date);

            const filtered = sorted.filter(sale => {
                return (
                    sale.product.toLowerCase().includes(query) ||
                    String(sale.quantity).includes(query) ||
                    String(sale.unitPrice).includes(query) ||
                    new Date(sale.date).toLocaleString().toLowerCase().includes(query)
                );
            });

            if (filtered.length === 0) {
                historyList.innerHTML = `<p style="padding: 16px; text-align: center; color: #9ca3af; font-style: italic;">No matching sales found.</p>`;
                return;
            }

            filtered.forEach(sale => {
                const total = sale.quantity * sale.unitPrice;
                const product = productCatalog[sale.product];
                const buyingPrice = product ? product.buyingPrice : 0;
                const profit = (sale.unitPrice - buyingPrice) * sale.quantity;
                const profitColor = profit >= 0 ? "text-secondary" : "text-danger";

                const entry = document.createElement("div");
                entry.className = "list-item";

                entry.innerHTML = `
                    <div style="flex-grow:1;">
                        <div class="list-item-main">${sale.product}</div>
                        <div class="list-item-detail">Qty: ${sale.quantity} @ ${formatAmount(sale.unitPrice)}</div>
                        <div style="font-size:11px;color:#9ca3af;margin-top:4px;">
                            ${new Date(sale.date).toLocaleString()}
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div class="list-total">${formatAmount(total)}</div>
                        <div class="${profitColor}" style="font-size:13px;">
                            Profit: ${formatAmount(profit)}
                        </div>
                    </div>
                `;
                historyList.appendChild(entry);
            });
        });
    }
});
function showProductCatalog() {

}
// Add this to your existing JavaScript

// Split Screen State
let splitScreenState = {
    isActive: false,
    leftPage: null,
    rightPage: null,
    contextMenu: null
};

// Create Split Screen Context Menu
function createSplitContextMenu() {
    const menu = document.createElement('div');
    menu.id = 'split-context-menu';
    menu.className = 'card-context-menu';
    menu.innerHTML = `
        <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #1f293b; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px;">
            Split Screen With:
        </h4>
        <div class="split-menu-items">
            <div class="context-menu-item" onclick="openSplitScreen('dashboard-page')">
                <i data-lucide="layout-dashboard" style="width: 16px; height: 16px;"></i>
                <span>Dashboard</span>
            </div>
            <div class="context-menu-item" onclick="openSplitScreen('sales-history-page')">
                <i data-lucide="receipt" style="width: 16px; height: 16px;"></i>
                <span>Sales History</span>
            </div>
            <div class="context-menu-item" onclick="openSplitScreen('inventory-page')">
                <i data-lucide="package" style="width: 16px; height: 16px;"></i>
                <span>Product Catalog</span>
            </div>
            <div class="context-menu-item" onclick="openSplitScreen('deductions-page')">
                <i data-lucide="minus-circle" style="width: 16px; height: 16px;"></i>
                <span>Fixed Deductions</span>
            </div>
            <div class="context-menu-item" onclick="openSplitScreen('chartsPage')">
                <i data-lucide="bar-chart-2" style="width: 16px; height: 16px;"></i>
                <span>Charts</span>
            </div>
            <div class="context-menu-item" onclick="openSplitScreen('AI-page')">
                <i data-lucide="sparkles" style="width: 16px; height: 16px;"></i>
                <span>AI Assistant</span>
            </div>
            <div class="context-menu-item" onclick="openSplitScreen('Clients')">
                <i data-lucide="users" style="width: 16px; height: 16px;"></i>
                <span>Clients & Accounts</span>
            </div>
            <div class="context-menu-item" onclick="openSplitScreen('warehouse-page')">
                <i data-lucide="warehouse" style="width: 16px; height: 16px;"></i>
                <span>Warehouse Management</span>
            </div>
            <div class="context-menu-item" onclick="openSplitScreen('goals-page')">
                <i data-lucide="target" style="width: 16px; height: 16px;"></i>
                <span>Goals</span>
            </div>
            <div class="menu-divider"></div>
            <div class="context-menu-item" onclick="closeSplitScreen()" style="color: #ef4444;">
                <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                <span>Close Split Screen</span>
            </div>
        </div>
    `;
    document.body.appendChild(menu);
    return menu;
}

// Initialize Split Screen
function initializeSplitScreen() {
    // Add right-click event listeners to nav buttons
    document.querySelectorAll('.nav-button').forEach(button => {
        button.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            showSplitContextMenu(e, button);
        });
    });
    
    // Create the split screen container
    const splitContainer = document.createElement('div');
    splitContainer.id = 'split-screen-container';
    splitContainer.style.display = 'none';
    splitContainer.innerHTML = `
        <div class="split-panel" id="split-left-panel">
            <div class="split-panel-header">
                <span class="split-panel-title">Main View</span>
                <button class="split-panel-close" onclick="closeLeftPanel()">
                    <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                </button>
            </div>
            <div class="split-panel-content" id="left-panel-content"></div>
        </div>
        <div class="split-divider" id="split-divider">
            <div class="split-divider-handle"></div>
        </div>
        <div class="split-panel" id="split-right-panel">
            <div class="split-panel-header">
                <span class="split-panel-title">Split View</span>
                <button class="split-panel-close" onclick="closeRightPanel()">
                    <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                </button>
            </div>
            <div class="split-panel-content" id="right-panel-content"></div>
        </div>
    `;
    document.body.appendChild(splitContainer);
    
    // Initialize resize functionality
    initializeSplitResize();
}

// Show Split Context Menu
function showSplitContextMenu(e, button) {
    // Hide any existing context menus
    hideAllContextMenus();
    
    let menu = document.getElementById('split-context-menu');
    if (!menu) {
        menu = createSplitContextMenu();
    }
    
    // Position menu
    menu.style.left = e.pageX + 'px';
    menu.style.top = e.pageY + 'px';
    menu.classList.add('active');
    
    // Store current button for reference
    splitScreenState.currentButton = button;
    
    // Hide menu when clicking outside
    setTimeout(() => {
        document.addEventListener('click', hideSplitContextMenu, { once: true });
    }, 100);
}

// Hide Split Context Menu
function hideSplitContextMenu() {
    const menu = document.getElementById('split-context-menu');
    if (menu) {
        menu.classList.remove('active');
    }
}

// Hide All Context Menus
function hideAllContextMenus() {
    hideSplitContextMenu();
    const cardMenu = document.getElementById('card-context-menu');
    if (cardMenu) {
        cardMenu.classList.remove('active');
    }
}

// Open Split Screen
function openSplitScreen(targetPageId) {
    const currentPage = document.querySelector('.page.active');
    const currentPageId = currentPage ? currentPage.id : 'dashboard-page';
    
    splitScreenState.isActive = true;
    splitScreenState.leftPage = currentPageId;
    splitScreenState.rightPage = targetPageId;
    
    // Hide main content and show split container
    document.getElementById('main').style.display = 'none';
    document.getElementById('split-screen-container').style.display = 'flex';
    
    // Clone and display pages
    displaySplitPages(currentPageId, targetPageId);
    
    // Update panel titles
    updatePanelTitles(currentPageId, targetPageId);
    
    // Hide context menu
    hideSplitContextMenu();
    
    // Initialize page-specific functionality
    setTimeout(() => {
        initializeSplitPageFunctionality(targetPageId);
    }, 100);
}

// Display Split Pages
function displaySplitPages(leftPageId, rightPageId) {
    const leftContent = document.getElementById('left-panel-content');
    const rightContent = document.getElementById('right-panel-content');
    
    // Clone the left page
    const leftPage = document.getElementById(leftPageId);
    if (leftPage && leftContent) {
        leftContent.innerHTML = leftPage.outerHTML;
    }
    
    // Clone the right page
    const rightPage = document.getElementById(rightPageId);
    if (rightPage && rightContent) {
        rightContent.innerHTML = rightPage.outerHTML;
        // Make the cloned page active
        const clonedRightPage = rightContent.querySelector('.page');
        if (clonedRightPage) {
            clonedRightPage.classList.add('active');
        }
    }
}

// Update Panel Titles
function updatePanelTitles(leftPageId, rightPageId) {
    const leftTitle = document.querySelector('#split-left-panel .split-panel-title');
    const rightTitle = document.querySelector('#split-right-panel .split-panel-title');
    
    const pageNames = {
        'dashboard-page': 'Dashboard',
        'sales-history-page': 'Sales History',
        'inventory-page': 'Product Catalog',
        'deductions-page': 'Fixed Deductions',
        'chartsPage': 'Charts',
        'AI-page': 'AI Assistant',
        'Clients': 'Clients & Accounts',
        'warehouse-page': 'Warehouse Management',
        'goals-page': 'Goals',
        'reports-page': 'Reports',
        'settings-page': 'Settings'
    };
    
    if (leftTitle) leftTitle.textContent = pageNames[leftPageId] || 'Main View';
    if (rightTitle) rightTitle.textContent = pageNames[rightPageId] || 'Split View';
}

// Initialize Split Page Functionality
function initializeSplitPageFunctionality(pageId) {
    const rightPanel = document.getElementById('right-panel-content');
    if (!rightPanel) return;
    
    // Re-initialize page-specific functionality
    switch(pageId) {
        case 'chartsPage':
        case 'pie-page-chart':
        case 'lineChart':
        case 'deductions-chart-page':
        case 'advanced-charts':
            setTimeout(() => {
                if (typeof renderCharts === 'function') renderCharts();
                if (typeof renderDeductionsChart === 'function') renderDeductionsChart();
                if (typeof renderMonthlyTrendsChart === 'function') renderMonthlyTrendsChart();
                if (typeof renderAdvancedCharts === 'function') renderAdvancedCharts();
            }, 200);
            break;
            
        case 'inventory-page':
            setTimeout(() => {
                if (typeof renderProductCatalog === 'function') renderProductCatalog();
                if (typeof renderInventoryPage === 'function') renderInventoryPage();
            }, 200);
            break;
            
        case 'sales-history-page':
            setTimeout(() => {
                if (typeof renderSalesHistory === 'function') renderSalesHistory();
            }, 200);
            break;
            
        case 'deductions-page':
            setTimeout(() => {
                if (typeof renderDeductions === 'function') renderDeductions();
                if (typeof renderEmployees === 'function') renderEmployees();
            }, 200);
            break;
            
        case 'AI-page':
            setTimeout(() => {
                if (typeof initializeChatApp === 'function') initializeChatApp();
            }, 200);
            break;
    }
    
    // Re-create Lucide icons
    setTimeout(() => {
        if (window.lucide) {
            lucide.createIcons();
        }
    }, 300);
}

// Close Split Screen
function closeSplitScreen() {
    splitScreenState.isActive = false;
    
    // Show main content and hide split container
    document.getElementById('main').style.display = 'block';
    document.getElementById('split-screen-container').style.display = 'none';
    
    // Clear split panel contents
    const leftContent = document.getElementById('left-panel-content');
    const rightContent = document.getElementById('right-panel-content');
    if (leftContent) leftContent.innerHTML = '';
    if (rightContent) rightContent.innerHTML = '';
}

// Close Left Panel (returns to normal view)
function closeLeftPanel() {
    const rightPageId = splitScreenState.rightPage;
    if (rightPageId) {
        showPage(rightPageId);
    }
    closeSplitScreen();
}

// Close Right Panel (keeps left panel as main view)
function closeRightPanel() {
    const leftPageId = splitScreenState.leftPage;
    if (leftPageId) {
        showPage(leftPageId);
    }
    closeSplitScreen();
}

// Initialize Split Resize
function initializeSplitResize() {
    const divider = document.getElementById('split-divider');
    const container = document.getElementById('split-screen-container');
    const leftPanel = document.getElementById('split-left-panel');
    const rightPanel = document.getElementById('split-right-panel');
    
    if (!divider || !container) return;
    
    let isResizing = false;
    let startX = 0;
    let startLeftWidth = 0;
    
    const handle = divider.querySelector('.split-divider-handle');
    if (handle) {
        handle.addEventListener('mousedown', (e) => {
            isResizing = true;
            startX = e.clientX;
            startLeftWidth = leftPanel.offsetWidth;
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        });
    }
    
    document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const deltaX = e.clientX - startX;
        const containerWidth = container.offsetWidth;
        const newLeftWidth = startLeftWidth + deltaX;
        const newRightWidth = containerWidth - newLeftWidth - divider.offsetWidth;
        
        // Minimum widths
        if (newLeftWidth >= 300 && newRightWidth >= 300) {
            leftPanel.style.width = newLeftWidth + 'px';
            rightPanel.style.width = newRightWidth + 'px';
        }
    });
    
    document.addEventListener('mouseup', () => {
        if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        }
    });
}

// Add keyboard shortcut for split screen (Ctrl/Cmd + S)
document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        if (splitScreenState.isActive) {
            closeSplitScreen();
        } else {
            // Default split with dashboard and AI
            openSplitScreen('AI-page');
        }
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        initializeSplitScreen();
    }, 1000);
});
// Add these functions to your existing JavaScript

// Enhanced AI Lab Tools
function renderEnhancedAILabTools() {
    const toolsContainer = document.createElement('div');
    toolsContainer.className = 'ai-lab-tools-container';
    toolsContainer.innerHTML = `
        <div class="ai-tools-grid">
            <div class="ai-tool-card" onclick="openCashFlowAnalyzer()">
                <div class="ai-tool-icon">
                    <i data-lucide="trending-up"></i>
                </div>
                <h3>Cash Flow Analyzer</h3>
                <p>Analyze your cash flow patterns and identify potential issues</p>
            </div>
            
            <div class="ai-tool-card" onclick="openInventoryOptimizer()">
                <div class="ai-tool-icon">
                    <i data-lucide="package"></i>
                </div>
                <h3>Inventory Optimizer</h3>
                <p>Get AI recommendations for optimal inventory levels</p>
            </div>
            
            <div class="ai-tool-card" onclick="openSalesPatternAnalyzer()">
                <div class="ai-tool-icon">
                    <i data-lucide="bar-chart-3"></i>
                </div>
                <h3>Sales Pattern Analyzer</h3>
                <p>Discover patterns in your sales data</p>
            </div>
            
            <div class="ai-tool-card" onclick="openCustomerSegmentation()">
                <div class="ai-tool-icon">
                    <i data-lucide="users"></i>
                </div>
                <h3>Customer Segmentation</h3>
                <p>Identify customer groups and their behaviors</p>
            </div>
            
            <div class="ai-tool-card" onclick="openDemandForecasting()">
                <div class="ai-tool-icon">
                    <i data-lucide="calendar"></i>
                </div>
                <h3>Demand Forecasting</h3>
                <p>Predict future demand for your products</p>
            </div>
            
            <div class="ai-tool-card" onclick="openWarehouseMapView()">
                <div class="ai-tool-icon">
                    <i data-lucide="map"></i>
                </div>
                <h3>Warehouse Map View</h3>
                <p>Visualize your warehouse locations and inventory</p>
            </div>
        </div>
    `;
    
    const labPage = document.getElementById('lab-page');
    if (labPage) {
        const existingTools = labPage.querySelector('.ai-lab-tools-container');
        if (existingTools) {
            existingTools.replaceWith(toolsContainer);
        } else {
            labPage.appendChild(toolsContainer);
        }
    }
    
    // Initialize Lucide icons
    setTimeout(() => {
        lucide.createIcons();
    }, 100);
}

// Add these CSS styles to your existing CSS
const aiLabStyles = `
.ai-lab-tools-container {
    margin-top: 24px;
}

.ai-tools-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.ai-tool-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border-left: 4px solid var(--color-primary);
    transition: all 0.3s ease;
    cursor: pointer;
}

.ai-tool-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
}

.ai-tool-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(59, 130, 246, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 15px;
}

.ai-tool-icon svg {
    color: var(--color-primary);
    width: 24px;
    height: 24px;
}

.ai-tool-card h3 {
    margin: 0 0 10px 0;
    font-size: 18px;
    color: var(--color-text-dark);
}

.ai-tool-card p {
    margin: 0;
    color: var(--color-text-medium);
    font-size: 14px;
    line-height: 1.4;
}
`;

// Add the styles to the document
const styleElement = document.createElement('style');
styleElement.textContent = aiLabStyles;
document.head.appendChild(styleElement);

// Warehouse Map View
function openWarehouseMapView() {
    const modal = document.createElement('dialog');
    modal.id = 'warehouse-map-dialog';
    modal.className = 'warehouse-map-dialog';
    modal.innerHTML = `
        <div class="modal-header">
            <h3>Warehouse Map View</h3>
            <button class="close-button" onclick="this.closest('dialog').close()">&times;</button>
        </div>
        <div class="warehouse-map-content">
            <div class="map-controls">
                <button onclick="showTransferHistory()" class="button button-secondary">
                    <i data-lucide="history" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                    Transfer History
                </button>
                <button onclick="addNewWarehouseLocation()" class="button button-primary">
                    <i data-lucide="map-pin" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                    Add Warehouse Location
                </button>
            </div>
            <div id="warehouse-map" class="warehouse-map"></div>
            <div id="warehouse-details" class="warehouse-details-panel">
                <h4>Warehouse Details</h4>
                <div id="selected-warehouse-info">
                    <p>Click on a warehouse marker to view details</p>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.showModal();
    
    // Initialize the map
    setTimeout(() => {
        initializeWarehouseMap();
        lucide.createIcons();
    }, 100);
}

// Initialize warehouse map
function initializeWarehouseMap() {
    const mapContainer = document.getElementById('warehouse-map');
    if (!mapContainer) return;
    
    // Create a simple map using divs and absolute positioning
    // In a real implementation, you would use a mapping library like Leaflet or Google Maps
    mapContainer.innerHTML = `
        <div class="simple-map">
            <div class="map-background"></div>
            <div class="map-legend">
                <div class="legend-item">
                    <div class="legend-marker high-stock"></div>
                    <span>High Stock</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker medium-stock"></div>
                    <span>Medium Stock</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker low-stock"></div>
                    <span>Low Stock</span>
                </div>
            </div>
        </div>
    `;
    
    // Add warehouse markers
    const mapBackground = mapContainer.querySelector('.map-background');
    if (mapBackground) {
        warehouses.forEach(warehouse => {
            const totalStock = warehouse.products.reduce((sum, productName) => {
                const product = productCatalog[productName];
                return sum + (product ? product.stock : 0);
            }, 0);
            
            const utilizationPercent = warehouse.capacity > 0 ? (totalStock / warehouse.capacity) * 100 : 0;
            
            let stockLevel = 'high-stock';
            if (utilizationPercent < 30) stockLevel = 'low-stock';
            else if (utilizationPercent < 70) stockLevel = 'medium-stock';
            
            // Generate random positions for demo purposes
            // In a real implementation, you would use actual coordinates
            const left = 10 + Math.random() * 80;
            const top = 10 + Math.random() * 80;
            
            const marker = document.createElement('div');
            marker.className = `warehouse-marker ${stockLevel}`;
            marker.style.left = `${left}%`;
            marker.style.top = `${top}%`;
            marker.innerHTML = `
                <div class="marker-icon">
                    <i data-lucide="home"></i>
                </div>
                <div class="marker-label">${warehouse.name}</div>
            `;
            
            marker.addEventListener('click', () => showWarehouseDetails(warehouse));
            mapBackground.appendChild(marker);
        });
    }
    
    // Initialize Lucide icons
    lucide.createIcons();
}

// Show warehouse details
function showWarehouseDetails(warehouse) {
    const detailsContainer = document.getElementById('selected-warehouse-info');
    if (!detailsContainer) return;
    
    const totalStock = warehouse.products.reduce((sum, productName) => {
        const product = productCatalog[productName];
        return sum + (product ? product.stock : 0);
    }, 0);
    
    const utilizationPercent = warehouse.capacity > 0 ? (totalStock / warehouse.capacity) * 100 : 0;
    const client = warehouse.clientId ? clients.find(c => c.id === warehouse.clientId) : null;
    
    detailsContainer.innerHTML = `
        <div class="warehouse-detail-item">
            <h5>${warehouse.name}</h5>
            <p>${warehouse.address}</p>
        </div>
        <div class="warehouse-detail-item">
            <span class="detail-label">Capacity:</span>
            <span class="detail-value">${warehouse.capacity} units</span>
        </div>
        <div class="warehouse-detail-item">
            <span class="detail-label">Current Stock:</span>
            <span class="detail-value">${totalStock} units</span>
        </div>
        <div class="warehouse-detail-item">
            <span class="detail-label">Utilization:</span>
            <span class="detail-value">${utilizationPercent.toFixed(1)}%</span>
        </div>
        <div class="warehouse-detail-item">
            <span class="detail-label">Linked Client:</span>
            <span class="detail-value">${client ? client.name : 'None'}</span>
        </div>
        <div class="warehouse-detail-actions">
            <button onclick="editWarehouse('${warehouse.id}')" class="button button-primary" style="width: auto; padding: 8px 16px; font-size: 14px;">
                <i data-lucide="edit" style="width: 14px; height: 14px; margin-right: 6px;"></i>
                Edit
            </button>
            <button onclick="initiateTransferFrom('${warehouse.id}')" class="button button-secondary" style="width: auto; padding: 8px 16px; font-size: 14px;">
                <i data-lucide="truck" style="width: 14px; height: 14px; margin-right: 6px;"></i>
                Transfer From
            </button>
        </div>
    `;
    
    // Initialize Lucide icons
    lucide.createIcons();
}

// Show transfer history
function showTransferHistory() {
    const modal = document.createElement('dialog');
    modal.id = 'transfer-history-dialog';
    modal.className = 'transfer-history-dialog';
    modal.innerHTML = `
        <div class="modal-header">
            <h3>Inventory Transfer History</h3>
            <button class="close-button" onclick="this.closest('dialog').close()">&times;</button>
        </div>
        <div class="transfer-history-content">
            <div class="transfer-filters">
                <div class="filter-group">
                    <label for="transfer-from-filter">From Warehouse:</label>
                    <select id="transfer-from-filter" class="form-input">
                        <option value="">All Warehouses</option>
                        ${warehouses.map(w => `<option value="${w.id}">${w.name}</option>`).join('')}
                    </select>
                </div>
                <div class="filter-group">
                    <label for="transfer-to-filter">To Warehouse:</label>
                    <select id="transfer-to-filter" class="form-input">
                        <option value="">All Warehouses</option>
                        ${warehouses.map(w => `<option value="${w.id}">${w.name}</option>`).join('')}
                    </select>
                </div>
                <div class="filter-group">
                    <label for="transfer-product-filter">Product:</label>
                    <select id="transfer-product-filter" class="form-input">
                        <option value="">All Products</option>
                        ${Object.keys(productCatalog).map(p => `<option value="${p}">${p}</option>`).join('')}
                    </select>
                </div>
                <button onclick="filterTransferHistory()" class="button button-primary">Apply Filters</button>
            </div>
            <div class="transfer-history-list" id="transfer-history-list">
                <!-- Transfer history will be populated here -->
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.showModal();
    
    // Load transfer history
    loadTransferHistory();
    
    // Initialize Lucide icons
    setTimeout(() => {
        lucide.createIcons();
    }, 100);
}

// Load transfer history
function loadTransferHistory() {
    const transferHistoryList = document.getElementById('transfer-history-list');
    if (!transferHistoryList) return;
    
    // Get transfer history from localStorage
    const savedHistory = localStorage.getItem('epsilon_transfer_history');
    let history = [];
    
    if (savedHistory) {
        try {
            history = JSON.parse(savedHistory);
        } catch (e) {
            console.error('Failed to parse transfer history:', e);
            history = [];
        }
    }
    
    if (history.length === 0) {
        transferHistoryList.innerHTML = '<p class="no-transfers">No transfer history available</p>';
        return;
    }
    
    // Sort by date (newest first)
    history.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Render transfer history
    transferHistoryList.innerHTML = history.map(transfer => {
        const fromWarehouse = warehouses.find(w => w.id === transfer.fromWarehouseId);
        const toWarehouse = warehouses.find(w => w.id === transfer.toWarehouseId);
        const product = productCatalog[transfer.productId];
        
        return `
            <div class="transfer-item">
                <div class="transfer-date">${new Date(transfer.date).toLocaleString()}</div>
                <div class="transfer-details">
                    <div class="transfer-route">
                        <span class="warehouse-name">${fromWarehouse ? fromWarehouse.name : 'Unknown'}</span>
                        <i data-lucide="arrow-right" style="width: 16px; height: 16px; margin: 0 8px;"></i>
                        <span class="warehouse-name">${toWarehouse ? toWarehouse.name : 'Unknown'}</span>
                    </div>
                    <div class="transfer-product">
                        <span class="product-name">${product ? product.name : 'Unknown Product'}</span>
                        <span class="transfer-quantity">${transfer.quantity} units</span>
                    </div>
                </div>
                <div class="transfer-status ${transfer.status}">
                    ${transfer.status === 'completed' ? 'Completed' : 'Pending'}
                </div>
            </div>
        `;
    }).join('');
    
    // Initialize Lucide icons
    lucide.createIcons();
}

// Filter transfer history
function filterTransferHistory() {
    const fromFilter = document.getElementById('transfer-from-filter').value;
    const toFilter = document.getElementById('transfer-to-filter').value;
    const productFilter = document.getElementById('transfer-product-filter').value;
    
    // Get transfer history from localStorage
    const savedHistory = localStorage.getItem('epsilon_transfer_history');
    let history = [];
    
    if (savedHistory) {
        try {
            history = JSON.parse(savedHistory);
        } catch (e) {
            console.error('Failed to parse transfer history:', e);
            history = [];
        }
    }
    
    // Apply filters
    let filteredHistory = history;
    
    if (fromFilter) {
        filteredHistory = filteredHistory.filter(t => t.fromWarehouseId === fromFilter);
    }
    
    if (toFilter) {
        filteredHistory = filteredHistory.filter(t => t.toWarehouseId === toFilter);
    }
    
    if (productFilter) {
        filteredHistory = filteredHistory.filter(t => t.productId === productFilter);
    }
    
    // Re-render the filtered history
    const transferHistoryList = document.getElementById('transfer-history-list');
    if (!transferHistoryList) return;
    
    if (filteredHistory.length === 0) {
        transferHistoryList.innerHTML = '<p class="no-transfers">No transfers match the selected filters</p>';
        return;
    }
    
    // Sort by date (newest first)
    filteredHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Render filtered transfer history
    transferHistoryList.innerHTML = filteredHistory.map(transfer => {
        const fromWarehouse = warehouses.find(w => w.id === transfer.fromWarehouseId);
        const toWarehouse = warehouses.find(w => w.id === transfer.toWarehouseId);
        const product = productCatalog[transfer.productId];
        
        return `
            <div class="transfer-item">
                <div class="transfer-date">${new Date(transfer.date).toLocaleString()}</div>
                <div class="transfer-details">
                    <div class="transfer-route">
                        <span class="warehouse-name">${fromWarehouse ? fromWarehouse.name : 'Unknown'}</span>
                        <i data-lucide="arrow-right" style="width: 16px; height: 16px; margin: 0 8px;"></i>
                        <span class="warehouse-name">${toWarehouse ? toWarehouse.name : 'Unknown'}</span>
                    </div>
                    <div class="transfer-product">
                        <span class="product-name">${product ? product.name : 'Unknown Product'}</span>
                        <span class="transfer-quantity">${transfer.quantity} units</span>
                    </div>
                </div>
                <div class="transfer-status ${transfer.status}">
                    ${transfer.status === 'completed' ? 'Completed' : 'Pending'}
                </div>
            </div>
        `;
    }).join('');
    
    // Initialize Lucide icons
    lucide.createIcons();
}

// Save transfer to history
function saveTransferToHistory(fromWarehouseId, toWarehouseId, productId, quantity, status = 'completed') {
    // Get existing transfer history
    const savedHistory = localStorage.getItem('epsilon_transfer_history');
    let history = [];
    
    if (savedHistory) {
        try {
            history = JSON.parse(savedHistory);
        } catch (e) {
            console.error('Failed to parse transfer history:', e);
            history = [];
        }
    }
    
    // Add new transfer
    const newTransfer = {
        id: generateId(),
        fromWarehouseId,
        toWarehouseId,
        productId,
        quantity,
        status,
        date: new Date().toISOString()
    };
    
    history.push(newTransfer);
    
    // Save updated history
    localStorage.setItem('epsilon_transfer_history', JSON.stringify(history));
}

// Add these CSS styles for the warehouse map and transfer history
const warehouseMapStyles = `
.warehouse-map-dialog {
    width: 90vw;
    max-width: 1200px;
    height: 80vh;
    max-height: 800px;
}

.warehouse-map-content {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.map-controls {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
}

.warehouse-map {
    flex-grow: 1;
    border: 1px solid var(--color-border-light);
    border-radius: 8px;
    position: relative;
    overflow: hidden;
}

.simple-map {
    width: 100%;
    height: 100%;
    background-color: #f0f8ff;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f0f8ff" /><path d="M0,0 L100,0 L100,100 L0,100 Z" fill="none" stroke="%23e0e0e0" stroke-width="0.5" /><path d="M0,50 L100,50 M50,0 L50,100" fill="none" stroke="%23e0e0e0" stroke-width="0.5" /></svg>');
    background-size: 100px 100px;
    position: relative;
}

.map-legend {
    position: absolute;
    bottom: 20px;
    right: 20px;
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.legend-item:last-child {
    margin-bottom: 0;
}

.legend-marker {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    margin-right: 10px;
}

.high-stock {
    background-color: #10b981;
}

.medium-stock {
    background-color: #f59e0b;
}

.low-stock {
    background-color: #ef4444;
}

.warehouse-marker {
    position: absolute;
    transform: translate(-50%, -50%);
    cursor: pointer;
    z-index: 10;
}

.marker-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    border: 2px solid;
}

.warehouse-marker.high-stock .marker-icon {
    border-color: #10b981;
}

.warehouse-marker.medium-stock .marker-icon {
    border-color: #f59e0b;
}

.warehouse-marker.low-stock .marker-icon {
    border-color: #ef4444;
}

.marker-label {
    position: absolute;
    bottom: -25px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.warehouse-details-panel {
    width: 300px;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    overflow-y: auto;
}

.warehouse-detail-item {
    margin-bottom: 15px;
}

.warehouse-detail-item h5 {
    margin: 0 0 5px 0;
    font-size: 18px;
    color: var(--color-text-dark);
}

.warehouse-detail-item p {
    margin: 0;
    color: var(--color-text-medium);
    font-size: 14px;
}

.detail-label {
    font-weight: 600;
    color: var(--color-text-dark);
}

.detail-value {
    margin-left: 10px;
    color: var(--color-text-medium);
}

.warehouse-detail-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.transfer-history-dialog {
    width: 90vw;
    max-width: 1000px;
    height: 80vh;
    max-height: 800px;
}

.transfer-history-content {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.transfer-filters {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background: #f9fafb;
    border-radius: 8px;
}

.filter-group {
    display: flex;
    flex-direction: column;
    flex: 1;
}

.filter-group label {
    margin-bottom: 5px;
    font-weight: 600;
    font-size: 14px;
}

.transfer-history-list {
    flex-grow: 1;
    overflow-y: auto;
    border: 1px solid var(--color-border-light);
    border-radius: 8px;
    padding: 15px;
}

.transfer-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid var(--color-border-light);
}

.transfer-item:last-child {
    border-bottom: none;
}

.transfer-date {
    font-size: 12px;
    color: var(--color-text-medium);
    min-width: 150px;
}

.transfer-details {
    flex-grow: 1;
}

.transfer-route {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
}

.warehouse-name {
    font-weight: 600;
    color: var(--color-text-dark);
}

.transfer-product {
    display: flex;
    justify-content: space-between;
}

.product-name {
    color: var(--color-text-medium);
}

.transfer-quantity {
    font-weight: 600;
    color: var(--color-primary);
}

.transfer-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    min-width: 80px;
    text-align: center;
}

.transfer-status.completed {
    background-color: #d1fae5;
    color: #065f46;
}

.transfer-status.pending {
    background-color: #fef3c7;
    color: #92400e;
}

.no-transfers {
    text-align: center;
    color: var(--color-text-medium);
    padding: 20px;
    font-style: italic;
}
`;

// Add the styles to the document
const warehouseMapStyleElement = document.createElement('style');
warehouseMapStyleElement.textContent = warehouseMapStyles;
document.head.appendChild(warehouseMapStyleElement);

// Modify the executeTransfer function to save transfer history
const originalExecuteTransfer = window.executeTransfer;
window.executeTransfer = function() {
    // Call the original function
    originalExecuteTransfer();
    
    // Get transfer details
    const fromWarehouseId = document.getElementById('transfer-from').value;
    const toWarehouseId = document.getElementById('transfer-to').value;
    const productId = document.getElementById('transfer-product').value;
    const quantity = parseInt(document.getElementById('transfer-quantity').value);
    
    // Save to transfer history
    if (fromWarehouseId && toWarehouseId && productId && quantity > 0) {
        saveTransferToHistory(fromWarehouseId, toWarehouseId, productId, quantity);
    }
};

// Add new warehouse location
function addNewWarehouseLocation() {
    const modal = document.createElement('dialog');
    modal.id = 'add-warehouse-location-dialog';
    modal.className = 'add-warehouse-location-dialog';
    modal.innerHTML = `
        <div class="modal-header">
            <h3>Add Warehouse Location</h3>
            <button class="close-button" onclick="this.closest('dialog').close()">&times;</button>
        </div>
        <div class="form-box">
            <div class="form-group">
                <label for="warehouse-location-name" class="form-label">Warehouse Name</label>
                <input type="text" id="warehouse-location-name" class="form-input" placeholder="e.g., Main Storage">
            </div>
            <div class="form-group">
                <label for="warehouse-location-address" class="form-label">Address</label>
                <input type="text" id="warehouse-location-address" class="form-input" placeholder="e.g., 123 Storage St, City">
            </div>
            <div class="form-group">
                <label for="warehouse-location-lat" class="form-label">Latitude</label>
                <input type="number" id="warehouse-location-lat" class="form-input" placeholder="e.g., 40.7128" step="0.0001">
            </div>
            <div class="form-group">
                <label for="warehouse-location-lng" class="form-label">Longitude</label>
                <input type="number" id="warehouse-location-lng" class="form-input" placeholder="e.g., -74.0060" step="0.0001">
            </div>
            <div class="form-group">
                <label for="warehouse-location-capacity" class="form-label">Capacity (units)</label>
                <input type="number" id="warehouse-location-capacity" class="form-input" placeholder="e.g., 1000">
            </div>
            <button onclick="saveWarehouseLocation()" class="button button-primary">Save Location</button>
            <button onclick="this.closest('dialog').close()" class="button button-danger">Cancel</button>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.showModal();
}

// Save warehouse location
function saveWarehouseLocation() {
    const name = document.getElementById('warehouse-location-name').value.trim();
    const address = document.getElementById('warehouse-location-address').value.trim();
    const lat = parseFloat(document.getElementById('warehouse-location-lat').value);
    const lng = parseFloat(document.getElementById('warehouse-location-lng').value);
    const capacity = parseInt(document.getElementById('warehouse-location-capacity').value);
    
    if (!name || !address || isNaN(lat) || isNaN(lng) || isNaN(capacity) || capacity <= 0) {
        showMessage('Please fill all fields with valid values', 'error');
        return;
    }
    
    const newWarehouse = {
        id: generateId(),
        name,
        address,
        lat,
        lng,
        capacity,
        products: [],
        createdAt: new Date().toISOString()
    };
    
    warehouses.push(newWarehouse);
    saveData();
    
    document.getElementById('add-warehouse-location-dialog').close();
    showMessage('Warehouse location added successfully!', 'success');
    
    // Refresh the warehouse map if it's open
    const warehouseMapDialog = document.getElementById('warehouse-map-dialog');
    if (warehouseMapDialog && warehouseMapDialog.open) {
        initializeWarehouseMap();
    }
}

// AI Lab Tool Functions
function collectBusinessDataForAI() {
    const businessData = {
        products: productCatalog || {},
        services: typeof services !== 'undefined' ? services : [],
        employees: typeof employees !== 'undefined' ? employees : [],
        assets: typeof assets !== 'undefined' ? assets : [],
        warehouses: typeof warehouses !== 'undefined' ? warehouses : [],
        deductions: typeof fixedDeductions !== 'undefined' ? fixedDeductions : [],
        salesHistory: typeof salesHistory !== 'undefined' ? salesHistory : [],
        expenses: typeof expenses !== 'undefined' ? expenses : [],
        postedProducts: typeof postedProducts !== 'undefined' ? postedProducts : [],
        orders: typeof orders !== 'undefined' ? orders : [],
        customers: typeof customers !== 'undefined' ? customers : []
    };
    return businessData;
}

function openCashFlowAnalyzer() {
    const businessData = collectBusinessDataForAI();
    
    const modal = document.createElement('dialog');
    modal.id = 'cash-flow-analyzer-dialog';
    modal.className = 'ai-tool-dialog';
    modal.innerHTML = `
        <div class="modal-header">
            <h3>Cash Flow Analyzer</h3>
            <button class="close-button" onclick="this.closest('dialog').close()">&times;</button>
        </div>
        <div class="ai-tool-content">
            <div class="form-box">
                <h4>Cash Flow Analysis</h4>
                <p>Analyzing your cash flow patterns, sales, expenses, employees, and inventory data...</p>
                <div id="cash-flow-results" class="analysis-results">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.showModal();
    
    // Simulate AI analysis with comprehensive data
    setTimeout(() => {
        analyzeCashFlow(businessData);
    }, 1000);
}

function analyzeCashFlow(businessData) {
    const { totalRevenue, totalFixedDeductions, netProfitLoss } = calculateFinancials();
    
    const dataContext = businessData || collectBusinessDataForAI();
    
    // Calculate monthly averages
    const monthlyRevenue = totalRevenue / 12;
    const monthlyExpenses = totalFixedDeductions / 12;
    const monthlyProfit = netProfitLoss / 12;
    
    // Generate insights
    const insights = [];
    
    if (netProfitLoss < 0) {
        insights.push({
            type: 'warning',
            icon: 'alert-triangle',
            text: 'Your business is currently operating at a loss. Consider reducing expenses or increasing revenue.'
        });
    } else if (monthlyProfit < monthlyRevenue * 0.1) {
        insights.push({
            type: 'info',
            icon: 'info',
            text: 'Your profit margin is below 10%. Look for ways to increase profitability.'
        });
    } else {
        insights.push({
            type: 'success',
            icon: 'check-circle',
            text: 'Your business has a healthy profit margin. Keep up the good work!'
        });
    }
    
    // Cash flow projection
    const projection = [];
    let runningCash = monthlyRevenue - monthlyExpenses;
    
    for (let i = 1; i <= 6; i++) {
        projection.push({
            month: i,
            cashFlow: runningCash,
            cumulative: runningCash * i
        });
    }
    
    // Render results
    const resultsContainer = document.getElementById('cash-flow-results');
    resultsContainer.innerHTML = `
        <div class="cash-flow-summary">
            <div class="summary-item">
                <span class="summary-label">Monthly Revenue:</span>
                <span class="summary-value">${formatAmount(monthlyRevenue)}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Monthly Expenses:</span>
                <span class="summary-value">${formatAmount(monthlyExpenses)}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Monthly Profit:</span>
                <span class="summary-value ${monthlyProfit >= 0 ? 'positive' : 'negative'}">${formatAmount(monthlyProfit)}</span>
            </div>
        </div>
        
        <div class="cash-flow-insights">
            <h5>AI Insights:</h5>
            ${insights.map(insight => `
                <div class="insight-item ${insight.type}">
                    <i data-lucide="${insight.icon}"></i>
                    <span>${insight.text}</span>
                </div>
            `).join('')}
        </div>
        
        <div class="cash-flow-projection">
            <h5>6-Month Cash Flow Projection:</h5>
            <div class="projection-chart">
                ${projection.map(item => `
                    <div class="projection-item">
                        <div class="projection-month">Month ${item.month}</div>
                        <div class="projection-value ${item.cashFlow >= 0 ? 'positive' : 'negative'}">${formatAmount(item.cashFlow)}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    // Initialize Lucide icons
    lucide.createIcons();
}

function openInventoryOptimizer() {
    const businessData = collectBusinessDataForAI();
    
    const modal = document.createElement('dialog');
    modal.id = 'inventory-optimizer-dialog';
    modal.className = 'ai-tool-dialog';
    modal.innerHTML = `
        <div class="modal-header">
            <h3>Inventory Optimizer</h3>
            <button class="close-button" onclick="this.closest('dialog').close()">&times;</button>
        </div>
        <div class="ai-tool-content">
            <div class="form-box">
                <h4>Inventory Optimization Analysis</h4>
                <p>Analyzing your inventory data, warehouses, sales history, and products...</p>
                <div id="inventory-optimizer-results" class="analysis-results">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.showModal();
    
    // Simulate AI analysis with comprehensive data
    setTimeout(() => {
        optimizeInventory(businessData);
    }, 1000);
}

function optimizeInventory(businessData) {
    const dataContext = businessData || collectBusinessDataForAI();
    const productAnalysis = [];
    
    // Analyze each product
    Object.keys(productCatalog).forEach(productName => {
        const product = productCatalog[productName];
        const stock = product.stock || 0;
        const reorderPoint = product.reorderPoint || 5;
        
        // Calculate days of inventory (assuming average daily sales)
        const sales = salesHistory.filter(s => s.product === productName);
        const totalSold = sales.reduce((sum, s) => sum + s.quantity, 0);
        const daysWithSales = sales.length || 1;
        const avgDailySales = totalSold / daysWithSales;
        const daysOfInventory = avgDailySales > 0 ? stock / avgDailySales : 999;
        
        // Determine status
        let status = 'optimal';
        let recommendation = '';
        
        if (stock === 0) {
            status = 'out-of-stock';
            recommendation = 'Immediate restocking required';
        } else if (stock <= reorderPoint) {
            status = 'low-stock';
            recommendation = `Order ${reorderPoint * 2 - stock} units to reach optimal level`;
        } else if (daysOfInventory > 90) {
            status = 'overstock';
            recommendation = 'Consider running a promotion to reduce excess inventory';
        }
        
        productAnalysis.push({
            name: productName,
            stock,
            reorderPoint,
            daysOfInventory: Math.round(daysOfInventory),
            status,
            recommendation,
            value: stock * product.sellingPrice
        });
    });
    
    // Sort by inventory value (highest first)
    productAnalysis.sort((a, b) => b.value - a.value);
    
    // Render results
    const resultsContainer = document.getElementById('inventory-optimizer-results');
    resultsContainer.innerHTML = `
        <div class="inventory-optimization-summary">
            <div class="summary-item">
                <span class="summary-label">Total Products:</span>
                <span class="summary-value">${productAnalysis.length}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Products Needing Attention:</span>
                <span class="summary-value">${productAnalysis.filter(p => p.status !== 'optimal').length}</span>
            </div>
        </div>
        
        <div class="inventory-recommendations">
            <h5>AI Recommendations:</h5>
            <div class="recommendations-list">
                ${productAnalysis.map(product => `
                    <div class="recommendation-item ${product.status}">
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            <div class="product-details">
                                Stock: ${product.stock} | Days of Inventory: ${product.daysOfInventory}
                            </div>
                        </div>
                        <div class="product-recommendation">
                            ${product.recommendation}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function openSalesPatternAnalyzer() {
    const businessData = collectBusinessDataForAI();
    
    const modal = document.createElement('dialog');
    modal.id = 'sales-pattern-analyzer-dialog';
    modal.className = 'ai-tool-dialog';
    modal.innerHTML = `
        <div class="modal-header">
            <h3>Sales Pattern Analyzer</h3>
            <button class="close-button" onclick="this.closest('dialog').close()">&times;</button>
        </div>
        <div class="ai-tool-content">
            <div class="form-box">
                <h4>Sales Pattern Analysis</h4>
                <p>Analyzing your sales patterns, products, customers, and historical data...</p>
                <div id="sales-pattern-results" class="analysis-results">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.showModal();
    
    // Simulate AI analysis with comprehensive data
    setTimeout(() => {
        analyzeSalesPatterns(businessData);
    }, 1000);
}

function analyzeSalesPatterns(businessData) {
    const dataContext = businessData || collectBusinessDataForAI();
    // Group sales by day of week
    const salesByDay = {
        0: [], // Sunday
        1: [], // Monday
        2: [], // Tuesday
        3: [], // Wednesday
        4: [], // Thursday
        5: [], // Friday
        6: []  // Saturday
    };
    
    salesHistory.forEach(sale => {
        const dayOfWeek = new Date(sale.date).getDay();
        salesByDay[dayOfWeek].push(sale);
    });
    
    // Calculate average sales by day
    const avgSalesByDay = {};
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    
    Object.keys(salesByDay).forEach(day => {
        const daySales = salesByDay[day];
        const totalRevenue = daySales.reduce((sum, sale) => sum + (sale.quantity * sale.unitPrice), 0);
        avgSalesByDay[day] = {
            dayName: dayNames[day],
            totalRevenue,
            transactionCount: daySales.length,
            avgTransactionValue: daySales.length > 0 ? totalRevenue / daySales.length : 0
        };
    });
    
    // Find best and worst days
    const sortedDays = Object.values(avgSalesByDay).sort((a, b) => b.totalRevenue - a.totalRevenue);
    const bestDay = sortedDays[0];
    const worstDay = sortedDays[sortedDays.length - 1];
    
    // Analyze product performance
    const productPerformance = {};
    
    salesHistory.forEach(sale => {
        if (!productPerformance[sale.product]) {
            productPerformance[sale.product] = {
                quantity: 0,
                revenue: 0,
                transactions: 0
            };
        }
        
        productPerformance[sale.product].quantity += sale.quantity;
        productPerformance[sale.product].revenue += sale.quantity * sale.unitPrice;
        productPerformance[sale.product].transactions += 1;
    });
    
    // Sort products by revenue
    const sortedProducts = Object.keys(productPerformance).sort((a, b) => 
        productPerformance[b].revenue - productPerformance[a].revenue
    );
    
    const topProduct = sortedProducts[0];
    const bottomProduct = sortedProducts[sortedProducts.length - 1];
    
    // Render results
    const resultsContainer = document.getElementById('sales-pattern-results');
    resultsContainer.innerHTML = `
        <div class="sales-pattern-summary">
            <h5>Day of Week Analysis</h5>
            <div class="day-analysis">
                <div class="day-item best-day">
                    <div class="day-label">Best Day</div>
                    <div class="day-name">${bestDay.dayName}</div>
                    <div class="day-revenue">${formatAmount(bestDay.totalRevenue)}</div>
                </div>
                <div class="day-item worst-day">
                    <div class="day-label">Worst Day</div>
                    <div class="day-name">${worstDay.dayName}</div>
                    <div class="day-revenue">${formatAmount(worstDay.totalRevenue)}</div>
                </div>
            </div>
        </div>
        
        <div class="product-performance-analysis">
            <h5>Product Performance</h5>
            <div class="product-analysis">
                <div class="product-item best-product">
                    <div class="product-label">Top Performer</div>
                    <div class="product-name">${topProduct}</div>
                    <div class="product-revenue">${formatAmount(productPerformance[topProduct].revenue)}</div>
                </div>
                <div class="product-item worst-product">
                    <div class="product-label">Lowest Performer</div>
                    <div class="product-name">${bottomProduct}</div>
                    <div class="product-revenue">${formatAmount(productPerformance[bottomProduct].revenue)}</div>
                </div>
            </div>
        </div>
        
        <div class="sales-insights">
            <h5>AI Insights:</h5>
            <div class="insight-item">
                <i data-lucide="trending-up"></i>
                <span>Your best sales day is ${bestDay.dayName} with ${formatAmount(bestDay.totalRevenue)} in revenue.</span>
            </div>
            <div class="insight-item">
                <i data-lucide="package"></i>
                <span>${topProduct} is your top performing product with ${formatAmount(productPerformance[topProduct].revenue)} in revenue.</span>
            </div>
            <div class="insight-item">
                <i data-lucide="lightbulb"></i>
                <span>Consider promoting ${bottomProduct} or bundling it with ${topProduct} to increase sales.</span>
            </div>
        </div>
    `;
    
    // Initialize Lucide icons
    lucide.createIcons();
}

function openCustomerSegmentation() {
    const businessData = collectBusinessDataForAI();
    
    const modal = document.createElement('dialog');
    modal.id = 'customer-segmentation-dialog';
    modal.className = 'ai-tool-dialog';
    modal.innerHTML = `
        <div class="modal-header">
            <h3>Customer Segmentation</h3>
            <button class="close-button" onclick="this.closest('dialog').close()">&times;</button>
        </div>
        <div class="ai-tool-content">
            <div class="form-box">
                <h4>Customer Segmentation Analysis</h4>
                <p>Analyzing customer data, sales history, orders, and purchase patterns...</p>
                <div id="customer-segmentation-results" class="analysis-results">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.showModal();
    
    // Simulate AI analysis with comprehensive data
    setTimeout(() => {
        segmentCustomers(businessData);
    }, 1000);
}

function segmentCustomers(businessData) {
    const dataContext = businessData || collectBusinessDataForAI();
    // In a real implementation, you would analyze actual customer data
    // For this demo, we'll create mock customer segments
    
    const segments = [
        {
            name: 'High Value Customers',
            description: 'Customers who purchase frequently and spend more than average',
            percentage: 20,
            characteristics: ['High purchase frequency', 'Above average order value', 'Brand loyal'],
            recommendations: ['Offer exclusive deals', 'Provide priority support', 'Create loyalty program']
        },
        {
            name: 'Price Sensitive Customers',
            description: 'Customers who are primarily motivated by price and discounts',
            percentage: 30,
            characteristics: ['Respond to promotions', 'Compare prices', 'Less brand loyal'],
            recommendations: ['Offer volume discounts', 'Price match guarantees', 'Bundle deals']
        },
        {
            name: 'Occasional Customers',
            description: 'Customers who purchase infrequently but spend well when they do',
            percentage: 25,
            characteristics: ['Low purchase frequency', 'High order value', 'Event-driven purchases'],
            recommendations: ['Re-engagement campaigns', 'Special event promotions', 'Reminder notifications']
        },
        {
            name: 'New Customers',
            description: 'Recently acquired customers who are still forming habits',
            percentage: 25,
            characteristics: ['Recent first purchase', 'Exploring product range', 'Price testing'],
            recommendations: ['Welcome offers', 'Product education', 'Onboarding support']
        }
    ];
    
    // Render results
    const resultsContainer = document.getElementById('customer-segmentation-results');
    resultsContainer.innerHTML = `
        <div class="customer-segments">
            ${segments.map(segment => `
                <div class="segment-card">
                    <div class="segment-header">
                        <h5>${segment.name}</h5>
                        <div class="segment-percentage">${segment.percentage}%</div>
                    </div>
                    <p class="segment-description">${segment.description}</p>
                    <div class="segment-characteristics">
                        <h6>Characteristics:</h6>
                        <ul>
                            ${segment.characteristics.map(char => `<li>${char}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="segment-recommendations">
                        <h6>Recommendations:</h6>
                        <ul>
                            ${segment.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `).join('')}
        </div>
        
        <div class="segmentation-insights">
            <h5>AI Insights:</h5>
            <div class="insight-item">
                <i data-lucide="target"></i>
                <span>Focusing on High Value Customers can increase revenue by up to 25% with targeted marketing.</span>
            </div>
            <div class="insight-item">
                <i data-lucide="trending-up"></i>
                <span>Converting Price Sensitive Customers to loyal customers can increase customer lifetime value.</span>
            </div>
            <div class="insight-item">
                <i data-lucide="users"></i>
                <span>New Customers have the highest potential for growth with proper onboarding.</span>
            </div>
        </div>
    `;
    
    // Initialize Lucide icons
    lucide.createIcons();
}

function openDemandForecasting() {
    const businessData = collectBusinessDataForAI();
    
    const modal = document.createElement('dialog');
    modal.id = 'demand-forecasting-dialog';
    modal.className = 'ai-tool-dialog';
    modal.innerHTML = `
        <div class="modal-header">
            <h3>Demand Forecasting</h3>
            <button class="close-button" onclick="this.closest('dialog').close()">&times;</button>
        </div>
        <div class="ai-tool-content">
            <div class="form-box">
                <h4>Demand Forecasting Analysis</h4>
                <p>Analyzing historical data, inventory levels, products, and sales trends to predict future demand...</p>
                <div id="demand-forecasting-results" class="analysis-results">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.showModal();
    
    // Simulate AI analysis with comprehensive data
    setTimeout(() => {
        forecastDemand(businessData);
    }, 1000);
}

function forecastDemand(businessData) {
    const dataContext = businessData || collectBusinessDataForAI();
    // Calculate historical sales data
    const monthlySales = {};
    
    salesHistory.forEach(sale => {
        const date = new Date(sale.date);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        
        if (!monthlySales[monthKey]) {
            monthlySales[monthKey] = {
                total: 0,
                byProduct: {}
            };
        }
        
        monthlySales[monthKey].total += sale.quantity * sale.unitPrice;
        
        if (!monthlySales[monthKey].byProduct[sale.product]) {
            monthlySales[monthKey].byProduct[sale.product] = 0;
        }
        
        monthlySales[monthKey].byProduct[sale.product] += sale.quantity;
    });
    
    // Generate forecast for next 3 months
    const forecast = [];
    const currentMonth = new Date();
    
    for (let i = 1; i <= 3; i++) {
        const forecastDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + i, 1);
        const monthKey = `${forecastDate.getFullYear()}-${String(forecastDate.getMonth() + 1).padStart(2, '0')}`;
        
        // Simple forecast: use historical average with seasonal adjustment
        const historicalMonths = Object.keys(monthlySales).filter(key => {
            const [year, month] = key.split('-');
            return parseInt(month) === forecastDate.getMonth() + 1;
        });
        
        let avgRevenue = 0;
        if (historicalMonths.length > 0) {
            avgRevenue = historicalMonths.reduce((sum, key) => sum + monthlySales[key].total, 0) / historicalMonths.length;
        }
        
        // Apply growth factor (assuming 5% month-over-month growth)
        const growthFactor = 1 + (0.05 * i);
        const forecastRevenue = avgRevenue * growthFactor;
        
        forecast.push({
            month: forecastDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
            revenue: forecastRevenue,
            confidence: Math.max(0.8 - (i * 0.1), 0.5) // Decreasing confidence for further months
        });
    }
    
    // Product-level forecast
    const productForecast = {};
    
    Object.keys(productCatalog).forEach(productName => {
        const productSales = salesHistory.filter(sale => sale.product === productName);
        
        if (productSales.length > 0) {
            // Calculate average monthly sales for this product
            const monthlyProductSales = {};
            
            productSales.forEach(sale => {
                const date = new Date(sale.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyProductSales[monthKey]) {
                    monthlyProductSales[monthKey] = 0;
                }
                
                monthlyProductSales[monthKey] += sale.quantity;
            });
            
            // Calculate average
            const avgMonthlySales = Object.values(monthlyProductSales).reduce((sum, qty) => sum + qty, 0) / Object.keys(monthlyProductSales).length;
            
            // Apply growth factor
            productForecast[productName] = {
                currentMonth: Math.round(avgMonthlySales * 1.05),
                nextMonth: Math.round(avgMonthlySales * 1.1),
                thirdMonth: Math.round(avgMonthlySales * 1.15)
            };
        }
    });
    
    // Sort products by forecast demand
    const sortedProducts = Object.keys(productForecast).sort((a, b) => 
        (productForecast[b].currentMonth + productForecast[b].nextMonth + productForecast[b].thirdMonth) - 
        (productForecast[a].currentMonth + productForecast[a].nextMonth + productForecast[a].thirdMonth)
    );
    
    // Render results
    const resultsContainer = document.getElementById('demand-forecasting-results');
    resultsContainer.innerHTML = `
        <div class="demand-forecast-summary">
            <h5>3-Month Revenue Forecast</h5>
            <div class="forecast-chart">
                ${forecast.map(item => `
                    <div class="forecast-item">
                        <div class="forecast-month">${item.month}</div>
                        <div class="forecast-revenue">${formatAmount(item.revenue)}</div>
                        <div class="forecast-confidence">Confidence: ${Math.round(item.confidence * 100)}%</div>
                    </div>
                `).join('')}
            </div>
        </div>
        
        <div class="product-demand-forecast">
            <h5>Product Demand Forecast</h5>
            <div class="product-forecast-list">
                ${sortedProducts.slice(0, 5).map(productName => {
                    const forecast = productForecast[productName];
                    return `
                        <div class="product-forecast-item">
                            <div class="product-name">${productName}</div>
                            <div class="forecast-quantities">
                                <div class="forecast-quantity">
                                    <span class="forecast-label">Current:</span>
                                    <span class="forecast-value">${forecast.currentMonth}</span>
                                </div>
                                <div class="forecast-quantity">
                                    <span class="forecast-label">Next:</span>
                                    <span class="forecast-value">${forecast.nextMonth}</span>
                                </div>
                                <div class="forecast-quantity">
                                    <span class="forecast-label">+2:</span>
                                    <span class="forecast-value">${forecast.thirdMonth}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
        
        <div class="forecast-insights">
            <h5>AI Insights:</h5>
            <div class="insight-item">
                <i data-lucide="trending-up"></i>
                <span>Expected revenue growth of ${Math.round((forecast[2].revenue / forecast[0].revenue - 1) * 100)}% over the next 3 months.</span>
            </div>
            <div class="insight-item">
                <i data-lucide="package"></i>
                <span>${sortedProducts[0]} is expected to have the highest demand in the coming months.</span>
            </div>
            <div class="insight-item">
                <i data-lucide="alert-triangle"></i>
                <span>Consider increasing inventory for top 5 products by 15-20% to meet forecasted demand.</span>
            </div>
        </div>
    `;
    
    // Initialize Lucide icons
    lucide.createIcons();
}

// Initialize the enhanced AI Lab tools when the page loads
document.addEventListener('DOMContentLoaded', () => {
    // Add the enhanced AI Lab tools to the lab page
    setTimeout(() => {
        renderEnhancedAILabTools();
    }, 1000);
});

// Add these CSS styles for the AI Lab tools
const aiLabToolsStyles = `
.ai-tool-dialog {
    width: 90vw;
    max-width: 1000px;
    height: 80vh;
    max-height: 800px;
}

.ai-tool-content {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.analysis-results {
    flex-grow: 1;
    overflow-y: auto;
    padding: 20px;
}

.cash-flow-summary {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
}

.summary-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    background: #f9fafb;
    border-radius: 8px;
    width: 30%;
}

.summary-label {
    font-size: 14px;
    color: var(--color-text-medium);
    margin-bottom: 5px;
}

.summary-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--color-text-dark);
}

.summary-value.positive {
    color: var(--color-secondary);
}

.summary-value.negative {
    color: var(--color-danger);
}

.cash-flow-insights, .inventory-recommendations, .sales-insights, .segmentation-insights, .forecast-insights {
    margin-top: 20px;
}

.cash-flow-insights h5, .inventory-recommendations h5, .sales-insights h5, .segmentation-insights h5, .forecast-insights h5 {
    margin-bottom: 15px;
    color: var(--color-text-dark);
}

.insight-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 10px;
    padding: 10px;
    background: #f9fafb;
    border-radius: 8px;
}

.insight-item i {
    margin-right: 10px;
    color: var(--color-primary);
    flex-shrink: 0;
}

.projection-chart {
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
}

.projection-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 16%;
}

.projection-month {
    font-size: 14px;
    color: var(--color-text-medium);
    margin-bottom: 5px;
}

.projection-value {
    font-size: 16px;
    font-weight: 600;
    padding: 5px 10px;
    border-radius: 4px;
    margin-bottom: 5px;
}

.projection-value.positive {
    background: #d1fae5;
    color: #065f46;
}

.projection-value.negative {
    background: #fee2e2;
    color: #991b1b;
}

.recommendation-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}

.recommendation-item.out-of-stock {
    background: #fee2e2;
    border-left: 4px solid var(--color-danger);
}

.recommendation-item.low-stock {
    background: #fef3c7;
    border-left: 4px solid var(--color-orange);
}

.recommendation-item.overstock {
    background: #dbeafe;
    border-left: 4px solid var(--color-primary);
}

.product-info {
    flex-grow: 1;
}

.product-name {
    font-weight: 600;
    margin-bottom: 5px;
}

.product-details {
    font-size: 14px;
    color: var(--color-text-medium);
}

.product-recommendation {
    font-weight: 600;
    color: var(--color-primary);
    margin-left: 15px;
    max-width: 40%;
    text-align: right;
}

.day-analysis {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
}

.day-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    border-radius: 8px;
    width: 45%;
}

.day-item.best-day {
    background: #d1fae5;
    border-left: 4px solid var(--color-secondary);
}

.day-item.worst-day {
    background: #fee2e2;
    border-left: 4px solid var(--color-danger);
}

.day-label {
    font-size: 14px;
    color: var(--color-text-medium);
    margin-bottom: 5px;
}

.day-name {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 5px;
}

.day-revenue {
    font-size: 18px;
    font-weight: 700;
    color: var(--color-text-dark);
}

.product-analysis {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
}

.product-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px;
    border-radius: 8px;
    width: 45%;
}

.product-item.best-product {
    background: #d1fae5;
    border-left: 4px solid var(--color-secondary);
}

.product-item.worst-product {
    background: #fee2e2;
    border-left: 4px solid var(--color-danger);
}

.product-label {
    font-size: 14px;
    color: var(--color-text-medium);
    margin-bottom: 5px;
}

.product-name {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 5px;
}

.product-revenue {
    font-size: 18px;
    font-weight: 700;
    color: var(--color-text-dark);
}

.customer-segments {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.segment-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border-top: 4px solid var(--color-primary);
}

.segment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.segment-header h5 {
    margin: 0;
    font-size: 18px;
    color: var(--color-text-dark);
}

.segment-percentage {
    font-size: 24px;
    font-weight: 700;
    color: var(--color-primary);
}

.segment-description {
    margin-bottom: 15px;
    color: var(--color-text-medium);
}

.segment-characteristics, .segment-recommendations {
    margin-bottom: 15px;
}

.segment-characteristics h6, .segment-recommendations h6 {
    margin: 0 0 10px 0;
    font-size: 16px;
    color: var(--color-text-dark);
}

.segment-characteristics ul, .segment-recommendations ul {
    margin: 0;
    padding-left: 20px;
}

.segment-characteristics li, .segment-recommendations li {
    margin-bottom: 5px;
    color: var(--color-text-medium);
}

.demand-forecast-summary {
    margin-bottom: 20px;
}

.forecast-chart {
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
}

.forecast-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 30%;
    padding: 15px;
    background: #f9fafb;
    border-radius: 8px;
}

.forecast-month {
    font-size: 14px;
    color: var(--color-text-medium);
    margin-bottom: 5px;
}

.forecast-revenue {
    font-size: 18px;
    font-weight: 700;
    color: var(--color-text-dark);
    margin-bottom: 5px;
}

.forecast-confidence {
    font-size: 12px;
    color: var(--color-text-medium);
}

.product-demand-forecast {
    margin-bottom: 20px;
}

.product-forecast-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.product-forecast-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: #f9fafb;
    border-radius: 8px;
}

.product-name {
    font-weight: 600;
    color: var(--color-text-dark);
}

.forecast-quantities {
    display: flex;
    gap: 15px;
}

.forecast-quantity {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.forecast-label {
    font-size: 12px;
    color: var(--color-text-medium);
    margin-bottom: 5px;
}

.forecast-value {
    font-size: 16px;
    font-weight: 600;
    color: var(--color-text-dark);
}
`;

// Add the styles to the document
const aiLabToolsStyleElement = document.createElement('style');
aiLabToolsStyleElement.textContent = aiLabToolsStyles;
document.head.appendChild(aiLabToolsStyleElement);
console.log(mockBusinessData);
// MARKETPLACE DATA
let marketplaceProducts = JSON.parse(localStorage.getItem('epsilon_marketplace_products') || '[]');
let marketplaceOrders = JSON.parse(localStorage.getItem('epsilon_marketplace_orders') || '[]');
let marketplaceServices = JSON.parse(localStorage.getItem('epsilon_marketplace_services') || '[]');
let marketplaceAssets = JSON.parse(localStorage.getItem('epsilon_marketplace_assets') || '[]');
let assetBids = JSON.parse(localStorage.getItem('epsilon_asset_bids') || '[]');

// Initialize marketplace when page loads
document.addEventListener('DOMContentLoaded', () => {
    // Add marketplace to navigation if not already there
    const navLinks = document.querySelector('.nav-links');
    if (navLinks && !document.querySelector('[data-page="marketplace-page"]')) {
        const marketplaceButton = document.createElement('button');
        marketplaceButton.className = 'nav-button';
        marketplaceButton.setAttribute('data-page', 'marketplace-page');
        marketplaceButton.setAttribute('onclick', 'showPage(\'marketplace-page\'); closeSidebarOnMobile();');
        marketplaceButton.innerHTML = `
            <i data-lucide="shopping-cart"></i>
            <span>Marketplace</span>
        `;
        navLinks.appendChild(marketplaceButton);
    }
    
    // Load marketplace data
    loadMarketplaceData();
    updateMarketplaceStats();
    renderMarketplaceProducts();
    
    // Add event listener for order management dialog
    const orderManagementDialog = document.getElementById('order-management-dialog');
    if (orderManagementDialog) {
        orderManagementDialog.addEventListener('show', () => {
            filterOrderManagement();
        });
    }
    
    // Add event listener for post all products dialog
    const postAllDialog = document.getElementById('post-all-products-dialog');
    if (postAllDialog) {
        postAllDialog.addEventListener('show', () => {
            const preview = document.getElementById('unposted-products-preview');
            const unpostedProducts = [];
            
            Object.keys(productCatalog || {}).forEach(productName => {
                const product = productCatalog[productName];
                const alreadyPosted = marketplaceProducts.some(mp => mp.originalProductId === product.id);
                if (!alreadyPosted) {
                    unpostedProducts.push(product);
                }
            });
            
            if (unpostedProducts.length === 0) {
                preview.innerHTML = '<p style="text-align: center; color: #9ca3af;">All products are already posted to the marketplace.</p>';
                return;
            }
            
            preview.innerHTML = unpostedProducts.map(p => `<div style="padding: 8px; border-bottom: 1px solid var(--color-border-light);">${p.name} - ${formatAmount(p.sellingPrice)}</div>`).join('');
        });
    }
});

// Load marketplace data from localStorage
function loadMarketplaceData() {
    const savedProducts = localStorage.getItem('epsilon_marketplace_products');
    if (savedProducts) {
        try {
            marketplaceProducts = JSON.parse(savedProducts);
        } catch (e) {
            console.error('Failed to parse marketplace products:', e);
            marketplaceProducts = [];
        }
    }
    
    const savedOrders = localStorage.getItem('epsilon_marketplace_orders');
    if (savedOrders) {
        try {
            marketplaceOrders = JSON.parse(savedOrders);
        } catch (e) {
            console.error('Failed to parse marketplace orders:', e);
            marketplaceOrders = [];
        }
    }
    
    const savedServices = localStorage.getItem('epsilon_marketplace_services');
    if (savedServices) {
        try {
            marketplaceServices = JSON.parse(savedServices);
        } catch (e) {
            console.error('Failed to parse marketplace services:', e);
            marketplaceServices = [];
        }
    }
    
    const savedAssets = localStorage.getItem('epsilon_marketplace_assets');
    if (savedAssets) {
        try {
            marketplaceAssets = JSON.parse(savedAssets);
        } catch (e) {
            console.error('Failed to parse marketplace assets:', e);
            marketplaceAssets = [];
        }
    }
    
    const savedBids = localStorage.getItem('epsilon_asset_bids');
    if (savedBids) {
        try {
            assetBids = JSON.parse(savedBids);
        } catch (e) {
            console.error('Failed to parse asset bids:', e);
            assetBids = [];
        }
    }
}

// Save marketplace data to localStorage
function saveMarketplaceData() {
    localStorage.setItem('epsilon_marketplace_products', JSON.stringify(marketplaceProducts));
    localStorage.setItem('epsilon_marketplace_orders', JSON.stringify(marketplaceOrders));
    localStorage.setItem('epsilon_marketplace_services', JSON.stringify(marketplaceServices));
    localStorage.setItem('epsilon_marketplace_assets', JSON.stringify(marketplaceAssets));
    localStorage.setItem('epsilon_asset_bids', JSON.stringify(assetBids));
}

// Update marketplace statistics
function updateMarketplaceStats() {
    const postedProductsCount = document.getElementById('posted-products-count');
    const totalOrdersCount = document.getElementById('total-orders-count');
    const pendingOrdersCount = document.getElementById('pending-orders-count');
    const deliveredOrdersCount = document.getElementById('delivered-orders-count');
    
    if (postedProductsCount) postedProductsCount.textContent = marketplaceProducts.length;
    
    if (totalOrdersCount) totalOrdersCount.textContent = marketplaceOrders.length;
    
    if (pendingOrdersCount) {
        const pendingOrders = marketplaceOrders.filter(order => order.status === 'ordered');
        pendingOrdersCount.textContent = pendingOrders.length;
    }
    
    if (deliveredOrdersCount) {
        const deliveredOrders = marketplaceOrders.filter(order => order.status === 'delivered');
        deliveredOrdersCount.textContent = deliveredOrders.length;
    }
}

// Populate product select in post dialog
function populateProductSelect() {
    const productSelect = document.getElementById('post-product-select');
    if (!productSelect) return;
    
    productSelect.innerHTML = '<option value="">Select a product...</option>';
    
    Object.keys(productCatalog).forEach(productName => {
        const option = document.createElement('option');
        option.value = productName;
        option.textContent = productName;
        productSelect.appendChild(option);
    });
}

// Update post product details when product is selected
function updatePostProductDetails() {
    const productSelect = document.getElementById('post-product-select');
    const productName = productSelect.value;
    
    if (!productName || !productCatalog[productName]) return;
    
    const product = productCatalog[productName];
    
    document.getElementById('post-product-name').value = productName;
    document.getElementById('post-product-price').value = product.sellingPrice;
    document.getElementById('post-product-stock').value = product.stock;
    
    // Set category if product has one
    if (product.category) {
        document.getElementById('post-product-category').value = product.category;
    }
    
    // Set description if product has one
    if (product.description) {
        document.getElementById('post-product-description').value = product.description;
    }
}

// Post product to marketplace
function postProductToMarketplace() {
    const productName = document.getElementById('post-product-select').value;
    const category = document.getElementById('post-product-category').value;
    const price = parseFloat(document.getElementById('post-product-price').value);
    const stock = parseInt(document.getElementById('post-product-stock').value);
    const description = document.getElementById('post-product-description').value;
    
    if (!productName || !category || isNaN(price) || isNaN(stock)) {
        showMessage('Please fill all required fields', 'error');
        return;
    }
    
    const product = productCatalog[productName];
    if (!product) {
        showMessage('Product not found in catalog', 'error');
        return;
    }
    
    // Get business settings
    const businessSettings = JSON.parse(localStorage.getItem('epsilon_account_settings') || '{}');
    const businessName = businessSettings.businessName || 'Unknown Business';
    
    // Create marketplace product
    const marketplaceProduct = {
        id: generateId(),
        originalProductId: product.id,
        name: productName,
        category: category,
        price: price,
        stock: stock,
        description: description || `High quality ${productName}`,
        businessName: businessName,
        postedDate: new Date().toISOString(),
        image: null // Will be set if image is uploaded
    };
    
    // Handle image upload
    const imageInput = document.getElementById('post-product-image');
    if (imageInput.files && imageInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            marketplaceProduct.image = e.target.result;
            saveMarketplaceProduct();
        };
        reader.readAsDataURL(imageInput.files[0]);
    } else {
        saveMarketplaceProduct();
    }
    
    function saveMarketplaceProduct() {
        marketplaceProducts.push(marketplaceProduct);
        saveMarketplaceData();
        updateMarketplaceStats();
        renderMarketplaceProducts();
        
        // Reset form
        document.getElementById('post-product-select').value = '';
        document.getElementById('post-product-name').value = '';
        document.getElementById('post-product-category').value = 'Electronics';
        document.getElementById('post-product-price').value = '';
        document.getElementById('post-product-stock').value = '';
        document.getElementById('post-product-description').value = '';
        document.getElementById('post-product-image').value = '';
        
        document.getElementById('post-product-dialog').close();
        showMessage(`Product "${productName}" posted to marketplace successfully!`, 'success');
    }
}

// Post service to marketplace
function postServiceToMarketplace() {
    const serviceName = document.getElementById('post-service-name').value.trim();
    const category = document.getElementById('post-service-category').value;
    const price = parseFloat(document.getElementById('post-service-price').value);
    const duration = parseFloat(document.getElementById('post-service-duration').value);
    const description = document.getElementById('post-service-description').value.trim();
    
    if (!serviceName || !category || isNaN(price) || isNaN(duration)) {
        showMessage('Please fill all required fields', 'error');
        return;
    }
    
    if (price <= 0) {
        showMessage('Price must be greater than 0', 'error');
        return;
    }
    
    if (duration <= 0) {
        showMessage('Duration must be greater than 0', 'error');
        return;
    }
    
    const businessSettings = JSON.parse(localStorage.getItem('epsilon_account_settings') || '{}');
    const businessName = businessSettings.businessName || 'Unknown Business';
    
    const marketplaceService = {
        id: generateId(),
        name: serviceName,
        category: category,
        price: price,
        duration: duration,
        description: description || `Professional ${serviceName} service`,
        businessName: businessName,
        postedDate: new Date().toISOString(),
        type: 'service'
    };
    
    marketplaceServices.push(marketplaceService);
    saveMarketplaceData();
    updateMarketplaceStats();
    renderMarketplaceProducts();
    
    document.getElementById('post-service-name').value = '';
    document.getElementById('post-service-category').value = 'Consulting';
    document.getElementById('post-service-price').value = '';
    document.getElementById('post-service-duration').value = '';
    document.getElementById('post-service-description').value = '';
    
    document.getElementById('post-service-dialog').close();
    showMessage(`Service "${serviceName}" posted to marketplace successfully!`, 'success');
}

// Render marketplace products and services
function renderMarketplaceProducts() {
    const productsGrid = document.getElementById('marketplace-products-grid');
    if (!productsGrid) return;
    
    const allItems = [
        ...marketplaceProducts.map(p => ({...p, type: 'product'})),
        ...marketplaceServices.map(s => ({...s, type: 'service'}))
    ];
    
    if (allItems.length === 0) {
        productsGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #9ca3af; padding: 40px;">No products or services in marketplace yet.</p>';
        return;
    }
    
    productsGrid.innerHTML = allItems.map(item => `
        <div class="product-card">
            <div class="product-image">
                ${item.image ? 
                    `<img src="${item.image}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                    `<i data-lucide="${item.type === 'service' ? 'briefcase' : 'package'}" style="width: 48px; height: 48px;"></i>`
                }
            </div>
            <div class="product-details">
                <h3 class="product-name">${item.name || 'Unnamed Product'}</h3>
                <span class="product-category">${item.category}</span>
                <div class="product-price">${formatAmount(item.price)}</div>
                ${item.type === 'product' ? 
                    `<div class="product-stock">Stock: ${item.stock} units</div>` :
                    `<div class="product-stock">Duration: ${item.duration} hours</div>`
                }
                <p class="product-description">${item.description}</p>
                <div class="product-business">Posted by: ${item.businessName}</div>
                <div class="product-actions">
                    <button onclick="openOrderDialog('${item.id}')" class="button button-primary" style="flex: 1;">Order Now</button>
                </div>
            </div>
        </div>
    `).join('');
    
    // Re-create Lucide icons
    setTimeout(() => lucide.createIcons(), 100);
}

// Filter marketplace products and services
function filterMarketplaceProducts() {
    const searchTerm = document.getElementById('marketplace-search').value.toLowerCase();
    const categoryFilter = document.getElementById('marketplace-category-filter').value;
    
    const allItems = [
        ...marketplaceProducts.map(p => ({...p, type: 'product'})),
        ...marketplaceServices.map(s => ({...s, type: 'service'}))
    ];
    
    const filteredItems = allItems.filter(item => {
        const matchesSearch = !searchTerm || 
            (item.name || '').toLowerCase().includes(searchTerm) || 
            (item.description || '').toLowerCase().includes(searchTerm) ||
            (item.businessName || '').toLowerCase().includes(searchTerm);
            
        const matchesCategory = !categoryFilter || item.category === categoryFilter;
        
        return matchesSearch && matchesCategory;
    });
    
    renderFilteredMarketplaceProducts(filteredItems);
}

// Sort marketplace products and services
function sortMarketplaceProducts() {
    const sortBy = document.getElementById('marketplace-sort').value;
    
    const allItems = [
        ...marketplaceProducts.map(p => ({...p, type: 'product'})),
        ...marketplaceServices.map(s => ({...s, type: 'service'}))
    ];
    
    let sortedItems = [...allItems];
    
    switch(sortBy) {
        case 'newest':
            sortedItems.sort((a, b) => new Date(b.postedDate) - new Date(a.postedDate));
            break;
        case 'oldest':
            sortedItems.sort((a, b) => new Date(a.postedDate) - new Date(b.postedDate));
            break;
        case 'price-low':
            sortedItems.sort((a, b) => a.price - b.price);
            break;
        case 'price-high':
            sortedItems.sort((a, b) => b.price - a.price);
            break;
    }
    
    renderFilteredMarketplaceProducts(sortedItems);
}

// Render filtered marketplace products and services
function renderFilteredMarketplaceProducts(items) {
    const productsGrid = document.getElementById('marketplace-products-grid');
    if (!productsGrid) return;
    
    if (items.length === 0) {
        productsGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #9ca3af; padding: 40px;">No products or services match your criteria.</p>';
        return;
    }
    
    productsGrid.innerHTML = items.map(item => `
        <div class="product-card">
            <div class="product-image">
                ${item.image ? 
                    `<img src="${item.image}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                    `<i data-lucide="${item.type === 'service' ? 'briefcase' : 'package'}" style="width: 48px; height: 48px;"></i>`
                }
            </div>
            <div class="product-details">
                <h3 class="product-name">${item.name || 'Unnamed Product'}</h3>
                <span class="product-category">${item.category}</span>
                <div class="product-price">${formatAmount(item.price)}</div>
                ${item.type === 'product' ? 
                    `<div class="product-stock">Stock: ${item.stock} units</div>` :
                    `<div class="product-stock">Duration: ${item.duration} hours</div>`
                }
                <p class="product-description">${item.description}</p>
                <div class="product-business">Posted by: ${item.businessName}</div>
                <div class="product-actions">
                    <button onclick="openOrderDialog('${item.id}')" class="button button-primary" style="flex: 1;">Order Now</button>
                </div>
            </div>
        </div>
    `).join('');
    
    // Re-create Lucide icons
    setTimeout(() => lucide.createIcons(), 100);
}

// Open order dialog
function openOrderDialog(productId) {
    // Try to find in products first, then services
    let item = marketplaceProducts.find(p => p.id === productId);
    let isService = false;
    
    if (!item) {
        item = marketplaceServices.find(s => s.id === productId);
        isService = true;
    }
    
    if (!item) return;
    
    document.getElementById('order-product-id').value = productId;
    document.getElementById('order-product-name').value = item.name || 'Unnamed Product';
    document.getElementById('order-product-price').value = item.price;
    document.getElementById('order-quantity').value = isService ? 1 : 1;
    document.getElementById('order-customer-name').value = '';
    document.getElementById('order-customer-email').value = '';
    document.getElementById('order-customer-phone').value = '';
    document.getElementById('order-pickup-location').value = '';
    document.getElementById('order-downpayment').value = '';
    document.getElementById('order-remaining-balance').value = '';
    document.getElementById('order-total-price').value = item.price;
    document.getElementById('order-installation-plan').value = '';
    document.getElementById('order-payment-per-installation').value = '';
    document.getElementById('order-notes').value = '';
    document.getElementById('installment-info').style.display = 'none';
    
    // Hide quantity field for services
    const quantityField = document.getElementById('order-quantity').parentElement;
    if (isService) {
        quantityField.style.display = 'none';
        document.getElementById('order-quantity').value = 1;
    } else {
        quantityField.style.display = 'block';
        document.getElementById('order-quantity').oninput = updateOrderTotal;
    }
    
    document.getElementById('order-product-dialog').showModal();
}

// Update order total when quantity changes
function updateOrderTotal() {
    const price = parseFloat(document.getElementById('order-product-price').value) || 0;
    const quantity = parseInt(document.getElementById('order-quantity').value) || 1;
    const totalPrice = price * quantity;
    document.getElementById('order-total-price').value = totalPrice;
    calculateRemainingBalance();
}

// Calculate remaining balance
function calculateRemainingBalance() {
    const totalPrice = parseFloat(document.getElementById('order-total-price').value) || 0;
    const downPayment = parseFloat(document.getElementById('order-downpayment').value) || 0;
    const remaining = totalPrice - downPayment;
    document.getElementById('order-remaining-balance').value = remaining < 0 ? 0 : remaining;
}

// Update installment info
function updateInstallmentInfo() {
    const plan = document.getElementById('order-installation-plan').value;
    const infoDeck = document.getElementById('installment-info');
    const details = document.getElementById('installment-details');
    
    if (!plan) {
        infoDeck.style.display = 'none';
        document.getElementById('order-payment-per-installation').value = '';
        return;
    }
    
    const planNames = {
        'daily': 'Daily',
        'weekly': 'Weekly',
        'monthly': 'Monthly',
        'quarterly': 'Quarterly',
        'half-yearly': 'Half-Yearly',
        'yearly': 'Yearly'
    };
    
    const periods = {
        'daily': 365,
        'weekly': 52,
        'monthly': 12,
        'quarterly': 4,
        'half-yearly': 2,
        'yearly': 1
    };
    
    const remaining = parseFloat(document.getElementById('order-remaining-balance').value) || 0;
    const numPeriods = periods[plan] || 1;
    const paymentPerInstallment = (remaining / numPeriods).toFixed(2);
    
    document.getElementById('order-payment-per-installation').value = paymentPerInstallment;
    details.textContent = `${planNames[plan]} payments of ${formatAmount(paymentPerInstallment)} for ${numPeriods} payments (1 per ${plan})`;
    infoDeck.style.display = 'block';
}

// Post all unposted products
function postAllUnpostedProducts() {
    const preview = document.getElementById('unposted-products-preview');
    const unpostedProducts = [];
    
    Object.keys(productCatalog).forEach(productName => {
        const product = productCatalog[productName];
        const alreadyPosted = marketplaceProducts.some(mp => mp.originalProductId === product.id);
        if (!alreadyPosted) {
            unpostedProducts.push(product);
        }
    });
    
    if (unpostedProducts.length === 0) {
        preview.innerHTML = '<p style="text-align: center; color: #9ca3af;">All products are already posted to the marketplace.</p>';
        return;
    }
    
    preview.innerHTML = unpostedProducts.map(p => `<div style="padding: 8px; border-bottom: 1px solid var(--color-border-light);">${p.name} - ${formatAmount(p.sellingPrice)}</div>`).join('');
    
    const button = document.querySelector('#post-all-products-dialog button[class*="primary"]');
    button.onclick = () => {
        const businessSettings = JSON.parse(localStorage.getItem('epsilon_account_settings') || '{}');
        const businessName = businessSettings.businessName || 'Unknown Business';
        
        unpostedProducts.forEach(product => {
            const marketplaceProduct = {
                id: generateId(),
                originalProductId: product.id,
                name: product.name,
                category: product.category || 'Other',
                price: product.sellingPrice,
                stock: product.stock,
                description: product.description || `High quality ${product.name}`,
                businessName: businessName,
                postedDate: new Date().toISOString(),
                image: null
            };
            marketplaceProducts.push(marketplaceProduct);
        });
        
        saveMarketplaceData();
        updateMarketplaceStats();
        renderMarketplaceProducts();
        document.getElementById('post-all-products-dialog').close();
        showMessage(`${unpostedProducts.length} product(s) posted to marketplace successfully!`, 'success');
    };
}

// Show unposted products when dialog opens
document.addEventListener('DOMContentLoaded', () => {
    const postAllDialog = document.getElementById('post-all-products-dialog');
    if (postAllDialog) {
        postAllDialog.addEventListener('show', function() {
            const preview = document.getElementById('unposted-products-preview');
            const unpostedProducts = [];
            
            Object.keys(productCatalog || {}).forEach(productName => {
                const product = productCatalog[productName];
                const alreadyPosted = marketplaceProducts.some(mp => mp.originalProductId === product.id);
                if (!alreadyPosted) {
                    unpostedProducts.push(product);
                }
            });
            
            if (unpostedProducts.length === 0) {
                preview.innerHTML = '<p style="text-align: center; color: #9ca3af;">All products are already posted to the marketplace.</p>';
                return;
            }
            
            preview.innerHTML = unpostedProducts.map(p => `<div style="padding: 8px; border-bottom: 1px solid var(--color-border-light);">${p.name} - ${formatAmount(p.sellingPrice)}</div>`).join('');
        });
    }
});

// Filter order management
function filterOrderManagement() {
    const filterType = document.getElementById('order-filter-type').value;
    const businessSettings = JSON.parse(localStorage.getItem('epsilon_account_settings') || '{}');
    const businessName = businessSettings.businessName || 'Unknown Business';
    
    let orders = [];
    
    if (filterType === 'my-orders') {
        orders = marketplaceOrders.filter(o => o.businessName === businessName);
    } else if (filterType === 'pending') {
        orders = marketplaceOrders.filter(o => o.status === 'ordered');
    } else if (filterType === 'delivered') {
        orders = marketplaceOrders.filter(o => o.status === 'delivered');
    } else {
        orders = marketplaceOrders;
    }
    
    renderOrderManagementList(orders);
    renderAssetBidsList();
}

// Render order management list
function renderOrderManagementList(orders) {
    const list = document.getElementById('order-management-list');
    if (!list || orders.length === 0) {
        if (list) list.innerHTML = '<p style="text-align: center; color: #9ca3af;">No orders to display.</p>';
        return;
    }
    
    list.innerHTML = orders.map(order => `
        <div style="padding: 12px; border-bottom: 1px solid var(--color-border-light); border-radius: 6px; margin-bottom: 8px; background: #f9fafb;">
            <div style="font-weight: 600; margin-bottom: 6px;">${order.productName}</div>
            <div style="font-size: 12px; color: var(--color-text-medium); margin-bottom: 4px;">Customer: ${order.customerName}</div>
            <div style="font-size: 12px; color: var(--color-text-medium); margin-bottom: 4px;">Total: ${formatAmount(order.total)}</div>
            ${order.downPayment ? `<div style="font-size: 12px; color: var(--color-text-medium); margin-bottom: 4px;">Down Payment: ${formatAmount(order.downPayment)}</div>` : ''}
            ${order.installmentPlan ? `<div style="font-size: 12px; color: var(--color-primary); margin-bottom: 6px;"> ${order.installmentPlan} installments</div>` : ''}
            <div style="display: flex; gap: 8px;">
                <button onclick="viewOrderDetailsFromManagement('${order.id}')" class="button button-secondary" style="flex: 1; padding: 4px; font-size: 12px;">View</button>
                ${order.status === 'ordered' ? `<button onclick="rejectOrder('${order.id}')" class="button button-danger" style="flex: 1; padding: 4px; font-size: 12px;">Reject</button>` : ''}
            </div>
        </div>
    `).join('');
}

// Render asset bids list
function renderAssetBidsList() {
    const list = document.getElementById('asset-bids-list');
    if (!list) return;
    
    if (marketplaceAssets.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: #9ca3af;">No assets posted yet.</p>';
        return;
    }
    
    list.innerHTML = marketplaceAssets.map(asset => {
        const bidsForAsset = assetBids.filter(b => b.assetId === asset.id);
        const highestBid = bidsForAsset.length > 0 ? Math.max(...bidsForAsset.map(b => b.amount)) : asset.startingBid;
        
        return `
            <div style="padding: 12px; border-bottom: 1px solid var(--color-border-light); border-radius: 6px; margin-bottom: 8px; background: #f9fafb;">
                <div style="font-weight: 600; margin-bottom: 6px;">${asset.name}</div>
                <div style="font-size: 12px; color: var(--color-text-medium); margin-bottom: 4px;">Starting Bid: ${formatAmount(asset.startingBid)}</div>
                <div style="font-size: 12px; color: var(--color-primary); margin-bottom: 6px;">Current Bid: ${formatAmount(highestBid)}</div>
                <div style="font-size: 12px; color: var(--color-text-medium); margin-bottom: 6px;">Total Bids: ${bidsForAsset.length}</div>
                <button onclick="viewAssetBids('${asset.id}')" class="button button-secondary" style="width: 100%; padding: 4px; font-size: 12px;">View Bids</button>
            </div>
        `;
    }).join('');
}

// View order details from management
function viewOrderDetailsFromManagement(orderId) {
    const order = marketplaceOrders.find(o => o.id === orderId);
    if (!order) return;
    
    document.getElementById('order-details-id').value = orderId;
    
    const detailsContent = document.getElementById('order-details-content');
    detailsContent.innerHTML = `
        <div class="order-detail-row">
            <div class="order-detail-label">Product:</div>
            <div class="order-detail-value">${order.quantity} x ${order.productName}</div>
        </div>
        <div class="order-detail-row">
            <div class="order-detail-label">Total:</div>
            <div class="order-detail-value">${formatAmount(order.total)}</div>
        </div>
        ${order.downPayment ? `
            <div class="order-detail-row">
                <div class="order-detail-label">Down Payment:</div>
                <div class="order-detail-value">${formatAmount(order.downPayment)}</div>
            </div>
            <div class="order-detail-row">
                <div class="order-detail-label">Remaining:</div>
                <div class="order-detail-value">${formatAmount(order.total - order.downPayment)}</div>
            </div>
        ` : ''}
        ${order.installmentPlan ? `
            <div class="order-detail-row">
                <div class="order-detail-label">Installment Plan:</div>
                <div class="order-detail-value">${order.installmentPlan}</div>
            </div>
            <div class="order-detail-row">
                <div class="order-detail-label">Payment Per Installation:</div>
                <div class="order-detail-value">${formatAmount(order.paymentPerInstallation)}</div>
            </div>
        ` : ''}
        <div class="order-detail-row">
            <div class="order-detail-label">Customer:</div>
            <div class="order-detail-value">${order.customerName}</div>
        </div>
        <div class="order-detail-row">
            <div class="order-detail-label">Email:</div>
            <div class="order-detail-value">${order.customerEmail}</div>
        </div>
        ${order.customerPhone ? `
            <div class="order-detail-row">
                <div class="order-detail-label">Phone:</div>
                <div class="order-detail-value">${order.customerPhone}</div>
            </div>
        ` : ''}
        <div class="order-detail-row">
            <div class="order-detail-label">Pickup Location:</div>
            <div class="order-detail-value">${order.pickupLocation}</div>
        </div>
        <div class="order-detail-row">
            <div class="order-detail-label">Order Date:</div>
            <div class="order-detail-value">${new Date(order.orderDate).toLocaleDateString()}</div>
        </div>
        <div class="order-detail-row">
            <div class="order-detail-label">Status:</div>
            <div class="order-detail-value">${order.status}</div>
        </div>
        ${order.notes ? `
            <div class="order-detail-row">
                <div class="order-detail-label">Notes:</div>
                <div class="order-detail-value">${order.notes}</div>
            </div>
        ` : ''}
    `;
    
    const orderActions = document.getElementById('order-actions');
    if (order.status === 'ordered') {
        orderActions.innerHTML = `
            <button onclick="markAsDelivered('${orderId}')" class="button button-primary" style="width: 100%; margin-bottom: 8px;">Mark as Delivered</button>
            <button onclick="rejectOrder('${orderId}')" class="button button-danger" style="width: 100%;">Reject Order</button>
        `;
    } else {
        orderActions.innerHTML = `
            <p style="text-align: center; color: var(--color-secondary); margin: 20px 0;">This order has been ${order.status}.</p>
        `;
    }
    
    document.getElementById('order-details-dialog').showModal();
}

// Reject order
function rejectOrder(orderId) {
    const order = marketplaceOrders.find(o => o.id === orderId);
    if (!order) return;
    
    if (confirm(`Are you sure you want to reject this order from ${order.customerName}?`)) {
        order.status = 'rejected';
        order.rejectedDate = new Date().toISOString();
        
        saveMarketplaceData();
        updateMarketplaceStats();
        filterOrderManagement();
        
        document.getElementById('order-details-dialog').close();
        showMessage(`Order rejected. Notification sent to ${order.customerEmail}`, 'info');
        addNotification(`Order rejected for ${order.customerName} - ${order.productName}`, 'warning');
    }
}

// Post asset
function postAsset() {
    const name = document.getElementById('asset-name').value.trim();
    const description = document.getElementById('asset-description').value.trim();
    const startingBid = parseFloat(document.getElementById('asset-starting-bid').value);
    
    if (!name || !description || isNaN(startingBid) || startingBid <= 0) {
        showMessage('Please fill all required fields with valid values', 'error');
        return;
    }
    
    const businessSettings = JSON.parse(localStorage.getItem('epsilon_account_settings') || '{}');
    const businessName = businessSettings.businessName || 'Unknown Business';
    
    const asset = {
        id: generateId(),
        name: name,
        description: description,
        startingBid: startingBid,
        businessName: businessName,
        postedDate: new Date().toISOString(),
        image: null
    };
    
    const imageInput = document.getElementById('asset-image');
    if (imageInput.files && imageInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            asset.image = e.target.result;
            saveAsset();
        };
        reader.readAsDataURL(imageInput.files[0]);
    } else {
        saveAsset();
    }
    
    function saveAsset() {
        marketplaceAssets.push(asset);
        saveMarketplaceData();
        
        document.getElementById('asset-name').value = '';
        document.getElementById('asset-description').value = '';
        document.getElementById('asset-starting-bid').value = '';
        document.getElementById('asset-image').value = '';
        
        document.getElementById('post-asset-dialog').close();
        showMessage(`Asset "${name}" posted for bidding successfully!`, 'success');
        renderAssetBidsList();
    }
}

// View asset bids
function viewAssetBids(assetId) {
    const asset = marketplaceAssets.find(a => a.id === assetId);
    if (!asset) return;
    
    const bidsForAsset = assetBids.filter(b => b.assetId === assetId);
    
    const modal = document.createElement('dialog');
    modal.style.width = '500px';
    modal.innerHTML = `
        <div class="modal-header">
            <h3>${asset.name} - Bids</h3>
            <button class="close-button" onclick="this.closest('dialog').close()">&times;</button>
        </div>
        <div style="max-height: 400px; overflow-y: auto; padding: 15px; border: 1px solid var(--color-border-light); border-radius: 8px; margin-bottom: 15px;">
            ${bidsForAsset.length === 0 ? `<p style="text-align: center; color: #9ca3af;">No bids yet. Starting bid: ${formatAmount(asset.startingBid)}</p>` : bidsForAsset.map((bid, idx) => `
                <div style="padding: 12px; border-bottom: 1px solid var(--color-border-light); margin-bottom: 8px;">
                    <div style="font-weight: 600;">Bid #${idx + 1}</div>
                    <div style="font-size: 14px; color: var(--color-primary); margin: 4px 0;">${formatAmount(bid.amount)}</div>
                    <div style="font-size: 12px; color: var(--color-text-medium);">By: ${bid.bidderName}</div>
                    <div style="font-size: 12px; color: var(--color-text-medium);">Email: ${bid.bidderEmail}</div>
                    <div style="font-size: 12px; color: var(--color-text-medium);">Date: ${new Date(bid.bidDate).toLocaleDateString()}</div>
                </div>
            `).join('')}
        </div>
        <button onclick="this.closest('dialog').close()" class="button button-secondary" style="width: 100%;">Close</button>
    `;
    
    document.body.appendChild(modal);
    modal.showModal();
    
    setTimeout(() => lucide.createIcons(), 100);
}

// Submit order
function submitOrder() {
    const productId = document.getElementById('order-product-id').value;
    const productName = document.getElementById('order-product-name').value;
    const price = parseFloat(document.getElementById('order-product-price').value);
    const quantity = parseInt(document.getElementById('order-quantity').value);
    const customerName = document.getElementById('order-customer-name').value.trim();
    const customerEmail = document.getElementById('order-customer-email').value.trim();
    const customerPhone = document.getElementById('order-customer-phone').value.trim();
    const pickupLocation = document.getElementById('order-pickup-location').value.trim();
    const downPayment = parseFloat(document.getElementById('order-downpayment').value) || 0;
    const installmentPlan = document.getElementById('order-installation-plan').value;
    const paymentPerInstallation = parseFloat(document.getElementById('order-payment-per-installation').value) || 0;
    const notes = document.getElementById('order-notes').value.trim();
    
    if (!productId || !productName || isNaN(price)) {
        showMessage('Invalid product information', 'error');
        return;
    }
    
    if (!customerName || !customerEmail || !pickupLocation || !customerPhone) {
        showMessage('Please fill all required fields', 'error');
        return;
    }
    
    // Check if this is a product or service
    let item = marketplaceProducts.find(p => p.id === productId);
    let isService = false;
    
    if (!item) {
        item = marketplaceServices.find(s => s.id === productId);
        isService = true;
    }
    
    if (!item) {
        showMessage('Item not found', 'error');
        return;
    }
    
    // For products, check stock
    if (!isService) {
        if (isNaN(quantity) || quantity <= 0) {
            showMessage('Invalid quantity', 'error');
            return;
        }
        
        if (quantity > item.stock) {
            showMessage(`Only ${item.stock} units available`, 'error');
            return;
        }
    }
    
    const finalQuantity = isService ? 1 : quantity;
    const total = price * finalQuantity;
    
    // Create order
    const order = {
        id: generateId(),
        productId: productId,
        productName: productName,
        businessName: item.businessName,
        businessId: getBusinessIdByProductName(productName),
        price: price,
        quantity: finalQuantity,
        total: total,
        customerName: customerName,
        customerEmail: customerEmail,
        customerPhone: customerPhone,
        pickupLocation: pickupLocation,
        downPayment: downPayment > 0 ? downPayment : null,
        installmentPlan: installmentPlan || null,
        paymentPerInstallation: installmentPlan && paymentPerInstallation > 0 ? paymentPerInstallation : null,
        notes: notes,
        status: 'ordered',
        orderDate: new Date().toISOString(),
        itemType: isService ? 'service' : 'product'
    };
    
    marketplaceOrders.push(order);
    saveMarketplaceData();
    updateMarketplaceStats();
    
    // Update product stock only if it's a product
    if (!isService) {
        item.stock -= finalQuantity;
        
        // Update original product in catalog
        if (productCatalog[productName]) {
            productCatalog[productName].stock = item.stock;
            saveData();
        }
    }
    
    document.getElementById('order-product-dialog').close();
    showMessage(`Order placed successfully! Total: ${formatAmount(order.total)}`, 'success');
    
    // Notify business
    notifyBusinessOfOrder(order);
}

// Get business ID by product name
function getBusinessIdByProductName(productName) {
    // In a real implementation, you would have a proper way to track this
    // For this demo, we'll use a simplified approach
    const businessSettings = JSON.parse(localStorage.getItem('epsilon_account_settings') || '{}');
    return businessSettings.businessId || 'default-business';
}

// Notify business of new order
function notifyBusinessOfOrder(order) {
    // In a real implementation, you would send a notification to the business
    // For this demo, we'll just add it to the notifications
    const message = `New order for ${order.quantity} x ${order.productName} from ${order.customerName}. Total: ${formatAmount(order.total)}`;
    addNotification(message, 'info');
}

// Render my orders
function renderMyOrders() {
    const ordersList = document.getElementById('my-orders-list');
    if (!ordersList) return;
    
    // Get business settings
    const businessSettings = JSON.parse(localStorage.getItem('epsilon_account_settings') || '{}');
    const businessName = businessSettings.businessName || 'Unknown Business';
    
    // Filter orders for this business
    const businessOrders = marketplaceOrders.filter(order => order.businessName === businessName);
    
    if (businessOrders.length === 0) {
        ordersList.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 20px;">No orders yet.</p>';
        return;
    }
    
    // Sort orders by date (newest first)
    businessOrders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));
    
    ordersList.innerHTML = businessOrders.map(order => `
        <div class="list-item" style="border-left: 4px solid ${order.status === 'delivered' ? 'var(--color-secondary)' : 'var(--color-orange)'};">
            <div style="flex-grow: 1;">
                <div class="list-item-main">${order.quantity} x ${order.productName}</div>
                <div class="list-item-detail">Customer: ${order.customerName}</div>
                <div class="list-item-detail">Email: ${order.customerEmail}</div>
                <div class="list-item-detail">Pickup: ${order.pickupLocation}</div>
                <div class="list-item-detail">Total: ${formatAmount(order.total)}</div>
                <div class="list-item-detail">Order Date: ${new Date(order.orderDate).toLocaleDateString()}</div>
                ${order.notes ? `<div class="list-item-detail">Notes: ${order.notes}</div>` : ''}
            </div>
            <div style="text-align: right;">
                <span class="order-status ${order.status === 'delivered' ? 'status-delivered' : 'status-ordered'}">${order.status}</span>
                <button onclick="viewOrderDetails('${order.id}')" class="button button-secondary" style="margin-top: 8px;">View Details</button>
            </div>
        </div>
    `).join('');
}

// Filter my orders
function filterMyOrders() {
    const filter = document.getElementById('orders-filter').value;
    
    // Get business settings
    const businessSettings = JSON.parse(localStorage.getItem('epsilon_account_settings') || '{}');
    const businessName = businessSettings.businessName || 'Unknown Business';
    
    // Filter orders for this business
    let businessOrders = marketplaceOrders.filter(order => order.businessName === businessName);
    
    if (filter !== 'all') {
        businessOrders = businessOrders.filter(order => order.status === filter);
    }
    
    // Sort orders by date (newest first)
    businessOrders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));
    
    const ordersList = document.getElementById('my-orders-list');
    if (!ordersList) return;
    
    if (businessOrders.length === 0) {
        ordersList.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 20px;">No orders match your filter.</p>';
        return;
    }
    
    ordersList.innerHTML = businessOrders.map(order => `
        <div class="list-item" style="border-left: 4px solid ${order.status === 'delivered' ? 'var(--color-secondary)' : 'var(--color-orange)'};">
            <div style="flex-grow: 1;">
                <div class="list-item-main">${order.quantity} x ${order.productName}</div>
                <div class="list-item-detail">Customer: ${order.customerName}</div>
                <div class="list-item-detail">Email: ${order.customerEmail}</div>
                <div class="list-item-detail">Pickup: ${order.pickupLocation}</div>
                <div class="list-item-detail">Total: ${formatAmount(order.total)}</div>
                <div class="list-item-detail">Order Date: ${new Date(order.orderDate).toLocaleDateString()}</div>
                ${order.notes ? `<div class="list-item-detail">Notes: ${order.notes}</div>` : ''}
            </div>
            <div style="text-align: right;">
                <span class="order-status ${order.status === 'delivered' ? 'status-delivered' : 'status-ordered'}">${order.status}</span>
                <button onclick="viewOrderDetails('${order.id}')" class="button button-secondary" style="margin-top: 8px;">View Details</button>
            </div>
        </div>
    `).join('');
}

// View order details
function viewOrderDetails(orderId) {
    const order = marketplaceOrders.find(o => o.id === orderId);
    if (!order) return;
    
    document.getElementById('order-details-id').value = orderId;
    
    const detailsContent = document.getElementById('order-details-content');
    detailsContent.innerHTML = `
        <div class="order-detail-row">
            <div class="order-detail-label">Product:</div>
            <div class="order-detail-value">${order.quantity} x ${order.productName}</div>
        </div>
        <div class="order-detail-row">
            <div class="order-detail-label">Total:</div>
            <div class="order-detail-value">${formatAmount(order.total)}</div>
        </div>
        <div class="order-detail-row">
            <div class="order-detail-label">Customer:</div>
            <div class="order-detail-value">${order.customerName}</div>
        </div>
        <div class="order-detail-row">
            <div class="order-detail-label">Email:</div>
            <div class="order-detail-value">${order.customerEmail}</div>
        </div>
        <div class="order-detail-row">
            <div class="order-detail-label">Pickup Location:</div>
            <div class="order-detail-value">${order.pickupLocation}</div>
        </div>
        <div class="order-detail-row">
            <div class="order-detail-label">Order Date:</div>
            <div class="order-detail-value">${new Date(order.orderDate).toLocaleDateString()}</div>
        </div>
        <div class="order-detail-row">
            <div class="order-detail-label">Status:</div>
            <div class="order-detail-value">${order.status}</div>
        </div>
        ${order.notes ? `
            <div class="order-detail-row">
                <div class="order-detail-label">Notes:</div>
                <div class="order-detail-value">${order.notes}</div>
            </div>
        ` : ''}
    `;
    
    const orderActions = document.getElementById('order-actions');
    if (order.status === 'ordered') {
        orderActions.innerHTML = `
            <button onclick="markAsDelivered('${orderId}')" class="button button-primary" style="width: 100%;">Mark as Delivered</button>
        `;
    } else {
        orderActions.innerHTML = `
            <p style="text-align: center; color: var(--color-secondary); margin: 20px 0;">This order has been delivered.</p>
        `;
    }
    
    document.getElementById('order-details-dialog').showModal();
}

// Mark order as delivered
function markAsDelivered(orderId) {
    const order = marketplaceOrders.find(o => o.id === orderId);
    if (!order) return;
    
    // Show confirmation dialog
    document.getElementById('delivery-confirmation-message').textContent = 
        `Are you sure you want to mark this order as delivered? The customer (${order.customerName}) will receive a confirmation.`;
    
    document.getElementById('delivery-confirmation-dialog').showModal();
    
    // Store the order ID for confirmation
    document.getElementById('delivery-confirmation-dialog').setAttribute('data-order-id', orderId);
}

// Confirm delivery
function confirmDelivery() {
    const orderId = document.getElementById('delivery-confirmation-dialog').getAttribute('data-order-id');
    const order = marketplaceOrders.find(o => o.id === orderId);
    
    if (!order) return;
    
    // Update order status
    order.status = 'delivered';
    order.deliveredDate = new Date().toISOString();
    
    // Add to sales history for revenue tracking
    // Determine if this is a product or service
    const isProduct = marketplaceProducts.some(p => p.id === order.productId);
    const isService = marketplaceServices.some(s => s.id === order.productId);
    
    if (isProduct) {
        // Find the product to get details
        const product = marketplaceProducts.find(p => p.id === order.productId);
        if (product) {
            // Add sales history entry
            const saleEntry = {
                product: product.name,
                quantity: order.quantity,
                unitPrice: order.price,
                date: new Date().toISOString(),
                businessName: order.businessName,
                type: 'marketplace'
            };
            salesHistory.push(saleEntry);
            
            // Reduce product stock
            const catalogProduct = productCatalog[product.name];
            if (catalogProduct) {
                catalogProduct.stock -= order.quantity;
                if (catalogProduct.stock < 0) catalogProduct.stock = 0;
            }
        }
    } else if (isService) {
        // Find the service to get details
        const service = marketplaceServices.find(s => s.id === order.productId);
        if (service) {
            // Add sales history entry for service
            const saleEntry = {
                product: service.name,
                quantity: 1,
                unitPrice: service.price,
                date: new Date().toISOString(),
                businessName: order.businessName,
                type: 'marketplace_service'
            };
            salesHistory.push(saleEntry);
        }
    }
    
    saveMarketplaceData();
    saveData();
    updateMarketplaceStats();
    updateTotals();
    
    // Close dialogs
    document.getElementById('delivery-confirmation-dialog').close();
    document.getElementById('order-details-dialog').close();
    
    // Re-render orders
    renderMyOrders();
    
    showMessage('Order marked as delivered', 'success');
    
    // In a real implementation, you would send a notification to the customer
    // For this demo, we'll just show a message
    showMessage(`Delivery confirmation sent to ${order.customerName} at ${order.customerEmail}`, 'info');
}

// Add marketplace page to navigation
function addMarketplaceToNavigation() {
    const navLinks = document.querySelector('.nav-links');
    if (!navLinks) return;
    
    // Check if marketplace button already exists
    if (document.querySelector('[data-page="marketplace-page"]')) return;
    
    const marketplaceButton = document.createElement('button');
    marketplaceButton.className = 'nav-button';
    marketplaceButton.setAttribute('data-page', 'marketplace-page');
    marketplaceButton.setAttribute('onclick', 'showPage(\'marketplace-page\'); closeSidebarOnMobile();');
    marketplaceButton.innerHTML = `
        <i data-lucide="shopping-cart"></i>
        <span>Marketplace</span>
    `;
    
    navLinks.appendChild(marketplaceButton);
    
    // Re-create Lucide icons
    setTimeout(() => lucide.createIcons(), 100);
}

// Initialize marketplace when page is shown
document.addEventListener('DOMContentLoaded', () => {
    // Add marketplace to navigation
    addMarketplaceToNavigation();
    
    // Override showPage function to handle marketplace
    const originalShowPage = window.showPage;
    window.showPage = function(pageId) {
        originalShowPage(pageId);
        
        if (pageId === 'marketplace-page') {
            populateProductSelect();
            updateMarketplaceStats();
            renderMarketplaceProducts();
        }
    };
});

// ===== BUSINESS SHOWCASE FUNCTIONALITY =====

let businessesData = JSON.parse(localStorage.getItem('epsilon_businesses') || '[]');
let currentViewingBusiness = null;
let followedBusinesses = JSON.parse(localStorage.getItem('epsilon_followed_businesses') || '[]');

// Sample businesses if none exist
function initializeSampleBusinesses() {
    if (businessesData.length === 0) {
        businessesData = [
            {
                id: 1,
                name: 'TechHub Solutions',
                owner: 'John Smith',
                category: 'Technology',
                description: 'Leading provider of software development and IT consulting services.',
                logo: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%233b82f6" width="100" height="100"/%3E%3Ctext x="50" y="50" font-size="40" fill="white" text-anchor="middle" dominant-baseline="middle"%3ETH%3C/text%3E%3C/svg%3E',
                products: [
                    { id: 1, name: 'Web Development', category: 'Services', price: 5000, stock: 20, description: 'Custom web development services' },
                    { id: 2, name: 'Mobile App Dev', category: 'Services', price: 8000, stock: 15, description: 'iOS and Android app development' }
                ],
                services: [
                    { id: 3, name: 'Consulting', category: 'Consulting', price: 150, description: 'IT strategy and consulting' }
                ]
            },
            {
                id: 2,
                name: 'Fresh Farms Co',
                owner: 'Maria Garcia',
                category: 'Food & Beverage',
                description: 'Organic farm products and fresh produce delivery.',
                logo: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%2310b981" width="100" height="100"/%3E%3Ctext x="50" y="50" font-size="40" fill="white" text-anchor="middle" dominant-baseline="middle"%3EFF%3C/text%3E%3C/svg%3E',
                products: [
                    { id: 4, name: 'Organic Vegetables', category: 'Food', price: 25, stock: 100, description: 'Fresh organic vegetables' },
                    { id: 5, name: 'Fresh Fruits', category: 'Food', price: 30, stock: 80, description: 'Seasonal fresh fruits' }
                ],
                services: []
            },
            {
                id: 3,
                name: 'ProDesign Studio',
                owner: 'Alex Chen',
                category: 'Services',
                description: 'Creative design services for brands and businesses.',
                logo: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23f59e0b" width="100" height="100"/%3E%3Ctext x="50" y="50" font-size="40" fill="white" text-anchor="middle" dominant-baseline="middle"%3EPD%3C/text%3E%3C/svg%3E',
                products: [
                    { id: 6, name: 'Logo Design', category: 'Services', price: 500, stock: 50, description: 'Professional logo design' },
                    { id: 7, name: 'Brand Guidelines', category: 'Services', price: 1200, stock: 30, description: 'Complete brand identity packages' }
                ],
                services: [
                    { id: 8, name: 'Graphic Design', category: 'Design', price: 75, description: 'Per hour graphic design services' }
                ]
            },
            {
                id: 4,
                name: 'ElectroMart',
                owner: 'Robert Wilson',
                category: 'Retail',
                description: 'Your one-stop shop for electronics and gadgets.',
                logo: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%23ef4444" width="100" height="100"/%3E%3Ctext x="50" y="50" font-size="40" fill="white" text-anchor="middle" dominant-baseline="middle"%3EEM%3C/text%3E%3C/svg%3E',
                products: [
                    { id: 9, name: 'USB-C Cables', category: 'Electronics', price: 15, stock: 200, description: 'Durable USB-C charging cables' },
                    { id: 10, name: 'Wireless Headphones', category: 'Electronics', price: 80, stock: 50, description: 'Premium wireless headphones' }
                ],
                services: []
            }
        ];
        saveBusinessesData();
    }
}

function saveBusinessesData() {
    localStorage.setItem('epsilon_businesses', JSON.stringify(businessesData));
}

function saveFollowedBusinesses() {
    localStorage.setItem('epsilon_followed_businesses', JSON.stringify(followedBusinesses));
}

function toggleFollowBusiness(businessId) {
    const index = followedBusinesses.indexOf(businessId);
    if (index > -1) {
        followedBusinesses.splice(index, 1);
    } else {
        followedBusinesses.push(businessId);
    }
    saveFollowedBusinesses();
    renderBusinesses();
}

function getUserBusinessInfo() {
    const accountSettings = JSON.parse(localStorage.getItem('epsilon_account_settings') || '{}');
    return {
        name: accountSettings.businessName || 'My Business',
        owner: accountSettings.ownerName || 'Business Owner',
        logo: accountSettings.businessLogo || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%233b82f6" width="100" height="100"/%3E%3Ctext x="50" y="50" font-size="40" fill="white" text-anchor="middle" dominant-baseline="middle"%3EMB%3C/text%3E%3C/svg%3E',
        location: accountSettings.location || '',
        businessType: accountSettings.businessType || 'Other'
    };
}

function getUserBusinessProducts() {
    const products = [];
    if (productCatalog) {
        Object.entries(productCatalog).forEach(([name, details]) => {
            products.push({
                name: name,
                price: details.sellingPrice || 0,
                stock: details.stock || 0,
                category: 'Product',
                description: `Selling Price: ${formatAmount(details.sellingPrice)}`
            });
        });
    }
    if (serviceCatalog) {
        Object.entries(serviceCatalog).forEach(([name, details]) => {
            products.push({
                name: name,
                price: details.price || 0,
                stock: 0,
                category: details.category || 'Service',
                description: details.description || `Duration: ${details.duration || 0} mins`
            });
        });
    }
    return products;
}

function renderBusinesses(businesses = businessesData) {
    const grid = document.getElementById('businesses-grid');
    const noMessage = document.getElementById('no-businesses-message');
    
    if (!grid) return;
    
    grid.innerHTML = '';
    
    const userBusiness = getUserBusinessInfo();
    const userProducts = getUserBusinessProducts();
    const totalItems = userProducts.length;
    
    const userCard = document.createElement('div');
    userCard.className = 'business-card';
    userCard.style.border = '3px solid #3b82f6';
    userCard.style.backgroundColor = '#f0f9ff';
    userCard.onclick = () => showUserBusinessDetail();
    
    const logo = userBusiness.logo.startsWith('data:') ? userBusiness.logo : 
                 (document.getElementById('business-logo-img')?.src || userBusiness.logo);
    
    userCard.innerHTML = `
        <div class="business-logo">
            <img src="${logo}" alt="${userBusiness.name}" style="border: 2px solid #3b82f6;">
        </div>
        <div class="business-info">
            <h3 class="business-name" style="color: #3b82f6;">${userBusiness.name}</h3>
            <p class="business-owner">By ${userBusiness.owner}</p>
            <span class="business-category">${userBusiness.businessType}</span>
            ${userBusiness.location ? `<p class="business-description">${userBusiness.location}</p>` : ''}
            <div class="business-stats">
                <span> YOUR BUSINESS</span>
            </div>
            <div class="business-stats">
                <span>${totalItems} products & services</span>
            </div>
        </div>
    `;
    
    grid.appendChild(userCard);
    
    if (businesses.length === 0) {
        noMessage.style.display = 'none';
        return;
    }
    
    noMessage.style.display = 'none';
    
    businesses.forEach(business => {
        const card = document.createElement('div');
        card.className = 'business-card';
        card.onclick = () => showBusinessDetail(business.id);

        const isFollowed = followedBusinesses.includes(business.id);

        card.innerHTML = `
            <div class="business-logo">
                <img src="${business.logo}" alt="${business.name}">
            </div>
            <div class="business-info">
                <h3 class="business-name">${business.name}</h3>
                <p class="business-owner">By ${business.owner}</p>
                <span class="business-category">${business.category}</span>
                <p class="business-description">${business.description}</p>
                <div class="business-stats">
                    <span>${(business.products || []).length + (business.services || []).length} products & services</span>
                </div>
                <button class="follow-btn ${isFollowed ? 'followed' : ''}" onclick="event.stopPropagation(); toggleFollowBusiness(${business.id})">
                    ${isFollowed ? 'Unfollow' : 'Follow'}
                </button>
            </div>
        `;

        grid.appendChild(card);
    });
}

function filterBusinesses() {
    const searchTerm = document.getElementById('business-search')?.value.toLowerCase() || '';
    const category = document.getElementById('business-category-filter')?.value || '';
    
    let filtered = businessesData.filter(business => {
        const matchesSearch = business.name.toLowerCase().includes(searchTerm) ||
                             business.owner.toLowerCase().includes(searchTerm) ||
                             business.description.toLowerCase().includes(searchTerm);
        const matchesCategory = !category || business.category === category;
        
        return matchesSearch && matchesCategory;
    });
    
    renderBusinesses(filtered);
}

function showUserBusinessDetail() {
    const userBusiness = getUserBusinessInfo();
    
    const logo = userBusiness.logo.startsWith('data:') ? userBusiness.logo : 
                 (document.getElementById('business-logo-img')?.src || userBusiness.logo);
    
    document.getElementById('detail-business-name').textContent = userBusiness.name;
    document.getElementById('detail-business-owner').textContent = `Owner: ${userBusiness.owner}`;
    document.getElementById('detail-business-category').textContent = userBusiness.businessType;
    document.getElementById('detail-business-description').textContent = userBusiness.location || 'Your Business';
    document.getElementById('detail-business-logo').src = logo;
    
    renderUserBusinessProducts();
    
    showPage('business-detail-page');
}

function showBusinessDetail(businessId) {
    const business = businessesData.find(b => b.id === businessId);
    if (!business) return;
    
    currentViewingBusiness = business;
    
    document.getElementById('detail-business-name').textContent = business.name;
    document.getElementById('detail-business-owner').textContent = `Owner: ${business.owner}`;
    document.getElementById('detail-business-category').textContent = business.category;
    document.getElementById('detail-business-description').textContent = business.description;
    document.getElementById('detail-business-logo').src = business.logo;
    
    renderBusinessProducts(business);
    
    showPage('business-detail-page');
}

function renderUserBusinessProducts() {
    const grid = document.getElementById('business-products-grid');
    const noMessage = document.getElementById('no-products-message');
    
    if (!grid) return;
    
    const userProducts = getUserBusinessProducts();
    const userBusiness = getUserBusinessInfo();
    
    grid.innerHTML = '';
    
    if (userProducts.length === 0) {
        noMessage.style.display = 'block';
        return;
    }
    
    noMessage.style.display = 'none';
    
    userProducts.forEach(item => {
        const card = document.createElement('div');
        card.className = 'product-card';
        
        const gradient = item.category === 'Product' ? 
            'linear-gradient(135deg, #3b82f6 0%, #1e40af 100%)' : 
            'linear-gradient(135deg, #10b981 0%, #047857 100%)';
        
        card.innerHTML = `
            <div class="product-image" style="background: ${gradient}; color: white; font-size: 16px;">
                ${item.category}
            </div>
            <div class="product-details">
                <h4 class="product-name">${item.name}</h4>
                <span class="product-category">${item.category}</span>
                <p class="product-description">${item.description}</p>
                <p class="product-price">${formatAmount(item.price)}</p>
                ${item.stock > 0 ? `<p class="product-stock">Stock: ${item.stock} units</p>` : ''}
                <p class="product-business">${userBusiness.name}</p>
            </div>
        `;
        
        grid.appendChild(card);
    });
}

function renderBusinessProducts(business) {
    const grid = document.getElementById('business-products-grid');
    const noMessage = document.getElementById('no-products-message');
    
    if (!grid) return;
    
    const allItems = [...(business.products || []), ...(business.services || [])];
    
    grid.innerHTML = '';
    
    if (allItems.length === 0) {
        noMessage.style.display = 'block';
        return;
    }
    
    noMessage.style.display = 'none';
    
    allItems.forEach(item => {
        const card = document.createElement('div');
        card.className = 'product-card';
        
        card.innerHTML = `
            <div class="product-image" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 16px;">
                ${item.category}
            </div>
            <div class="product-details">
                <h4 class="product-name">${item.name}</h4>
                <span class="product-category">${item.category}</span>
                <p class="product-description">${item.description}</p>
                <p class="product-price">$${item.price}</p>
                ${item.stock ? `<p class="product-stock">Stock: ${item.stock} units</p>` : ''}
                <p class="product-business">${business.name}</p>
            </div>
        `;
        
        grid.appendChild(card);
    });
}

function addBusinessShowcaseToNavigation() {
    const navLinks = document.querySelector('.nav-links');
    if (!navLinks) return;
    
    if (document.querySelector('[data-page="business-showcase-page"]')) return;
    
    const showcaseButton = document.createElement('button');
    showcaseButton.className = 'nav-button';
    showcaseButton.setAttribute('data-page', 'business-showcase-page');
    showcaseButton.setAttribute('onclick', 'showPage(\'business-showcase-page\'); closeSidebarOnMobile();');
    showcaseButton.innerHTML = `
        <i data-lucide="briefcase"></i>
        <span>Business Showcase</span>
    `;
    
    navLinks.appendChild(showcaseButton);
    
    setTimeout(() => lucide.createIcons(), 100);
}

// Initialize business showcase
document.addEventListener('DOMContentLoaded', () => {
    initializeSampleBusinesses();
    addBusinessShowcaseToNavigation();
    renderBusinesses();
    
    const originalShowPage = window.showPage;
    window.showPage = function(pageId) {
        originalShowPage(pageId);
        
        if (pageId === 'business-showcase-page') {
            renderBusinesses();
        }
    };
});
    </script>
    <script>
(function() {
    // --- 1. LOADER UTILITIES ---
    function loadResource(type, url) {
        if (type === 'css') {
            if (!document.querySelector(`link[href="${url}"]`)) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = url;
                document.head.appendChild(link);
            }
        } else if (type === 'js') {
            if (!document.querySelector(`script[src="${url}"]`)) {
                const script = document.createElement('script');
                script.src = url;
                script.onload = initTourSystem;
                document.body.appendChild(script);
            } else {
                initTourSystem();
            }
        }
    }

    // Load Libraries
    loadResource('css', 'https://unpkg.com/intro.js/minified/introjs.min.css');
    loadResource('css', 'https://unpkg.com/intro.js/themes/introjs-modern.css');
    loadResource('js', 'https://unpkg.com/intro.js/minified/intro.min.js');

    // --- 2. CONFIGURATION ---
    // Mapped precisely to IDs in your provided HTML
    const getTourConfig = () => ({
        'dashboard-page': [
            { intro: "Welcome to your <b>Financial Dashboard</b>. This is your mission control." },
            { element: '.header-section', intro: "<b>Global Header:</b> Access the sidebar toggle, profile, and app title here." },
            { element: '.global-search-container', intro: "<b>Global Search:</b> Quickly find any product, client, or transaction across the app." },
            { element: 'button[onclick="openWidgetsDialog()"]', intro: "<b>Widgets:</b> Quick access to tools like Quick Sale and Calculator without leaving the screen." },
            { element: '.kpi-grid', intro: "<b>Live Financials:</b> Real-time view of Revenue, Deductions, Costs, and Net Profit." },
            { element: '.card-budget', intro: "<b>Budget Tracker:</b> Visualizes your spending against your limit. Click 'Set Budget' to configure." },
            { element: '.form-layout-grid .form-box', intro: "<b>Quick Sale:</b> Record a transaction instantly here." }
        ],
        'sales-history-page': [
            { intro: "<b>Sales History:</b> A detailed ledger of every transaction." },
            { element: '#sales-search', intro: "<b>Search Ledger:</b> Filter by product name to find specific sales." },
            { element: '#history-list', intro: "<b>Transaction List:</b> Shows product, quantity, unit price, and calculated profit per sale." }
        ],
        'inventory-page': [
            { intro: "<b>Product Catalog:</b> Manage your stock and pricing." },
            { element: '.kpi-grid', intro: "<b>Stock Alerts:</b> Immediate indicators for Out of Stock, Low Stock, and Expired items." },
            { element: 'button[onclick*="new-product-dialog"]', intro: "<b>Add Product:</b> Register a new item with buying/selling price and stock levels." },
            { element: 'button[onclick*="newCatalogDialog"]', intro: "<b>Catalogs:</b> Organize products into specific groups (e.g., 'Summer Sale')." },
            { element: '#products-search', intro: "<b>Inventory Search:</b> Quickly locate items to edit stock." },
            { element: '#product-list-container', intro: "<b>The Grid:</b> Your products appear here. Buttons on cards allow for Editing Stock or Deletion." }
        ],
        'deductions-page': [
            { intro: "<b>Fixed Deductions:</b> Manage recurring bills and employees." },
            { element: '.kpi-grid', intro: "<b>Expense Overview:</b> See total committed costs vs actual paid amounts." },
            { element: 'button[onclick*="new-deduction-dialog"]', intro: "<b>Add Expense:</b> Record a new bill (Rent, Internet, etc)." },
            { element: 'button[onclick*="new-employee-dialog"]', intro: "<b>Add Employee:</b> Register staff to track payroll costs." },
            { element: '#deductions-list', intro: "<b>Bills List:</b> Toggle 'Paid/Unpaid' status here." },
            { element: '#employees-list', intro: "<b>Staff List:</b> View and manage your team." }
        ],
        'pos-page': [
            { intro: "<b>Point of Sale:</b> The checkout interface." },
            { element: '.pos-mode-buttons', intro: "<b>Mode Switch:</b> Toggle between selling physical 'Products' or intangible 'Services'." },
            { element: '#pos-search', intro: "<b>Item Search:</b> Quickly find items to add to the bill." },
            { element: '#pos-products-grid', intro: "<b>Item Grid:</b> Click cards here to add them to the cart." },
            { element: '#pos-cart', intro: "<b>Active Cart:</b> Review items, adjust quantities, and see the subtotal." },
            { element: 'button[onclick="completePOSSale()"]', intro: "<b>Checkout:</b> Finalize the sale. This updates inventory and revenue automatically." }
        ],
        'AI-page': [
            { intro: "<b>Epsilon Nexus:</b> Your AI Assistant." },
            { element: '#chat-header', intro: "<b>Status:</b> Shows AI status and session ID." },
            { element: '#user-input', intro: "<b>Input:</b> Type your business questions here (e.g., 'How is my profit?')." },
            { element: '#image-button', intro: "<b>Image Mode:</b> Switch to AI Image Generation." },
            { element: '#code-button', intro: "<b>Coding Mode:</b> Switch to Coding Assistant mode." },
            { element: '#file-button', intro: "<b>Analyze:</b> Upload documents (PDF/CSV) for the AI to read." },
            { element: '.collapse-toggle', intro: "<b>Float/Dock:</b> Minimize the chat to a floating window." }
        ],
        'lab-page': [
            { intro: "<b>AI Lab:</b> Advanced predictive tools." },
            { element: '#smart-insights', intro: "<b>Auto-Insights:</b> The AI analyzes your data and posts key findings here automatically." },
            { element: 'button[onclick="runSalesForecast()"]', intro: "<b>Forecast:</b> Predict revenue for the next 30 days based on history." },
            { element: 'button[onclick="optimizePricing()"]', intro: "<b>Pricing AI:</b> Get suggestions on optimal price points." },
            { element: 'button[onclick="analyzeTrends()"]', intro: "<b>Trend Analysis:</b> Identify best-selling products and risks." },
            { element: '#whatif-results', intro: "<b>Scenario Simulator:</b> Test 'What If' scenarios (e.g., cost increase) safely." },
            { element: '.ai-lab-tools-container', intro: "<b>Advanced Tools:</b> Access Warehouse Mapping, Demand Forecasting, and Customer Segmentation." }
        ],
        'chartsPage': [
            { intro: "<b>Charts & Data:</b> Visual analytics." },
            { element: '.chart-tabs', intro: "<b>Navigation:</b> Switch between Bar, Pie, Trend, and Advanced charts." },
            { element: '#chart-timeline', intro: "<b>Timeframe:</b> Filter charts by 7, 30, 90 days or All Time." },
            { element: '.chart-container', intro: "<b>Visualization:</b> Interact with the graph here." }
        ],
        // Mapped sub-pages for charts so the button works even if user navigated via tab
        'pie-page-chart': [{ intro: "<b>Pie Charts:</b> View product contribution distributions." }, { element: '.chart-container', intro: "Visual breakdown of revenue sources." }],
        'lineChart': [{ intro: "<b>Trend Lines:</b> View performance over time." }, { element: '.chart-container', intro: "Track growth or decline." }],
        'deductions-chart-page': [{ intro: "<b>Expense Analysis:</b> Visual breakdown of costs." }, { element: '.chart-container', intro: "See where your money is going." }],
        'p-s-d': [{ intro: "<b>Stock Analysis:</b> Inventory levels visualization." }, { element: '.chart-container', intro: "Track stock quantities." }],
        'advanced-charts': [{ intro: "<b>Advanced Metrics:</b> Complex financial ratios." }, { element: '.chart-grid', intro: "Compare multiple advanced metrics." }],

        'Clients': [
            { intro: "<b>CRM:</b> Manage Clients and Contractors." },
            { element: '.kpi-grid', intro: "<b>Stats:</b> Active contacts and total clients." },
            { element: 'button[onclick*="client-dialog"]', intro: "<b>Add Contact:</b> Register a new entity." },
            { element: '#client-list', intro: "<b>Directory:</b> Access contact details and notes." }
        ],
        'warehouse-page': [
            { intro: "<b>Warehouse Ops:</b> Manage physical storage." },
            { element: '.kpi-grid', intro: "<b>Capacity:</b> Total vs Used space." },
            { element: 'button[onclick*="new-warehouse-dialog"]', intro: "<b>New Location:</b> Add a storage facility." },
            { element: 'button[onclick*="transfer-dialog"]', intro: "<b>Transfer Stock:</b> Move items between warehouses." },
            { element: '#warehouse-list', intro: "<b>Locations:</b> View specific stock levels per warehouse." }
        ],
        'news-page': [ // Identified as Tools Page in HTML
            { intro: "<b>Tools & Calculators:</b> Business utilities." },
            { element: 'button[onclick*="scanner-dialog"]', intro: "<b>QR Scanner:</b> Scan barcodes via camera." },
            { element: '.form-box', intro: "<b>Calculators:</b> Use these for Margin, ROI, and Tax calculations." },
            { element: 'input[id="amount"]', intro: "<b>Converter:</b> Real-time currency conversion tool." }
        ],
        'reports-page': [
            { intro: "<b>Reports:</b> Generate official documents." },
            { element: 'button[onclick="generateFinancialReport()"]', intro: "<b>Financial PDF:</b> Download a complete summary." },
            { element: 'button[onclick="generateSalesReport()"]', intro: "<b>Sales PDF:</b> Download transaction logs." },
            { element: 'button[onclick*="receipt-upload"]', intro: "<b>OCR Scanner:</b> Upload receipt images to auto-extract data." }
        ],
        'goals-page': [
            { intro: "<b>Goal Tracker:</b> Set business targets." },
            { element: '.kpi-grid', intro: "<b>Progress:</b> Completion rates." },
            { element: '.form-box', intro: "<b>Set Goal:</b> Define a target (Revenue/Sales) and deadline." },
            { element: '#goals-list', intro: "<b>Active Goals:</b> Monitor your progress bars here." }
        ],
        'settings-page': [
            { intro: "<b>Settings:</b> Configuration." },
            { element: '.settings-container', intro: "<b>Profile:</b> Manage business details." },
            { element: 'button[onclick*="account-settings-dialog"]', intro: "<b>Edit:</b> Update logo and owner info." },
            { element: 'button[onclick*="export-dialog"]', intro: "<b>Backup:</b> Download all data." },
            { element: '.toggle-switch', intro: "<b>Preferences:</b> Toggle notifications and sounds." }
        ],
        'node-editor-page': [
            { intro: "<b>Node Editor:</b> Visual mapping tool." },
            { element: 'button[onclick="addNode()"]', intro: "<b>New Node:</b> Add an element to the canvas." },
            { element: '#graph-container', intro: "<b>Canvas:</b> Right-click nodes to connect or rename them." }
        ],
        'assets-page': [
            { intro: "<b>Asset Management:</b> Track company equipment." },
            { element: '.kpi-grid', intro: "<b>Valuation:</b> Total asset worth." },
            { element: 'button[onclick*="new-asset-dialog"]', intro: "<b>Register:</b> Log new equipment." }
        ],
        'services-page': [
            { intro: "<b>Service Menu:</b> Intangible offerings." },
            { element: 'button[onclick*="new-service-dialog"]', intro: "<b>Add Service:</b> Create a service item." },
            { element: '#services-list', intro: "<b>Menu:</b> View active services." }
        ],
        'marketplace-page': [
            { intro: "<b>Marketplace:</b> B2B Trading." },
            { element: '.kpi-grid', intro: "<b>Orders:</b> Track incoming and outgoing trade." },
            { element: 'button[onclick*="post-product-dialog"]', intro: "<b>Sell:</b> Post an item for sale." },
            { element: '#marketplace-products-grid', intro: "<b>Browse:</b> View listings from others." }
        ],
        'business-showcase-page': [
            { intro: "<b>Showcase:</b> Business directory." },
            { element: '#businesses-grid', intro: "<b>Network:</b> View profiles of other businesses." }
        ]
    });

    // --- 3. HELPER FUNCTIONS ---

    // Filter out steps where the element is missing or hidden
    function validateSteps(steps) {
        if (!steps) return [];
        return steps.filter(step => {
            // Always allow intro-only steps (no element selector)
            if (!step.element) return true;
            
            const el = document.querySelector(step.element);
            // Check if element exists AND has dimensions (is visible)
            if (el && (el.offsetWidth > 0 || el.offsetHeight > 0)) {
                return true;
            }
            console.warn(`Intro.js: Skipped step for '${step.element}' because it's missing or hidden.`);
            return false;
        });
    }

    // Initialize the Help Button
    function initTourSystem() {
        // Prevent duplicate buttons
        if (document.getElementById('epsilon-tour-btn')) return;

        const btn = document.createElement('button');
        btn.id = 'epsilon-tour-btn';
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>';
        btn.title = "Start Page Tour";
        
        // Dynamic Styles
        btn.style.cssText = `
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 10000;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
            animation: tour-pulse 3s infinite;
        `;

        // NEW BUTTON: Ask AI
        const aiBtn = document.createElement('button');
        aiBtn.id = 'epsilon-ai-ask-btn';
        aiBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>';
        aiBtn.title = "Ask AI about this page";
        
        aiBtn.style.cssText = `
            position: fixed;
            bottom: 25px;
            right: 90px;
            z-index: 10000;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        `;
        
        aiBtn.onmouseover = () => {
            aiBtn.style.transform = 'scale(1.15)';
        };
        aiBtn.onmouseout = () => {
            aiBtn.style.transform = 'scale(1)';
        };
        
        aiBtn.onclick = function() {
            askAIAboutCurrentPage();
        };

        // Animation Styles
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes tour-pulse {
                0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); transform: scale(1); }
                70% { box-shadow: 0 0 0 15px rgba(37, 99, 235, 0); transform: scale(1.05); }
                100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); transform: scale(1); }
            }
            .introjs-tooltip {
                font-family: 'Inter', sans-serif !important;
            }
        `;
        document.head.appendChild(styleSheet);

        // Hover Effects
        btn.onmouseover = () => {
            btn.style.animation = 'none';
            btn.style.transform = 'scale(1.15) rotate(10deg)';
        };
        btn.onmouseout = () => {
            btn.style.animation = 'tour-pulse 3s infinite';
            btn.style.transform = 'scale(1)';
        };

        // Click Logic
        btn.onclick = function() {
            // Identify active page
            // Logic: Your app uses "page active" classes. 
            // Fallback: If no .page.active, try to guess based on visible ID or default to dashboard
            const activePage = document.querySelector('.page.active') || 
                               document.querySelector('.page[style*="block"]') ||
                               document.getElementById('dashboard-page');

            if (!activePage) {
                alert("Please navigate to a specific page to start the tour.");
                return;
            }

            const pageId = activePage.id;
            const allTours = getTourConfig();
            
            // Get steps and VALIDATE them against the DOM
            let validSteps = validateSteps(allTours[pageId]);

            // If no steps found for this page, or all were invalid
            if (!validSteps || validSteps.length === 0) {
                introJs().setOptions({
                    steps: [
                        { 
                            intro: `You are currently on the <b>${pageId.replace(/-/g, ' ')}</b>. <br><br>Explore the interface using the buttons visible on screen.` 
                        }
                    ],
                    showButtons: true,
                    showBullets: false
                }).start();
                return;
            }

            // Start the actual tour
            introJs().setOptions({
                steps: validSteps,
                showProgress: true,
                showBullets: false,
                scrollToElement: true,
                disableInteraction: false,
                buttonClass: "button button-primary", // Matches your CSS
            }).start();
        };

        document.body.appendChild(btn);
        document.body.appendChild(aiBtn);
    }

    function askAIAboutCurrentPage() {
        const activePage = document.querySelector('.page.active') || 
                           document.querySelector('.page[style*="block"]') ||
                           document.getElementById('dashboard-page');
                           
        if (!activePage) return;
        
        const pageId = activePage.id;
        let contextData = "";
        
        // Gather data based on page
        if (pageId === 'products-page') {
            const products = Object.values(productCatalog).map(p => `${p.name} ($${p.sellingPrice}, Stock: ${p.stock})`).join(', ');
            contextData = `I am currently on the Products page. Here are the products: ${products}.`;
        } else if (pageId === 'employees-page') {
            const empList = employees.map(e => `${e.name} (${e.position})`).join(', ');
            contextData = `I am currently on the Employees page. Here are the employees: ${empList}.`;
        } else if (pageId === 'dashboard-page') {
            const revenue = document.getElementById('total-revenue') ? document.getElementById('total-revenue').textContent : 'Unknown';
            contextData = `I am on the Dashboard. Total Revenue: ${revenue}.`;
        } else if (pageId === 'marketplace-page') {
            contextData = `I am on the Marketplace page.`;
        } else if (pageId === 'sales-history-page') {
            contextData = `I am on the Sales History page.`;
        } else if (pageId === 'deductions-page') {
            contextData = `I am on the Deductions page.`;
        } else if (pageId === 'warehouse-page') {
            contextData = `I am on the Warehouse Management page.`;
        }
        
        const prompt = `Tell me about this page. ${contextData}`;
        
        // Open AI page
        showPage('AI-page');
        
        // Set input and send
        setTimeout(() => {
            const input = document.getElementById('user-input');
            if (input) {
                input.value = prompt;
                if (window.sendMessage) {
                    window.sendMessage();
                }
            }
        }, 500);
    }
})();
</script>
<script>
// EXTENSIONS SYSTEM
let installedExtensions = JSON.parse(localStorage.getItem('epsilon_extensions') || '[]');

// Pre-populate test extensions for the new feature
if (!installedExtensions.some(e => e.id === 'test_ext_global')) {
    installedExtensions.push({
        id: 'test_ext_global',
        name: 'Global Alert Button',
        author: 'System',
        version: '1.0.0',
        icon: 'bell',
        targetPage: 'global',
        description: 'A global floating button that shows an alert.',
        permissions: {},
        installed: true,
        local: true,
        downloads: 0,
        rating: 5,
        html: `
            <div style="position: fixed; bottom: 80px; right: 20px; z-index: 9999;">
                <button onclick="alert('Global Extension Triggered!')" style="width: 50px; height: 50px; border-radius: 50%; background: #ef4444; color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <i data-lucide="bell"></i>
                </button>
            </div>
        `
    });
}

if (!installedExtensions.some(e => e.id === 'test_ext_dashboard')) {
    installedExtensions.push({
        id: 'test_ext_dashboard',
        name: 'Dashboard Welcome',
        author: 'System',
        version: '1.0.0',
        icon: 'smile',
        targetPage: 'dashboard-page',
        description: 'Adds a welcome message to the dashboard.',
        permissions: {},
        installed: true,
        local: true,
        downloads: 0,
        rating: 5,
        html: `
            <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); padding: 20px; border-radius: 12px; color: white; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 10px 0;">Welcome to the Dashboard!</h3>
                <p style="margin: 0; opacity: 0.9;">This is an injected extension specific to the dashboard page.</p>
            </div>
        `
    });
}

// Mock Online Store Data
const mockStoreExtensions = [
    {
        id: 'store_ext_1',
        name: 'Dark Mode Pro',
        author: 'Epsilon Team',
        version: '1.2.0',
        icon: 'moon',
        description: 'Advanced dark mode with custom color themes.',
        rating: 4.8,
        downloads: 1250,
        permissions: { products: false, employees: false },
        html: '<h1>Dark Mode Pro</h1><p>Theme settings coming soon...</p>'
    },
    {
        id: 'store_ext_2',
        name: 'Payroll Export',
        author: 'Finance Wiz',
        version: '1.0.1',
        icon: 'file-spreadsheet',
        description: 'Export employee payroll data to CSV/Excel.',
        rating: 4.5,
        downloads: 890,
        permissions: { employees: true, deductions: true },
        html: '<h1>Payroll Export</h1><button class="button button-primary">Export CSV</button>'
    },
    {
        id: 'store_ext_3',
        name: 'Inventory Forecaster',
        author: 'AI Labs',
        version: '2.1.0',
        icon: 'trending-up',
        description: 'Predict stock shortages using AI.',
        rating: 4.9,
        downloads: 2100,
        permissions: { products: true, warehouse: true },
        html: '<h1>Inventory Forecast</h1><div id="forecast-chart"></div>'
    }
];

function switchBuilderTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.builder-tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
    
    // Show selected tab
    document.getElementById('builder-tab-' + tabId).style.display = 'block';
    document.getElementById('tab-btn-' + tabId).classList.add('active');
}

function previewExtension() {
    const html = document.getElementById('ext-code-html').value;
    const css = document.getElementById('ext-code-css').value;
    const js = document.getElementById('ext-code-js').value;
    
    const container = document.getElementById('ext-preview-container');
    
    const combinedContent = `
        <style>${css}</style>
        <div class="extension-preview-wrapper">
            ${html}
        </div>
    `;
    
    container.innerHTML = combinedContent;
    
    // Execute JS
    try {
        // Basic safety wrapper
        const safeFunction = new Function(js);
        safeFunction();
    } catch (e) {
        container.innerHTML += `<div style="color: red; margin-top: 20px; border-top: 1px solid red; padding-top: 10px;">JS Error: ${e.message}</div>`;
    }
}

function copySnippet(elementId) {
    const text = document.getElementById(elementId).innerText;
    navigator.clipboard.writeText(text).then(() => {
        showMessage('Snippet copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Failed to copy: ', err);
        showMessage('Failed to copy snippet', 'error');
    });
}

function openPublishDialog() {
    document.getElementById('publish-extension-dialog').showModal();
}

function publishExtension() {
    if (!document.getElementById('agree-terms').checked) {
        showMessage('You must agree to the terms and conditions.', 'error');
        return;
    }
    
    saveExtension();
    
    document.getElementById('publish-extension-dialog').close();
}

function saveExtension() {
    const name = document.getElementById('ext-name').value;
    const author = document.getElementById('ext-author').value || 'Anonymous';
    const version = document.getElementById('ext-version').value || '1.0.0';
    const icon = document.getElementById('ext-icon').value || 'puzzle';
    const description = document.getElementById('ext-description').value || '';
    const targetPage = document.getElementById('ext-target').value || 'standalone';
    
    const htmlCode = document.getElementById('ext-code-html').value;
    const cssCode = document.getElementById('ext-code-css').value;
    const jsCode = document.getElementById('ext-code-js').value;
    
    if (!name) {
        showMessage('Please provide an extension name in Code Sets tab', 'error');
        switchBuilderTab('code-sets');
        return;
    }
    
    // Combine code
    const fullHtml = `
<style>
/* Extension: ${name} */
${cssCode}
</style>

${htmlCode}

<script>
(function() {
    try {
        ${jsCode}
    } catch(e) {
        console.error("Extension Error:", e);
    }
})();
<\/script>
    `;

    const permissions = {
        products: document.getElementById('perm-products').checked,
        services: document.getElementById('perm-services').checked,
        deductions: document.getElementById('perm-deductions').checked,
        employees: document.getElementById('perm-employees').checked,
        assets: document.getElementById('perm-assets').checked,
        warehouse: document.getElementById('perm-warehouse').checked
    };

    const extension = {
        id: 'ext_' + Date.now(),
        name,
        author,
        version,
        icon,
        description,
        targetPage,
        html: fullHtml,
        permissions,
        installed: true,
        local: true,
        downloads: 0,
        rating: 0,
        source: {
            html: htmlCode,
            css: cssCode,
            js: jsCode
        }
    };

    installedExtensions.push(extension);
    localStorage.setItem('epsilon_extensions', JSON.stringify(installedExtensions));
    
    showMessage('Extension published successfully!', 'success');
    loadExtensions(); // Reload sidebar
    showPage('extensions-page');
    renderExtensionsList('my');
}

function renderExtensionsList(tab = 'installed') {
    const container = document.getElementById('extensions-list-container');
    if (!container) return;

    // Update active tab styling
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-${tab}`).classList.add('active');

    let extensions = [];
    if (tab === 'installed') {
        extensions = installedExtensions;
    } else if (tab === 'store') {
        extensions = mockStoreExtensions.filter(se => !installedExtensions.some(ie => ie.name === se.name));
    } else if (tab === 'my') {
        extensions = installedExtensions.filter(e => e.local);
    }

    const search = document.getElementById('extensions-search').value.toLowerCase();
    if (search) {
        extensions = extensions.filter(e => e.name.toLowerCase().includes(search) || e.author.toLowerCase().includes(search));
    }

    if (extensions.length === 0) {
        container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--color-text-medium);">No extensions found.</div>';
        return;
    }

    container.innerHTML = extensions.map(ext => `
        <div class="product-card" style="position: relative;">
            <div class="product-details">
                <div style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 15px;">
                    <div style="width: 48px; height: 48px; background: #f3f4f6; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="${ext.icon}" style="width: 24px; height: 24px; color: var(--color-primary);"></i>
                    </div>
                    <div>
                        <div class="product-name" style="margin: 0; font-size: 16px;">${ext.name}</div>
                        <div style="font-size: 12px; color: var(--color-text-medium);">by ${ext.author}  v${ext.version}</div>
                        ${ext.rating ? `<div style="font-size: 12px; color: #f59e0b; margin-top: 4px;"> ${ext.rating} (${ext.downloads} users)</div>` : ''}
                    </div>
                </div>
                
                <div class="product-description" style="font-size: 13px; margin-bottom: 15px; height: 40px; overflow: hidden;">
                    ${ext.description || 'No description provided.'}
                </div>

                <div style="margin-bottom: 15px;">
                    <div style="font-size: 11px; font-weight: 600; color: var(--color-text-medium); margin-bottom: 5px;">PERMISSIONS</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        ${Object.keys(ext.permissions).filter(k => ext.permissions[k]).map(p => 
                            `<span style="background: #e5e7eb; padding: 2px 6px; border-radius: 4px; font-size: 10px; text-transform: capitalize;">${p}</span>`
                        ).join('') || '<span style="font-size: 10px; color: #9ca3af;">None</span>'}
                    </div>
                </div>

                <div class="product-actions">
                    ${tab === 'store' ? 
                        `<button onclick="installStoreExtension('${ext.id}')" class="button button-primary" style="width: 100%;">Install</button>` :
                        `<button onclick="deleteExtension('${ext.id}')" class="button button-danger" style="width: 100%;">Uninstall</button>`
                    }
                </div>
            </div>
        </div>
    `).join('');
    
    if (window.lucide) lucide.createIcons();
}

function installStoreExtension(id) {
    const ext = mockStoreExtensions.find(e => e.id === id);
    if (ext) {
        const newExt = { ...ext, id: 'ext_' + Date.now(), installed: true };
        installedExtensions.push(newExt);
        localStorage.setItem('epsilon_extensions', JSON.stringify(installedExtensions));
        showMessage(`${ext.name} installed successfully!`, 'success');
        loadExtensions();
        renderExtensionsList('installed');
    }
}

function deleteExtension(id) {
    if(confirm('Are you sure you want to uninstall this extension?')) {
        installedExtensions = installedExtensions.filter(e => e.id !== id);
        localStorage.setItem('epsilon_extensions', JSON.stringify(installedExtensions));
        loadExtensions(); // Reload sidebar
        renderExtensionsList('installed');
        showMessage('Extension uninstalled', 'info');
    }
}

function loadExtensions() {
    // Remove existing extension buttons from sidebar
    document.querySelectorAll('.extension-nav-btn').forEach(el => el.remove());
    document.querySelectorAll('.extension-page-container').forEach(el => el.remove());
    // Remove injected extensions
    document.querySelectorAll('.extension-injected-content').forEach(el => el.remove());

    const navLinks = document.querySelector('.nav-links');
    const mainContent = document.getElementById('main');

    installedExtensions.forEach(ext => {
        const target = ext.targetPage || 'standalone';
        let contentContainer;

        if (target === 'standalone') {
            // Add Sidebar Button
            const btn = document.createElement('button');
            btn.className = 'nav-button extension-nav-btn';
            btn.setAttribute('data-page', ext.id);
            btn.onclick = () => { showPage(ext.id); closeSidebarOnMobile(); };
            btn.innerHTML = `<i data-lucide="${ext.icon}"></i><span>${ext.name}</span>`;
            navLinks.appendChild(btn);

            // Add Page Container
            const page = document.createElement('div');
            page.id = ext.id;
            page.className = 'page extension-page-container';
            
            contentContainer = document.createElement('div');
            contentContainer.innerHTML = ext.html;
            page.appendChild(contentContainer);
            
            mainContent.appendChild(page);
        } else if (target === 'global') {
            // Inject globally (fixed overlay or appended to body)
            contentContainer = document.createElement('div');
            contentContainer.className = 'extension-injected-content extension-global';
            contentContainer.setAttribute('data-ext-id', ext.id);
            // Ensure it doesn't block clicks unless intended
            contentContainer.style.pointerEvents = 'none'; 
            // Children should have pointer events
            contentContainer.innerHTML = `<div style="pointer-events: auto;">${ext.html}</div>`;
            document.body.appendChild(contentContainer);
        } else {
            // Inject into specific page
            const targetEl = document.getElementById(target);
            if (targetEl) {
                contentContainer = document.createElement('div');
                contentContainer.className = 'extension-injected-content';
                contentContainer.setAttribute('data-ext-id', ext.id);
                contentContainer.style.marginTop = '20px';
                contentContainer.style.borderTop = '1px dashed #ccc';
                contentContainer.style.paddingTop = '20px';
                contentContainer.innerHTML = ext.html;
                targetEl.appendChild(contentContainer);
            }
        }

        if (contentContainer) {
            // EXECUTE SCRIPTS WITH PERMISSIONS
            const scripts = contentContainer.getElementsByTagName('script');
            Array.from(scripts).forEach(script => {
                const scriptContent = script.innerHTML;
                if (scriptContent) {
                    try {
                        // Create restricted context
                        const context = {
                            document: document,
                            window: window,
                            console: console,
                            alert: alert,
                            // Conditionally expose data based on permissions
                            productCatalog: ext.permissions.products ? productCatalog : undefined,
                            employees: ext.permissions.employees ? employees : undefined,
                            fixedDeductions: ext.permissions.deductions ? fixedDeductions : undefined,
                            marketplaceAssets: ext.permissions.assets ? marketplaceAssets : undefined,
                            marketplaceServices: ext.permissions.services ? marketplaceServices : undefined,
                            // Helper to check permissions inside script
                            hasPermission: (perm) => ext.permissions[perm]
                        };

                        // Execute script in restricted scope
                        // We use a function constructor to wrap the code
                        // Note: This is not a perfect sandbox but prevents accidental access to globals if variables are shadowed
                        // To truly shadow globals we need to pass them as arguments
                        const argNames = Object.keys(context);
                        const args = Object.values(context);
                        
                        const safeScript = new Function(...argNames, `
                            try {
                                ${scriptContent}
                            } catch(e) {
                                console.error("Extension Error (${ext.name}):", e);
                            }
                        `);
                        
                        safeScript(...args);
                    } catch (e) {
                        console.error(`Failed to execute script for extension ${ext.name}:`, e);
                    }
                }
            });
        }
    });
    
    if (window.lucide) lucide.createIcons();
}

// Initialize extensions on load
document.addEventListener('DOMContentLoaded', () => {
    loadExtensions();
    renderExtensionsList('installed');
});
/**
 * Calculates and updates the Dashboard cards for Today's Revenue and Profit.
 */
function updateTodayMetrics() {
    const today = new Date().toLocaleDateString();
    let todayRevenue = 0;
    let todayCOGS = 0;

    // Filter sales history for today's date
    salesHistory.forEach(sale => {
        const saleDate = new Date(sale.date).toLocaleDateString();
        if (saleDate === today) {
            todayRevenue += sale.quantity * sale.unitPrice;
            
            // Calculate cost for profit
            const product = productCatalog[sale.product];
            if (product) {
                todayCOGS += sale.quantity * product.buyingPrice;
            }
        }
    });

    const todayProfit = todayRevenue - todayCOGS;

    // Update the UI
    const todayRevEl = document.getElementById('today-revenue');
    const todayProfEl = document.getElementById('today-profit');

    if (todayRevEl) todayRevEl.textContent = formatAmount(todayRevenue);
    if (todayProfEl) todayProfEl.textContent = formatAmount(todayProfit);
}

// Intercept the existing updateTotals to ensure our new cards update automatically
const originalUpdateTotals = window.updateTotals;
window.updateTotals = function() {
    if (originalUpdateTotals) originalUpdateTotals();
    updateTodayMetrics();
    // Ensure icons are rendered if lucide is available
    if (window.lucide) lucide.createIcons();
};

// Initial call to populate data on load
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(updateTodayMetrics, 500); 
});
// Fullscreen Toggle Functionality
(function() {
    // 1. Create the floating button
    const fsBtn = document.createElement('button');
    fsBtn.innerHTML = ''; // Fullscreen icon
    fsBtn.id = 'fullscreen-toggle-btn';
    
    // 2. Style the button to be in the bottom-right
    Object.assign(fsBtn.style, {
        position: 'fixed',
        bottom: '80px',
        right: '80px',
        width: '45px',
        height: '45px',
        borderRadius: '50%',
        backgroundColor: '#3b82f6',
        color: 'white',
        border: 'none',
        cursor: 'pointer',
        fontSize: '20px',
        zIndex: '10000',
        boxShadow: '0 4px 12px rgba(0,0,0,0.2)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        transition: 'transform 0.2s'
    });

    document.body.appendChild(fsBtn);

    const header = document.querySelector('.header-section');
    const nav = document.querySelector('.nav-bar');
    const mainContent = document.querySelector('.main-content');

    // 3. Toggle Fullscreen Mode
    fsBtn.addEventListener('click', () => {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                console.error(`Error attempting to enable full-screen mode: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    });

    // 4. Listen for Fullscreen Change (handles both button click and Esc key)
    document.addEventListener('fullscreenchange', () => {
        if (document.fullscreenElement) {
            // Hide header and nav
            if (header) header.style.display = 'none';
            if (nav) nav.style.display = 'none';
            // Expand main content area
            if (mainContent) mainContent.style.marginLeft = '0';
            fsBtn.style.opacity = '0.3'; // Dim button in fullscreen
        } else {
            // Restore normal view
            if (header) header.style.display = 'flex';
            if (nav) nav.style.display = 'flex';
            if (mainContent) mainContent.style.marginLeft = 'var(--nav-width)';
            fsBtn.style.opacity = '1';
        }
    });

    // Hover effect
    fsBtn.onmouseover = () => fsBtn.style.transform = 'scale(1.1)';
    fsBtn.onmouseout = () => fsBtn.style.transform = 'scale(1)';
})();
// --- VENDOR & SUPPLY CHAIN MANAGEMENT MODULE ---
(function initSupplyChainModule() {
    // 1. Add Navigation Link to Sidebar
    const navLinks = document.querySelector('.nav-links');
    if (navLinks && !document.querySelector('[data-page="supply-chain-page"]')) {
        const supplyBtn = document.createElement('button');
        supplyBtn.className = 'nav-button';
        supplyBtn.setAttribute('data-page', 'supply-chain-page');
        supplyBtn.setAttribute('onclick', "showPage('supply-chain-page'); closeSidebarOnMobile();");
        supplyBtn.innerHTML = `<i data-lucide="truck"></i> <span>Supply Chain</span>`;
        navLinks.appendChild(supplyBtn);
        if (window.lucide) lucide.createIcons();
    }

    // 2. Define Data Structure
    let vendors = JSON.parse(localStorage.getItem('epsilon_vendors') || '[]');
    let purchaseOrders = JSON.parse(localStorage.getItem('epsilon_pos') || '[]');

    // 3. Create Page HTML Structure
    const mainContent = document.querySelector('.main-content') || document.getElementById('main');
    if (mainContent && !document.getElementById('supply-chain-page')) {
        const page = document.createElement('div');
        page.id = 'supply-chain-page';
        page.className = 'page';
        page.innerHTML = `
            <div class="section-heading">Vendor & Supply Chain Management</div>
            
            <div class="kpi-grid">
                <div class="card" style="border-color: var(--color-primary)">
                    <h3>Total Vendors</h3>
                    <p id="total-vendors-stat" class="kpi-value">0</p>
                </div>
                <div class="card" style="border-color: var(--color-orange)">
                    <h3>Active POs</h3>
                    <p id="active-pos-stat" class="kpi-value">0</p>
                </div>
                <div class="card" style="border-color: var(--color-secondary)">
                    <h3>Avg. Lead Time</h3>
                    <p id="avg-lead-time-stat" class="kpi-value">0 Days</p>
                </div>
            </div>

            <div class="form-box" style="margin-bottom: 24px;">
                <h3 class="form-box-title">Add New Vendor</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <input type="text" id="v-name" placeholder="Vendor Name" class="form-input">
                    <input type="text" id="v-category" placeholder="Category (e.g. Raw Materials)" class="form-input">
                    <input type="number" id="v-leadtime" placeholder="Est. Lead Time (Days)" class="form-input">
                </div>
                <button onclick="window.addNewVendor()" class="button button-primary" style="margin-top: 15px;">Register Vendor</button>
            </div>

            <div class="card">
                <h3>Vendor Scorecard & Performance</h3>
                <div class="table-container">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="text-align: left; border-bottom: 2px solid var(--color-border-light);">
                                <th style="padding: 12px;">Vendor</th>
                                <th>Category</th>
                                <th>Lead Time</th>
                                <th>Risk Level</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vendor-list-body"></tbody>
                    </table>
                </div>
            </div>
        `;
        mainContent.appendChild(page);
    }

    // 4. Feature Logic
    window.addNewVendor = function() {
        const name = document.getElementById('v-name').value;
        const cat = document.getElementById('v-category').value;
        const lt = document.getElementById('v-leadtime').value;

        if(!name || !lt) return showMessage('Name and Lead Time required', 'error');

        const newVendor = {
            id: 'v-' + Date.now(),
            name: name,
            category: cat,
            avgLeadTime: parseInt(lt),
            risk: parseInt(lt) > 10 ? 'High' : 'Low'
        };

        vendors.push(newVendor);
        localStorage.setItem('epsilon_vendors', JSON.stringify(vendors));
        renderVendors();
        updateSupplyStats();
        showMessage('Vendor Registered');
    };

    function renderVendors() {
        const body = document.getElementById('vendor-list-body');
        if(!body) return;
        body.innerHTML = vendors.map(v => `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 12px; font-weight: 600;">${v.name}</td>
                <td>${v.category}</td>
                <td>${v.avgLeadTime} Days</td>
                <td><span class="status-${v.risk === 'High' ? 'ordered' : 'delivered'}" style="padding: 4px 8px; border-radius: 4px; font-size: 11px;">${v.risk}</span></td>
                <td><button class="button button-primary" style="padding: 4px 8px; font-size: 12px;">Order</button></td>
            </tr>
        `).join('');
    }

    function updateSupplyStats() {
        if(document.getElementById('total-vendors-stat')) {
            document.getElementById('total-vendors-stat').textContent = vendors.length;
        }
    }

    // Initialize display
    renderVendors();
    updateSupplyStats();
})();
// --- PAGE BLOCKING SYSTEM ---
(function() {
    const BLOCKED_PAGES_KEY = 'epsilon_blocked_pages';
    
    // 1. Identify all available pages based on nav buttons
    const getPageList = () => {
        const buttons = document.querySelectorAll('.nav-button');
        return Array.from(buttons).map(btn => {
            const onClickAttr = btn.getAttribute('onclick') || '';
            const pageId = onClickAttr.match(/'([^']+)'/)?.[1];
            const pageName = btn.querySelector('span')?.innerText || pageId;
            return { id: pageId, name: pageName };
        }).filter(p => p.id && p.id !== 'settings-page'); // Don't allow blocking settings!
    };

    // 2. Function to apply blocking to the Navigation Bar
    window.applyPageBlocks = function() {
        const blockedPages = JSON.parse(localStorage.getItem(BLOCKED_PAGES_KEY) || '[]');
        const navButtons = document.querySelectorAll('.nav-button');
        
        navButtons.forEach(btn => {
            const onClickAttr = btn.getAttribute('onclick') || '';
            const pageId = onClickAttr.match(/'([^']+)'/)?.[1];
            
            if (blockedPages.includes(pageId)) {
                btn.style.display = 'none'; // Disappear from nav bar
            } else {
                btn.style.display = 'flex'; // Show if not blocked
            }
        });

        // Safety: If current page is now blocked, redirect to dashboard
        const currentPage = Array.from(document.querySelectorAll('.page')).find(p => p.classList.contains('active'))?.id;
        if (blockedPages.includes(currentPage)) {
            showPage('dashboard-page');
        }
    };

    // 3. Inject the Blocking Panel into the Settings Page
    const injectSettingsPanel = () => {
        const settingsPage = document.getElementById('settings-page');
        if (!settingsPage) return;

        const container = settingsPage.querySelector('.form-layout-grid') || settingsPage;
        const blockedPages = JSON.parse(localStorage.getItem(BLOCKED_PAGES_KEY) || '[]');
        const pages = getPageList();

        const panelHtml = `
            <div class="form-box" style="margin-top: 24px; grid-column: 1 / -1;">
                <h3 class="form-box-title"><i data-lucide="lock" style="width: 18px; vertical-align: middle; margin-right: 8px;"></i>Page Visibility & Focus</h3>
                <p style="color: #6b7280; font-size: 14px; margin-bottom: 16px;">Uncheck pages to hide them from the navigation bar and block access. Use this to focus on core tasks.</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                    ${pages.map(p => `
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px;">
                            <input type="checkbox" class="block-toggle" data-page="${p.id}" ${!blockedPages.includes(p.id) ? 'checked' : ''} style="width: 18px; height: 18px;">
                            <span style="font-size: 14px; font-weight: 500;">${p.name}</span>
                        </label>
                    `).join('')}
                </div>
                <button onclick="savePageBlocks()" class="button button-primary" style="margin-top: 20px;">Save Visibility Settings</button>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', panelHtml);
        if (window.lucide) lucide.createIcons();
    };

    // 4. Save and Update logic
    window.savePageBlocks = function() {
        const checkboxes = document.querySelectorAll('.block-toggle');
        const blocked = [];
        checkboxes.forEach(cb => {
            if (!cb.checked) blocked.push(cb.getAttribute('data-page'));
        });

        localStorage.setItem(BLOCKED_PAGES_KEY, JSON.stringify(blocked));
        applyPageBlocks();
        if (window.showMessage) showMessage('Navigation settings updated!');
    };

    // Initial load
    setTimeout(() => {
        injectSettingsPanel();
        applyPageBlocks();
    }, 1000);
})();
// Initialize Hammer.js on the body to detect swiping anywhere
const bodyHammer = new Hammer(document.body);

// Listen for swipe right to OPEN the sidebar
bodyHammer.on('swiperight', function(ev) {
    const navBar = document.querySelector('.nav-bar');
    // Only trigger if we are on a mobile screen (matching your @media query)
    if (window.innerWidth <= 768) {
        navBar.classList.add('active');
        console.log('Sidebar opened via swipe');
    }
});

// Optional: Listen for swipe left to CLOSE the sidebar
bodyHammer.on('swipeleft', function(ev) {
    const navBar = document.querySelector('.nav-bar');
    if (window.innerWidth <= 768 && navBar.classList.contains('active')) {
        navBar.classList.remove('active');
        console.log('Sidebar closed via swipe');
    }
});
</script>
</body>
</html>
